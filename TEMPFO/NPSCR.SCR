111 3 3 3                                                                                                                       DFGDF                                                            DFGDFGDF G                                                     DF GDFGD                                                        FGDFG                                                           DFG                                                             DFG                                                             DFGD                                                            D                                                               FGDFG                                                           SDF                                                             DFG                                                             SDFGSDFGSDFGSDFGSDFGD                                           DFGDFGD FGDFG                                                          DFG DFGDFGDFG                                            MARKER -MYDO  : I RP@ 2+  2@ - ;  : I< RP@ 2+ 2@ + ;            \ CODE I  BX PUSH,  2 /BP BX MOV,  0 /BP BX SUB, NEXT, END-CODE \ : THRU  PUSH PUSH I RDROP 1+ FOR I LOAD NEXT RDROP ;          : |-| POP -ROT DUP PUSH COM + ABS SWAP PUSH ;                   : \' [',] [',] ;  IMMEDIATE                                     : \N COMPILE lit \' [',] ;  IMMEDIATE                           : MYDO   COMPILE |-| \' FOR ; IMMEDIATE                         : MYLOOP \' NEXT COMPILE RDROP ; IMMEDIATE                      : MYPROBA MYDO R. I . MYLOOP ;                                  : PROBA 2 PUSH 1 PUSH I RDROP RDROP ;                           : PROBA2 2 PUSH 5 PUSH I RDROP RDROP ;                          : INDEX  1+ SWAP DO I BLOCK I CR .LINE LOOP ;                   : INDEX2 DUP TO SCR 1+ SWAP - 0MAX FOR                                CR SCR R@ - DUP BLOCK SWAP .LINE NEXT ;                   : INDEX3 FOR R@ . NEXT ;                                                                                                        MARKER -TIMES                                                   0 VALUE BR : ;BR BR EX TO BR ; : C!B+ ;BR C!+ ; : !B+ ;BR !+ ;  0 VALUE AR : ;AR AR EX TO AR ; : C@A+ ;AR C@+ ; : @A+ ;AR @+ ;                                                                  : PROBA TIMES DUP . ;                                           : CMOVE -ROT TO BR TO AR TIMES C@A+ C!B+ ;                      : SPACES TIMES SPACE ;    : (TYPE TO AR TIMES C@+ ?EMIT ;       : STYPE C@+ (TYPE ;  : TYPE SWAP (TYPE ; : #> TIMES SWAP EMIT ; : (." POP STYPE AR PUSH ; : (" POP DUP C@+ + PUSH ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                             EDGE TO SPTR                                                    : ;BASE BASE XCHG PUSH TO BASE EX POP TO BASE ;                  : ?CSP SP@ CSP - A" PAIRS? " TO CSP ; : CSP! CSP SP@ TO CSP ;  ' : TO MPTR : : CSP! : ; MPTR EXEC ; [',] ; ?CSP ; IMMEDIATE                                                                      0 NM: C@ (BR TO ;BASE ;M        1 NM: C@ TO BASE ;M             2 NM: C@ ;BASE BLWORD  NUM ?LITERAL ;M                            |  3 MAKER >BASE C,          16  >BASE $   IMMEDIATE            10  >BASE #   IMMEDIATE       2  >BASE %   IMMEDIATE                                                                         VARIABLE  %!%                                                  : #% @ IF %!% AT HDRS? OVER @ @SWAP @SWAP DROP THEN <N> ;       : <N  0 %!% ! AT HDRS? #% ;  ( START HI - CODE WITH NAMES)      : N>  %!% #% ;            ( END HI - CODE)                         PRUNE          -->                                                                                                                        : "T  SPTR CSTR ; : "ALLOT DUP 1+ AT SPTR @-! C! ; : #>" "ALLOT "T FOR C!+ NEXT DROP ;     : "DROP  "T + TO SPTR ; : "PUSH  DUP PUSH 1+ AT SPTR @-! 1+ R@ MOVE POP SPTR C! ;       : "INS "T PUSH TO SPTR "PUSH POP SPTR +! ; : ">' SPTR "DROP ;                : "SWAP+ ">' COUNT "INS ;                          : "INSC 1 #>" "SWAP+ ; : =" C" " WORD COUNT "ALLOT "T CMOVE ;   : "MOVE OVER C@ 1+ MOVE ; : >OS bl "INSC COUNT "INS ">' SHELL ; : "POP   SPTR HERE "MOVE "DROP HERE CSTR ; : N>" 0 <# S# #>" ;  | : CM0  CREATE ,S" ;    | : CMD2" CM0 DOES> =" >OS ;           \ | : CM0  CREATE "WORD ", ;    | : CMD2" CM0 DOES> =" >OS ;    : A>" [AT] $ SWAP N>" C" : "INSC N>" "SWAP+ ;                   | : CMD1# CM0 DOES> SWAP ?CS: A>" >OS ;                         CMD1# $TEST ..\AFD.COM"   CMD2" REN REN"  CMD2" DOS COMMAND /C"   CMD2" DIR DIR /O"       CMD2" DEL DEL"  CMD2" ED EDT"           CMD2" CD CD"            CMD2" RD RD"   0 0 "PUSH 0 0 "PUSH      CMD2" ATEST ..\AFD.COM" : '$ ' @ $TEST ;                      \ KBD   CONSTANTS                                               : BCONST CREATE C, DOES> C@ STATE IF COMPILE blit C, THEN ;        IMMEDIATE                                                    : CONST CONSTANT DOES> @ [',] LITERAL ; IMMEDIATE                72 BCONST kUP       80 BCONST kDOWN     77 BCONST kRIGHT        75 BCONST kLEFT    116 BCONST kcRIGHT  115 BCONST kcLEFT        82 BCONST kINS      83 BCONST kDEL      73 BCONST kPGUP         81 BCONST kPGDN     71 BCONST kHOME     79 BCONST kEND         119 BCONST kcHOME   117 BCONST kcEND     59 BCONST kF1           60 BCONST kF2       61 BCONST kF3       62 BCONST kF4           63 BCONST kF5       64 BCONST kF6       65 BCONST kF7           66 BCONST kF8       67 BCONST kF9       27 BCONST kESQ          68 BCONST kF10      84 BCONST ksF1      93 BCONST ksF10         94 BCONST kCF1     103 BCONST kcF10     15 BCONST ksTAB        104 BCONST kaF1     113 BCONST kaF10      9 BCONST kTAB         ' CTRL  ALIAS  ^  IMMEDIATE                                     HERE TO FENCE  CREATE -MARKER : THRU 1+ SWAP ?DO I LOAD LOOP ;  : +THRU PUSH BLK + POP BLK + THRU ;                               0 VALUE XK       : WHAT? 7 EMIT ;                             : -:  ' , C,  XK 2+ DUP TO XK       ( BYTES FOR MOVE UP 1 )              HERE OVER - DUP PUSH       ( START ADDRESS   )                  DUP 1+ ROT                 ( PREPARE FOR MOVE)                  MOVE  HERE C@ POP C!   ;   ( FIX CODE  )               : SWITCH: CREATE HERE 73 1 TO XK 0 -:                               DOES> SWAP TO XK COUNT 2DUP XK SCANB 1+ 2* + + PERFORM ;    : ;SWITCH  73 - A" BAD KEYS" XK 2/ 1- SWAP C! ;                                                                                 3 LOAD     7 11 THRU           \ STRING # $ % EDITOR            12              LOAD           \ MARKER ORDER <% ASM CODE             200       LOAD           \ DECOMPILER                     86 101 THRU   PRUNE            \ ASSEMBLER                      \ 13 LOAD  14 LOAD  PRUNE      \ COMMANDS                       (  EDITOR POSXY WIPE RELOAD SAVEBLK LB N B ARROW)               : >SORT 2DUP < IF SWAP THEN ;                                   : MAX >SORT DROP ; : MIN >SORT NIP ; : <SORT >SORT SWAP ;       F83 ONLY TO FORTH \ VOCABULARY EDITOR                                                                                           ( ONLY FORTH ALSO  EDITOR  ALSO DEFINITIONS)   0 VALUE XY        -HEADERS       0 VALUE  PDATA     0 VALUE OLD_RP                 VARIABLE INS  0 VECTOR 'ADVANCE                               : ?XY 1L U/MOD  7 2 D+  ;    : ?INS 1 INS @ AND ;               : POSXY XY ?XY GOTOXY   ;                                       : .INS  75 2 GOTOXY ?INS IF ." INS" ;THEN ." OVT" ;             : _INS  1 INS XOR! .INS ;    : RELOAD SCR BLOCK TO PDATA ;      : REDRAW .INS HOME PDATA .BLOCK ;                               : /L  1L 1- OR ;           ( LINE END)                          : L/ 1L NEGATE AND ;       ( LINE BEGIN)                                                                                        ( COPY POS^ LINE/ /LINE LDRAW EL INSC DELC OVTC INSL DELL LL  ) : ;LRUD  XY EX 1K 1- AND TO XY ;    : ;LPOS  XY EX PDATA + ;    : L_UP  ;LRUD  1L - ;     ( LINE UP)                            : L_DN  ;LRUD  1L + ;     ( LINE DOWN)                          : L_END ;LRUD  /L ;       ( LINE END)                           : L_BEG ;LRUD  L/ ;       ( LINE BEGIN)                         : ->    ;LRUD  1+ ;       ( MOVE 1 CHAR RIGHT)                  : <-    ;LRUD  1- ;       ( MOVE 1 CHAR LEFT)                   : TAB>  ;LRUD  7 OR 1+ ;  ( NEXT TABULATION )                   : <TAB  ;LRUD  1- -8 AND ;  ( PREVIOUS TABULATION)              : <_|   L_DN L_BEG    ;   ( CARRIGE RETURN L_DN L_BEG )         : APOS  ;LRUD  0 AND ;    ( HOME POSITION OF CURSOR)            : LINE/ ;LPOS L/ ;  : /LINE ;LPOS /L ;                          : LDRAW POSXY LINE/ cr EMIT XY 1L / .LINE ;                     : EJECTBLOCK DISCARD -1 PREV 1+ ! ;                             : RESET EJECTBLOCK RELOAD REDRAW ;   ( !!!!!!!)                 : LB SCR + 0 MAX TO SCR RELOAD REDRAW ;   ( +blk - )            : LEOS 1K  XY - 1L - 0 MAX ;  ( - chars_to_end_of_screen )      : POS^ PDATA XY + ;          ( - char^ )                        : P2 POS^ DUP DUP 1L + ;     ( - char^ char^ char^+1l )         : LL XY /L XY - ;            ( - chars_to_end_of_line )         : GETCHAR XY 0= 'ADVANCE POS^ C@ 33 U< ;                        : -BL BEGIN  GETCHAR 0= OR UNTIL ;        : N  1 LB ;           : -NONBL BEGIN GETCHAR OR UNTIL ;         : B -1 LB ;           : >NEXT TO 'ADVANCE -NONBL -BL ;  : ADV ['] -> >NEXT ;          : >EL 1K LEOS - 1L MIN ;      : BACK ['] <- >NEXT -> ;          : EL >EL BLANK ;  ( ERASE LINE OR LESS)                         : RDRC REDRAW UPDATE ;                                          : DELL P2 SWAP LEOS CMOVE LEOS +  EL RDRC ;                     : >INSL P2 LEOS CMOVE> EL ;                                                                                                                                                                     : C POS^ >EL L_DN "PUSH ;             : G C L_UP DELL ;         : P "T NIP 0;  >INSL "POP >EL MIN POS^ SWAP CMOVE RDRC ;        \ : C ; : P ; : G ;                                                                                                             : OVTC POS^ C! UPDATE ;                                         : INSL >INSL RDRC ;                                             : POSC POS^ DUP 1+ ;                                            : INSC ?INS IF POSC LL CMOVE> THEN OVTC ;                       : DELC POSC SWAP LL CMOVE bl /LINE C! LDRAW UPDATE ;            : BS <- DELC ;                                                  : X-POS 0 18 GOTOXY OLD_RP RP! ;                                : Q/ED  FLUSH  X-POS ;                                          : ESQ/E EMPTY-BUFS X-POS ;         <N  5 LOAD  N>                                                                                                                                                                                                               : @KEY POSXY KEY UNPACK OVER IF DROP ;THEN SWAP ;               : ONEC XK bl U<  IF WHAT? ;THEN XK INSC LDRAW -> ;              | SWITCH: EF WHAT?               kLEFT -: <-     kUP -: L_UP     kHOME -: L_BEG   kEND -: L_END  kPGUP -:  B   kPGDN -: N        kDOWN -: L_DN  kRIGHT -: ->     kINS  -: _INS  kDEL -: DELC     ksTAB -: <TAB  kcHOME -: APOS  ;SWITCH                                                                                         | SWITCH:  EK  ONEC   ^ J -: <-  ^ K -: ->     ^ X -:  G          127 -: DELL    bs -: BS        ^ D -: DELC  cr -: <_|          ^ N -: N     ^ B -: B    ^ L -: RESET   ^ I -: TAB>             ^ C -: C     ^ V -: P    ^ Q -: ESQ/E   ^ Z -: BACK             ^ A -: ADV   kESQ -: Q/ED  ^ S -: INSL   0 -: EF   ;SWITCH                                                                     : E  RELOAD REDRAW  RP@ TO OLD_RP  BEGIN @KEY EK AGAIN ;        : EDIT PAGE TO SCR  E ;     : ERR CSP TO XY SCR EDIT ;          : HELP SCR PUSH TO SCR E POP TO SCR E ;  FORTH  PRUNE           \ CREATE -MARKER                                                : ?IN @R+ >IN PUSH ?EXEC POP TO >IN ;                           : MARKER ?IN -FIND NIP IF ?IN FORGET THEN                               CREATE DOES> 2- C>N DROP forget ;                       : ORDER. ORDER# WCOUNT FOR WCOUNT 6 - ?ID. NEXT DROP ;            : CLARY HERE OVER ERASE ALLOT ;                                 | : ARRAY CREATE , DOES> HEADER  @ ,                                  HERE DUP PUSH 2- EXEC POP - CLARY ;                     ' ORIGIN+ 2+ @ DUP        ARRAY QARY                              2+ DUP  ARRAY WARY   2+ ARRAY BARY                            MARKER -ASM       ' -ASM @ ' -MARKER !                          0 VECTOR ASM     : CODE HEADER HERE 2+ , ASM ;                  : ;CODE COMPILE ;code ['] [ ASM ; IMMEDIATE                     -->                                                                                                                                                                                                                                                             | : #S.  EMIT ." [" SPACE  OVER SWAP  - 2 / 1-                   DUP 0< A" STACK UNDERFLOW"  FOR 2- DUP @ . NEXT DROP ." ]" ;                                                                     : S. S0 SP@ C" S #S. ;  : R. TIB RP@ C" R #S. ;                                                                               : VOX. VOCLINK BEGIN ?DUP WHILE DUP 8 - C>N DROP                    CR DUP H. ID.  @ REPEAT ;                                   : VOC. CR ." CONTEXT = "  CONTEXT 6 - ?ID.                       CR ." CURRENT = "  CURRENT 6 - ?ID.  ;                                                                                         \ : ?CSP SP@ CSP - A" PAIRS? " TO CSP ;                         \ : CSP! CSP SP@ TO CSP ;                                       : U/ 0 SWAP UM/MOD NIP ;                                        \ : R>M 8 U/ ;                                                                                                                  ASM  L: >BOOT CLD, 0 #, JMP,    L: >COLD CLD, 0 #, JMP,         L,? 3  L,? 2  NOP, NOP, LODSW, L: >EX AX DI XCHG, 0 /DI JMP,    L: >TRON  $ 2EB #, AX MOV, ?, NOT, IF,    L:  F> SI JMP,        L: >TROFF >EX 1- /// AX MOV, THEN, DI SKIPW, L,? 1 STOSW, RET,  L: ;F> SI PUSH,  X, SI POP, X, RET,   L: >TRF: >TROFF CALLI,    L: >F: X, SI PUSH, X,           L: >F  SI POP, ?, NOT, IF,      L: >SWAP! DI POP, CX SKIPW, SCASW, L: >VAR! SCASW, BX 0 /DI MOV, L: >DROP DROP, ?, NOT, IF, SCASW, SCASW,  FL: 3                L: >CONST 2 /DI AX MOV, ?, NOT, IF,  SCASW, SCASW,              L: >VAR   2 /DI AX LEA,  THEN,    L: >PUSH  DUP,                L: >SWAP AX BX XCHG, THEN, THEN, FL: 1  HERE TO ?NEXT ( !!!)    L: >MAIN LODSW, AX DI XCHG, 0 /DI JMP,                          >TRF: CALLI, FL: 2 Z,    ;F> , >TRON CALLI, >EX 1- JMP,                                                                                                                                                                                                         L: >RP@ BP AX MOV, >PUSH JMP,   L: >RP! BX BP MOV, >DROP JMP,   L: >SP@ DUP, SP BX MOV, NEXT,   L: >SP! BX SP MOV, >DROP JMP,   L: >PERF 0 /BX BX MOV,          L: >EXEC   AX POP, AX BX XCHG,  L: >?EX AX CX MOV, >MAIN JCXZ, >EX JMP,   SCASW, SCASW,         L: >DEFER SCASW, 0 /DI AX MOV, >?EX JMP,  L: >ALIAS >DEFER JMP,            SCASW, SCASW,        L: >NEST   2 /DI AX LEA,        L: >?NEST  SI AX XCHG,                                          L: >ARPH -2 /BP BP LEA, AX 0 /BP MOV, NEXT,                     L: >;: SI 0 /BP XCHG, NEXT, SCASW, SCASW,                       L: >DOES AX POP, DUP,  2 /DI BX LEA, >?NEST JMP,                L: >XCHG BX 0 /BP XCHG, NEXT,  \ XCHG                           L: >CONT -2 /SI AX LEA, >ARPH JMP,                              L: >#PUSH  AX POP, BX AX XCHG, >ARPH JMP,                       L: >CALL LODSW, >?NEST JMP,                                                                                                                                                                         1 #, BX SHL,  BX DI ADD,  1 #, BX SHL,                      L: >ARY 1 #, BX SHL, 2 X/D BX LEA, NEXT,                        L: >BLIT LODSB,        L: >BPUSH   0 #, AH MOV, >PUSH JMP,      L: >MLIT LODSB,        L: >MPUSH  -1 #, AH MOV, >PUSH JMP,      L: >DLIT DUP, LODSW, AX BX XCHG,                                L: >LIT   LODSW, >PUSH JMP,                                     L: >!+  0 /BX POP,     L: >2+ BX INC,    L: >1+ BX INC, NEXT,   L: >-! -2 /BX POP,     L: >2- BX DEC,    L: >1- BX DEC, NEXT,   L: >@PC+ AX AX XOR, CX POP, DUP, SI 0 /BP XCHG, SI BX MOV,          CX CALL, AX SI ADD, >;: JMP,                                L: >@PC' >@PC+ CALLI, AL LODS, RET,                                                                                                                                                                                                                                                                                                                                                             L: >IF  BX BX OR,               L: >0=IF 0=, IF,                L: >JMP 0 /SI SI MOV, NEXT,     L: >UNNEST  0 /BP SI MOV,       L: >RDROP  2 /BP BP LEA, NEXT, THEN,                            L: >SKIP 2 /SI SI LEA, NEXT,                                    L: >#IF  AX POP, AX BX XCHG, AX AX OR,  >0=IF JMP,              L: >-IF  BX BX OR,  >JMP JNL,  >SKIP SJMP,                      L: >NEXT -1 #, CX MOV,  CX 0 /BP ADD,  >JMP JB,                              2 /SI SI LEA, >RDROP SJMP,                         L: >OF    AX POP,  AX BX XCHG,  AX BX CMP, >JMP JNE,                      DROP, >SKIP JMP,                                      L: >?FOR  AX POP,  AX BX XCHG,  AX DEC, >JMP JL,                         2 /SI SI LEA,  >ARPH JMP,  END-CODE                        ;F> CODE, ;4TH        F> CODE, 4TH>                            >LIT CODE, LIT    >UNNEST CODE, EXIT     >MAIN CODE, NOP     TO COMP  COMP        >UNNEST CODE, X   0 ' X 3 - C!  \ ZERO     ROOT                                                              >JMP  CODE, (BR      >?FOR CODE, ?for     >SKIP CODE, skip       >IF  CODE, if        >-IF CODE, -if      >NEXT CODE, next      >#IF  CODE, (0BR     >CALL CODE, call    TSTART CODE, boot       >OF  CODE, of       >BLIT CODE, blit     >DLIT CODE, dlit                          >PERF  CODE, PERFORM                        >EXEC CODE, EXEC       >;: CODE, EX     >RDROP  CODE, RDROP     >XCHG CODE, XCHG    >#PUSH CODE, PUSH   >SWAP!  CODE, SWAP!     >MLIT CODE, mlit   >DROP   CODE, DROP     >@PC' CODE, @pc+       >RP! CODE, RP!      >RP@  CODE, RP@        >2+ CODE, 2+         >SP! CODE, SP!        >2- CODE, 2-         >1+ CODE, 1+                             >SP@  CODE, SP@        >1- CODE, 1-      \  >FIND CODE, find     >PLUS CODE, +                                                                                                                                                                                                                                                                                           \ DEFINING WORDS                                                >CONST (1 CONSTANT ,               >VAR! >CONST 1- (2  VALUE ,    >VAR (1 VARIABLE Z,                       >ALIAS (1  ALIAS ,  >DEFER (1 DEFER ,                 >VAR! >DEFER 1-  (2  VECTOR ,                                                                 >VAR >VAR! 1- >CONST 2- (3  QUAN ,                              >VAR >VAR! 1- >DEFER 2- (3  VQUAN ,                                                                                             0 QUAN DERR  L: >DERR  0 , 0 , 0 , 0 , 0 , 0 ,                                  \ ERR AX  BX  CX  DX  ES  DS                                \  ERRORS & RESULTS IN DOS FUNCTIONS                                                                                                                                                                                                                                                                                                                                                CODE C!+ CX POP, CL 0 /BX MOV, >1+ JMP,  END-CODE               CODE C@+  0 CH MOV, 0 /BX CL MOV, CX PUSH, >1+ JMP, END-CODE    CODE @+  0 /BX PUSH, >2+ JMP, END-CODE                          CODE -C! CX POP, CL -1 /BX MOV, >1- JMP,  END-CODE              CODE -@ -2 /BX PUSH, >2- JMP,  END-CODE                         CODE -C@ 0 CH MOV,  -1 /BX CL MOV, CX PUSH, >1- JMP, END-CODE   CODE 2*  1 #, BX SHL, NEXT, END-CODE                            CODE 2/  1 #, BX SAR, NEXT, END-CODE                            CODE ROT   CX POP,  AX POP, CX PUSH, DUP,  >SWAP JMP,  END-CODE CODE -ROT  AX POP,  CX POP, DUP, CX PUSH,  >SWAP JMP,  END-CODE CODE AND   AX POP,  AX  BX AND,  NEXT,  END-CODE                CODE OR    AX POP,  AX  BX OR,   NEXT,  END-CODE                CODE XOR   AX POP,  AX  BX XOR,  NEXT,  END-CODE                CODE - BX NEG, L: >PLUS AX POP,  AX  BX ADD,  NEXT,  END-CODE                                                                                                                                   CODE INVERT BX INVERT, NEXT,    L:  >PUSHES CX POP, BX SI XCHG,      CX CALL,  BX SI XCHG,  >PUSH JMP, END-CODE                 CODE NIP    AX POP, NEXT,  END-CODE                             CODE SWAP  AX POP, >PUSH JMP, END-CODE                          CODE STR   >PUSHES CALLI,  LODSW, RET, END-CODE                 CODE CSTR  >PUSHES CALLI,  LODSB, 0 #, AH MOV, RET, END-CODE    CODE BSTR  >PUSHES CALLI,  LODSB, CBW, RET, END-CODE            CODE DSTR  >PUSHES CALLI,  CX POP, DUP, LODSW, AX BX XCHG,            LODSW, CX JMP,  END-CODE                                  CODE 0=  1 #, BX SUB,     L:  >CARRY BX BX SBB, NEXT, END-CODE  CODE 0< 1 #, BX SHL, >CARRY JMP, END-CODE                       CODE U< AX POP, BX AX SUB, >CARRY JMP, END-CODE                 CODE UNPACK AX AX XOR, AL BH XCHG, >PUSH JMP, END-CODE                                                                                                                                                                                                          CODE PACK AX POP, BL AH MOV, >SWAP JMP, END-CODE                CODE +*   1 #, DL TEST, 0=, NOT, IF,                                   AX POP, AX BX ADD, AX PUSH, THEN,  1 #, BX RCR,                1 #, DX RCR, NEXT, END-CODE                               CODE -/ 1 #, DX SHL,  1 #, BX RCL, AX POP,  AX BX CMP, AX PUSH,     U<, NOT, IF, AX BX SUB, DX INC, THEN,  NEXT, END-CODE       CODE DUP   DUP, NEXT, END-CODE                                  CODE POP   DUP, 0 /BP BX MOV, >RDROP JMP, END-CODE              CODE  A  DUP,  DX BX MOV, NEXT, END-CODE                        CODE A!  BX DX  MOV,  DROP, NEXT, END-CODE                      CODE OVER  AX POP, AX PUSH, >PUSH JMP, END-CODE                                                                                                                                                                                                                                                                                                                                                 CODE -LEAD   ( /ADR -LEN CHAR -- /ADR -LEN') AX BX XCHG,         DROP, DI POP,  BX DEC, DI PUSH,   BEGIN,  BX INC,  0=, J, 1        AL 0 X/D CMP,  0=, NOT, UNTIL, FB: 1  NEXT, END-CODE                                                                        CODE -LEAD#  ( /ADR -LEN CHAR -- /ADR -LEN') AX BX XCHG,         DROP, DI POP,  BX DEC, DI PUSH,   BEGIN,  BX INC,               0=, J, 1  AL 0 X/D CMP, 0=, UNTIL, FB: 1  NEXT, END-CODE                                                                       CODE -TRAIL   ( ADR/ LEN CHAR -- ADR/ LEN') AX BX XCHG,          DROP, DI POP,  BX INC, DI PUSH,   BEGIN,  BX DEC,  0=, J, 1        AL 0 X/D CMP,  0=, NOT, UNTIL, FB: 1  NEXT, END-CODE                                                                        CODE -TRAIL#  ( ADR/ LEN CHAR -- ADR/ LEN') AX BX XCHG,          DROP, DI POP,  BX INC, DI PUSH,   BEGIN,  BX DEC,               0=, J, 1  AL 0 X/D CMP, 0=, UNTIL, FB: 1  NEXT, END-CODE                                                                       CODE WBLK  $ 40 #, CH MOV,      AX SKIPW,                       L: >RBLK  $ 3F #, CH MOV, DI POP, 1024 #, AX MOV,  AX  PUSH,      CX PUSH,    DI MUL,       AX DX XCHG,   AX CX XCHG,                    $ 4200 #, AX MOV,  DOS,  DI POP,  U<, NOT,                 IF,      DUP, DI BX MOV,                                    L: >DOS AX BX XCHG, DROP,  CX POP, DX POP, DS PUSH,                 >DERR 10 +  /// DS MOV, DOS, DS POP,  DI SKIPW,                 THEN,    DI POP, DI POP,  ES PUSH,  CS PUSH,  ES  POP,          >DERR 2+  #, DI MOV,   U<, IF,  AX -2 /DI MOV, THEN,            STOSW,  BX AX XCHG, STOSW,  CX AX XCHG, STOSW,  DX AX XCHG,     STOSW,  AX POP, STOSW, >DROP JMP, END-CODE                  CODE SCANI AX POP, AX SI XCHG, CX CX XOR, CX BX XCHG, CXNZ, IF,            BEGIN  0 /SI BL MOV,  1 X/S SI LEA,  CXNZ, UNTIL,    THEN,  SI AX XCHG, >SWAP JMP,                                                                                                                                                                   L: >BSTR=  255 #, CX MOV,         L: >LSTR= LODSB, AX CX AND,     CL 0 /DI CMP,  0=, IF, DI INC,  L: >STR=  REP: CMPSB,           0=, NOT, IF,  CX SI ADD,  THEN,  THEN,  RET,                  L: >FIND  -2 /BP BP LEA, SI 0 /BP MOV,                          BEGIN,  BEGIN,  SI POP,  SI INC, 0=, IF,                            DUP, AX SI XCHG, ?, J, 8 THEN,  SI DEC,  0=, NOT, UNTIL,      BEGIN, CX POP,  SI CX CMP, 0=, NOT, UNTIL,  CX PUSH,            BEGIN, BX DI MOV, 31 #, CX MOV, >LSTR= #, CALL,                   0=, IF,  $ 20 #, AL TEST,  0=, J, 7 THEN,                       0 /SI SI MOV, SI SI OR,                                       0=, UNTIL,                                                    AGAIN,  FB: 7   BEGIN, CX POP, CX INC, 0=, UNTIL,                  SI INC,  SI INC,  SI PUSH,  CBW,  STC,  AH AL MOV,              1 #, AX RCL,  FB: 8  AX BX XCHG, >UNNEST JMP,                                                                                                                                                L: >SCAN: AX POP,  AX BX XCHG,     CX POP,    DI POP,                    CS PUSH,      ES POP,  CX DX MOV,   BX CALL,                    0=, NOT, IF,   DX CX MOV,  THEN,                         CX INC,   CX DX SUB,  AX DX XCHG,  >SWAP JMP,  END-CODE       CODE SCANW >SCAN: CALLI,  REP: SCASW, RET,  END-CODE            CODE SCANW< >SCAN: CALLI, STD,  CX BX MOV, 0 X/D DI LEA,         -2 X/D DI LEA,   REP: SCASW,   CLD, RET,  END-CODE             CODE SCANB< >SCAN: CALLI, STD,  CX BX MOV,                         -1 X/D DI LEA,   REP: SCASB,   CLD, RET,  END-CODE           CODE SCANB >SCAN: CALLI,  REP: SCASB, RET,  END-CODE            CODE SCANL >SCAN: CALLI,   SI PUSH,   BX BX  OR,                     AX BX  XCHG,   SI DI  MOV,   CXNZ,                         IF,  BX DI MOV,                                                      BEGIN, CX PUSH,  >STR= CALLI, CX POP,  EQ, UNTIL,          THEN,   SI POP,  RET,            END-CODE                         >RBLK  CODE, RBLK       >DOS CODE, (DOS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       FORTH TO FORTH                                                                                                                  P#.  KBD                                                                                                                        ' HERE   ' NOP   (( FOR/        '  ,     ' NOP   (( /NEXT       ' LOOP/  ' NOP   (( FOR         ' /LOOP  ' NOP   (( NEXT        ' >MARK  ' NOP   (( ?FOR        ' >MARK  ' NOP   (( (CALL       ' >MARK  ' NOP   (( -IF         ' >MARK  ' NOP   (( #IF         P#.  KBD                                                         VOCABULARY TEMP     51 LOAD                                    P#.  KBD                                                                   FORTH TO TEMP  >IMMED                                                                                                \          FORGET TEMP                                                                                                                                                                          FORTH TO FORTH  MARKER -TARG  50 LOAD  \ SAVE CONTROL WORDS     0 VALUE RAM  ' NOP TO 'SAME  0 CONSTANT TSTART 0 CONSTANT TEND  : COMPILE, DUP TSTART TEND WITHIN 0= A" NOT TARGET SPACE! " , ; | : /META IF ' 2+ STR , 2- , ;THEN  DO: @R+ @R+ ! ; IMMEDIATE   : IS ' 2+ ! ;  : META ' IS ;   META COMPILE /META \ META PRIMIT | : ;-NAME <N EX N> ;  : CODE, HEADER , ;                       | : FINDER CREATE DOES> SWAP STR FIND ;                         : <% THERE 2@ dA HERE THERE 2! TO HERE TO dA ; ' <% ALIAS %>    | : ;NS  CURRENT XCHG PUSH TO CURRENT EX POP TO CURRENT ;       | : CONST CONSTANT IMMEDIATE DOES> @ [',] LITERAL ;             : C: AT HIDDEN ;NS ['] CONST ;-NAME EXEC ;  : L: HERE C: ;      HERE 16 ALIGN DUP TO HERE IS TSTART                              12000 CLARY         HERE IS TEND       0 TSTART THERE 2!                                                                         1 4 +THRU                                                                                                                       ONLY                                                                                   ROOT ALSO   TO FORTH                   FINDER COMPILE? 1 , AT MACROS , FINDER INTERPRET? 1 , AT ROOT , FINDER SEARCH? 2 , AT ROOT , AT COMP ,                                                                                          : D+   ROT + PUSH +.2/ 0< XCHG POP - ;                          : NEGATE 0 SWAP - ;                                                                                                              TEST                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            156 LOAD    \ NUMBERS                                          0 VALUE RPADR                                                   : ] RP@ TO RPADR  BEGIN BLWORD    [ DUP ]                              COMPILE?      WHILE  EXEC      REPEAT [ DUP ]                   INTERPRET?    WHILE  COMPILE,  REPEAT                           NUM [',] LITERAL   AGAIN ;                                ' (INT @   ' ] !   \ RECURCE LIKE A LOOP                       P#.                                                                 KBD                                                                ' :  ALIAS ':                0 CONSTANT #NEST            : [ RPADR RP! ;   IMMEDIATE    ' (INT @ ' [ !                   ' ; ALIAS ';  IMMEDIATE   : ; SMUDGE ?CSP [',] [ ;  IMMEDIATE   : : HEADER CSP! SMUDGE  #NEST , ] ';                            P#.                                                                 KBD                                                                                                                         \ META_IZINIG  COMPILATION WORDS                                P#.    TEST   14 LOAD    ROOT                                       TO ROOT  <%   102 112 THRU %>  ' RESCAN TO 'SAME   TEST     ROOT KBD                                                        P#. META lit [LIT]          META  lit  [']                          META jump AHEAD         META  jump AGAIN                        META of OF              META  call (CALL                                                                                        META -if -IF            META   if  #IF                          META #if IF             META  #if UNTIL                                                                                         META ?for  ?FOR         META  PUSH FOR/                         META ?for  FOR                                                  META next  /NEXT        META  next  NEXT                    P#.                                                                                                                             TO FORTH                \ DEFINING WORDS                        >CONST (1 CONSTANT ,    >VAR (1 VARIABLE Z,   >DEFER (1 DEFER ,                                                                 >VAR! >DEFER 1-         (2  VECTOR ,         >ALIAS (1  ALIAS , >VAR >VAR! 1- >CONST 2- (3  QUAN ,  >VAR! >CONST 1- (2  VALUE , >VAR >VAR! 1- >DEFER 2- (3  VQUAN ,      >DOES CONSTANT #does                                                                                                                                   ROOT                                                             >NEST IS #NEST        META EXIT ;M       META EXIT ;THEN       TO ROOT   ' (INT2  IS INTERPRET  <%  \ TARGET COMPILER            TEST                                                                                                                           1 2 +THRU  \ SWITCH INTERPRETTER                                                                                                                                                               \ : ((S ( -) CONTEXT BEGIN @ ?DUP WHILE                         \   DUP N>C DUP @ lit [ ' A" @ , ] = IF OVER ID. THEN NIP 2-    \  REPEAT ;                                                                                                                     \ [LIT] ;M DO: UNTIL AGAIN NEXT OF FOR IF AHEAD +LOOP DO LOOP ?D\ ;THEN  [']            ."   "   A"                             : (." (STR ". ;                                                 : ("  (STR  ;                                                   : (A" (STR SWAP IF                                                     CR HERE ID. BLK TO SCR  >IN TO CSP  ". CR ABORT THEN           DROP ;                                                                                                                    \     >F CODE, >4th       >F: CODE, 4th:                        \   >ARY CODE, ary     >ALIAS CODE, alias                                                                                                                                                       TO FORTH        : IS ' 2+ ! ;  : META ' IS ;                    : /META IF ' 2+ STR , 2- , ;THEN  DO: @R+ @R+ ! ; IMMEDIATE     : ALIST CREATE DUP C, FOR , NEXT ;  META COMPILE /META          : RECURSE CURRENT @ N>C , ;  IMMEDIATE                          : FINDER ALIST DOES> CSTR (find ;                                         AT COMP 1  FINDER COMPILE?                            AT MACROS AT ROOT 2  FINDER INTERPRET?                          TO ROOT : ] BLWORD COMPILE? IF EXEC RECURSE THEN INTERPRET?            IF , RECURSE THEN        NUM ['] LITERAL RECURSE ;         ' INTERPRET 4 + @  ' ] !   TO COMP  : [ RDROP ;               TO FORTH                                                        : RESTORE_IMM   /META [LIT] /META ;M    /META DO:  /META ;THEN   /META UNTIL  /META AGAIN /META NEXT  /META [']   /META OF       /META FOR  /META IF    /META AHEAD  /META +LOOP /META LOOP      /META ." /META "     /META A"     /META ?DO    /META DO          0 TO 'ERR ;   ' RESTORE_IMM TO 'ERR                           MARKER -MOD                                                     CODE 16/MOD  AX AX XOR,  AX BX XCHG,  AAH, AH BL XCHG,                    AX PUSH,  NEXT, END-CODE                                                                                              CODE MY/MOD  AX POP,  AX BX XCHG, AL 0 /// MOV, HERE 2-                      AX AX XOR,  AX BX XCHG,  AAH, HERE 1- SWAP!                     AH BL XCHG,  AX PUSH,  NEXT, END-CODE                                                                              : P1 ( NUM NSTART NUMEND)  1+ SWAP                                    DO  CR I .. DUP I MY/MOD  OVER .. DUP ..                               I * + ..  LOOP DROP ;                                                                                                                                                                                                                                                                                                                                                              : +.+ + PUSH + POP ;  : ++ TUCK +.+ ;  : C+ ROT +.+ ;           : -.- - PUSH - POP ;  : -- TUCK -.- ;  : C- ROT -.- ;           : /STR TUCK NEGATE +.+ ;                                                                                                        : COPY SWAP BLOCK SWAP BUFFER 1K CMOVE UPDATE ;                 | : COPY1 2DUP COPY ROT DUP PUSH ++ POP -ROT ;                  | : NCOPY SWAP PUSH -ROT POP FOR COPY1 NEXT 2DROP DROP FLUSH ;  : <COPY 1 NCOPY ;  : COPY> DUP PUSH ++ 1 -- POP -1 NCOPY ;                                                                      : (C, (B, DOES> C@ DUP C, 232 XOR  2 < IF HERE 2+ - THEN , ;                                                                     0 (B, ZC,    0 (W, Z,  | 232 (B, CAL#,  | 233 (B, JMP#,        : >MARK HERE Z, ; : ,MARK HERE SWAP! ;                          : CALL, CAL#, REL, ;    : >LOOP >MARK HERE ; : ,LOOP , ,MARK ;                                                                                                                                  FORTH MARKER -TARG              : (B, CREATE C, DOES> C@ C, ;   : (BC, (B, DOES> C@ C, C, ;     : (W, CREATE , DOES> @ , ;      | : (, HEADER EX W, PERFORM ;   | : (X (W, EX ' , ;             : (0 (X DOES> W, PERFORM ;      : (1 (X DOES> (, ;              : (2 (X , DOES> (, W, ;         : (3 (X , , DOES> (, W, W, ;    : (WC, (B, DOES> C@ DUP C, 232 XOR  2 < IF HERE 2+ - THEN , ;    0 (B, ZC,  0 (W, Z, : >MARK HERE Z, ; : ,MARK HERE SWAP! ;     : >LOOP >MARK HERE ; : ,LOOP , ,MARK ;      232 (WC, CALLI,     VOCABULARY COMP    VOCABULARY ROOT   : =? - A" PAIRS!" ;        : CSP! CSP SP@ TO CSP ; : ?CSP SP@ CSP =? TO CSP ;              \ 0 VALUE RAM  ' NOP TO 'SAME                                                                0 CONSTANT TSTART 0 CONSTANT TEND  | : /META IF ' 2+ STR , 2- , ;THEN  DO: @R+ @R+ ! ; IMMEDIATE   : IS ' 2+ ! ;  : META ' IS ;   META COMPILE /META \ META PRIMIT -->                                                                                                                             | : U. [AT] # 0 D. ;                      0 VALUE THERE         | : ##. EMIT C" # EMIT U. ; | : bl#. bl ##. ;                   : P#. CR BLK U. >IN 1L /MOD ." ROW " U. ." POS " U. BIOS-KEY ;  \ : ADDR. DUP ?ID. ['] : OVER = 0; DUP H. DUP BIOS-KEY ;        \ : TEST C" | EMIT SPACE  >IN . BLK . BIOS-KEY ; IMMEDIATE      \ : ;S EOS-ON ; IMMEDIATE  : TEST ; IMMEDIATE                   \ : LOAD ( n -) DUP C" < ##. DUP PUSH LOAD  BIOS-KEY            \      HERE bl#. S. POP bl#. ." LOADED #>" CR ;                 | : ;-NAME <N EX N> ;  : CODE, HEADER , ;                       : <% HERE THERE TO HERE TO THERE ; ' <% ALIAS %>                | : ;NS  CURRENT XCHG PUSH TO CURRENT EX POP TO CURRENT ;       : C: AT HIDDEN ;NS ['] CONSTANT ;-NAME EXEC ;  : L: HERE C: ;   PRUNE  HERE 16 ALIGN DUP  IS TSTART  DUP  TO THERE  TO HERE      12000 CLARY         HERE IS TEND    PAD  TO HERE \ SPACE       TO ROOT                           -->                                                                                            <% 14 17 THRU %>  TO FORTH  ROOT : TLITERAL COMPILE LIT , ;    ROOT ALSO  FORTH  156 LOAD  | : NOT_FOUND SNUMBER TLITERAL ;    ' SNUMBER TO NUM   ' LITERAL TO ?LITERAL   \ PRUNE              | : TARGET? TSTART TEND WITHIN 0= A" NOT TARGET!" ;             | : SEARCH @ SWAP  -1 -ROT (find  TO ?, ;                       | : AT_ROOT DUP TARGET? , ;                                     | : LOCATE BLWORD AT COMP SEARCH IF  2 ;THEN                                    AT ROOT SEARCH IF  1 ;THEN  0 ;                 | : LOCATE? C@ LOCATE 0= A" ?" + ;                              | 0 WARY COMMAND ] NOT_FOUND AT_ROOT EXEC [                     | : [#] ' EXEC COMPILE lit , ;  IMMEDIATE                       : ] BEGIN LOCATE COMMAND PERFORM AGAIN ;        -->             \ : +.+ + PUSH + POP ; : /STR TUCK NEGATE +.+ ; : ++ TUCK +.+ ; \ : THRU 1+ SWAP ?DO I LOAD LOOP ;   : +THRU BLK ++ THRU ;                                                                                                                                      TO FORTH                ' ; ALIAS '; IMMEDIATE                  ' : ALIAS ': IMMEDIATE | : ;M: HERE SWAP CALLI, ?CSP EX ] ;     | : [' (B, DOES> LOCATE?  , ; | : '' (B, DOES> LOCATE?  ;       | : ;CSP ?CSP EX RDROP ;                                        TO COMP ROOT  : >CODE ;CSP COMPILE 4TH> ASM ;                   : NM: NEGATE [#] >DOES + ;M: ;      : M: [#] >F: ;M: ;          : ;CODE ;CSP SMUDGE COMPILE ;4TH ASM ;  : [ RDROP ;             \ : DOES> [#] #code , [#] >DOES CALLI, ;                        ': ; ;CSP SMUDGE  COMPILE EXIT ';                               0 [' [',]      2 [' [TO]   4 [' [AT]    TO FORTH                ': : HEADER CSP! SMUDGE [#] >NEST , ] ';                        TO ROOT    ' FORTH ALIAS 'FORTH    ' F83 ALIAS 'F83             0 '' '      2 '' 'TO   4 '' 'AT                                 <% 18  26 THRU %>       TO COMP -->                                                                                                                                                             ' HERE ALIAS BEGIN                                              ' HERE   ' NOP   (( FOR/        '  ,     ' NOP   (( /NEXT       ' LOOP/  ' NOP   (( FOR         ' /LOOP  ' NOP   (( NEXT        ' >MARK  ' NOP   (( ?FOR        ' >MARK  ' NOP   (( (CALL       ' >MARK  ' NOP   (( -IF         ' >MARK  ' NOP   (( #IF                                                                         : ;THEN COMPILE EXIT [',] THEN  ' ,<MARK #JMP +COMP (( AGAIN    ' .MARK  #?FOR +COMP (( ?FOR    ' .MARK  #NEXT +COMP (( ?NEXT   ' <MARK ALIAS BEGIN IMMEDIATE   ' ,<MARK ##IF +COMP (( UNTIL    ' ,.MARK  ALIAS THEN IMMEDIATE  ' IF ALIAS WHILE IMMEDIATE      : REPEAT [',] AGAIN [',] THEN ; IMMEDIATE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ VOCABULARY TEMP                                                                 0 VALUE P1    0 VALUE P2 \ REORDER  OF VOCAB  : ?GET1 CONTEXT @ DUP TO P1 ?DUP IF  N>C 2- @ CONTEXT ! THEN ;  : PUT1  CURRENT @  P1 N>C 2- !  P1 CURRENT ! ;                  : ?INSERT  CURRENT @ TO P2 P2 P1 U< IF PUT1 ;THEN BEGIN P2 DUP    PUSH N>C 2- @ TO P2  P1 P2 U<  WHILE RDROP REPEAT P2  P1 N>C     2- !  P1 POP  N>C 2- ! ;  : ?SAME CONTEXT CURRENT XOR ;      : >LIST  ?SAME 0;  BEGIN ?GET1 P1 WHILE PUT1 REPEAT ;           : XLIST CONTEXT CURRENT TO CONTEXT TO CURRENT ;                 : ;XLIST ?SAME 0= IF RDROP ;THEN >LIST XLIST EX XLIST ;         : ;CURRENT CURRENT XCHG PUSH TO CURRENT EX  POP TO CURRENT ;    : <ORDER ;XLIST BEGIN ?GET1 P1 WHILE  ?INSERT  REPEAT ;         : MPUT? P1 C@ 128 AND IF AT MACROS ;CURRENT THEN PUT1 ;         : >IMMED ;XLIST BEGIN ?GET1 P1 WHILE MPUT? REPEAT ;                                                                                                                                             : EXECUTE PUSH ;                                                 : 1Z, 0 C, ;                                                    : N>LINK N>C 2- ;                                               : OFF 0 SWAP! ;                                                 : ON -1 SWAP! ;                                                 : ALIGN 1- SWAP 1- OR 1+ ;                                                                                                      ' IOV @ ' SCRH TO @ 1- SWAP 1- SWAP 3 MAKER QUAN ,              ' bl @ 1 MAKER CONSTANT ,                                       ' SCRH TO @ 2 MAKER VALUE ,                                     ' INITW TO @ 2 MAKER VECTOR ,                                                                                                    HERE VALUE THERE   ' H.  VECTOR  `.                             : T|H HERE THERE TO HERE TO THERE ;                                                                                                                                                            1024  CONSTANT 1K                                              32768  CONSTANT #SIGN                                            1028  CONSTANT B/BUF                                            16    CONSTANT 1H                                               31    CONSTANT #LEN                                             64    CONSTANT 1L                                                                                                                HERE TO THERE   15000 ALLOT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( FLOAD CONTROL.TX  1                                          : CSP! CSP SP TO CSP ;                                          : ?CSP SP CSP - A" SP CHG!" TO CSP ; )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           : NM: NEGATE HERE SWAP [TO] DOES> HERE 2- +! ] ;               (                                                                : M: HERE AT , [ ' WORD @ 1+ DUP @ + 2+ , ] [AT] DOES> ] ;      : JM: M: 5 HERE 2- +! ;                                         : LBL: HEADER COMPILE [ ' INTERPRET 2+ @ , ] ] ;               )                                                               : ( C" ) WORD DROP ; IMMEDIATE     ( nf '("' ; (" (". ". )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       : -HEAD AT HERE SPTR 8000 - AT VSWAP 2!  HEADERS ;              ' IOV @ 1 MAKER VARIABLE 2Z,                                    ' IOV @ 1 NM: AT 2+ ! ;M 2 NM: AT 2- @ ;M 3 MAKER STACK> ,      ' IOV @ 1 NM: AT 2- ! ;M 2 NM: AT 2+ @ ;M 3 MAKER <STACK ,      : 'STR, DUP C, STR, ;                                           ' (" 2+ 'C ."    ' (" 'C "   ' ABORT 2+ 'C A"                   : ," TO WORD ", ;                                                                                                               T|H                                                             : .( C" ) WORD ". ; IMMEDIATE                                   T|H                                                                                                                              : RESCAN       >IN -FIND ROT TO >IN  NIP 0;                          CR HERE ". ."   EXIST ! "  BLK 1- 0>= 0;                                                                                                                                                       ." IN BLK " BLK `. ;                                                                                                       ' RESCAN TO ?SAME                                                                                                               256 DUP <STACK ON; , ( "," FOR FAST COMPARING BELOW)                                                                            AT FORTH 2- DUP @ SWAP 2- DUP @ SWAP 2- @ 3 MAKER MAKEVOC 2Z,                                                                                                                                   : VOCABULARY TO FORTH MAKEVOC VOCLINK LINK+  ;                                                                                  MAKEVOC MACROS 2Z,                                              VOCABULARY HIDDEN                                               VOCABULARY ASSEMBLER                                                                                                            : .MARK >MARK   ;     ( FOR IFS , SKIPS, WHILES)                : >RESOLVE [',] THEN ;                                          : ,.MARK >RESOLVE ;                                             : >LOOP >MARK HERE ;                                            : ,>LOOP , >RESOLVE ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ' CSP! ALIAS CASE IMMEDIATE                                     ' .MARK       ' (BR (( SKIP                                     ' .MARK    ' (BR 2+ (( IF                                       ' .MARK       ' (FOR (( FOR      ( IN THIS VERSION!!!)          ' ,.MARK   ' (FOR 2+ (( NEXT     ( IN THIS VERSION!!)           ' ,.MARK  ALIAS THEN IMMEDIATE                                  ' <MARK ALIAS BEGIN IMMEDIATE                                   ' ,<MARK       ' (BR (( AGAIN                                   ' ,<MARK    ' (BR 2+ (( UNTIL                                   ' IF ALIAS WHILE IMMEDIATE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ' >LOOP        ' (DO (( DO                                      ' >LOOP     ' (DO 2+ (( ?DO                                     ' ,>LOOP       ' (LP (( LOOP                                    ' ,>LOOP    ' (LP 2+ (( +LOOP                                  : REPEAT  [',] AGAIN [',] THEN ; IMMEDIATE                       : ELSE [',] SKIP SWAP [',] THEN ; IMMEDIATE                     ' ELSE ALIAS ENDOF IMMEDIATE                                    : ENDCASE COMPILE DROP BEGIN SP CSP -                           WHILE [',] THEN REPEAT TO CSP ; IMMEDIATE                                                                                                                                                                                                                                                                                                                                                                                                                      \ ?EMIT ?TYPE DUMPLINE DUMP                                        : ?EMIT DUP bl < IF DROP C" . THEN EMIT ;                       : ?TYPE FOR COUNT ?EMIT NEXT DROP ;                          : >EMIT? 33 127 WITHIN ;                  -HEADERS              | : 'C CREATE [',] C" C, DOES> C@ EMIT ;                          'C `" "     'C `' '     'C `# #                                 'C `[ [     'C `] ]     'C `. .                               | : DUMPLINE CR DUP H. 1H  2DUP 2/ FOR WCOUNT SPACE FLIP H.              NEXT DROP SPACE `[ ?TYPE `] ;                            : DUMP 1H ALIGN 1H / FOR DUP DUMPLINE 1H + NEXT DROP ;         : TRACE CR ' TR EXEC -TR ; IMMEDIATE                           : #NUM `# 0 .R SPACE ;    : 'CHAR' `' EMIT `' SPACE ;           : "STR"  `" COUNT ?TYPE `" SPACE ;                              : ?STACK POP WCOUNT SWAP PUSH SP PUSH ?EXEC  POP SP - #NUM ;    : UNNEST POP RDROP RDROP RDROP PUSH ;                                                                                                                                                                                                                            : PREVIOUS AT ORDER# TO CONTEXT ;                               : ALSO CONTEXT TO ORDER# ;                                      : DEFINITIONS CONTEXT TO CURRENT ;                              : ONLY ORDER# OFF TO FORTH ALSO MACROS ALSO HIDDEN ALSO ;       : SPACES 0MAX FOR SPACE NEXT ;                                   : HOME 0 0 GOTOXY ;                                             : PAGE (CLSC HOME ;                                             : .LINE ( 3 .R) `. SPACE 1L ?TYPE ;                             : .BLOCK CR SCR `. 16 0 DO DUP I CR .LINE 1L + LOOP DROP ;                                                                      ONLY                                                                                                                                                                                                                                                            0 VALUE FENCE                                                   : forget DUP FENCE  U< A" fence !" PUSH (  - R@ )  BEGIN VOCLINK                                                       (      - )            @ ?DUP R@ U<        (  -     ?)        ~WHILE @ VOCLINK !                                              REPEAT   (    -      )    VOCLINK  (      - )     BEGIN DUP 2- (         )     BEGIN @ DUP                                                      (     -   )           -->                                                                                                                                                                                                                                                                                                                                                                                               R@ U<           ( -  -     ?)         ~WHILE N>C 2-     ( -    -   )       REPEAT            ( -    -v )                  OVER 2- !         (    )                    @ ?DUP            (      ?)             ~UNTIL FORTH        ( FORTH -> CONTEXT)                         TO FORTH POP        ( FORTH -> CURRENT)                         TO HERE             ( R> -> HERE )                              DROP ;              ( VOCLINK @ )                               : FORGET ' C>N DROP forget ;                                                                                                    HERE TO FENCE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  : PRUNE VOCLINK                                                  BEGIN DUP PUSH  (                   )               V>LINK   (              )          BEGIN @ DUP   (              )            HERE U<     (    >= HERE                 )        ~WHILE N>LINK REPEAT  (             )        DUP R@ V>LINK !                                                       (        < HERE)              (                 )        ?DUP IF DUP PUSH      (     -  )        BEGIN N>LINK          (                    )                                                                             -->                                                                                                                                                                                        @ ?DUP                (                           )        WHILE DUP HERE U<     (      < HERE)        IF DUP POP            (            )          N>LINK                (        )           ! DUP PUSH            (                              )          THEN                  (                             )           REPEAT                (                              )          0 POP N>LINK !        (     )          THEN                                                            POP @ ?DUP ~UNTIL     (  )                         -HEAD                                                           ;                                                                                                                                                                                                                                                             : ;SWAP! SWAP OVER @ CO SWAP! ;                                 : +!       ;SWAP! + ;                                           : XOR!     ;SWAP! XOR ;                                         : OR!      ;SWAP! OR ;                                          : AND!     ;SWAP! AND ;                                         : @!  SWAP ;SWAP! -ROT ;                                        : EXCHANGE ;SWAP! @! ;                                                                                                          \ : EXCHANGE  OVER @ @! @! DROP ;                                                                                                                                                                                                                               -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ MACRO ENGINE                                                                                                                   M: DUP BEGIN COUNT  0= UNTIL 1- OVER - ;M                       ( 4 TO HEADER)                                                  0 VALUE MH   : SWAPH HERE MH TO HERE TO MH ;                    M: TO MH AT MACROS ! ;M                                                                                                         M: AT MACROS @ MH ;M   HEADER MAC , , ,  C" ; STACK> MAC:       : MAC> CREATE AT MAC: @ WORD COUNT STR, 1Z, IMMEDIATE                  DOES>  EVAL ;                                           : >MAC SWAPH CURRENT PUSH TO MACROS EXEC POP TO CURRENT SWAPH ;  M: ['] MAC> >MAC ;M    ' MAC: !    : ?MAC ' 2+ AT MAC TYPE ;   M: AT MAC: @ [',] C" AT MAC: ! MAC: AT MAC: ! ;M   ' MAC: 2+ !   : -MAC  0 MPTR TO MAC ;     -MAC                                : MLOAD ['] LOAD CONTEXT PUSH MACROS >MAC POP TO CONTEXT ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \ STREEM EVALUATION  - SEVAL   USING EXPECT3                  \\: ;GETBUF ( N -- A )  POP   RP ROT - RP OVER                       TO RP  PUSH SWAP PUSH   CO POP TO RP ;                       VARIABLE LINES  CREATE OK ," ><o  bl C, 15 ALLOT  1 OK +!        -HEADERS    0 VALUE ?HAND  : ?SEOF ?HAND HANDLES = ;           : HAND! HANDLES TO ?HAND  TO HANDLES  0 LINES !  ;              : OK? CR BLK IF CO EXIT THEN OK ". CO SPACE ;                   : 1LINE 1 LINES +! OK?  0 TO >IN  TIB 80 EXPECT  CO                   0  TIB SPAN + C! TO INTERPRET ;                           : ?IO BLK NOT IF SIO EXIT THEN FIO ;                            : FOPEN HANDLES bs - 0= ?? FOPEN DUP 0< A" OPEN ERR" ;          | : SEVAL ( HANDLE NBLK ) ;TI  TO BLK  ?IO                        90 ;GETBUF TO TIB  HAND!  BEGIN  1LINE  ?SEOF UNTIL  ;        : ;S HANDLES 0; AT HANDLES BLK 1+ 0= IF CLOSE THEN DROP ;       : FLOAD FOPEN  -1 SEVAL ?IO ;  : KBD  0 0 SEVAL ?IO ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \ 63 64 THRU  \ CONTROL                                         \ 49 LOAD \ FUNC: RETURN LOCALS                                 \ 77 LOAD \ STREEM EVALUATION                                    104 LOAD \ MARKER                                               103 LOAD \ S. R.                                                 31 LOAD \ $ # % <# #>                                          116 LOAD \ SEE                                                 87 101 THRU \ ASSEMBLER                                         \ FLOAD DEBUG.F  CR BLK . .( BLOCK NUMBER)                      \ VOCABULARY ROOT  VOCABULARY CONTROL MARKER -ROOT              \  PRUNE   F83   35 LOAD 116 LOAD                               \ 111 LOAD  \ TARGET COMPILATION                                                                                                                                                                                                                                                                                                  55    LOAD     \ ALIASES                                                                                                        44    LOAD \ STRINGS                                            47    LOAD \ DOS COMMANDS, SHELL                                75 76 THRU \ MACRO ENGINE  + MACROSES                           25 30 THRU                                                      65 LOAD                                                                                                                       \ 83 84 THRU \ RECURCE CO   \ ; :                                 86    LOAD \ .(                                               \ 79    LOAD                                                      2 ATTR C!                                                      \ 67 LOAD \ FORGET      \ 70 LOAD \ PRUNE                       \ 69 LOAD \ WORDS       \ 81 LOAD \ NUMBERS                                                                                                                                                    (   PAD SPACES <# #> # #S SIGN D# D.R D. .R . U.   )             : UM/MOD TUCK U/MOD PUSH  SWAP TO U/MOD POP ;                   : S# 0 BEGIN 1+ PUSH BASE UM/MOD 2DUP OR POP SWAP                               0= UNTIL -ROT 2DROP ;                           : D# IF DABS S# 1+ PUSH -10 POP EXIT THEN S# ;                  : D.R PUSH D# POP OVER - SPACES  FOR ALPHA EMIT NEXT ;          : D. S>D 0 D.R SPACE ;                                          : . S>D D. ;                                                    : U. 0 D. ;                                                     : .R PUSH S>D S>D POP D.R ;                                     : U.R  0 0 ROT D.R ;                                            : UD. 0 0 D.R SPACE ;                                           : UD.R 0 SWAP D.R ;                                            : .. BASE PUSH 6 .R SPACE POP TO BASE ;                                                                                                                                                         \ LOAD EVAL THRU +THRU LIST ?LD --> COPY                                                                                        \ 0 NM: BLK PUSH >IN PUSH EXECUTE POP TO >IN POP TO BLK ;M      \  DUP                                                          \ HEADER LOAD , ] 0 TO >IN  TO BLK ?LD TO INTERPRET [           \ HEADER EVAL , ] 0 TO BLK TIB - TO >IN  TO INTERPRET [           : THRU 1+ SWAP DO I LOAD LOOP ;                                 : +THRU BLK DUP D+ THRU ;                                       : LIST DUP TO SCR BLOCK .BLOCK ;                                : ?LD BLK 0= A" LOADING?" ;                                     : --> ?LD 0 TO >IN BLK 1+ TO BLK ; IMMEDIATE                  : COPY BLOCK SCR BLOCK 1K CMOVE UPDATE ;                        : NCOPY FOR DUP COPY 1+ SCR 1+ TO SCR NEXT DROP ;               : <NCOPY FOR 1- DUP SCR 1- TO SCR COPY NEXT DROP ;                                                                                                                                              \ RECURCE CO                                                     ( WITH-ADDR ROOTLINK_ADR WITH-ADDR - )                          M: ( FIXLINX) BEGIN OVER @XCHG ?DUP 0= UNTIL DROP ;M TO ON;     0 NM: AT CURRENT N>C OVER ( FIXLINX) [ >MARK TO ON; ] OFF ;M    1 NM: LINK+ ;M                                                  2 MAKER RECUR ,                                                 ( TO FORTH ( AT RECURCE - FIXLINX)                              0 RECUR RECURCE HERE ON; ! ON; , IMMEDIATE                      M: ON; PUSH ;M ( THIS IS "AT CO")                               M: POP TO ON; AT , [ >MARK TO ON; ] TO ON; ;M                   ' RP 4 + @ ( v-- --v "DO" ">RELEASE" TRICKY WAY)                ( TO HIDDEN)                                                    HEADER CO , , ,  HERE 2- ON; !                                  ( TO FORTH)                                                                                                                                                                                    \ ;  :                                                           ' :  ( !!! VERY SPECIAL )                                      : : MAC  0 TO ON; CS! CSP! : TO CO                                       ?CS TO MAC [TO] RECURCE ;                                                                                               ( EXEC = LAST : )                                              EXEC ; ?CSP [',] ; BEGIN ON; ?DUP                                           WHILE EXEC REPEAT ; IMMEDIATE                                                                                                                                                       : .( C" ) WORD ". ; IMMEDIATE                                                                                                                                                                                                                                                                                                                                                                    : WORDS CR 10 TO CSP CONTEXT -1 0 DO @ ?DUP                      IF DUP                                                             C@ #LEN AND 6 + OUTC + 80 <                                     ~IF CR CSP ?DUP                                                     IF 1- TO CSP                                                    ELSE 10 TO CSP KEY B>W 27 =                                         IF DROP I " LISTED" LEAVE THEN                              THEN                                                        THEN DUP H. DUP ID.                                             1H OUTC OVER MOD ?DUP                                           ~IF DUP THEN - DUP 13 < ~IF DROP 1 THEN                         OUTC 64 < ~IF 1- THEN SPACES                                    N>C 2-                                                       ELSE CR I " TOTAL" LEAVE THEN                                   LOOP ". ."  WORDS = " `. ;                                      F83                                                           ( assembler  -  control words   )                               F83 ONLY ASSEMBLER  ALSO DEFINITIONS \ VOCABULARY  ASSEMBLER    HEX 0 VALUE DISP 0 QUAN FLAGS   ( xxxxxxccOMIAGSDW )            | : SHORT? ( n - f)  -80 80 WITHIN ;   : DB, C, ; : DW, , ;     : BEGIN, ( - a) HERE ;   | : ?A DUP SHORT? 0= A" SH-ADR?" ;     : IF,    ( OPC - A) , HERE ;     : NOT, 1 XOR ;                 : WHILE, ( A OPC -) IF, SWAP ; | : -?A - ?A EX 1- C! ;          : THEN,  ( A -) HERE OVER -?A SWAP ;                            : UNTIL, ( a opc) IF, -?A HERE ;                                : ELSE, EB WHILE, THEN, ;                                           1L | WARY BRANCHES                                          : FBI 0 1L FOR R@ BRANCHES 0 @SWAP IF R@ .. 7 EMIT 1+ THEN                 NEXT  ?DUP IF DUP CR .. A" UNRESOLVED !" THEN ;      : ASM-RESET 2 TO FLAGS  0 TO DISP ;                                                                                                                                                             0 VALUE ?NEXT  ( STEP FROM TIMES ! WHAT )                       | : FAMILY ' TO ?NEXT FOR DUP ?NEXT EXEC OVER + NEXT 2DROP ;    | : NFAMILY ' TO ?NEXT FOR [',] $ ?NEXT EXEC NEXT ;             | : ^BRANCH [',] # DUP 1L U< 0= A"  BR#? "  BRANCHES ;          | : FB, ^BRANCH DUP 0 @SWAP A" REDEF! " HERE 2+ SWAP! , ;       | : ^< ^BRANCH 0 @SWAP ;        : L,? HERE 2+ FB, ;             : JMP,? E9 C, L,? ;     : CALL,? E8 C, L,? ;                    : FB: ^< THEN, ;  ( RESOLVE FORWARD BRANCH NUMBER)              | : FL?      ( A - A) 2- @ OVER - A" LBL? " ;                   | : WREL-FIX?  ( A -)  HERE OVER  3 - C@ FE AND E8 =                        IF  OVER - THEN SWAP 2- ! ;                         : FL: ^< DUP  FL?  WREL-FIX? ;  : J, NOT, FB, ;  ( OPC JMP_FWD) : END-CODE PREVIOUS FBI ?CSP ;                                  | : 'ASM ASM-RESET ALSO ASSEMBLER CSP! ;                            ' 'ASM TO ASM                                                                                                               HEX  ( relative jumps   )                                       | : opc ( opcode -) ( - opcode) CREATE C, DOES> C@ ;            | : ?OPC ( opcode -) ( - opcode) CREATE C, DOES> C@ UNTIL, ;    # 11 NFAMILY opc  E1 EQ, 73 CS,  75 0=,  79 0<,  73 U<,                 E3 CXNZ,  7D <,   7E >,   76 U>,  71 OV,  EA ?,         ( ?, J, 5  ===   JMP SHORT @@5 |  @@5:  ===  FB! 5 )            ( the rest can be made by following above with NOT, )           EB ?OPC SJMP,                                                   -1 E3 4 FAMILY ?OPC  JCXZ, LOOP,  LOOPZ, LOOPNZ,                 1 70 8 FAMILY ?OPC  JO, JNO,  JB, JNB,  JE, JNE, JBE, JNBE,    \ 1 72 6 FAMILY ?OPC            JC, JNC,  JZ, JNZ, JNA, JA,      1 78 8 FAMILY ?OPC  JS, JNS,  JP, JNP,  JL, JNL, JLE, JNLE,    \ 1 7A 6 FAMILY ?OPC          JPE, JPO, JNGE, JGE, JNG, JG,                                                                                                                                                                                                     HEX  ( bit-flags and reg seg & r/m defining words )             ( VARIABLE DISP   VARIABLE FLAGS  ( xxxxxxccOMIAGSDW )          ( M=r/m; cc=reg count; I=immediate; A=accumulator; G=seg;)      ( S=imm.size; D=direction;  W=word or byte; O=disp only  )      | : F-SET ( mask -) FLAGS OR TO FLAGS ;                         | : F-GET ( mask -) FLAGS AND ;                                 | : F-CLR ( mask -) COM F-GET TO FLAGS ;                        | : F-FLIP ( mask - ) FLAGS XOR TO FLAGS ;                      | : <reg> ( a -n) DUP 1+ C@ DUP 1 AND 1 XOR 2* 2* OR F-SET C@ ; | : reg ( 000a000w00rrr000 -) ( - 0000000000rrr000)  CREATE ,         DOES> <reg> 100 AT FLAGS +! ( count regs)  2 F-FLIP  ;    | : seg ( n -) ( -n) CREATE ,  DOES> <reg> 2 F-SET ;            | : r/m ( n -) ( disp - n) CREATE ,                                   DOES> <reg>  2 F-CLR ( D) SWAP TO DISP ;                                                                                                                                                  ( default D is on, r/m clears it, reg flips it, seg sets it)    ( D=0 when r/m field is destination )                           ( bits 3-5=reg, bit 8=W, bit 9=D flg, bit 12=ACC flg )          HEX ( R/M & REG are 16bit constants, but reg keeps count )      1 4000 8 FAMILY r/m  X/S X/D P/S P/D /SI /DI /BP /BX              C006 r/m /// ( chg this?)                                     CREATE 'REGS                               1000 reg AL            8 8 7 FAMILY reg  CL DL BL AH CH DH BH   1100 reg AX          8 108 7 FAMILY reg  CX DX BX SP BP SI DI                        8 900 4 FAMILY seg  ES CS SS DS                                 | 0 BARY F$  4457 , 4753 , 4941 , 4F4D ,                        : .F ( -) 8 FOR 20 R@ 2^ F-GET IF DROP R@ F$ C@ THEN               EMIT NEXT FLAGS 100 / 3 U.R ."  regs " ;                                                                                                                                                                                                                     HEX ( REG>R/M  #,  orW  11mod  01mod  10mod  ,DISP BYTE )       | : R>M ( reg -r/m) 2/ 2/ 2/ ;   | : 1REG? 100 F-GET ;          | : 16/ R>M 2/ ;  : B#,  24 F-SET ; : W#, B#, 4 F-CLR ;           : #, ( n1 - n1) 20 OVER SHORT? 04 AND OR F-SET  ;             | : orW ( --opc---   -  --opc--w)  1 F-GET  OR ;                | : orDW ( --opc---  -  --opc-dw)  3 F-GET  OR ;                | : modDISP, ( 2nd - ) 40 F-GET ( ie M)                           IF 80 F-GET ( ie Only) IF C, DISP ,                               ELSE 8 F-GET ( ie G) DISP OR  OVER 7 AND 6 = OR ( ie[BP])       IF DISP SWAP OVER SHORT?                                          IF 40 OR C, C, ELSE 80 OR C,  , THEN                          ELSE ( zero & not seg) C, THEN  THEN ELSE C0 OR C,  THEN ;                                                                  \   DECIMAL  84 LOAD                                            | : NAME? ; IMMEDIATE                                                                                                           HEX     ( one byte opcodes with no variables )                  | : IMM? ( -f) 20 F-GET  ;  | : ACC? ( -f) 10 F-GET ;           | : ,IMM  ( n -) 5 F-GET 4 = IF ( S,-W)  C, ELSE  , THEN ;        : W/ ( -)  1 F-SET  ; ( WORD PTR - the default is byte )      | : 2REGS? ( -f) 308 F-GET DUP 200 = SWAP 108 = OR ;            | : M1 ( n -) ( -)  CREATE C, DOES> NAME? C@ C, ASM-RESET ;     5 NFAMILY M1  D7 XLAT,  CF IRET,  C3 RET,  CB RETF,  90 NOP,    2 NFAMILY M1  53 DUP,  5B DROP,                                 1 A4 4 FAMILY M1  MOVSB, MOVSW, CMPSB, CMPSW,                   1 AA 6 FAMILY M1  STOSB, STOSW, LODSB, LODSW, SCASB, SCASW,     1 98 8 FAMILY M1  CBW, CWD, _ WAIT, PUSHF, POPF, SAHF, LAHF,    1 F8 6 FAMILY M1  CLC, STC, CLI, STI, CLD, STD,                 1 F0 6 FAMILY M1  LOCK: _ REP: REPZ: HALT: CMC,                 8 26 4 FAMILY M1  ES: CS: SS: DS:                               \ 8  6 4 FAMILY M1  ES> CS> SS> DS>                             \ 8  7 4 FAMILY M1  ES< PROT: SS< DS<                           ( 2 operand instructions such as ADD,  )                        HEX     | : M2 ( n -) ( various - ) CREATE C,                     DOES> NAME? C@ PUSH  IMM?                                        IF ACC? IF     DROP  POP orW 4 OR C,                                    ELSE   1REG? IF R>M THEN  80 orW C,                                    POP 38 AND OR  modDISP,                                  THEN  ,IMM                                              ELSE  2REGS?  IF SWAP R>M THEN                                        POP orDW C, OR modDISP,    THEN  ASM-RESET  ;           8 0 8 FAMILY M2  ADD, OR, ADC, SBB, AND, SUB, XOR, CMP,                                                                        HEX  | : M3 ( n -) ( reg -) CREATE C, DOES> NAME? C@                   orW C, DROP ASM-RESET   ;                                7 NFAMILY M3  A6 CMPS,  AC LODS,  A4 MOVS,                                    AE SCAS,  AA STOS,  6C INS,  6E OUTS,                                                                             HEX ( MOV,) ( one byte instr w/ W  - the string instructions )  : MOV, NAME? IMM?                                                 IF  1REG?  IF   R>M B0 OR 1 F-GET  2* 2* 2* OR C,                          ELSE C6 orW C, modDISP,    THEN  ,IMM                ELSE 90 F-GET 90 =                                              IF   DROP DROP A0 2 F-FLIP orDW C, DISP ,                       ELSE  2REGS? IF   2 F-GET ( ie D) IF SWAP THEN  R>M  THEN        8 F-GET ( ie G) IF 1 F-CLR 8C ELSE 88 THEN  orDW C,             OR  modDISP,  THEN THEN  ASM-RESET ;                         ( M6 for the rotate & shift instructions )                      HEX  | : M6 ( n -) ( n# r/m | r/m    - ) CREATE C,               DOES> NAME? C@ IMM? 16/  2 XOR  1 F-GET ( ie W) OR D0 OR C,        1REG? IF SWAP R>M THEN OR modDISP,  IMM? IF DROP THEN                 ASM-RESET  ;     38 M6 SAR,                           8 0 6  FAMILY M6  ROL, ROR, RCL, RCR, SHL, SHR,                                                                                 ( mul, div, xxxxxxxW  mdNNNr/m ) ( M5 for LDS, LEA, & LES, )    HEX  | : M4 ( n -) ( -) CREATE C,                                DOES> NAME? C@ F6 orW C, SWAP 1REG? IF R>M THEN OR  modDISP,         ASM-RESET  ;                                              -8 38 6 FAMILY M4  IDIV, DIV, IMUL, MUL, NEG, INVERT,           | : M5 CREATE C, DOES> NAME? C@ C, OR modDISP, ASM-RESET  ;     3 NFAMILY M5    C5 LDS,  8D LEA,  C4 LES,                                                                                       : SKIPB, 0 SWAP B#, MOV, 0 C, RECOVER ;                         : SKIPW, 0 SWAP W#, MOV, RECOVER ;                              : SKIPCB, 0 #, AL ' EXEC 0 C, RECOVER ;                         : SKIPCW, 0 #, AX ' EXEC RECOVER ;                                                                                                                                                                                                                                                                                              | : M11 CREATE C, DOES> NAME? C@ C, C, ;                        | : M12 CREATE C, DOES> NAME? C@ C, , ;                         \ 1 B0 8 FAMILY M11  AL!, BL!, CL!, DL!, AH!, BH!, CH!, DH!,    \ 1 B8 8 FAMILY M12  AX!, BX!, CX!, DX!, SP!, BP!, SI!, DI!,    \ 1 A0 4 FAMILY M12  (AL@, (AX@, (AL!, (AX!,                    \ 1 A8 2 FAMILY M12  (AL?, (AX?,                                $ CD M11 INT,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   HEX ( INC, & DEC, instructions )   ( IN, OUT, instr )           | : M7 ( n -) ( r1 | r/m  -) CREATE C,                             DOES> NAME? C@ SWAP  1REG? IF  ( opc r1) R>M THEN               1REG? 100 =  1 F-GET AND  ( ie it's a 2-byte register)          IF  ( opc rX)  OR 40 OR C,  ( opc mem | opc rH | opc rL )       ELSE FE orW C,  OR modDISP, THEN  ASM-RESET  ;               08 M7 DEC,   00 M7 INC,                                         | : M9 ( n# r1 | r1) CREATE C,  DOES> NAME? C@  orW NIP              IMM? IF ( n# opc)  C, ( n#) ELSE ( opc) 8 OR THEN C,            ASM-RESET ;  E4 M9 IN,   E6 M9 OUT,                                                                                                                                                                                                                                                                                                                                                                                                                        ( PUSH, & POP, instructions ) HEX                               | : M8 ( n -) ( reg | seg | r/m  -)  CREATE ,                      DOES> NAME? @  8 F-GET                                            IF  ( seg opc ) 16/ 1 AND 1 XOR 6 OR OR C,                      ELSE 1REG?                                                      IF  ( reg opc ) 2/ 8 AND 8 XOR 50 OR SWAP R>M OR C,             ELSE ( r/m opc) DUP 100 U/ FF AND C,  OR modDISP,               THEN  THEN  ASM-RESET ;                                    FF30 M8 PUSH,  8F00 M8 POP,                                     ( use   port #, AL IN,  or  port #, AX IN,  for 8 bit ports )   ( or    AL IN,  or  AX IN,   for port in the DX register  )     | : M10 CREATE , DOES> NAME? @ , ;                              8 NFAMILY M10   21CD DOS,  16CD KBD,  10CD VIDEO,  0AD4 AAM,                0AD5 AAD,  13CD DISK,   E587 X,  10D4 AAH,                                                                                                                                          HEX ( XCHG )  ( TEST, instruction  - almost like ADD, etc. )    : TEST,  ( various - ) NAME? IMM?                                  IF ACC? IF     DROP  A8 orW ( 4 OR) C,                                  ELSE   1REG? IF R>M THEN  F6 orW C, ( OR)  modDISP,             THEN  ,IMM                                              ELSE  2REGS?  IF SWAP R>M THEN                                        84 orW C, OR modDISP,                                     THEN  ASM-RESET  ;                                           : XCHG,  ( reg mem | mem reg | reg1 reg2   -)   NAME?             211 F-GET 211 = ( 2 regs & one is AX)                           IF  ?DUP IF NIP THEN ( r1 ) R>M  90 OR C,                       ELSE  2REGS? IF  R>M  THEN  OR  86 orW C, modDISP,              THEN  ASM-RESET ;                                             | : M13 CREATE C, DOES> NAME? C@ C, HERE 2+ - , ;               E8  M13  CALLI,    E9 M13 JMPI,      ( lay down 3byte jump)                                                                     HEX ( CALL, instr  ) ( INT,  & segment override instructions )  : CALL, ( various -) NAME?  IMM?   ( intra-seg direct )           IF  ( n#)  HERE 3 + - ( make it relative)                           E8 C, , ( eg 2389 #, CALL, calls addr $2389)                ELSE ( mem | reg  -)  1REG?  IF R>M  THEN                           FF C,  10 OR modDISP, ( eg 0 [BX] CALL, or DX CALL, )       THEN  ASM-RESET ;         ( this is intra-seg indirect )                                                                      \ 1 40 8 FAMILY M1  AX+, BX+, CX+, DX+, SP+, BP+, SI+, DI+,     \ 1 48 8 FAMILY M1  AX-, BX-, CX-, DX-, SP-, BP-, SI-, DI-,     \ 1 50 8 FAMILY M1  AX>, BX>, CX>, DX>, SP>, BP>, SI>, DI>,     \ 1 58 8 FAMILY M1  AX<, BX<, CX<, DX<, SP<, BP<, SI<, DI<,     \ 1 90 8 FAMILY M1  NOP, BX^, CX^, DX^, SP^, BP^, SI^, DI^,     \ 8 4 8 FAMILY M11  B#+, B#|, B#C+, B#C-, B#&, B#-, B#~, B#=,   \ 8 5 8 FAMILY M12  W#+, W#|, W#C+, W#C-, W#&, W#-, W#~, W#=,                                                                   ( JMP, instr  &  NXT, )    HEX                                  : JMP, NAME?                                                           ( various -) 140 F-GET ( ie R or M  intra-seg indirect )    IF ( mem | reg  -)  1REG?  IF R>M  THEN                            FF C,  20 OR modDISP, ( eg 0 [BX] JMP, DX JMP, )                                      ( or 3759 rt-paren JMP,  )             ELSE  ( a) HERE 3 + -                                            ( relative) DUP SHORT? IF 1+ EB C, C, ELSE  E9 C,  ,  THEN      ( disp is added to IP, so this is a relative jump )          THEN  ASM-RESET ;   : AGAIN, JMP, ;                             ' NOP @   TO ?NEXT                                             ( I am not implementing the inter-seg direct or indir. versions): NEXT, ( -) ?NEXT JMP, ;                                       PREVIOUS                                                        FORTH                     F83 ( 96 LOAD)                                                                                        ASM  L: >BOOT CLD, 0 #, JMP,    L: >COLD CLD, 0 #, JMP,         L,? 3   L,? 2   LODSW, L: >EX AX DI XCHG, 0 /DI JMP,            L: >TRON  $ 2EB #, AX MOV, ?, NOT, IF,    L:  F> SI JMP,        L: >TROFF >EX 1- AX MOV, THEN,   DI SKIPW, L,? 1 STOSW, RET,    L: :F> SI PUSH,  X, SI POP, X, RET,   L: >TRF: >TROFF CALLI,    L: >F: X, SI PUSH, X,           L: >F  SI POP, ?, NOT, IF,      L: >SWAP! DI POP, CX SKIPW, SCASW,                              L: >VAR! SCASW, BX 0 /DI MOV,                                   L: >DROP DROP, ?, NOT, IF, SCASW, SCASW,  FL: 3                 L: >CONST 2 /DI AX MOV, ?, NOT, IF,  SCASW, SCASW,              L: >VAR   2 /DI AX LEA,  THEN,    L: >PUSH  DUP,                L: >SWAP AX BX XCHG, THEN, THEN, FL: 1  HERE TO ?NEXT ( !!!)    L: >MAIN LODSW, AX DI XCHG, 0 /DI JMP,                          >TRF: CALLI, FL: 2 Z,    :F> , >TRON CALLI, >EX 1- JMP,                                                                                                                                         L: >RP@ BP AX MOV, >PUSH JMP,   L: >RP! BX BP MOV, >DROP JMP,   L: >SP@ DUP, SP BX MOV, NEXT,   L: >SP! BX SP MOV, >DROP JMP,   L: >PERF 0 /BX BX MOV,          L: >EXEC   AX POP, AX BX XCHG,  L: >?EX AX CX MOV, >MAIN JCXZ, >EX JMP,   SCASW, SCASW,         L: >DEFER SCASW, 0 /DI AX MOV, >?EX JMP,  L: >ALIAS >DEFER JMP,            SCASW, SCASW,        L: >NEST   2 /DI AX LEA,        L: >?NEST  SI AX XCHG,                                          L: >ARPH -2 /BP BP LEA, AX 0 /BP MOV, NEXT,                     L: >;: SI 0 /BP XCHG, NEXT, SCASW, SCASW,                       L: >DOES AX POP, DUP,  2 /DI BX LEA, >?NEST JMP,                L: >XCHG BX 0 /BP XCHG, NEXT,  \ XCHG                           L: >CONT -2 /SI AX LEA, >ARPH JMP,                              L: >#PUSH  AX POP, BX AX XCHG, >ARPH JMP,                       L: >CALL LODSW, >?NEST JMP,                                                                                                                                                                         1 #, BX SHL,  BX DI ADD,  1 #, BX SHL,                      L: >ARY 1 #, BX SHL, 2 X/D BX LEA, NEXT,                        L: >BLIT LODSB,        L: >BPUSH   0 #, AH MOV, >PUSH JMP,      L: >MLIT LODSB,        L: >MPUSH  -1 #, AH MOV, >PUSH JMP,      L: >DLIT DUP, LODSW, AX BX XCHG,                                L: >LIT   LODSW, >PUSH JMP,                                     L: >!+  0 /BX POP,     L: >2+ BX INC,    L: >1+ BX INC, NEXT,   L: >-! -2 /BX POP,     L: >2- BX DEC,    L: >1- BX DEC, NEXT,   L: >@PC+ AX AX XOR, CX POP, DUP, SI 0 /BP XCHG, SI BX MOV,          CX CALL, AX SI ADD, >;: JMP,                                L: >@PC' >@PC+ CALLI, AL LODS, RET,                                END-CODE                                                                                                                     \  >F: IS #4th:   >F IS #4th   >VAR IS #var  >CONST IS #const   \ >NEST IS #nest   >CALL  IS #call  >DOES IS #does                                                                              CODE C!+ CX POP, CL 0 /BX MOV, >1+ JMP,  END-CODE               CODE C@+  0 CH MOV, 0 /BX CL MOV, CX PUSH, >1+ JMP, END-CODE    CODE @+  0 /BX PUSH, >2+ JMP, END-CODE                          CODE -C! CX POP, CL -1 /BX MOV, >1- JMP,  END-CODE              CODE -@ -2 /BX PUSH, >2- JMP,  END-CODE                         CODE -C@ 0 CH MOV,  -1 /BX CL MOV, CX PUSH, >1- JMP, END-CODE   CODE 2*  1 #, BX SHL, NEXT, END-CODE                            CODE 2/  1 #, BX SAR, NEXT, END-CODE                            CODE ROT   CX POP,  AX POP, CX PUSH, DUP,  >SWAP JMP,  END-CODE CODE -ROT  AX POP,  CX POP, DUP, CX PUSH,  >SWAP JMP,  END-CODE CODE AND   AX POP,  AX  BX AND,  NEXT,  END-CODE                CODE OR    AX POP,  AX  BX OR,   NEXT,  END-CODE                CODE XOR   AX POP,  AX  BX XOR,  NEXT,  END-CODE                CODE - BX NEG, L: >PLUS AX POP,  AX  BX ADD,  NEXT,  END-CODE                                                                                                                                   CODE +.2/  AX POP, AX BX ADD, DUP, 1 #, BX RCR, NEXT,           L: >IF  BX BX OR,               L: >0=IF 0=, IF,                L: >JMP 0 /SI SI MOV, NEXT,     L: >UNNEST  0 /BP SI MOV,       L: >RDROP  2 /BP BP LEA, NEXT, THEN,                            L: >SKIP 2 /SI SI LEA, NEXT,                                    L: >#IF  AX POP, AX BX XCHG, AX AX OR,  >0=IF JMP,              L: >-IF  BX BX OR,  >JMP JNL,  >SKIP SJMP,                      L: >NEXT -1 #, CX MOV,  CX 0 /BP ADD,  >JMP JB,                              2 /SI SI LEA, >RDROP SJMP,                         L: >OF    AX POP,  AX BX XCHG,  AX BX CMP, >JMP JNE,                      DROP, >SKIP JMP,                                      L: >?FOR  AX POP,  AX BX XCHG,  AX DEC, >JMP JL,                         2 /SI SI LEA,  >ARPH JMP,                                 204 LOAD     END-CODE   \ FIND  STR=  ...                                                                                                                                                    CODE INVERT BX INVERT, NEXT,    L:  >PUSHES CX POP, BX SI XCHG,      CX CALL,  BX SI XCHG,  >PUSH JMP, END-CODE                 CODE NIP    AX POP, NEXT,  END-CODE                             CODE SWAP  AX POP, >PUSH JMP, END-CODE                          CODE STR   >PUSHES CALLI,  LODSW, RET, END-CODE                 CODE CSTR  >PUSHES CALLI,  LODSB, 0 #, AH MOV, RET, END-CODE    CODE BSTR  >PUSHES CALLI,  LODSB, CBW, RET, END-CODE            CODE DSTR  >PUSHES CALLI,  CX POP, DUP, LODSW, AX BX XCHG,            LODSW, CX JMP,  END-CODE                                  CODE 0=  1 #, BX SUB,     L:  >CARRY BX BX SBB, NEXT, END-CODE  CODE 0< 1 #, BX SHL, >CARRY JMP, END-CODE                       CODE U< AX POP, BX AX SUB, >CARRY JMP, END-CODE                 CODE UNPACK AX AX XOR, AL BH XCHG, >PUSH JMP, END-CODE                                                                                                                                                                                                          CODE PACK AX POP, BL AH MOV, >SWAP JMP, END-CODE                CODE +*   1 #, DL TEST, 0=, NOT, IF,                                   AX POP, AX BX ADD, AX PUSH, THEN,  1 #, BX RCR,                1 #, DX RCR, NEXT, END-CODE                               CODE -/ 1 #, DX SHL,  1 #, BX RCL, AX POP,  AX BX CMP, AX PUSH,     U<, NOT, IF, AX BX SUB, DX INC, THEN,  NEXT, END-CODE       CODE DUP   DUP, NEXT, END-CODE                                  CODE POP   DUP, 0 /BP BX MOV, >RDROP JMP, END-CODE              CODE  A  DUP,  DX BX MOV, NEXT, END-CODE                        CODE A!  BX DX  MOV,  DROP, NEXT, END-CODE                      CODE OVER  AX POP, AX PUSH, >PUSH JMP, END-CODE                                                                                                                                                                                                                                                                                                                                                   >JMP  CODE, jump     >?FOR CODE, ?for     >SKIP CODE, skip       >IF  CODE, if        >-IF CODE, -if      >NEXT CODE, next      >#IF  CODE, #if      >CALL CODE, call        F> CODE, 4th>       >OF  CODE, of                                                >UNNEST CODE, EXIT    >PERF  CODE, PERFORM  >MAIN CODE, NOP      >EXEC  CODE, EXEC       >;: CODE, EX     >RDROP  CODE, RDROP   >XCHG   CODE, XCHG    >#PUSH CODE, PUSH   >SWAP!  CODE, SWAP!     >MLIT CODE, mlit   >DROP   CODE, DROP     >@PC' CODE, @pc+       >LIT CODE, lit      >BLIT CODE, blit     >DLIT CODE, dlit      >RP!  CODE, RP!      >RP@  CODE, RP@        >2+ CODE, 2+        >SP!  CODE, SP!      >SP@  CODE, SP@        >1- CODE, 1-        >PLUS CODE, +          >1+ CODE, 1+      TSTART CODE, boot      >FIND CODE, find       >2- CODE, 2-                           >CONST 2- CODE, DERR  >VAR! 1- , >VAR ,  L: >DERR 0 ,               0 , 0 , 0 , 0 ,  \  ERRORS IN DOS FUNCTIONS                                                                                 CODE -LEAD   ( /ADR -LEN CHAR -- /ADR -LEN') AX BX XCHG,         DROP, DI POP,  BX DEC, DI PUSH,   BEGIN,  BX INC,  0=, J, 1        AL 0 X/D CMP,  0=, NOT, UNTIL, FB: 1  NEXT, END-CODE                                                                        CODE -LEAD#  ( /ADR -LEN CHAR -- /ADR -LEN') AX BX XCHG,         DROP, DI POP,  BX DEC, DI PUSH,   BEGIN,  BX INC,               0=, J, 1  AL 0 X/D CMP, 0=, UNTIL, FB: 1  NEXT, END-CODE                                                                       CODE -TRAIL   ( ADR/ LEN CHAR -- ADR/ LEN') AX BX XCHG,          DROP, DI POP,  BX INC, DI PUSH,   BEGIN,  BX DEC,  0=, J, 1        AL 0 X/D CMP,  0=, NOT, UNTIL, FB: 1  NEXT, END-CODE                                                                        CODE -TRAIL#  ( ADR/ LEN CHAR -- ADR/ LEN') AX BX XCHG,          DROP, DI POP,  BX INC, DI PUSH,   BEGIN,  BX DEC,               0=, J, 1  AL 0 X/D CMP, 0=, UNTIL, FB: 1  NEXT, END-CODE                                                                       CODE WBLK  $ 40 #, CH MOV,      AX SKIPW,                       L: >RBLK  $ 3F #, CH MOV, DI POP, 1024 #, AX MOV,  AX  PUSH,      CX PUSH,    DI MUL,       AX DX XCHG,   AX CX XCHG,                    $ 4200 #, AX MOV,  DOS,  DI POP,  U<, NOT,                 IF,      DUP, DI BX MOV,                                    L: >DOS AX BX XCHG, DROP,  CX POP, DX POP, DS PUSH,                 >DERR 10 +  /// DS MOV, DOS, DS POP,  DI SKIPW,                 THEN,    DI POP, DI POP,  ES PUSH,  CS PUSH,  ES  POP,          >DERR 2+  #, DI MOV,   U<, IF,  AX -2 /DI MOV, THEN,            STOSW,  BX AX XCHG, STOSW,  CX AX XCHG, STOSW,  DX AX XCHG,     STOSW,  AX POP, STOSW, >DROP JMP, END-CODE                  CODE SCANI AX POP, AX SI XCHG, CX CX XOR, CX BX XCHG, CXNZ, IF,            BEGIN  0 /SI BL MOV,  1 X/S SI LEA,  CXNZ, UNTIL,    THEN,  SI AX XCHG, >SWAP JMP,                                                                                                                                                                   L: >SCAN: AX POP,  AX BX XCHG,     CX POP,    DI POP,                    CS PUSH,      ES POP,  CX DX MOV,   BX CALL,                    0=, NOT, IF,   DX CX MOV,  THEN,                         CX INC,   CX DX SUB,  AX DX XCHG,  >SWAP JMP,  END-CODE       CODE SCANW >SCAN: CALLI,  REP: SCASW, RET,  END-CODE            CODE SCANW< >SCAN: CALLI, STD  CX BX MOV, 0 X/D DI LEA,          -2 X/D DI LEA,   REP: SCASW,   CLD RET,  END-CODE              CODE SCANB< >SCAN: CALLI, STD  CX BX MOV,                          -1 X/D DI LEA,   REP: SCASB,   CLD RET,  END-CODE            CODE SCANB >SCAN: CALLI,  REP: SCASB, RET,  END-CODE            CODE SCANL >SCAN: CALLI,   SI PUSH,   BX BX  OR,                     AX BX  XCHG,   SI DI  MOV,   CXNZ,                         IF,  BX DI MOV,                                                      BEGIN, CX PUSH,  >STR= #,  CALL, CX POP,  EQ, UNTIL,       THEN,   SI POP,  RET,            END-CODE                         >RBLK  CODE, RBLK       >DOS CODE, (DOS                       TO MACROS  \ CROSS COMPILER STUFF                               ' TO   ALIAS TO  IMMEDIATE      ' AT   ALIAS AT  IMMEDIATE       ' \ ALIAS \  IMMEDIATE         ' (    ALIAS (   IMMEDIATE      ' ', ' lit  (( [']                                                                    ' [',]  ALIAS [',] IMMEDIATE              ' HERE ALIAS BEGIN                                              ' HERE   ' NOP   (( FOR/        '  ,     ' NOP   (( /NEXT       ' LOOP/  ' NOP   (( FOR         ' /LOOP  ' NOP   (( NEXT        ' >MARK  ' NOP   (( ?FOR        ' >MARK  ' NOP   (( (CALL       ' >MARK  ' NOP   (( -IF         ' >MARK  ' NOP   (( #IF                                                                         : ;THEN COMPILE EXIT [',] THEN  ' ,<MARK #JMP +COMP (( AGAIN    ' .MARK  #?FOR +COMP (( ?FOR    ' .MARK  #NEXT +COMP (( ?NEXT   ' <MARK ALIAS BEGIN IMMEDIATE   ' ,<MARK ##IF +COMP (( UNTIL    ' ,.MARK  ALIAS THEN IMMEDIATE  ' IF ALIAS WHILE IMMEDIATE      : REPEAT [',] AGAIN [',] THEN ; IMMEDIATE                       : ONLY  ORDER# OFF  COMMON ALSO   CONTROL ALSO  ROOT ALSO           [ #LIT +COMP ] LITERAL   [ ' [LIT] 2+ ] LITERAL !  ;                                                                        : DONEST HEADER COMPILE [ #NEST +COMP @ , ] ]  CSP! ;           : UNNEST   ?CSP COMPILE [ ROOT ] EXIT [',] [ ;                  COMMON ONLY                                                                                 >PVAR! >PVECT 2 MAKER PVECTOR ,     ' DONEST  ALIAS :                                               ' UNNEST  ALIAS ; IMMEDIATE                                                                                                        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              META lit [LIT]          META  lit  [']                          META jump AHEAD         META  jump AGAIN                        META of OF              META  call (CALL                                                                                        META -if -IF            META   if  #IF                          META #if IF             META  #if UNTIL                                                                                         META ?for  ?FOR         META  PUSH FOR/                         META ?for  FOR                                                  META next  /NEXT        META  next  NEXT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    HEADER (JUMP (NEST , ] POP @+ DROP PUSH (UNNEST [               HEADER (-IF (NEST , ] DUP MSB# AND (IF [ HERE 14 + , ]                     DROP POP @+ PUSH DROP (UNNEST   \ SKIP                          DROP POP @+ DROP PUSH (UNNEST [ \ JUMP               HEADER (NEXT (NEST , ] POP @+ POP (IF [ HERE 14 + , ]                     -1  + PUSH DROP PUSH (UNNEST     \ JUMP                               DROP PUSH DROP (UNNEST [   \ SKIP               HEADER (?FOR (NEST , ] POP @+ PUSH SWAP POP SWAP                             (IF [ HERE 14 + , ]                                          -1  + PUSH PUSH DROP (UNNEST     \ SKIP                               DROP DROP PUSH (UNNEST [   \ JUMP               HEADER (IFC (NEST , ] DUP U2/C MSB# AND (IF [ HERE 14 + , ]                DROP POP @+ PUSH DROP (UNNEST   \ SKIP                          DROP POP @+ DROP PUSH (UNNEST [ \ JUMP               : TLOOP 10 ?FOR IND . ?NEXT ;                                   : T2    9  FOR  IND .  NEXT ;                                   \ CREATE (DOES ASM X, SI PUSH, X, SI POP, BX PUSH,              \          2 /DI BX LEA, NEXT, END-CODE                         \ CREATE (NEST ASM (DOES #, CALL, END-CODE ] PUSH (UNNEST [     \ HEADER (LIT (NEST , ] POP @+ PUSH (UNNEST [                   \ CREATE (VAR   ASM (DOES #, CALL, END-CODE ] (UNNEST [         \ CREATE (CONST ASM (DOES #, CALL, END-CODE ] @+ DROP (UNNEST [ CREATE DOVAR    ASM   BX PUSH, 2 /DI BX LEA, NEXT, END-CODE     CREATE DOCONST  ASM   BX PUSH, 2 /DI BX MOV, NEXT, END-CODE                                                                     : OLDY  F83 [ ALSO FORTH ] ONLY [ PREVIOUS ]                     [ ' [LIT] 2+ @ ] LITERAL   [ ' [LIT] 2+ ] LITERAL !  ;         : +* A U2/C DROP IFC OVER + THEN U2/C A U2/C A! ;               : -/ A 2* A! 2*C OVER OVER - IFC DROP ;THEN NIP A1+ ;           : +C IFC 1+ IF +  ;THEN 1+ U2/C DROP ;THEN + ;  : 2*C DUP +C ;  : C-OFF 0 U2/C DROP ; : C-ON -1 U2/C DROP ; : U2/ C-OFF U2/C ;  : 2* DUP + ;   : 2/ DUP 2* DROP U2/C ; : C-? 0 2*C ;            : 1+ 1 + ; : 1- -1 + ;  : INVERT -1 XOR ; : NEGATE INVERT 1+ ;  : >BYTE BYTE# AND ; : COUNT  @+ 1- SWAP >BYTE ;                 : C@ @+ DROP >BYTE ; : C! SWAP >BYTE OVER @ $ FF00 AND OR SWAP! ;  : OVER PUSH DUP POP SWAP ;  : OR OVER INVERT AND XOR ;       : TUCK SWAP OVER ; : NIP SWAP DROP ;                            : -ROT SWAP PUSH SWAP POP ;     : ;: POP POP SWAP PUSH PUSH ;           : A1+ A 1+ A! ;           : @A A @ ;   : !A A ! ;       : REPEAT  [',] AGAIN [',] THEN ; IMMEDIATE                       : ELSE [',] SKIP SWAP [',] THEN ; IMMEDIATE                    HEADER (JUMP LJMP ,   HEADER AHEAD LSKIP ,                      \ ' EXIT ALIAS X IMMEDIATE                                      \ 0 AT CURRENT 1+ C!  \ !!! VERI SPECIAL                        : DONEST HEADER COMPILE [ #NEST ` , ] ]    CSP! ;               : UNNEST ?CSP COMPILE EXIT [',] [ ;                             #:    +COMP  PVECTOR :                  ' DONEST TO :           #;    +COMP  PVECTOR ;  IMMEDIATE       ' UNNEST TO ;           VARIABLE SRC    : >= < 0= ;       : ?BLK BLK @ 1 -2 WITHIN ;    : ;TI POP      BLK @ PUSH    >IN @ PUSH   SRC @ PUSH                  PUSH EX  POP SRC !     POP >IN !    POP BLK ! ;           : ;IN CREG @ EX >IN ! ;                                         : SOURCE! A DUP 1- A! SRC @ - ;                                 : SRC@ SRC @ >IN @ #IF TUCK NEGATE CREG ! + A! ;THEN RDROP ;    : SRC? SRC @ IF ;THEN ?BLK IF BLK @ BLOCK 1K + SRC ! THEN ;     : ?WS  ;IN FOR/ C@A+ 33 >= IF RDROP SOURCE! 1- ;THEN /NEXT 0 ;  : ?NWS ;IN FOR/ C@A+ DREG @ = IF RDROP SOURCE! ;THEN /NEXT 0 ;  : PARSE DREG ! SRC? SRC@                                                DREG @ 33 >= IF ?WS SRC@ THEN                                   A ?NWS  A OVER - ;                                      : ". COUNT TYPE ;                                               : (."  ;LIT"  ". ;  : (LIT" ;LIT" ;                             : SSS " SERTYUIOP[" ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           : ;RBUF POP RP@ ROT - RP@ OVER RP! PUSH SWAP PUSH EX POP RP! ;  VARIABLE LINES  VARIABLE ?HAND : ?SEOF ?HAND @ HANDLES @ = ;    : HAND! HANDLES @ ?HAND ! HANDLES ! LINES OFF ;                 : OK? CR BLK @ IF EX ;THEN C" > EMIT EX SPACE ;                 : 1LINE 1 LINES +! OK?  ACCEPT EX >INTERPRET ;                  : ?IO BLK @ IF FIO ;THEN SIO ;                                  : FOPEN HANDLES bs - 0= ?? FOPEN DUP 0< A" OPEN ERR" ;          : SEVAL ;TI BLK ! ?IO   90 ;RBUF 2+ TIB ! HAND!                          BEGIN 1LINE ?SEOF UNTIL ;                              : ;S HANDLES 0; AT HANDLES BLK 1+ 0= IF CLOSE THEN DROP ;       : FLOAD FOPEN  -1 SEVAL ?IO ;  : KBD  0 0 SEVAL ?IO ;                                                                           : 0>= 1+ ?FOR RDROP -1 ;THEN 0 ;                                : ;INVERTED INVERT EX INVERT ; : DECR PUSH ?NEXT -1 ;THEN POP ; : INCR ;INVERTED DECR ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         #FLUSH +COMP  PVECTOR FLUSH   #BLOCK +COMP  PVECTOR BLOCK       #, +COMP  PVECTOR ,   #C, +COMP  PVECTOR C,                     #] +COMP  PVECTOR ]   #[ +COMP  PVECTOR [ IMMEDIATE             #HEAD +COMP  PVECTOR HEADER     : BCOMPILE POP C@+ PUSH C, ;    : COMPILE POP @+ PUSH , ;   : 2Z, COMPILE [ 0 , ] ;             : W, @+ SWAP , ; : DCOMPILE POP W, W, PUSH ;                    : VALUE HEADER DCOMPILE [ #CONST +COMP @+ DROP 1- ,                        #VAR! +COMP @+ DROP , ] , ;                          : VECTOR HEADER DCOMPILE [ #VECT +COMP @+ DROP ,                           #VAR! +COMP @+ DROP , ] , ;                          : CREATE HEADER COMPILE [ #VAR +COMP @+ DROP , ] ;              : VARIABLE CREATE 2Z, ;     : 2VARIABLE VARIABLE 2Z, ;          : CONSTANT HEADER COMPILE [ #CONST +COMP @+ DROP , ] , ;         1024  CONSTANT 1K     64  CONSTANT 1L   16  CONSTANT 1H         1030  CONSTANT B/BUF   0  CONSTANT 0    -1  CONSTANT -1           15  CONSTANT LEN#  255  CONSTANT BYTE#    -->            \\\ 1 CONSTANT 1    2 CONSTANT 2   -2 CONSTANT -2                   : ;LIT" POP POP DUP A! PUSH PUSH A EX  POP COUNT + PUSH ;       : ! !+ DROP ; : @ @+ DROP ;  : C! C!+ DROP ; : C@ C@+ DROP ;    : SWAP! SWAP ! ;  : OFF 0 SWAP! ;  : ON -1 SWAP! ;              : !A  A ! ; : @A A @ ; : +! A! @A + !A ;                        : WCOUNT @+ SWAP ;    : @SWAP OVER @ PUSH SWAP! POP ;           : C!A  A C! ;   : C@A  A C@ ;   : 2@ @+ @ SWAP ; : 2! !+ ! ;    : !A+ A !+ A! ; : @A+ A @+ A! ;  : C!A+ A C!+ A! ;              : C@A+ A C@+ A! ;                                               : IND POP POP DUP PUSH SWAP PUSH ;                              : ROT PUSH SWAP POP SWAP ;                                      : -ROT SWAP PUSH SWAP POP ;                                     : TUCK SWAP OVER ;                                              : NEGATE INVERT 1+ ;                                            : - NEGATE + ;  : ABS -IF NEGATE THEN ;  -->                                                                                    \ : ;code POP CFA @ ! ;  : HERE H @ ;  : ALLOT H +! ;           \ : DOES> COMPILE ;code [ >LIT , >DOES , ]                      \      BCOMPILE [ 232 C, ]  HERE 1+ 1+ - , ; IMMEDIATE          : 0= #IF DUP XOR ;THEN INVERT ; : S>D -IF -1 ;THEN 0 ;          : U< - DROP <IF 0 ;THEN -1 ; : = XOR 0= ; : 0< S>D NIP ;        : WITHIN OVER - PUSH - POP U< ;   : < - 0< ;                                    : 2DUP OVER OVER ;   : 3DROP DROP DROP DROP ;   : D+ PUSH A! PUSH A + POP POP +C ;   : M+ S>D D+ ;              : DNEGATE INVERT SWAP INVERT 1+ #IF SWAP ;THEN SWAP 1+ ;        : D- DNEGATE D+ ;        : DABS -IF DNEGATE THEN ;              : UM* A! 0  LEN# FOR +* NEXT NIP A SWAP ;                       : (M/MOD PUSH SWAP A! POP LEN# FOR -/ NEXT NIP A ;              : U/MOD 0 (M/MOD ; : UM/MOD TUCK  U/MOD  PUSH (M/MOD POP ;      : U/ U/MOD NIP ;   : UMOD U/MOD DROP ;                          -->                                                                                                                             : /MOD OVER S>D NIP (M/MOD ;                                    : / /MOD NIP ;                                                  : MOD /MOD DROP ;                                               : ;NEG 2DUP XOR 2* DROP <IF EX DNEGATE THEN ;                   : ;/ POP SWAP PUSH PUSH EX POP UM/MOD ROT DROP ;                : M* ;NEG ABS PUSH ABS POP UM* ;   : * M* DROP ;                : UM*/ ;/ UM* ;                                                 : M*/ PUSH M* POP ;NEG ABS ;/ DABS ;                            : */ M*/ DROP ;                                                 : 16/ 2/ 2/ 2/ 2/ ;  : 256/ 16/ 16/ ;                           VARIABLE H     VARIABLE BASE   VARIABLE BLK   VARIABLE >IN      VARIABLE TIB   VARIABLE SCR    VARIABLE SCRH  VARIABLE CFA      VARIABLE OUT   VARIABLE AREG   VARIABLE BREG  VARIABLE CREG     VARIABLE DREG  VARIABLE EREG   0 VECTOR ERROR 2VARIABLE NUM     VARIABLE FIN     -->                                                                                                            $ 5E TIB !     : DOSEMIT  DUP DUP $ 200 (DOS 3DROP 3DROP ;      : IO4 (DOS EREG ! AREG ! DROP  CREG ! DREG ! DROP ;             : ?ERR EREG @ 2* <IF 2/ ERROR THEN ;  : ;ERR ?ERR EX ?ERR ;     : IO BREG @ SWAP IO4 ; : CLOSE_H DUP DUP DUP $ 3E00 IO4 ;       : OPEN_H DUP $ 3D02 IO ;                                        : POSBLK  BREG ! 1K UM* $ 4200 IO 1K ;                          : READBLK  ( SCRH @ ) POSBLK ;ERR $ 3F00 IO ;                   : WRITEBLK ( SCRH @ ) POSBLK ;ERR $ 4000 IO ;                   : DOSKEY   DUP DUP DUP $ 800 IO4 AREG C@ ;                      ' DOSEMIT VECTOR 'EMIT : EMIT 'EMIT 1 OUT +! ;                  : ACCEPT  $ 84 TIB @ 2 - TUCK ! DUP DUP  $ A00 IO4                 0 TIB @ 1- COUNT DUP    CREG ! + C!  ;    -->                                                                                                                                                                                                                                                                                 10 BASE !     : ALPHA -10 + <IF 65 + ;THEN 58 + ;              : CR 13 EMIT 10 EMIT 0 OUT ! ;                                  : 1H. 15 AND ALPHA EMIT ;    : 1B. DUP 16/ 1H. 1H. ;            : 1W. DUP 256/ 1B.  1B. ;    : 1D. 1W. 1W. ;                    : TYPE FOR/ COUNT EMIT /NEXT DROP ; : STYPE FOR/ EMIT /NEXT ;   : HOLD SWAP 1+ ; : 1# NUM 2@ BASE @ UM/MOD NUM 2! ALPHA HOLD ;  : S# NUM 2! 0 BEGIN 1# NUM 2@ OR 0= UNTIL ;                     : N>TYPE A! OVER - FOR/ A HOLD /NEXT ;  : SPACE 32 EMIT ;       : D# #IF DROP DABS S# C" - HOLD ;THEN DROP S# ;                 : D.R PUSH D# POP 32 N>TYPE STYPE ; : SPACES FOR/ SPACE /NEXT ; : D. S>D 0 D.R SPACE ;   : . S>D D. ;  : U. 0 D. ;              : .R PUSH S>D S>D POP D.R ;   : U.R  0 0 ROT D.R ;              : UD. 0 0 D.R SPACE ;         : UD.R 0 SWAP D.R ;               : .. BASE @ PUSH 6 .R SPACE POP  BASE ! ;                       121 LOAD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ DEFER                                                         ' INTERPRET @   1 MAKER DEFER Z,   | : FIX @R+ ! ;              | : DEFRD? STR lit [ ' INTERPRET @ , ] XOR A" IS'NT DEFER'D " ; : IS ' DEFRD? STATE IF COMPILE FIX , ;THEN ! ; IMMEDIATE PRUNE                                                                                                                                    DEFER  PLUS      ' NOP IS PLUS                                : TEST_PLUS                                                      CR   ."  TEST1 OF PLUS"     S. PLUS S.  ;                        TEST_PLUS                                                      1 2  ' +  IS PLUS                                                TEST_PLUS                                                     : TEST2 9 5 ['] -  IS  PLUS    TEST_PLUS ;                        TEST2                                                         FORGET PLUS                                                                                                                     : ALIST CREATE DUP C, FOR , NEXT ;                              : FINDER ALIST DOES> CSTR (find ;                               AT TCOMP 1  FINDER FIND-C   AT MACROS AT TROOT 2  FINDER FIND-F : 1] BLWORD FIND-C IF EXEC ;THEN   ( IF COMPILER'S - EXECUTE)               FIND-F IF  ,   ;THEN   ( IF FORTH'S WORD - COMPILE)             NUMBER  \' LITERAL ;   ( ELSE TRY -IS IT A NUMBER?) : COMP] 1] ;  ' INTERPRET 4 + @  ' ] ! ' ] HERE 2- ! ( LOOPING) : INT[ RDROP ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  MARKER -PROBA   0 VALUE SADR  -HEADERS    140 LOAD              : ?N CREATE C, DOES> COUNT SADR 2- @ TO SCAN 1+ ;               : SHOW ." | " SADR @ DUP H. ?WORD ;                                2 ?N IS_1+? ] BLIT BCOMPILE [ 1 ?N IS_3+? ] ;code [            11 ?N  IS_2+? ] (BR TO (BR AT (BR (FOR LIT (OF (DO TO (DO         (LP TO (LP COMPILE [ 2 ?N IS_4+? ] DCOMPILE DLIT [             3 ?N IS_STR? ] TO ABORT (" TO (" [                           | : WW CR SADR H. SHOW  2 SADR+ IS_2+? IF SHOW 2 SADR+ ;THEN        IS_4+?  IF SADR 2@ D. SADR 2@ SWAP H. H. 4 SADR+ ;THEN          IS_3+?  IF SADR C@ . SADR 1+ WCOUNT + H. 3 SADR+ ;THEN          IS_STR? IF SADR DUP "STR" C@ 1+ SADR+ ;THEN                     IS_1+?  IF SADR C@ DUP H. .  1 SADR+ THEN ;                 : L WW WW WW WW WW WW WW ; : @SEE TO SADR L ; : SEE ' @SEE ;    : 'SEE SADR+ SADR N>C DUP TO SADR ?WORD L ; : +SEE SADR+ L ;    : /SEE -14 SADR+ ;  : .SEE SADR PUSH L POP TO SADR ;                                                                            : SADR+ SADR + TO SADR ;                                        : C/NUM DUP >EMIT? IF 'CHAR' ;THEN #NUM ;                       : ?STR C>N 0= IF 1 ;THEN      \ CODE TO NAME                           COUNT DUP 31 AND       \ A N  #LEN                              SWAP 96 AND            \ A #LEN  &96                            OVER 0= OR             \ A (1)  ((2)  (1) 0=) OR                IF DROP ;THEN          \ A CNT / A  INVALID LENGTH              FOR COUNT >EMIT?       \ A' C                                     0= IF UNNEST ;THEN   \ A' - UNPRINTABLE CHARACTER             NEXT DUP XOR ;         \ 0  - OK                         : ?WORD DUP ?STR IF C/NUM ;THEN ?ID. ;                                                                                                                                                                                                                                                                                                                                                          ( initialize target space)                                      \ : READC BREG DUP OFF 1 FIN @ $ 3F00 IO4 AREG @ ;              \ IF BREG @ THEN ;                                                                                                              VARIABLE RAM                                                                                                                    VARIABLE H'  dRELOC ,  ( relocation amount )                        ( 1st cell is tgt's DP & 2nd cell is tgt's offset)                                                                          dRELOC $3000 0 FILL  dRELOC H' !                                                ( ie we will start target image at dRELOC)                                                                                                                                                                                                                                                                                                                                      ( meta variables pointing to target runtime code    )           VARIABLE TVAR  ( variable OK) VARIABLE TUSER ( USER VARIAB OK)  VARIABLE TLIT  ( literal OK)  VARIABLE TBLIT ( BYTE LITERAL)    VARIABLE TCOL  ( docol OK)    VARIABLE TDOES ( ADDRESS'DOES OK) VARIABLE TBRA  ( branch OK)   VARIABLE TCONST ( CONSTANT OK)    VARIABLE T0BR  ( zero branch OK)                                VARIABLE TEXIT ( EXIT OK)     VARIABLE TDODEF ( DEFER OK)       VARIABLE TFOR  ( for OK)      VARIABLE 'EX    ( EXECUTE OK)     VARIABLE TNEXT ( next OK)     VARIABLE TALIAS ( ALIAS ? OK)     VARIABLE TR@   ( R@ and I)    VARIABLE TPOINT ( TEMP ADRS OK)   VARIABLE TARR  ( array OK)                                      VARIABLE TABORT ( abort")                                       VARIABLE TDOT   ( dot")                                         VARIABLE TNULL  (     OK)                                       VARIABLE 'NXT   ( for central next OK)                                                                                          ( switch between host & target spaces      )                                                                                    : {  dA @ HERE  H' 2@  H !  dA !  H' 2! ;      : }  { ;                                                                         : RECOVER ( -) ( -2) CELL NEGATE  ALLOT ;                                 ( RECOVERs final EXIT when it can never be reached)                                                                   : 0, 0 , ;         : >MARK HERE 0, ;                                                                                            : @,A @ ,A ;       : dA@- dA @ - ;                                                                                              : POINT! HERE TPOINT ! ;    : POINT, TPOINT @,A ;                                                                               : 2+ 1+ 1+ ;   : 2- 1- 1- ;                                                                                                                                                                     ( headers)  H/LESS OFF                                          : THEAD ( -) ( this is the basic HEAD without VF etc)             >MARK ( lf) 32 WORD  CONTEXT @  2DUP                            -FIND NIP NOT IF OVER TYPE$ ."  not unique " CR THEN            HASH   2DUP @ ( lfa  nfa  voc  nfa  prev.lfa) SWAP 2-           ( lfa  nfa  voc  prev.lfa  cur.lfa) !  SWAP ( lfa voc nfa)      C@  ( lfa voc len) 1+ ALLOT  !  ;                                                                                             : |  (  -)  H/LESS ON  ;  ( make following word headless)                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( headers)                                                                                                                      ( View fields are always created)                                33098 CONSTANT NONESUCH                                                                                                        : HEAD ( -) HEADERS @  H/LESS @ NOT  AND                            IF  BLK @ , THEAD                                             ELSE  {  THEAD  NONESUCH ,  H' @ ,  }                           THEN  H/LESS OFF  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( meta compiling words    )                                     HEX                                                             : NXT, 'NXT @ JMP,  ;  ( for central next)                      : forget ( -)  CONTEXT @  HASH @ CELL + DUP C@ 20 XOR SWAP C! ; : CREATE ( -) ( - a)  HEAD  TVAR @,A  ;                         : USER ( n) ( - a) HEAD TUSER @,A , ;                           : VARIABLE  ( -) (  RAM @ CONSTANT  CELL RAM +! for ROMing)       CREATE  0, ;                                                  : CONSTANT HEAD TCONST @,A , ;                                  : ARRAY ( a -) ( n -)  ( n is a word, not byte, index)            HEAD   TARR @,A , ;                                           : CODE  HEAD HERE 2+ ,A ASM-RESET ;                             : DEFER (  ) ( ...)  HEAD  TDODEF @,A 0,  ;                     : IS ( pfa -)   dA@-  ' 2+ ! ;                                                                                                                                                                  ( SCAN TRIM CLIP PRUNE to relink dictionary after metacompiling)                                                                : SCAN ( lfa - lfa)                                               @ BEGIN DUP 1 dRELOC WITHIN WHILE @ REPEAT ;                                                                                  : TRIM ( lfa new-lfa - new-lfa) DUP PUSH dA@- SWAP ! POP          DUP CELL + DUP C@ $DF AND SWAP C! ( unsmudge)  ;                                                                              : CLIP ( voc-head -) DUP BEGIN DUP SCAN DUP WHILE TRIM REPEAT     DROP TNULL @  dA@- SWAP !     ( @ ,)  DROP ;                                                                                  : PRUNE ( -)  {  8 HASH CLIP  6 HASH CLIP                           TNULL @ OFF ( zero out its link field)  {   ;                                                                                                                                                                                                               ( rename some host words )                                                                                                      : FORTH' FORTH ;                                                                                                                : COMPILER' COMPILER ;                                                                                                          : :'  :  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( LITERAL    ]       )                                          COMPILER                                                        : LITERAL ( n -)  TLIT @,A  ,  ;                                                                                                FORTH                                                           : ]  BEGIN 4  -'   ( restrict execution to host's COMPILER)            IF  6 -FIND ( restrict finding to target's FORTH   )                IF       NUMBER  \ LITERAL                                      ELSE    ,A                                                      THEN                                                        ELSE  EXECUTE                                                   THEN                                                          AGAIN ;                                                                                                                                                                                                                                                    ( meta structures   UNTIL AGAIN IF THEN etc       )             COMPILER                        | : if   T0BR @,A ;             : BEGIN ( - a) HERE ;           | : else TBRA @,A ;             : UNTIL ( a -) \ if    ,A  ;    : AHEAD \ else >MARK ;          : AGAIN ( a -) \ else  ,A  ;                                    : THEN  ( a -) HERE dA@-  SWAP ! ;                              : IF    ( - a) \ if   >MARK ;                                   : WHILE ( a - a a )  \ IF  SWAP ;                               : REPEAT ( a a -)  \ AGAIN   \ THEN ;                           : ELSE   ( a - a)  \ AHEAD  SWAP  \ THEN ;                      : FOR  ( h -) TFOR @,A  >MARK  ;  ( PERFORMS BODY OF LOOP )     : NEXT ( h -) DUP  \ THEN  2+  TNEXT @,A  ,A  ;                 : \  8 -'  ABORT" ?"   ,A  ; ( like F83's [COMPILE]  )          FORTH                                                                                                                                                                                           ( more meta compiling words )                                   COMPILER                                                        : ABORT"    TABORT @,A  $22  STRING ;                           : ."        TDOT   @,A  $22  STRING ;                           : [']       TLIT   @,A ;                                        : R@ ( - n) TR@    @,A ;                                        : I ( - n)  TR@    @,A ;                                        FORTH                                                           : FORTH    6 CONTEXT ! ;                                        : COMPILER 8 CONTEXT ! ;                                        : :  HEAD   TCOL @,A   forget ] ;                               COMPILER'                                                       :' ;  forget  POP DROP  TEXIT @,A ; ( must be the last colon)                                        ( def in the metacompiler) FORTH'                                                                                                                          : EXPECT ( a # -) SWAP ( #rem a)  OVER PUSH ( #rem a)             BEGIN OVER WHILE ( # a)    KEY DUP $0D - WHILE ( # a key)        DUP 8 = IF DROP ( # a) OVER R@ <                                           IF ( # a) 1- 32 OVER C! ( # a) 1 +UNDER                                      8 EMIT  SPACE  8 EMIT                              THEN                                                         ELSE ( # a key) DUP EMIT OVER C! ( # a) -1 +UNDER 1+            THEN                                                   REPEAT DROP SPACE THEN ( # a) DROP  POP SWAP -  SPAN  !  ;                                                                                                                                    EXIT                                                             ( you can use QUERY to get input ready for WORD to work on )                                                                                                                                                                                                   ( HASH     WORD)                                                                                                                : WORD ( c - a)                                                   PUSH  SOURCE ( buf rem#) OVER SWAP ( buf buf #)                 >IN @ /STRING 0 MAX  ( ie remaining string)                     R@ -LEADING=  ( buf 1stChr rem#)                                OVER SWAP  ( buf 1stChr 1stChr rem#)                            POP -LEADING<> ( buf 1stChr LastChr+1 rem#) DROP DUP PUSH       ( buf 1stChr LastChr+1) OVER - ( buf 1stChr #) DUP HERE C!      HERE 1+ SWAP CMOVE ( buf) POP SWAP -  1+   >IN !  (   )         HERE ( a)    ;                                                                                                                : HASH ( n - vocab-a) CONTEXT SWAP - ;                                                                                                                                                                                                                          HEX TALIAS @ dA@- CONSTANT NONESUCH  ( no opcode $D6 )           CODE -FIND  ( h n -  h true | pfa false)                         SI DX MOV, ( save IP)  ' CONTEXT 2 + @ #, DI MOV,               BX DI SUB, ( hash)  DS AX MOV, AX ES MOV,  BX POP, ( 'here')    0 [BX] AL MOV, AH AH SUB, ( cnt)   AX INC,    DI PUSH,         BEGIN, DI POP,  0 [DI] DI MOV, ( get next link addr)             DI DI TEST, 0=, IF, BX PUSH,  BX BX SUB, BX DEC, DX SI MOV,     NXT, THEN, DI PUSH,  2 #, DI ADD, ( move to name field)        BX SI MOV, ( here) AX CX MOV, ( reload count) REPZ, AL CMPS,    0=, UNTIL,  ( fall thru occurs when count is all used up and )   ( the last compare was still equal, now check if indirect  )    AX POP, NONESUCH #, W-PTR 0 [DI] CMP, ( indirect pfa?)          0=, IF,  ( get indirect addr) 2 [DI] DI MOV, THEN,             DI PUSH, ( the pfa) BX BX SUB, ( the flag) DX SI MOV,            NXT,   END-CODE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( multiplies number by BASE & adds digit)                     | : -DIGIT ( c - n $ DF  AND)    $ 30 -  DUP 10 < 0=               IF  7 - DUP $ A < OR THEN   DUP BASE ( @) U< 0= A" ?" ;      |  : 10*+ ( u a c - u a)                                          -DIGIT ROT BASE ( @) * + SWAP ;                               | : ;SIGN OVER C@ $ 2D = IF 1 STR- EX NEGATE THEN ;              : (SNUMBER ( a # - n) ;SIGN                                      OVER C@ C" $ OF [AT] $  1 STR-  ELSE                                    C" # OF [AT] #  1 STR-  ELSE                                    C" % OF [AT] %  1 STR-  ELSE                                    C" ^ OF DROP 1+ C@ 64 - ;THEN ( char value)                     C" ` OF DROP 1+ C@      ;THEN DROP THEN THEN THEN        0 -ROT   FOR  CSTR 10*+ NEXT DROP  ;                          ( above allows  $FF  and  'a   type literals )                 : SNUMBER ( a - n) COUNT ( a #) (SNUMBER  ;                                                                                     ( Intrepreter                                         )         : -'  ( u - here t | pfa f)  32 WORD  SWAP -FIND  ;             : ' ( - pfa)   CONTEXT @ -' ABORT" ?"  ;                        : INTERPRET  ( blk# offset -)                                     >IN 2!    BEGIN 2 -' ( search FORTH)  IF NUMBER                                 ELSE EXECUTE  THEN  AGAIN  ;      RECOVER     : QUERY ( -) TIB @ 255 EXPECT  SPAN @ #TIB !  0 0 >IN 2!  ;     VARIABLE DEFAULT-TIB         ( must be initialized by RESET )   VARIABLE DEFAULT-FIB                                            : RESET-TIB ( -)  DEFAULT-TIB @ TIB !  DEFAULT-FIB @ FIB !  ;   : (QUIT  R0 @ RP!  RESET-TIB  ( CR )                              BEGIN CR QUERY                                                     0 0 ( blk offset) INTERPRET  ."  ok"                         AGAIN ;   RECOVER    ' (QUIT IS QUIT                                                                                                                                                          ( CLEAR  LIST                                         )                                                                         : (LIST ( n -)                                                    BLOCK ( n a) 16 FOR CR  DUP 64 TYPE   64 + NEXT  DROP  CR ;                                                                   : LIST ( n -)                                                     SCR N! DUP CR ." scr " U. SPACE  DUP >UNIT# .FILE  (LIST  ;                                                                   : CLEAR ( n -) BLOCK 1024 32 FILL  UPDATE ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (  compiling       )                                            2 CONSTANT CELL       : CELLS ( # - #')  2*  ;                  : ALIGN ( -)   H @ DUP 1 AND +  H !  ;                          : ALLOT ( n -)  H +! ;                                          : , ( n -)  H @ !   CELL ALLOT ;                                : C, ( c -) H @ C!  1 ALLOT ;                                   : ,A  ( a -)  dA @ - , ;                                        : COMPILE  POP DUP @ , CELL + PUSH ;                            COMPILER                                                          DEFER LITERAL                                                   : SLITERAL ( n - ) COMPILE lit  ,  ;    ' SLITERAL IS LITERAL   : [  POP DROP ;                                               FORTH                                                           : ]  BEGIN  4 -' IF 2 -FIND IF NUMBER \ LITERAL                          ELSE  ,A  THEN  ELSE EXECUTE  THEN AGAIN ;   RECOVER                                                                   ( compiling   )                                                 : LASTW ( - nfa n)  CONTEXT @ HASH @ 2 +  DUP C@ ;              : >CFA ( nfa len -pfa) + 1+ DUP @ NONESUCH = IF 1+ 1+ @ THEN  ; : SMUDGE  LASTW $20 XOR SWAP C! ; ( flip bit 5 of len byte)     : FORTH    2 CONTEXT ! ;                                        : COMPILER 4 CONTEXT ! ;                                        : ;code  POP LASTW ( + 1+) >CFA  ! ;                            COMPILER                                                        : [']  COMPILE lit   ;                                          : DOES> COMPILE ;code  $E8 C, ( call) ['] dodoes HERE 2 + - , ; : RECURSIVE  LASTW $0DF AND SWAP C! ;                           : ;  \ RECURSIVE  POP DROP  COMPILE EXIT  ;                     FORTH                                                                                                                                                                                                                                                           ( This block allows relocating the dictionary when not            metacompiling.  The headers are visible until PRUNE             unlinks them.)                                                ( e.g.  { NEW-ASSEMBLER LOAD  } <use assembler> PRUNE  )        | : SCAN ( lfa - lfa)                                               @ BEGIN DUP EDGE @ -1 WITHIN WHILE @ REPEAT ;               | : TRIM ( lfa new-lfa - new-lfa)  DUP ROT  !  ;                | : CLIP ( voc-head -)                                              BEGIN DUP SCAN DUP WHILE TRIM REPEAT 2DROP  ;                : PRUNE ( -)  EDGE @ H' @ -                                       IF   4 HASH CLIP  2 HASH CLIP  EDGE @ H' !   THEN  ;                                                                                                                                                                                                                                                                                                                                         ( (HEAD      )                                                  : (HEAD ( -)                                                      BLK @ ( viewfield)  ,                                           HERE 0 ( linkfield)  ,                                          32 WORD  CONTEXT @  2DUP                                        -FIND NIP NOT IF OVER TYPE$ ."  not unique " THEN               HASH   2DUP @ ( lfa  nfa  voc  nfa  prev.lfa)                   SWAP 2 -   ( lfa  nfa  voc  prev.lfa  cur.lfa)                  !  SWAP ( lfa voc nfa)                                          C@  ( lfa voc len) 1+ ALLOT  !  ;                                                                                                                                                                                                                                                                                                                                                                                                                             ( HEAD  allows making individual words headerless with | and      allows making whole sections headerless with                    HEADERS OFF  .......  HEADERS ON  )                                                                                           : HEAD ( -)                                                       HEADERS @  H/LESS @ NOT  AND                                      IF       (HEAD                                                  ELSE  {  (HEAD  NONESUCH C,  H' @ ,  }                          THEN  H/LESS OFF ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( Defining words   )                                            FORTH                                                           : STRING ( delim -) WORD C@ 1+ ALLOT ;                          : CREATE  HEAD  COMPILE var ;                                   : :   HEAD  COMPILE docol  SMUDGE  ] ;                          : CONSTANT ( n) HEAD  COMPILE [ TCONST @ dA@- , ] , ;           : VARIABLE ( -)  CREATE  0 ,  ;                                 : CRASH ( -) -1 ABORT" no vector " ;             RECOVER        : DEFER ( -) HEAD  COMPILE [ TDODEF @ dA@- , ]                          COMPILE CRASH ;                                         : IS    ( a -) ' 1+ 1+ ! ;                                                                                                                                                                                                                                                                                                                                                                      ( WORDS  SP@  DEPTH  .S   ? )                                                                                                   : WORDS ( -) CR CONTEXT @ HASH BEGIN @ DUP WHILE DUP 2 +          COUNT 31 AND TYPE  2 SPACES  ?SCROLL  REPEAT DROP  ;                                                                          CODE SP@ ( - a) BX PUSH,  SP BX MOV,  NXT,  END-CODE                                                                            : DEPTH ( - words) SP@  S0 @ SWAP - CELL /   1-  ;                                                                              : .S  ( -) DEPTH  DUP 0< ABORT"  underflow "                       ?DUP IF DUP FOR  POP ROT PUSH PUSH NEXT                                   FOR  POP POP DUP U. SWAP PUSH NEXT ." <top "          ELSE ."  stack empty " THEN   ;                                                                                              : ? ( a -)  @ . ;                                                                                                               ( Structures       )                                            COMPILER                                                        : \ 4 -'  ABORT" ?"  ,A ;                                       : BEGIN ( - a) H @ ;                                            : UNTIL ( a -) COMPILE 0branch  ,A  ;                           : AGAIN ( a -) COMPILE branch   ,A  ;                           : THEN  ( a -) H @ dA @ -  SWAP ! ;                             : IF    ( - a) COMPILE 0branch  >MARK ;                         : WHILE ( a - a a ) \ IF  SWAP ;                                : REPEAT ( a a -) \ AGAIN  \ THEN ;                             : ELSE   ( a - a)  COMPILE branch  >MARK SWAP \ THEN ;                                                                          : FOR  ( - h) COMPILE for  >MARK  ;                             : NEXT ( h -) DUP \ THEN  2 + COMPILE next   ,A  ;              : I ( - n)  COMPILE R@ ;                                                                                                        ( Strings                                             )         HEX                                                             COMPILER                                                          : ABORT"  COMPILE abort"  22 STRING ;                           : ."      COMPILE dot"    22 STRING ;                           : (   29 WORD DROP ;                                            : IS ( pfa )  ' 1+ 1+  \ LITERAL COMPILE ! ;                    : "  ( -)  COMPILE (")  22 STRING 0 C,  ( asciiz for files) ;                                                                 FORTH                                                             : (  \ (  ;                                                     : ."  22 WORD TYPE$  ;  forget                                  : "  ( - a)   HERE  '" STRING  0 C,  ;                                        ( embed the string in the dictionary )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \ BLK NBLK >IN HERE (WORD TO >IN ;                                                                                              : WORD ( c - a)                                                   PUSH  BLK NBLK DUP SPAN ( buf buf #)  >IN STR- ( remaining)     0 MAX R@   >LEAD< -LEADING=  ( buf 1stChr rem#)                 OVER SWAP  ( buf 1stChr 1stChr rem#)                            POP >LEAD< -LEADING<> ( bf Chr/ /Chr+1 rem#) DROP DUP PUSH      ( buf 1stChr LastChr+1) OVER - ( buf 1stChr #) DUP HERE C!      HERE 1+ SWAP CMOVE ( buf) POP SWAP -  1+   >IN !  (   )         HERE 0 OVER  COUNT + ! ( a)    ;                                                                                              : PROBA 32 WORD PAD "MOVE ;                                                                                                                                                                                                                                                                                                     : -LEADING=  ( ADR LEN CHAR -- ADR' LEN')   PUSH                  BEGIN 2DUP 0= SWAP C@ R@ XOR AND WHILE 1 STR- REPEAT RDROP ;  : -LEADING<> ( ADR LEN CHAR -- ADR' LEN')   PUSH                  BEGIN 2DUP 0= SWAP C@ R@ =   AND WHILE 1 STR- REPEAT RDROP ;                                                                  : WORD ( c - a)   PUSH  SOURCE  OVER SWAP ( buf buf #)            >IN @ /STRING 0 MAX   R@                                              -LEADING=  ( buf 1stChr rem#)                             OVER SWAP  ( buf 1stChr 1stChr rem#)                            POP   -LEADING<>                                                               ( buf 1stChr LastChr+1 rem#) DROP DUP PUSH       ( buf 1stChr LastChr+1) OVER - ( buf 1stChr #) DUP HERE C!      HERE 1+ SWAP CMOVE ( buf) POP SWAP -  1+   >IN !  (   )         HERE ( a)    ;                                                                                                                                                                                CODE -LEADING=   ( /ADR -LEN CHAR -- /ADR -LEN') AX BX XCHG,     DROP, DI POP,  BX DEC, DI PUSH,   BEGIN,  BX INC,  0=, J, 1        AL 0 X/D CMP,  0=, NOT, UNTIL, FB! 1  NEXT, END-CODE                                                                        CODE -LEADING<>  ( /ADR -LEN CHAR -- /ADR -LEN') AX BX XCHG,     DROP, DI POP,  BX DEC, DI PUSH,   BEGIN,  BX INC,               0=, J, 1  AL 0 X/D CMP, 0=, UNTIL, FB! 1  NEXT, END-CODE                                                                       CODE -TRAILING=   ( ADR/ LEN CHAR -- ADR/ LEN') AX BX XCHG,      DROP, DI POP,  BX INC, DI PUSH,   BEGIN,  BX DEC,  0=, J, 1        AL 0 X/D CMP,  0=, NOT, UNTIL, FB! 1  NEXT, END-CODE                                                                        CODE -TRAILING<>  ( ADR/ LEN CHAR -- ADR/ LEN') AX BX XCHG,      DROP, DI POP,  BX INC, DI PUSH,   BEGIN,  BX DEC,               0=, J, 1  AL 0 X/D CMP, 0=, UNTIL, FB! 1  NEXT, END-CODE                                                                       MARKER -WORD   : +LOAD BLK + LOAD ;                             : (LEAD 0 SWAP STR- ;                                           : >LEAD< PUSH (LEAD POP @R+ EXEC (LEAD ;                        -1 +LOAD                                                                                                                        : WORD ( c - a)                                                   PUSH  BLK NBLK DUP SPAN ( buf buf #)  >IN STR- ( remaining)     0 MAX R@   >LEAD< -LEADING=  ( buf 1stChr rem#)                 OVER SWAP  ( buf 1stChr 1stChr rem#)                            POP >LEAD< -LEADING<> ( bf Chr/ /Chr+1 rem#) DROP DUP PUSH      ( buf 1stChr LastChr+1) OVER - ( buf 1stChr #) DUP HERE C!      HERE 1+ SWAP CMOVE ( buf) POP SWAP -  1+   >IN !  (   )         HERE 0 OVER  COUNT + ! ( a)    ;                                                                                                                                                                                                                                ( multiplies number by BASE & adds digit)                     : -DIGIT ( c - n $ DF  AND)    $ 30 -  DUP 10 < 0=                 IF  7 - DUP $ A < OR THEN   DUP BASE ( @) U< 0= A" ?" ;      | : 10*+ ( u a c - u a)                                           -DIGIT ROT BASE ( @) * + SWAP ;                               : ;SIGN OVER C@ $ 2D = IF 1 STR- EX NEGATE THEN ;               : (SNUMBER ( a # - n) ;SIGN                                       OVER C@ C" $ OF [AT] $  1 STR-  ELSE                                    C" # OF [AT] #  1 STR-  ELSE                                    C" % OF [AT] %  1 STR-  ELSE                                    C" ^ OF DROP 1+ C@ 64 - ;THEN ( char value)                     C" ` OF DROP 1+ C@      ;THEN DROP THEN THEN THEN        0 -ROT   FOR  CSTR 10*+ NEXT DROP  ;                          ( above allows  $FF  and  'a   type literals )                 : SNUMBER ( a - n) COUNT ( a #) (SNUMBER  ;                      DEFER NUMBER         ' SNUMBER IS NUMBER                       MARKER --FIND                                                   HEX ( TALIAS @ dA@-) 1 CONSTANT NONESUCH  ( no opcode $D6 )                                                                      CODE -FIND  ( h n -  h true | pfa false)                                SI DX  MOV, ( save IP)                                    ' CONTEXT                                                       2 + @ #, DI  MOV,                                                     BX DI  SUB, ( hash)                                             DS AX  MOV,                                                     AX ES  MOV,                                                        BX  POP, ( 'here')                                       0 /BX  AL  MOV,                                                 1F #,  AL  AND, ( MASK LEN)                                         AH AH  SUB, ( cnt)                                                 AX  INC,                                                        DI PUSH,                                             BEGIN,     DI  POP,                                                  0 /DI DI  MOV, ( get next link addr)                               DI DI TEST,                                                             0=, IF,                                                    BX PUSH,                                                     BX BX  SUB, ( ZERO TOP)                                            BX  DEC, ( -1  -  FALSE)                                     DX SI  MOV, ( RESTORE IP)                                             NEXT, THEN,                                                  DI PUSH,                                                   2 #, DI  ADD, ( move to name field)                               BX SI  MOV, ( here)                                             AX CX  MOV, ( reload count)                                  REPZ, AL CMPS,                                             0=, UNTIL,                                                                                                                       ( fall thru occurs when count is all used up and )              ( the last compare was still equal, now check if indirect  )   AX POP, NONESUCH #,                                                   W/ 0 /DI CMP,          ( indirect pfa?)                                       0=, IF,  ( get indirect addr)                     2 /DI DI MOV, THEN,                                      \ FSJMP, 23                                                                 DI PUSH, ( the pfa)                                          BX BX  SUB, ( the flag)                                         DX SI  MOV,                                                           NEXT,   END-CODE                                                                                                                                                                                                                                                                                                                                                                 : FIND PUSH -1 ORDER# WCOUNT                                           FOR WCOUNT @ SWAP NEXT DROP CONTEXT @ POP (FIND TO ?, ;                                                                  :: INTERPRET BL WORD FIND ?DUP IF ?, TO INTERPRET THEN               NUM ?? ?LITERAL TO INTERPRET ;                                                                                             : ?LITERAL DBL 1+  IF SWAP ['] LITERAL  DUP THEN                      DROP ['] LITERAL                                          ;                                                               : LITERAL STATE IF ['] [LIT] THEN ;                                                                                             : (( CREATE , , DOES> WCOUNT , PERFORM ;                                                                                        ' ,  ' LIT ((  [LIT]                                                                                                                                                                            | : BACK 8 EMIT ;      | : ;EXPECT RDROP DROP POP SWAP - ;      : EXPECT ( a # -) DUP PUSH ( a)  SWAP ( #REM a)                   BEGIN OVER WHILE ( #REM a)                                          KEY 255 AND  ( # a key)                                         13 OF ;EXPECT ELSE   0 OF 7 EMIT ELSE                            8 OF  OVER R@ < IF -1 STR+ BACK SPACE BACK THEN ELSE            ( # a key) DUP EMIT OVER C! ( # a) 1 STR+ THEN THEN THEN   REPEAT ;EXPECT ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( DEBUF LW LAST WORD  LA - LAST ADR  FA - FIRST ADR   )                                                                        \ MARKER -HACK                                                                                                                   0 QUAN ADR    -HEADERS                                                                                                          <%   \ COMPILING TIME ONLY                                                                                                      : VALUES FOR 0 VALUE NEXT ;                                     : 1-, HERE 2- @ 1- , ;                                          : '@,  ' @ , ;                                                                                                                  %>                                                                                                                                                                                                                                                             : BADR AT ADR @1+! C@ ;                                                                                                          1 VALUE FEMIT  \ TEMP VARIABLES    \REDIRECTION FLAG            0 VALUE LW  \ LAST WORD                                         0 VALUE EF  \ END FLAG                                          0 VALUE IX  \ INDEX OF WORD IN LAST TABLE                       0 VALUE 1A  \ FIRST ADDRESS                                     0 VALUE NA  \ NEXT ADDRESS                                      0 VALUE LA  \ LAST ADDRESS                                      0 VALUE PS  \ PASS NUMBER                                       0 VALUE HW  \ HELP WORD                                         0 VALUE TAB \ TABULATION POS                                    0 QUAN  SCP \ SCAN POINTER                                                  \ STACK OF FORWARD ADDRESSES                                                                                                                                                       0 <STACK FSTK 0 ,             \ STACK OF BACKWORD ADDRESSES     0 <STACK BSTK 0 ,                                                                                                               : /1PAS PS -IF RDROP THEN ;  \ ON FIRST PASS -  EXIT WORD                                                                       : WADR AT ADR @2+! @ ;       \ READ WORD AT ADR & ADR++                                                                         : SADR AT SCP @2+! @ ADR = ; \ ONE STEP SCAN FOR ADR                                                                            \ SAVE AN ADDRESS TO ONE OF TWO STACKS                          : !ADR ADR 1- OVER U< IF TO FSTK ;THEN TO BSTK ;                                                                                \ CHECK IF NAME IS 'OK'   0 IF OK   ELSE NOT OK                                                                                                                                                                                                                 : @BRAN  WADR TO NA  LA NA U< IF NA TO LA THEN ;                                                                                \ : WORD? DUP C>N DUP IF 1- SWAP PUSH - POP CSTR                \    DUP 128 AND 1+ PUSH 127 AND + 2+ = POP AND ;THEN NIP ;                                                                     : NAME-OK? SWAP C@ TUCK OR 129 AND SWAP 96 AND 0= AND ;         : WORD? C>N DUP IF OVER N>C 2- @ PUSH NAME-OK?                                 R@ 0= IF RDROP ;THEN  \ KRAJ NA SPISAK               POP N>C C>N DUP  IF ( F A 1/ F 0) NAME-OK?  ( F F)                               IF ;THEN DROP 0 ;THEN NIP THEN ;                                                                           : ID.OK DUP WORD? IF ?ID. ;THEN  C" : EMIT .H ;                                                                                                                                                                                                                                                                                  \ MAIN SCAN UTILITY CREATOR                                     : XSC CREATE C,   \ NUMBER OF ITEMS                                   DOES> COUNT \ N TABLE COUNT                                     2DUP 2* +   \ N TABLE COUNT ENDTABLE                            TO NA       \ ! IF IN TABLE THEN JUMP AFTER TABLE               LW  SCAN 1+ ?DUP        \ ELSE CONTINUE                         IF 1- TO IX RDROP NA PUSH THEN ;                                                                                          : #. [AT] # . ;  \ PRINT NUM IN DECIMAL                         ( DEBUF LW LAST WORD  LA - LAST ADR  1A - FIRST ADR    )                                                                        : NEWLN CR TAB SPACES ;  \ NEWLINE WITH TAB SPACES                                                                                                                                                                                                                                                                              : NEWLN? 1L SWAP - OUTC -  0< IF NEWLN THEN  ;                                                                                  : #NAME CREATE DOES> PS         \ IN SECOND PASS TYPE A NAME        IF DUP IX INDSCAN DUP C@  NEWLN? ". SPACE THEN DROP ;                                                                       : TAB+ TAB + TO TAB ;           \                                                                                              \ : BWADR IX -IF BADR ;THEN WADR ;                                                                                              \ : WDADR IX 2- -IF WADR ;THEN S>D ;                                                                                             \ LOOP NAMES                                                                                                                                                                                                                                                                                                                                                                                    #NAME LUP. ," DO ," ?DO ," LOOP ," +LOOP ," FOR                 5 XSC LOOPS  ] (DO (?DO (LP (+LP (FOR                                    @BRAN LUP. ;M                                                                                                          ' LUP. @ 1+ STR +   CONSTANT  DOES-ADR                                                                                          \ STRINGS COMPILE ?                                             #NAME STRG. ," " ," ."  ," A"                                   : DOES? DUP C@ 232 = IF 1+ STR + DOES-ADR  - THEN ;                                                                             : /END LA ADR U< IF 1 TO EF THEN ;                                                                                                                                                                                                                                                                                              \ STRING OPERATION STRING LITERAL, TYPE STRING,                 \   OR ERROR MESSAGE                                            3 XSC STRG ' " 2+ @ ,   ' ." 2+ @ ,   ' A" 2+ @ ,  ]                    ADR TO HW  \ CURRENT ADDR TO HW  PREPARED FOR TYPE           BADR ADR +    \ ADDRESS AFTER STRING                            TO ADR /1PAS  \ ON 1 PASS ENOUGHT                               HW C@ NEWLN?  \ SHOW STRING ON 2 PASS                           STRG. HW ". 34 EMIT SPACE ;M                                                                                               \ SCAN ROUTINE                                                  : IX? BEGIN SCP HW - WHILE SADR IF 1 ;THEN  REPEAT 0 ;                                                                          \ FORWARD NAMES                                                 #NAME FWD. ," AHEAD ," IF  ," -IF  ," OF                                                                                                                                                        \ BACKWARD NAMES                                                #NAME BWD. ," AGAIN ," UNTIL ," -UNTIL                                     ," REPEAT ," ELSE ," BEGIN ," THEN                   4 XSC BRANC  ] (BR (0BR  (0BR  (OF                                @BRAN  PS -IF NA  !ADR                                          ;THEN  LW lit (BR -                                             0;   ADR 1- NA U< IF NEWLN FWD. 2 TAB+                          ;THEN  -2 TAB+ BWD. NEWLN                                     ;M                                                                                                                              : TBS! 2@ TO SCP TO HW ;                                                                                                        : TBS? TO IX 0                                                       BEGIN TO CSP IX?                                                WHILE  BWD. CSP 2+ REPEAT ;                                                                                               : THENS.  /1PAS      \ WORKS ON SECOND PASS                          AT FSTK TBS! IX? 0;                                             6 -2  LW lit (BR =   IF 2DROP                                   3 -4 ADR 1- NA    U< IF 2DROP                                   4  0 THEN THEN                                                  TAB+ NEWLN TO IX BWD.                                           6 TBS? CSP NEGATE TAB+ ;                                   : BEGINS.  /1PAS  AT BSTK TBS!  5 TBS? CSP TAB+ ;                                                                               : BEG?  ADR 2- 1A - ;    \ AT THE BEGINING ?                                                                                    : BEG. 1A ID.OK ;        \ NAME OF WORD  - IF EXIST                                                                              #NAME OTHER.  ," NEXT                                           1 XSC OTHER ]   (NEXT   OTHER. ;M                                                                                                           \   [',]   [TO]   [AT]              \ COMPILERS     #NAME COMP?. ," ', ," TO, ," AT,                                            \   [']   [ ' 2+ , ]    [ ' 4 + , ] \ LITERALS      #NAME LITW?. ," \0+ ," \2+          ," \4+                                                                                     : IMMED? LW WORD? 129 - IF LW ID.OK ;THEN  LW C>N 1- 2/ TO IX         COMP?. ID. ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               : SPEC                                                             lit ;code LW =                                                    IF ADR DOES?                                                      -IF 3 AT ADR +! /1PAS ." DOES> "                                ;THEN  /END                                                   THEN                                                            lit [ ' INTERPRET 4 + @ , ]                                     LW @ = IF /END THEN                                             PS 0;                                                           IMMED?                                                          7  NEWLN? ;                                                                                                                                                                                                                                                                                                                                                                               : ;REM. ." ( " EX ." ) " ;  : ;INT. ." [ " EX ."  ] " ;         : LIT. NA #. 31 NA < 0;  C" ) NA - 0;                            ;REM.  NA 33 127 WITHIN IF C" ` EMIT NA EMIT ;THEN NA ID.OK ;  \       NA .  ;REM. NA ID.OK ;M                                                                                                  #NAME COMPB. ," blit ," BCOMPILE                                2 XSC COMPB ] blit BCOMPILE   BADR TO NA  /1PAS                  IX IF COMPB. ;INT. NA #. ." C," ;THEN    LIT. ;M                                                                              #NAME COMP. ," COMPILE                                            1 XSC COMP ] COMPILE WADR TO NA /1PAS                         \   NA WORD? ?DUP IF 1- 2/ OVER C@ 128 AND                      \   IF TO IX COMP?. ID. ;THEN COMP. DROP NA ?ID. ;THEN              COMP.  ;INT. NA #. ." ," ;M                                 #NAME NLIT. ," lit  1 XSC NLIT ] lit WADR TO NA /1PAS LIT. ;M                                                                    #NAME STARTS.                                                       ," ->:   ," :TR-  ," :   ," :1                                  ," :2     ," :3    ," :4                                                                                                    7 XSC STARTS                                                       '@, QUIT  '@, EXPECT   '@, XSC    1-,                           1-,          1-,         1-,                                  ]  BEG? 5 U< -IF /END THEN                                         /1PAS  STARTS.  BEG? -IF BEG. THEN ;M                                                                                       ( PROBA ID.OK     )                                             #NAME /END. ," EXIT ," ?TR;  ," ;4TH                                                                                            3 XSC ENDS ] EXIT  TO EX  ;4TH \  EXIT ?                            /END  /1PAS  EF IF ." ; "  ;THEN /END. ;M                                                                                   : 1I             \ DECOMPOSE 1 INSTRUNCTION                         THENS.       \ IF, -IF, OF, ELSE, WHILE,  ENDS?                 BEGINS.      \ START OF LOOP  ? ON THIS ADDRESS                 WADR TO LW   \ GET WORD  -> LAST WORD                           STARTS       \ IS IT STARTING WORD ?                            OTHER  COMPB  COMP  STRG  \ IS IT STRING WORD ?                 NLIT     LOOPS   \ NUMBERS  \ CICLES                            ENDS   BRANC  SPEC ; \ IMMEDIATE WORDS  ( COMPILING ?)                                                                          ( -HEADERS OFF )                                           | : PAS TO PS    \ PASS NUMBER 0\1                                  1A TO ADR   \ START ADR -> OPERATION ADR                         0 TO EF    \ 0 -> END FLAG                                     -1 TO LW    \ -1 -> LAST WORD - NO SUCH WORD                    BEGIN 1I EF UNTIL ;                                                                                                          : @HACK DECIMAL CR TO 1A    \ FIRST ADDRESS                       FEMIT IF ;EMIT ;CR THEN  \ REDIRECTION OF STD OUT               0 TO TAB                  \ NO TABULATION                       0 TO LA                   \ LAST ADDRES NOT FOUND YET           PAD 1K 2* +  DUP 1K + DUP \ EMPTY  FORWORD'S STACK              AT BSTK 2! DUP AT FSTK 2! \ EMPTY BACKWORD'S STACK              1A @ DOES?                \ IS IT A DOES> ? CHILD               -IF 1A ID.OK ;THEN        \   YES                               0 PAS 1 PAS ;             \ NO -> LET'S  HACK IT                                                                              | : @@@ CREATE C, DOES> C@ ' + @HACK ;   \ FLAT HACK 0CFA         0 @@@ HACK   2 @@@ 'HACK   4 @@@ "HACK \ 1CFA 2CFA                                                                            : >ADR  ADR @HACK ;    \ CONTINUE HACKING ON ADR                                                                               \ PRUNE                                                          MARKER -HAK   -HEADERS                                                        CREATE ;CR   CREATE ;EMIT                           ' IOV @  1 NM: @2+! ! ;M 2 NM: 2-!@ @ ;M 3 MAKER STACK> ,       ' IOV @  1 NM: 2-!@ ! ;M 2 NM: @2+! @ ;M 3 MAKER <STACK ,    <N  ' <N ALIAS <%   ' N> ALIAS %>                               : -IF COMPILE 0= [',] IF ; IMMEDIATE                            N>                                                                179 194 THRU          0 TO FEMIT                                PRUNE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         MARKER -WORD?    : ;NIP EX NIP ; : N>L@ N>C 2- @ ;              : WORD1? DUP  \ ADDR ADDR                                               C>N  \ ADDR ANAME FLAG / ADDR FLAG                              DUP  \ ADDR ANAME FLAG FLAG / ADDR FLAG FLAG                   IF 1- SWAP PUSH - POP CSTR 127 AND + 2+ =                ;THEN NIP ;                                                     : NAME-OK? SWAP C@ TUCK OR 129 AND SWAP 96 AND 0= AND ;         : WORD? C>N DUP IF OVER N>C 2- @ PUSH NAME-OK?                                 R@ 0= IF RDROP ;THEN  \ KRAJ NA SPISAK               POP N>C C>N DUP  IF ( F A 1/ F 0) NAME-OK?  ( F F)                               IF ;THEN DROP 0 ;THEN NIP THEN ;           : NAME? C>N DUP 0; SWAP C@ TUCK OR 129 AND SWAP 96 AND 0= AND ; : WORD2? DUP ;NIP NAME? DUP 0; SWAP C> N>L@ 0;                        SWAP N>L@ N>C NAME? DUP 0; SWAP ;                         : WORD2 0 -1 FOR R@ WORD2? IF 1+ THEN NEXT ;                                                                                    MARKER -SEE  0 VALUE WADR                                       | : ;WADR WADR EX TO WADR ;                                     : @BYTE ;WADR C@+ ;                                             | : .ADR SPACE DUP H. SPACE ?ID. ;                              : @STR  ;WADR DUP CSTR + ;                                      : $>' [AT] $ N>" ">' ;                                          : '@, ' @ , ;                                                   | : ONB @BYTE $>' ;                                             : @WORD ;WADR @+ ;                                              | : ONW @WORD $>' ;                                             <N  ' @STR ALIAS ONS N>                                         | : .STR? CREATE , DUP C, FOR , NEXT DOES> STR lit [ >MARK ] !    CSTR WADR 2- @ SCAN 1+ IF [ SWAP ] THEN NOP ". RDROP THEN ;   : WW CR WADR .ADR C" | EMIT @WORD .ADR ;                        | ' A" 2+ @  ' " 2+ @ ' ." 2+ @  3 ' ONS .STR? ?STR                                                                             | HEADER ?BYTE '@, ?STR ', ONB 3 C, ] BCOMPILE blit ;code [     | HEADER ?WORD '@, ?STR ', ONW 10 C, ] COMPILE lit (BR (FOR                                    (DO (?DO (0BR (LP (+LP (OF [     | : UNITS? U/MOD SWAP IF 1+ THEN ;                              | : 1W WW ?WORD ?STR ?BYTE ;                                    : L bs FOR 1W NEXT ;                                            | : D8 bs FOR @BYTE .H NEXT SPACE ;                             : DU CR WADR H. D8 D8 WADR 1H - 1H TYPE ;                       : @SEE TO WADR L ;                                              : DUMP SWAP TO WADR 1H UNITS? FOR DU NEXT ;                     : SEE ' @SEE ; PRUNE                                                                                                                                                                                                                                                                                                                                                                            \ MARKER -HAK                                                   \ 18 LOAD                                                          ' IOV @  1 NM: @2+! ! ;M 2 NM: 2-!@ @ ;M 3 MAKER STACK> ,       ' IOV @  1 NM: 2-!@ ! ;M 2 NM: @2+! @ ;M 3 MAKER <STACK ,    \ : CNTDO OVER + SWAP ;                                         <N  ' <N ALIAS <%   ' N> ALIAS %>                               : -IF COMPILE 0= [',] IF ; IMMEDIATE                            N>                                                              \  FLOAD HACK.TX                                                \ : LOAD DUP CR .. BIOS-KEY LOAD ;                              \ : THRU 1+ SWAP DO I LOAD LOOP ;                                                                                                 179 194 THRU                                                  \ PRUNE                                                                                                                                                                                         MARKER -SEE  \ FORTH CODE VIEWER                                 0 QUAN WADR Z, | : ;WADR WADR EX TO WADR ; : @BYTE ;WADR C@+ ; | : .ADR SPACE DUP H. SPACE ?ID. ;  : @STR  ;WADR DUP CSTR + ;  : $>' [AT] $ N>" ">' ; : '@, ' @ , ; | : ONB @BYTE $>' ;        : @WORD ;WADR @+ ; | : ONW @WORD $>' ; <N  ' @STR ALIAS ONS N>  | : .STR? CREATE , DUP C, FOR , NEXT DOES> STR lit [ >MARK ] !    CSTR WADR 2- @ SCAN 1+ IF [ SWAP ] THEN NOP ". RDROP THEN ;                          : WW CR WADR .ADR C" | EMIT @WORD .ADR ; | ' A" 2+ @  ' " 2+ @ ' ." 2+ @  3 ' ONS .STR? ?STR             | HEADER ?BYTE '@, ?STR ', ONB 3 C, ] BCOMPILE blit ;code [     | HEADER ?WORD '@, ?STR ', ONW 10 C, ] COMPILE lit (BR (FOR     (DO (?DO (0BR (LP (+LP (OF [ | : UNITS? U/MOD SWAP IF 1+ THEN ; | : 1W WW ?WORD ?STR ?BYTE ; : L bs FOR 1W NEXT ;                ' ?STR @ AT WADR 2+ ! | : D8 bs FOR @BYTE .H NEXT SPACE ;      : DU CR WADR H. D8 D8 WADR 1H - 1H TYPE ;  : @SEE TO WADR L ;   : DUMP SWAP TO WADR 1H UNITS? FOR DU NEXT ; : SEE ' @SEE ; PRUNE( DO A CALL  CALL A DOS FUNCTION   PERFORM INTERRUPT  #       ) 0 VALUE RAX  0 VALUE RBX  0 VALUE RCX  0 VALUE RDX  0 VALUE RFL                                                                 CREATE _INT HEX   ASM  21 #, INT, RET,   END-CODE               CODE _CALL BX DI MOV, ' RFL 4 + /// PUSH, POPF,                 ' RAX 4 + /// AX MOV, ' RBX 4 + /// BX MOV, ' RCX 4 + /// CX    MOV,  ' RDX 4 + /// DX MOV,  DI CALL,  AX ' RAX 4 + /// MOV,    BX ' RBX 4 + /// MOV,  CX ' RCX 4 + /// MOV,   DX ' RDX 4 + /// MOV,  PUSHF,  ' RFL 4 + /// POP,    BX POP, NEXT,   END-CODE    : DO_INT [ _INT 1+ ] LITERAL C! _INT _CALL ;                    : DO_DOS 21 DO_INT ;                                            : FCUT ( SCR) 1K M* TO RCX TO RDX  4200 TO RAX SCRH TO RBX         DO_DOS 0 TO RCX 4000 TO RAX DO_DOS ;                         DECIMAL                                                                                                                                                                                         MARKER -TARG  ONLY   VOCABULARY COMP    COMP ALSO                 VOCABULARY ROOT    ROOT ALSO   TO FORTH                       : <% THERE 2@ dA HERE THERE 2! TO HERE TO dA ; ' <% ALIAS %>    : >NS: CURRENT PUSH TO HIDDEN <N EXEC N> POP TO CURRENT ;       <N  : CONST CONSTANT IMMEDIATE DOES> @ [',] LITERAL ; N>        : C: ['] CONST >NS: ;    : L: HERE C: ;  : CODE, HEADER , ;     HERE 16 ALIGN DUP TO HERE   12000 CLARY HERE CONSTANT TEND        CONSTANT TSTART                        0  TSTART   THERE 2!    : ?TADR THERE 2@ SWAP - ;  TO ROOT  <%   102 109 THRU          TO COMP   ' EXIT @ HEADER X ,  0 ' X 3 - C! IMMEDIATE  %>                                                                                                                                                                                                                                                                                                                                                                                                       MARKER -SPECIAL                                                 : 'PFA ' 2+ ;  : ;! EX ! ;  : IS ;! 'PFA ;                      : META ' IS ;  : ?META 'PFA @ ?ID. ;  \ : META! @R+ @R+ ! ;     : -META AHEAD [ HERE ' META @ , SWAP ] @R+ @R+ ! ;THEN                  COMPILE [ , ] 'PFA STR , 2- , ; IMMEDIATE                                                                               ' (0BR ((  ?IF         CR ?META ?IF                             : RESTORE_IMM    -META ?IF ;                                      META (BR ?IF         CR ?META ?IF                                                                                               RESTORE_IMM          CR ?META ?IF                                                                                             : VPUSH ALSO ' DUP  @ lit [ ' FORTH @ , ]  XOR A" VOC?"          EXEC DEFINITIONS ;  : VPOP ORDER# @ 0; PREVIOUS DEFINITIONS ;                                                                                                                                  L: >BSTR=  255 #, CX MOV,         L: >LSTR= LODSB, AX CX AND,     CL 0 /DI CMP,  0=, IF, DI INC,  L: >STR=  REP: CMPSB,           0=, NOT, IF,  CX SI ADD,  THEN,  THEN,  RET,                  L: >FIND  -2 /BP BP LEA, SI 0 /BP MOV,                          BEGIN,  BEGIN,  SI POP,  SI INC, 0=, IF,                            DUP, AX SI XCHG, ?, J, 8 THEN,  SI DEC,  0=, NOT, UNTIL,      BEGIN, CX POP,  SI CX CMP, 0=, NOT, UNTIL,  CX PUSH,            BEGIN, BX DI MOV, 31 #, CX MOV, >LSTR= #, CALL,                   0=, IF,  $ 20 #, AL TEST,  0=, J, 7 THEN,                       0 /SI SI MOV, SI SI OR,                                       0=, UNTIL,                                                    AGAIN,  FB: 7   BEGIN, CX POP, CX INC, 0=, UNTIL,                  SI INC,  SI INC,  SI PUSH,  CBW,  STC,  AH AL MOV,              1 #, AX RCL,  FB: 8  AX BX XCHG, >UNNEST JMP,                                                                                                                                                 X_FIND:                                                           MOV   DX,SI                                                   @@1:                                                              pop   si                                                        inc   si                                                        jne   @@2                                                       push  bx                                                        xchg  ax,si                                                     jmp   short @@8                                               @@2:                                                              dec   si                                                        je    @@1                                                     @@3:                                                              pop   cx                                                        cmp   si,cx                                                     je    @@3                                                       push  cx                                                      @@4:                                                              mov   di,bx                                                     mov   cx,31                                                     call  _strequ1                                                  jnz     @@5                                                     test    al,20h                                                  jz      @@7                                                   @@5:                                                              mov     si,[si]                                                 or      si,si                                                   jnz     @@4                                                     jmp     short @@1                                                                                                                                                                                                                                             @@7:                                                              pop   cx                                                        inc   cx                                                        jne   @@7                                                       inc     si                                                      inc     si                                                      push  si                                                        cbw                                                             stc                                                             mov   al,ah                                                     rcl   ax,1                                                    @@8:                                                              MOV   SI,DX                                                     SWAPREG       ; _FIND_                                                                                                                                                                        _strequ:                                                          mov   cx,255                                                  _strequ1:                                                         lodsb                                                           and     cx,ax                                                   cmp     cl,[di]                                                 jne     _l5                                                     inc     di                                                    _strcmp:                                                          repe    cmpsb                                                   jz      _l6                                                   _l5:                                                              add     si,cx                                                 _l6:  ret                                                                                                                                                                                      MARKER -LOCALS   \ LOCALS                                         0 QUAN FPTR    0 VALUE #V   M: COM 2* FPTR + ;M  TO #V          M: AT #V @ ;M   ' #V !       M: AT #V ! ;M    ' #V 2+ !       : RETURN FPTR RP!  POP TO FPTR ; : >NEXT N>C 2- @ DUP 0 TO #V ; : LOCALS UNPACK OVER +  FPTR XCHG RP@ TO FPTR  SWAP AT #V RP!            PUSH   FOR R@ TO #V NEXT  EX RETURN ;                  : LL  6 LOCALS  0 #V . 1 #V .  2 #V .  3 #V . 4 #V .  5 #V . ;  : WORD2? C>N DUP 0= ?DUP  3  LOCALS  2 #V IF 0 ;THEN              [ >MARK ]  DUP 0; 0 #V >NEXT 0; [ >MARK ]                     0= 0;  DUP XOR ;THEN                                            THEN DO: 0 #V C@ DUP 159 AND SWAP 96 AND 0= AND DUP 2 TO #V ;   : WORD2 0 -1 FOR R@ WORD2? IF 1+ THEN NEXT ;                                                                                                                                                                                                                                                                                    \ TO MEMORY  OR .. TO BLOCK FILE                                VARIABLE DISKPOS  Z,   243 1K M* DISKPOS 2!  VARIABLE LASTC     : LASTC@ LASTC @ UNPACK ; : LASTC! LASTC@ DROP PACK LASTC ! ;   : M+! PUSH S>D R@ 2@ D+ POP 2! ;  0 VALUE CPOS                  : DO_CR CPOS 1L 1- OR 1+ CPOS -   DISKPOS M+! ;                 : BLOCK_EMIT DUP LASTC! DISKPOS 2@ 1K  \ WHAT & WHERE TO WRITE       UM/MOD BLOCK  OVER TO CPOS OVER   \ POSITION IN BLOCK           0= IF DUP 1K BLANK THEN + OVER    \ ERASE NEW BLOCK             cr OF DROP DO_CR EXIT ELSE                                      lf OF LASTC@ NIP cr - IF DO_CR THEN DROP EXIT ELSE              SWAP  C!  1 DISKPOS M+!  THEN THEN UPDATE ;                : ;EMIT ['] BLOCK_EMIT TO 'EMIT MIO EX SIO ;  : ;CR CR EX CR ;                                                                                                                                                                                                                                                                                                                                                                                                   : FOUND HERE OVER AT -TEXT 0= ;                                 : WORD. DUP H. ID. ;                                            : VOC. 2- C>N DROP WORD. ." :" ;                                                                                                : VOCS. VOCLINK                                                    BEGIN ?DUP                                                      WHILE DUP 2-  VOC.                                                  @                                                           REPEAT                                                       ;                                                                                                                                                                                                         -->                                                                                                                   : WORDS.  DUP                                                       BEGIN @ ?DUP                                                    WHILE FOUND IF 2DUP WORD. VOC. THEN                               N>C 2-                                                        REPEAT                                                          DROP                                                        ;                                                                                                                               : ALL-WORDS. VOCLINK                                               BEGIN ?DUP                                                      WHILE DUP  2- WORDS.                                                  @                                                         REPEAT                                                       ;                                                                            -->                                                                                                               FORGET ?IN  VOCABULARY TEMP                                                 TO HIDDEN 51 LOAD  FORTH TO MACROS >LIST            TO HIDDEN    210 LOAD  199 LOAD                                 VARIABLE WCOUNTER    0 VALUE F-DO  \ : '@, ' @ , ;              : WORD. DUP H. ID. WCOUNTER 1+! ;                               : VOC. 2- C>N DROP WORD. ." :" ;                                \ : DO-HACK WADR 2- ?ID. ;                                      CREATE STARTING  3 C, '@, :  '@, QUIT  '@, (-FIND               \ : FOUND N>C DUP @ STARTING CSTR ROT SCAN 1+ IF DUP ?ID. THEN ;: FOUND N>C DUP @ STARTING CSTR ROT SCAN 1+                           IF WCOUNTER 1+! DUP @HACK THEN ; : ;DROP EX DROP ;        \ : WORDS. ;DROP BEGIN @ DUP WHILE DUP WORD. N>C 2- REPEAT ;    : WORDS. ;DROP BEGIN @ DUP WHILE FOUND 2- REPEAT ;              : ALL-WORDS. VOCLINK BEGIN ?DUP IF DUP 2- WORDS. @ REPEAT ;     : VOCS. VOCLINK BEGIN ?DUP WHILE DUP 2- VOC. @  REPEAT ;        ALL-WORDS.                                                       VARIABLE -NAMES        : | 1 -NAMES ! ;                        : HEADERS -NAMES OFF ;  : -HEADERS -NAMES ON ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \ NUMBERS OUT                                                   : S>D DUP 0< ;  : SPACES FOR SPACE NEXT ;                       : <# NUM2 2! 0 ;  : #> FOR EMIT NEXT ;  : HOLD SWAP 1+ ;        : M/MOD TUCK U/MOD PUSH SWAP UM/MOD POP ;                       : 1# NUM2 2@ BASE M/MOD NUM2 2! ALPHA HOLD ;                    : S# BEGIN 1# NUM2 2@ OR 0= UNTIL ;                             : D# IF DABS <# S# 45 HOLD EXIT THEN <# S# ;                    : D.R PUSH D# POP OVER - SPACES #> ;  : D. S>D 0 D.R SPACE ;    : . S>D D. ;  : .R PUSH S>D S>D POP D.R ;  : U.R 0 0 ROT D.R ;  : UD. <# 1# S# #> SPACE ;  : UD.R 0 SWAP D.R ;                  : .DH BASE PUSH HEX UD. POP TO BASE ;                           : .. BASE PUSH DECIMAL 6 U.R POP TO BASE ;                      : .H 0 .DH ;                                                                                                                                                                                                                                                    : forget DUP FENCE U< A" fence !" PUSH BEGIN VOCLINK @ ?DUP       R@ U< 0=    IF @ VOCLINK !  REPEAT VOCLINK BEGIN DUP 2-           BEGIN @ DUP R@ U< 0=  WHILE N>LINK  REPEAT                   OVER 2- ! @ ?DUP 0= UNTIL   FORTH TO FORTH POP TO HERE DROP ;  : FORGET ' C>N DROP forget ;                                    : PRUNE VOCLINK                                                 BEGIN DUP PUSH V>LINK                                             BEGIN @ DUP HERE U< 0= WHILE N>LINK  REPEAT                     DUP R@ V>LINK ! ?DUP                                            IF DUP PUSH                                                       BEGIN  N>LINK @ ?DUP  WHILE                                       DUP HERE U< IF DUP POP N>LINK ! DUP PUSH THEN                 REPEAT 0 POP N>LINK !                                         THEN POP @ ?DUP 0=                                            UNTIL -HEAD AT HIDDEN OFF ;                                                                                                     : WORDS CR 10 TO CSP CONTEXT -1 0 DO @ ?DUP                     IF DUP C@ #LEN AND 6 + OUTC + 80 < 0=                             IF CR CSP ?DUP                                                    IF 1- TO CSP                                                      ELSE 10 TO CSP KEY LOW 27 =                                     IF DROP I " LISTED" LEAVE                                       THEN THEN THEN DUP H. DUP ID. 1H OUTC OVER MOD ?DUP  0=     IF DUP                                                          THEN - DUP 13 < 0=                                              IF DROP 1                                                       THEN OUTC 64 < 0=                                               IF 1-                                                           THEN SPACES N>C 2-                                              ELSE CR I " TOTAL" LEAVE                                      THEN LOOP ". ."  WORDS = " . ;                                                                                                  \ BLOCK                                                         | : ;ERR EX PREV 2+ 1+ DERR A" IO-BLK ?" ;                      | : +BUF B/BUF + DUP LIMIT =  IF DROP FIRST  THEN DUP PREV - ;  | : ?SAVE BSTR IF DUP STR WBLK 0 OVER 1- C! THEN ;              : SAVE-BUFS LIMIT FIRST ?DO I ?SAVE DROP B/BUF +LOOP ;          : BUFFER USE DUP BEGIN +BUF UNTIL                                         TO USE DUP TO PREV ?SAVE !+ ;                         : BLOCK ;ERR PUSH PREV 1+ @ R@ -  IF PREV BEGIN +BUF 0=             IF DROP POP BUFFER 2- STR RBLK ;THEN                                 DUP 1+ @ R@ = UNTIL   TO PREV  THEN RDROP ;            : EMPTY-BUFS FIRST LIMIT OVER - ERASE FIRST DUP                     TO PREV TO USE  LIMIT FIRST DO -1 I 1+ ! B/BUF +LOOP ;      : FLUSH SAVE-BUFS EMPTY-BUFS ;                                  : USING FLUSH -USE FOPEN TO SCRH ;                                                                                                                                                              \ TYPE , TYPE+ , STYPE , ID. , ?ID. , 'ERROR & DEBUG            : ;DROP EX DROP ;   : ;SPACE EX SPACE ;  : (STR DUP CSTR + ;    : TYPE+ FOR CSTR ?EMIT NEXT ; : TYPE ;DROP TYPE+ ;              : STYPE CSTR TYPE ; : ID. ;SPACE CSTR 31 AND TYPE ;             : CR cr EMIT lf EMIT 0 TO OUTC ;  0 VECTOR 'ERROR               : (." POP CSTR TYPE+ PUSH ;  : (" POP (STR PUSH ;               : (ERROR CR HERE ID. BLK TO SCR >IN TO CSP STYPE CR ;           : (A" POP SWAP IF 'ERROR  ABORT THEN CSTR + PUSH ;                                                                              HERE 2- >MARK >MARK >RELEASE ," AT >RELEASE ," TO               CONSTANT TO_AT    : 2H. 2DUP H. H. ;                            : ?ID. C>N ?DUP 0; 1- ?DUP IF TO_AT + @ ID. THEN ID. ;                                                                          : (DEBUG 2H. PUSH PUSH 2H. POP POP SP@ H. RP@ H.  R@ H. ?SI         -@ DUP @ H. H. H. HERE H. ?AX ?ID ;                                                                                         \ BASE HEX  DECIMAL BINARY &  ;BASE                             \ : EX POP POP SWAP PUSH PUSH ;  MAC: XCHG POP SWAP PUSH ;     `                                                                : ;BASE BASE XCHG PUSH TO BASE EX POP TO BASE ;                                                                                   0 NM: C@ (BR TO ;BASE ;M                                        1 NM: C@ ;BASE ;M                                               2 NM: C@ TO BASE ;M                                           |     (3  >BASE C,                                                16  >BASE HEX                                                   10  >BASE DECIMAL                                                2  >BASE BINARY                                                                                                              EXIT                                                            : PRIMER_2_BASE AT BINARY . ;  : HD. AT HEX D. ;  : H. 0 HD. ;                                                                  \ COMPILER STUFF                                                : ODD? 1 AND ;                                                  | : ;HERE HERE EX TO HERE ;                                     : C, ;HERE C!+ ;                                                : , ;HERE !+ ;                                                  : ALLOT ;HERE + ;                                               : RECOVER ;HERE 2- ;                                            : RECOVER1 ;HERE 1- ;                                           : ALIGN ;HERE DUP ODD? + ;                                      : B, CSTR C, ;                                                  : W, STR , ;                                                    : ;,  EX , ;                                                    : CLARY HERE OVER ERASE ALLOT ;                                 : Z, 0 , ;                                                      : ZC, 0 C, ;                                                                                                                    : COMPILE POP W, PUSH ;                                         : BCOMPILE POP B, PUSH ;                                        : >MARK HERE Z, ;                                               : >RELEASE HERE SWAP! ;                                         : WORD, C@ 1+ ALLOT ;                                           : /LOOP , >RELEASE ;                                            : LOOP/ >MARK HERE ;                                            : ;code POP CFA ! ;                                             : '@, ;, ' @ ;                                                  : ', ;, ' ;                                                     : <N> NPTR HERE TO NPTR TO HERE ;                               VARIABLE -HEADS                                                 : STR, FOR B, NEXT DROP ;                                                                                                                                                                                                                                       : BLWORD bl WORD ;                                              : LINK+ HERE @SWAP , ;                                          : HEAD CURRENT LINK+ BLWORD WORD, ;                             | : ;CFA! -HEADS 0 @SWAP DUP EX TO CFA -HEADS ! ;               DEFER ALIAS                                                     : HEADER ;CFA! IF 1- HERE DUP <N> ALIAS <N> ;THEN HEAD HERE ;   | : ,N 1+ HEADER Z, FOR , NEXT ', ;                             | : ,W HEADER FOR W, NEXT PERFORM ;                             : (0 0 ,N DOES> W, PERFORM ;                                    : (1 0 ,N DOES> 1 ,W ;                                          : (2 1 ,N DOES> 2 ,W ;                                          : (3 2 ,N DOES> 3 ,W ;                                                                                                                                                                                                                                                                                                          : SPACES FOR SPACE NEXT ;                                       : S>D DUP 0< ;                                                  : ", C@ 1+ ALLOT ;                                              : LATEST CURRENT @ ;                                            : ?CODE HERE SWAP RCALL, \, ] ;                                 : ;code POP CFA ! ;                                             : NM: >DOES SWAP - ?CODE ;                                      : M: >F: ?CODE ;                                                : DOES> COMPILE ;code >DOES RCALL, ;                            : STR, FOR B, NEXT DROP ;                                       : ,S" HERE C" " WORD ", ;                                       : ". CSTR TYPE ;                                                : ," BLWORD ", ;                                                : 0" HERE 2+ :1260 ZC, 1+! ;                                                                                                                                                                    : ODD? 1 ADD ;        : ALIGN2 ;HERE DUP ODD? ;  : ', ' , ;     : RECOVER ;HERE 2- ;  : ALLOT ;HERE + ;                         : B, CSTR C, ;                                                  : W, STR , ;                                                    : MAKER CREATE COM 3 AND 2* DUP C, :12CA , , , ' , DOES> CSTR   HEADER :12CA W, W, W, PERFORM ;                                 \ : (( CREATE , , IMMEDIATE DOES> STR , PERFORM ;               \ : 2^? DUP 0; DUP 1- AND 0= ;                                  \ : ;XY XY EX 1K 1- AND TO XY ;                                                                                                 : ," BLWORD ", ;                                                : CSTR, DUP C, STR, ;                                           : ( `) WORD ". ;                                                : Z" HERE 2+ \, " ZC, 1+! ;                                                                                                                                                                     : "MOVE OVER C@ 1+ MOVE ;                                       : CSTR, DUP C, STR, ;                                           : .( 41 WORD ". ;                                               : HOME 0 0 GOTOXY ;                                             : PAGE (CLSC HOME ;                                             : WCOUNT STR ;                                                  : COUNT CSTR ;                                                  : U/MOD 0 SWAP UM/MOD ;                                         : M/MOD TUCK U/MOD PUSH SWAP UM/MOD POP ;                       : ORDER. ORDER# WCOUNT FOR WCOUNT 6 - ?ID. NEXT DROP ;          : -USE SCRH 1+  IF SCRH CLOSE DROP -1 TO SCRH THEN ;            : .LINE .. SPACE 1L TYPE ;                                      : LIST DUP TO SCR BLOCK .BLOCK ;                                : .BLOCK CR SCR SPACE 213 EMIT ..                                    1H 0 DO CR DUP I .LINE 1L     + LOOP DROP ;                                                                                : '0+ -FIND ?DUP 0= A" ?" ;                                     : ' '0+ DROP ;                                                  : FIND ROT PUSH -1 -ROT FOR STR                                         @ SWAP NEXT DROP CONTEXT @ POP (find TO ?, ;            : (-FIND BLWORD ORDER# STR FIND ;                                                                                               : ALIAS THEAD COMPILE :54D , ;                                  : <N> NPTR HERE TO NPTR TO HERE ;                               : THEAD 'SAME CURRENT HERE @SWAP BLWORD ", , ;                  :TR- HEADER TO N>C ?DUP                                         IF 1- AT N>C HERE TO CFA <N> CFA ALIAS <N> ?TR;                 THEN THEAD HERE TO CFA ;                                        : CREATE HEADER COMPILE :277 ;                                                                                                                                                                                                                                  : BLWORD bl WORD ;                                                                                                              :TR- WORD BLK NBLK >IN HERE (WORD TO >IN ;                                                                                      : MARKER     ?IN -FIND NIP                                                IF ?IN FORGET THEN     CREATE                                     DOES> 2- C>N DROP forget ;                                                                                          : ?IN @R+ >IN PUSH ?EXEC POP TO >IN ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           : EXPECT 2DUP TO (DO ?DO BEGIN KEY LOW DUP I C! bl U< 0=          IF I C@ EMIT 1  ELSE I C@ cr    OF I ROT - LEAVE  THEN          bs  OF OVER I - UNTIL                                           bs DUP EMIT SPACE EMIT -1  ELSE DROP 0                          THEN THEN +LOOP TO SPAN DROP ;                                                                                                : ;RBUF POP RP@ ROT - RP@ OVER RP! PUSH SWAP PUSH EX                    POP RP!    ;                                            : ;TI POP BLK PUSH >IN PUSH TIB PUSH PUSH EX                            POP TO TIB POP     POP TO PERFORM ;                     : LOAD ;TI 0 SWAP TO PERFORM INTERPRET ;                        : EVAL ;TI 0 TO PERFORM 0 TO TIB INTERPRET ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    : RESCAN >IN -FIND ROT TO >IN NIP 0;                                      CR HERE ". ."   EXIST ! " BLK  1- 0>= 0;                        ." IN BLK " BLK . ;                                                                                                   : FOPEN BLWORD 1+ OPEN DUP 0< A"  OPEN ERROR " ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                : TRACE ' TR EXEC -TR ;                                         : -HEAD EDGE TO NPTR HEADERS ;                                  : PAGE (CLSC HOME ;                                             : WITHIN OVER - PUSH - POP U< ;                                                                                                 : THRU 1+ SWAP ?DO I LOAD LOOP ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                : LASTC@ LASTC @ UNPACK ;                                       : LASTC! LASTC@ DROP PACK LASTC ! ;                             : M+! PUSH S>D R@ 2@ D+ POP 2! ;                                : DO_CR CPOS 1L 1- OR 1+ CPOS - DISKPOS M+! ;                   : BLOCK_EMIT DUP LASTC! DISKPOS 2@                                  1K UM/MOD BLOCK OVER TO CPOS  OVER 0=                       IF DUP 1K BLANK  THEN + OVER cr  OF DROP DO_CR EXIT   ELSE       lf  OF LASTC@ NIP cr -   IF DO_CR THEN DROP EXIT  ELSE              SWAP C! 1 DISKPOS M+! THEN THEN UPDATE ;                   : ;EMIT ['] BLOCK_EMIT TO 'EMIT MIO EX SIO ;                    : VTYPE ;EMIT TYPE ;                                            : VCR ;EMIT CR ;                                                : ;VCR VCR EX VCR ;                                                                                                                                                                                                                                             : WORD BLK NBLK >IN HERE (WORD TO >IN ;                         : BLWORD bl WORD ;                                              : SEVAL ;TI TO BLK IO! 90 ;RBUF TO TIB TO OPEN                        BEGIN 1LINE        EOF? 0< UNTIL  TO OPEN ;               :- KBD 0 SEVAL IO! ;                                            : FLOAD HANDLES bs - 0= A"  TOO MUCH FILES "                            FOPEN TO HANDLES   -1 SEVAL IO! ;                                                                                       ->: QUIT KBD QUIT ;                                                                                                             : CLOSALL BEGIN HANDLES  0;  AT CLOSE  AGAIN ;                  ->: (INT -FIND ?DUP  IF ?, (INT  THEN NUM ?LITERAL (INT ;                                                                                                                                                                                                                                                                       : FOPEN BLWORD 1+ OPEN DUP 0< A"  OPEN ERROR " ;                : TYPE FOR CSTR ?EMIT NEXT DROP ;                               : ( C" ) WORD DROP ;                                            : CR cr EMIT lf EMIT 0 TO OUTC ;                                : OK? BLK IF EX CR ;THEN      ."  Ok" CR EX SPACE ;             : REFILL TIB 80 EXPECT 0 TO >IN TIB SPAN + OFF ;                : 1LINE OK? REFILL EX INTERPRET ;                               : IO! BLK COM IF SIO EXIT THEN FIO ;                            : EXECUTE PUSH ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                : VOCABULARY TO FORTH MAKEVOC VOCLINK LINK+ ;                   : DEFINITIONS CONTEXT TO CURRENT ;                              : ALSO CONTEXT TO ORDER# ;                                      : PREVIOUS AT ORDER# TO CONTEXT ;                               : <N> NPTR HERE TO NPTR TO HERE ;                                                                                               : THEAD 'SAME CURRENT HERE @SWAP BLWORD ", , ;                  : HEADER -NAMES @ DUP                                           IF 1- -NAMES ! HERE TO CFA <N> CFA ALIAS <N> ;THEN                   THEAD HERE TO CFA ;                                        : FIND ROT PUSH -1 -ROT FOR STR @ SWAP NEXT                            DROP CONTEXT @      POP (find TO ?, ;                    : (-FIND BLWORD ORDER# STR FIND ;                               : * M* DROP ;                                                                                                                                                                                   L: >WBLK  $40 #, CH MOV,      0 #, AX MOV,    RECOVER           L: >RBLK  $3F #, CH MOV,   1024 #, AX MOV,     AX  PUSH,             CX PUSH,    BX MUL,       AX DX XCHG,   AX CX XCHG,                $4200 #, AX MOV,  SCRH /// BX MOV,          DOS,        L: >DOS  DI POP,  CX POP,  DX POP,                                 U<, NOT, IF,  DI AX  MOV,   DOS,  THEN,                                CS PUSH,  ES  POP,   >DERR 2+  #, DI MOV,              U<, IF,  AX -2 /DI MOV, THEN,  STOSW,   BX AX XCHG,  STOSW,        CX AX XCHG,  STOSW,  DX AX XCHG,  STOSW,  >DROP JMP,                                                                        L: >SCANI  AX POP, AX SI XCHG, CX CX XOR, CX BX XCHG, CXNZ, IF,            BEGIN  0 /SI BL MOV,  1 X/S SI LEA,  CXNZ, UNTIL,    THEN,  SI AX XCHG, >SWAP JMP,                                                                                                                                                                                                                                   L: >SCAN: AX POP,  AX BX XCHG,     CX POP,    DI POP,                    CS PUSH,      ES POP,  CX DX MOV,   BX CALL,                    0=, NOT, IF,   DX CX MOV,  THEN,                                CX INC,   CX DX SUB,  AX DX XCHG,  >SWAP JMP,          L: >SCANW >SCAN: #, CALL,  REPNE, SCASW, RET,                   L: >SCANB >SCAN: #, CALL,  REPNE, SCASB, RET,                   L: >SCANL >SCAN: #, CALL,   SI PUSH,   BX BX  OR,                    AX BX  XCHG,   SI DI  MOV,   CXNZ,                         IF,  BX DI MOV,                                                      BEGIN, CX PUSH,  >STR= #,  CALL, CX POP,  EQ, UNTIL,       THEN,   SI POP,  RET,                                                                                                                                                                                                                                                                                                                                                                                                                                           : IOV! DOES> 2@ IOV 2! ;                                                                                                        : * M* DROP ;                                                                                                                   : EOS-OFF 0 TO EOF? ;                                                                                                           :TR- FOPEN BLWORD 1+ OPEN DUP 0< A"  OPEN ERROR " ;                                                                             : EOS-ON -1 TO EOF? ;                                                                                                           :TR- TYPE FOR CSTR ?EMIT NEXT DROP ;                                                                                            :TR- EXPECT 2DUP CNTDO ?DO BEGIN KEY LOW DUP I C! bl U< 0=                                                                        IF I C@ EMIT 1                                                    ELSE I C@ cr                                                    OF I ROT - LEAVE                                                THEN bs                                                         OF OVER I - UNTIL                                               bs DUP EMIT SPACE EMIT -1                                       ELSE DROP 0                                                   THEN THEN +LOOP TO SPAN DROP ;                                                                                                : ( 41 WORD DROP ;                                                                                                              : --> 0 BLK 1+ >STREAM ;                                                                                                        : EXECUTE PUSH ;                                                                                                                : IO! BLK COM                                                   IF SIO EXIT                                                     THEN FIO ;                                                                                                                      : OK? BLK                                                       IF EX CR EXIT                                                   THEN ."  Ok" CR EX SPACE ;                                                                                                      : CR cr EMIT lf EMIT 0 TO OUTC ;                                                                                                :TR- REFILL TIB 80 ( `P) EXPECT 0 TO >IN TIB SPAN + OFF ;                                                                       : 1LINE OK? REFILL EX INTERPRET ;                                                                                               : (CLOSE HANDLES                                                IF AT HANDLES CLOSE DROP HANDLES 0=                               IF 0 TO BLK SIO                                                 THEN THEN EOS-ON ;                                                                                                            : ;TI POP BLK PUSH >IN PUSH TIB PUSH PUSH EX POP TO TIB POP     POP >STREAM ;                                                                                                                   : ;RBUF POP RP@ ROT - RP@ OVER RP! PUSH SWAP PUSH EX POP RP!    ;                                                                                                                               : EVAL ;TI 0 >STREAM 0 TO TIB INTERPRET ;                                                                                       : LOAD ;TI 0 SWAP >STREAM INTERPRET ;                                                                                           : LOCATE -FIND ?DUP 0= A" ?" ;                                                                                                  : >STREAM TO BLK TO >IN ;                                                                                                       :TR- F83 DECIMAL FORTH TO FORTH 4512 ( (NUM ) TO NUM 4230 ( (-FIND ) TO -FIND                                                   5485 ( (?LIT ) TO ?LITERAL 4315 ( (INT ) 4306 ( TO INTERPRET ) !                                                                0 TO dA ;                                                                                                                       : ' LOCATE DROP ;                                                                                                               : FIND ROT PUSH -1 -ROT FOR STR @ SWAP NEXT DROP CONTEXT @      POP (find TO ?, ;                                                                                                               :TR- (-FIND BLWORD ORDER# STR FIND ;                                                                                            : BLWORD bl WORD ;                                                                                                              :TR- WORD BLK NBLK >IN HERE (WORD TO >IN ;                                                                                      ->: (INT -FIND ?DUP IF ?, (INT THEN NUM ?LITERAL (INT ;                                                                         : CLOSALL BEGIN HANDLES                                           IF TO CLOSE                                                   REPEAT ;                                                                                                                        ->: QUIT KBD QUIT ;                                                                                                             : SEVAL ;TI TO BLK IO! 90 ( `Z) ;RBUF TO TIB EOS-OFF BEGIN 1LINE                                                                  EOF? 0< UNTIL                                                 EOS-OFF ;                                                                                                                       : FLOAD HANDLES bs - 0= A"  TOO MUCH FILES " FOPEN TO HANDLES                                                                                                                                   -1 SEVAL IO! ;                                                                                                                  :TR- KBD 0 SEVAL IO! ;                                                                                                          :TR- (NUM DUP CSTR + PUSH BASE -1 DUP PUSH 0 AT DECIMAL 1+                                                                      IF DNEGATE                                                      THEN POP TO DBL POP A" Not Found" ;                                                                                             : C" BLWORD 1+ C@ ', LITERAL ;                                                                                                  : LINK+ HERE @SWAP , ;                                                                                                          : ,S" 34 ( `") WORD ", ;                                                                                                        :TR- (ABRT (STR SWAP                                            IF CR HERE ID. BLK TO SCR >IN TO CSP ". CR ABORT                THEN DROP ;                                                                                                                     : (" (STR ;                                                                                                                     : (." (STR ". ;                                                                                                                 : STR, FOR B, NEXT DROP ;                                                                                                       : (( CREATE , , IMMEDIATE DOES> STR , PERFORM ;                                                                                 : W, STR , ;                                                                                                                    : B, CSTR C, ;                                                                                                                  : +JUMP POP + PUSH ;                                                                                                            : MAKER CREATE COM 3 AND 2* DUP C, +JUMP , , , ' , DOES> CSTR   HEADER +JUMP W, W, W, PERFORM ;                                                                                                 : ". CSTR TYPE ;                                                                                                                : ALIAS THEAD COMPILE [ 1348 , ] , ;                                                                                            : X?COMP DOES> C@ LOCATE PUSH + POP ;                                                                                           : , HERE !+ TO HERE ;                                                                                                           : C, HERE C!+ TO HERE ;                                                                                                         : Z, 0 , ;                                                                                                                      : ZC, 0 C, ;                                                                                                                    : >MARK HERE Z, ;                                                                                                               : ', ' , ;                                                                                                                      : THEN HERE SWAP! ;                                                                                                             : LOOP/ >MARK HERE ;                                                                                                            : /LOOP , ', THEN ;                                                                                                             : COMPILE @R+ , ;                                                                                                               : ', ' , ;                                                                                                                      : REPEAT SWAP ', AGAIN ', THEN ;                                                                                                : ELSE ', AHEAD SWAP ', THEN ;                                                                                                  : BCOMPILE POP B, PUSH ;                                                                                                        : ALLOT AT HERE +! ;                                                                                                            : RECOVER 2 NEGATE ALLOT ;                                                                                                      : LITERAL STATE 0; ', [LIT] ;                                                                                                   : (?LIT DBL 1+                                                  IF STATE 0; SWAP ', LITERAL DUP                                 THEN DROP ', LITERAL ;                                                                                                          : ;code POP CFA ! ;                                                                                                             : REL, DOES> C@ C, HERE 2+ - , ;                                                                                                : ?CODE HERE SWAP RCALL, ] ;                                                                                                    : M: 783 ( :30F ) ?CODE ;                                                                                                       : NM: NEGATE #does + ?CODE ;                                                                                                    : DOES> COMPILE [ 5519 , ] #does RCALL, ;                                                                                       : ", C@ 1+ ALLOT ;                                                                                                              : CREATE HEADER COMPILE [ 616 , ] ;                                                                                             : USE: HERE ', DO: ;                                                                                                            : : HEADER SMUDGE ', DO: ;                                                                                                      : ; SMUDGE ', ;M ;                                                                                                              : LATEST CURRENT @ ;                                                                                                            : XSMG DOES> C@ LATEST XOR! ;                                                                                                   : (COMPIL DOES> C@ ' + , ;                                                                                                      : <N> NPTR HERE TO NPTR TO HERE ;                                                                                               :TR- HEADER HDRS? ?DUP                                          IF 1- TO HDRS? HERE TO CFA <N> CFA ALIAS <N> ?TR;               THEN THEAD HERE TO CFA ;                                                                                                        : THEAD 'SAME CURRENT HERE @SWAP BLWORD ", , ;                                                                                  : HEADERS 0 TO HDRS? ;                                                                                                          : -HEADERS -1 TO HDRS? ;                                                                                                        : | 1 TO HDRS? ;                                                                                                                : XBASE DOES> C@ TO BASE ;                                                                                                      : XSTATE DOES> C@ TO STATE ;                                                                                                    : TRACE ' TR EXEC -TR ;                                                                                                         : (DEBUG 2DUP H. H. PUSH PUSH 2DUP H. H. POP POP SP@ H. RP@     H. R@ H. :1C23 DUP 2- DUP H. SWAP @ H. @ H. HERE H. :1C1F       ?ID. ;                                                                                                                          : ID. CSTR 31 AND TYPE SPACE ;                                                                                                  : ?ID. C>N ?DUP 0; 1- ?DUP                                      IF 7264 ( :1C60 ) + @ ID.                                       THEN ID. ;                                                                                                                      : _INIT F83 'INIT 129 ( :81 ) EVAL QUIT ;                                                                                       : _ABORT -TR F83 CLOSALL ', [ 'ERR QUIT ;                                                                                       : -HEAD EDGE TO NPTR HEADERS ;                                                                                                  : U/MOD 0 SWAP UM/MOD ;                                                                                                         : >ALIGN 1- OR 1+ ;                                                                                                             : ALIGN 1- SWAP >ALIGN ;                                                                                                        : PAD HERE 320 ( :140 ) + ;                                                                                                     : WITHIN OVER - PUSH - POP U< ;                                                                                                 : ?BLK BLK 1 -2 WITHIN ;                                                                                                        : S>D DUP 0< ;                                                                                                                  : SPACES FOR SPACE NEXT ;                                                                                                       : COUNT CSTR ;                                                                                                                  : WCOUNT STR ;                                                                                                                  : HOME 0 0 GOTOXY ;                                                                                                             : PAGE (CLSC HOME ;                                                                                                             : .( 41 WORD ". ;                                                                                                               : CSTR, DUP C, STR, ;                                                                                                           : ," BLWORD ", ;                                                                                                                : 0" HERE 2+ ', " ZC, 1+! ;                                                                                                     : PREVIOUS AT ORDER# TO CONTEXT ;                                                                                               : ALSO CONTEXT TO ORDER# ;                                                                                                      : DEFINITIONS CONTEXT TO CURRENT ;                                                                                              : VOCABULARY TO FORTH MAKEVOC VOCLINK LINK+ ;                                                                                   : <# NUM2 2! 0 ;                                                                                                                : #> FOR EMIT NEXT ;                                                                                                            : HOLD SWAP 1+ ;                                                                                                                : ;SIGN                                                         IF DABS EX 45 ( `-) HOLD                                        THEN ;                                                                                                                          : M/MOD TUCK U/MOD PUSH SWAP UM/MOD POP ;                                                                                       : 1# NUM2 2@ BASE M/MOD NUM2 2! ALPHA HOLD ;                                                                                    : S# BEGIN 1# NUM2 2@ OR 0= UNTIL                               ;                                                                                                                               : <D# ;SIGN <# S# ;                                                                                                             : D.R PUSH <D# POP OVER - SPACES #> ;                                                                                           : D. S>D 0 D.R SPACE ;                                                                                                          : . S>D D. ;                                                                                                                    : .R PUSH S>D S>D POP D.R ;                                                                                                     : U.R 0 0 ROT D.R ;                                                                                                             : UD. <# 1# S# #> SPACE ;                                                                                                       : UD.R 0 SWAP D.R ;                                                                                                             : .DH BASE PUSH HEX UD. POP TO BASE ;                                                                                           : .. BASE PUSH DECIMAL 6 U.R POP TO BASE ;                                                                                      : .H 0 .DH ;                                                                                                                    : N>LINK N>C 2- ;                                                                                                               : V>LINK 2- ;                                                                                                                   : forget DUP FENCE U< A" fence !" PUSH BEGIN VOCLINK @ ?DUP       R@ U< 0=                                                        IF @ VOCLINK !                                                REPEAT VOCLINK BEGIN DUP 2- BEGIN @ DUP R@ U< 0=                    IF N>LINK                                                     REPEAT OVER 2- ! @ ?DUP 0= UNTIL                              FORTH TO FORTH POP TO HERE DROP ;                                                                                               : FORGET ' C>N DROP forget ;                                                                                                    : WORDS CR 10 TO CSP CONTEXT -1 0 DO @ ?DUP                     IF DUP C@ #LEN AND 6 + OUTC + 80 ( `P) < 0=                       IF CR CSP ?DUP                                                    IF 1- TO CSP                                                      ELSE 10 TO CSP KEY LOW 27 =                                     IF DROP I " LISTED" LEAVE                                       THEN THEN THEN DUP H. DUP ID. 1H OUTC OVER MOD ?DUP         0=                                                              IF DUP                                                          THEN - DUP 13 < 0=                                              IF DROP 1                                                       THEN OUTC 64 ( `@) < 0=                                         IF 1-                                                           THEN SPACES N>C 2-                                              ELSE CR I " TOTAL" LEAVE                                      THEN LOOP ". ."  WORDS = " . ;                                                                                                  : PRUNE VOCLINK BEGIN DUP PUSH V>LINK BEGIN @ DUP HERE U<           0=                                                              IF N>LINK                                                     REPEAT DUP R@ V>LINK ! ?DUP                                     IF DUP PUSH BEGIN N>LINK @ ?DUP                                     IF DUP HERE U<                                                    IF DUP POP N>LINK ! DUP PUSH                                    THEN                                                        REPEAT 0 POP N>LINK !                                         THEN POP @ ?DUP 0= UNTIL                                      -HEAD AT HIDDEN OFF ;                                                                                                           : EMPTY-BUFS FIRST LIMIT OVER - ERASE FIRST DUP TO PREV TO USE  LIMIT FIRST DO -1 I 1+ ! B/BUF +LOOP ;                                                                                          : ;ABLK EX PREV 2+ 1+ DERR A" IO-BLK ?" ;                                                                                       : +BUF B/BUF + DUP LIMIT =                                      IF DROP FIRST                                                   THEN DUP PREV - ;                                                                                                               : ?SAVE BSTR                                                    IF DUP STR WBLK 0 OVER 1- C!                                    THEN ;                                                                                                                          : BUFFER USE DUP BEGIN +BUF UNTIL                               TO USE DUP TO PREV ?SAVE !+ ;                                                                                                   : SAVE-BUFS LIMIT FIRST ?DO I ?SAVE DROP B/BUF +LOOP ;                                                                          : BLOCK ;ABLK PUSH PREV 1+ @ R@ -                               IF PREV BEGIN +BUF 0=                                               IF DROP POP BUFFER 2- STR RBLK EXIT                             THEN DUP 1+ @ R@ = UNTIL                                      TO PREV                                                       THEN RDROP ;                                                                                                                    : ONLY ORDER# OFF FORTH ALSO MACROS ALSO HIDDEN ALSO ;                                                                          : \ ?BLK                                                        IF >IN 1L >ALIGN TO >IN                                           ELSE -1 WORD DROP                                             THEN ;                                                                                                                          : CTRL BLWORD 1+ C@ #LEN AND ', LITERAL ;                                                                                       : FLUSH SAVE-BUFS EMPTY-BUFS ;                                                                                                  : -USE SCRH 1+                                                  IF SCRH CLOSE DROP -1 TO SCRH                                   THEN ;                                                                                                                          : USING FLUSH -USE FOPEN TO SCRH ;                                                                                              : .LINE .. SPACE 1L TYPE ;                                                                                                      : .BLOCK CR SCR SPACE 213 ( :D5 ) EMIT .. 1H 0 DO CR DUP I      .LINE 1L + LOOP DROP ;                                                                                                          : LIST DUP TO SCR BLOCK .BLOCK ;                                                                                                : RESCAN >IN -FIND ROT TO >IN NIP 0; CR HERE ". ."   EXIST ! " BLK                                                              1- 0>= 0; ." IN BLK " BLK . ;                                                                                                   : ?DISCARD DERR 0; DISCARD 0 TO DERR ;                                                                                          : THRU 1+ SWAP ?DO I LOAD LOOP ;                                                                                                : +THRU PUSH BLK + POP BLK + THRU ;                                                                                             : WHAT? 7 EMIT ;                                                                                                                : -: ' , C, XK 2+ DUP TO XK HERE OVER - DUP PUSH DUP 1+ ROT     MOVE HERE C@ POP C! ;                                                                                                           : SWITCH: CREATE HERE 73 ( `I) 1 TO XK 0 -: DOES> SWAP TO XK    COUNT 2DUP XK SCANB 1+ 2* + + PERFORM ;                                                                                         : ;SWITCH 73 ( `I) - A" BAD KEYS" XK 2/ 1- SWAP C! ;                                                                            : ;BASE BASE XCHG PUSH TO BASE EX POP TO BASE ;                                                                                 : ?CSP SP@ CSP - A" PAIRS? " TO CSP ;                                                                                           : CSP! CSP SP@ TO CSP ;                                                                                                         : : CSP! : ;                                                                                                                    : ; ', ; ?CSP ;                                                                                                                 : #% @                                                          IF %!% AT HDRS? OVER @ @SWAP @SWAP DROP                         THEN <N> ;                                                                                                                      : <N 0 %!% ! AT HDRS? #% ;                                                                                                      : N> %!% #% ;                                                                                                                   : "T SPTR CSTR ;                                                                                                                : "ALLOT DUP 1+ AT SPTR @-! C! ;                                                                                                : #>" "ALLOT "T FOR C!+ NEXT DROP ;                                                                                             : "DROP "T + TO SPTR ;                                                                                                          : "PUSH DUP PUSH 1+ AT SPTR @-! 1+ R@ MOVE POP SPTR C! ;                                                                        : "INS "T PUSH TO SPTR "PUSH POP SPTR +! ;                                                                                      : ">' SPTR "DROP ;                                                                                                              : "SWAP+ ">' COUNT "INS ;                                                                                                       : "INSC 1 #>" "SWAP+ ;                                                                                                          : =" 34 ( `") WORD COUNT "ALLOT "T CMOVE ;                                                                                      : "MOVE OVER C@ 1+ MOVE ;                                                                                                       : >OS bl "INSC COUNT "INS ">' SHELL ;                                                                                           : "POP SPTR HERE "MOVE "DROP HERE CSTR ;                                                                                        : N>" 0 <# S# #>" ;                                                                                                             : A>" AT, $ SWAP N>" 58 ( `:) "INSC N>" "SWAP+ ;                                                                                : '$ ' @ $TEST ;                                                                                                                : ;MNX 2DUP <                                                   IF EX NIP EXIT                                                  THEN EX DROP ;                                                                                                                  : MAX ;MNX ;                                                                                                                    : MIN ;MNX SWAP ;                                                                                                               : E :2A4A :2A54 RP@ :29EA BEGIN :2CAE :2D07 ;                                                                                   : EDIT PAGE TO SCR E ;                                                                                                          : ERR CSP TO XY SCR EDIT ;                                                                                                      : HELP SCR PUSH TO SCR E POP TO SCR E ;                                                                                         : ?SAME CONTEXT CURRENT XOR ;                                                                                                   : >LIST ?SAME 0; BEGIN ?GET1 P1                                   IF PUT1                                                       REPEAT ;                                                                                                                        : XLIST CONTEXT CURRENT TO CONTEXT TO CURRENT ;                                                                                 : ;XLIST ?SAME 0=                                               IF RDROP                                                        THEN >LIST XLIST EX XLIST ;                                                                                                     : ;CURRENT CURRENT XCHG PUSH TO CURRENT EX POP TO CURRENT       ;                                                                                                                               : <ORDER ;XLIST BEGIN ?GET1 P1                                    IF ?INSERT                                                    REPEAT ;                                                                                                                        : MPUT? P1 C@ 128 ( :80 ) AND                                   IF AT MACROS ;CURRENT                                           THEN PUT1 ;                                                                                                                     : >IMMED ;XLIST BEGIN ?GET1 P1                                    IF MPUT?                                                      REPEAT ;                                                                                                                                                                                                                                                                                                                                                                                        