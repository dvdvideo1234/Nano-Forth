   KERNEL.SCR                   CAN'T REMOVE CURRENT DIRECTORY  INVALID FUNCTION NUMBER         NOT SAME DEVICE                 FILE NOT FOUND                  NO MORE MATCHING FILES          PATH NOT FOUND                  WRITE-PROTECTED DISK            TOO MANY OPEN FILES             UNIT ID UNKNOWN                 ACCESS DENIED                   DISK DRIVE NOT READY            INVALID HANDLE                  UNKNOWN COMMAND                 MEM-CTRL-BLK DESTROYED          CRC ERROR                       INSUFFICIENT MEMORY             BAD LENGTH                      MEM-CTRL-BLK INVALID            DISK SEEK ERROR                 ENVIROMENT INVALID              UNKNOWN DISK MEDIA TYPE         FORMAT INVALID                  DISK SECTOR NOT FOUND           ACCESS CODE INVALID             PRINTER OUT OF PAPER            DATA INVALID                    WRITE FAULT                     ( NOT USED )                    READ FAULT                      DRIVE SPECIFIED INVALID         GENERAL FAILURE                                                                                                                                                                                                                                                                                                                                                   4 35 THRU                                                                                                                        L: _TOP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \  USER VARIABLE'S OFFSETS  :=: CONSTANTS                       \  EASY  TO CHANGE OFFSETS                                                                                                     MAC: >NEXT,  <MAIN JMP,;    MAC: >PUSH,  <PUSH JMP,;            MAC: >SWAP,  <SWAP JMP,;    MAC: >DROP,  <DROP JMP,;            MAC: CRY@ _CRRY /// AX MOV, 1 #, AX SHL, ;                      MAC: CRY! 1 #, AX RCR, AX _CRRY /// MOV, ;                       0                                                               +C: ->TASK     +C: -<TASK     +C: ->SP       +C: >S0            +C: >R0        +C: >FRAME     +C: >SELF      +C: >HDR           +C: >RPTR      +C: >TIB       +C: >BASE      +C: >HOLD          +C: >H         +C: >STATE     +C: >CURRENT   +C: >CONTEXT       +C: >VLINK     +C: >>IN       +C: >OUT       +C: >BLK           +C: >SCR       +C: >CSP       +C: >DBL       +C: >SPAN          +C: >SCRH       DROP                                                                                                            \  FORWARD DEFINITIONS CONTINUE ...                             ASM   256 T-ALIGNED \ KERNEL SOURCE IN ASSEMBLER                 L: START/   -?, IF,   L: _BOOT 0 DW,   L: _COLD 0 DW,           L: _WARM 0 DW,      L: _USER _ORIG1 DW, L: _CRRY 0 DW,          L: _DSTEP <TRONX DW,  0 DW,  _JUMP DW, _DSTEP DW,  \ DEBUG      L: FSTAT  <VAR DW, L: _AX   0 DW,  L: _SI   _DSTEP 2+ DW,       THEN,   CLD,     CALL,F 1                                     <%                                                                T-: DROP, BX POP, T-;                                           T-: SCASW,2 SCASW, SCASW, T-;                                   T-: SCASW,3 SCASW,2 SCASW, T-;                                  T-: DUP, BX PUSH, T-;                                         %>                                                                                                                                                                                                                                                              L: _ORIG  <WARY DW, ( USER VARS  128 BYTES   IN THIS BLOCK)     L: _ORIG1 \ +C: ->TASK  +C: -<TASK  +C: ->SP   +C: >S0           0 DW, $ FF00 DW, $ FF00 DW, $ FA00 DW, $ FA00 DW,              \ +C: >R0        +C: >FRAME     +C: >SELF      +C: >HDR            $ FE00 DW,        0 DW,           0 DW,         0 DW,        \ +C: >RPTR      +C: >TIB       +C: >BASE      +C: >HOLD             92 DW,     $ FE80  DW,     10 DW,         0 DW,            \ +C: >H         +C: >STATE     +C: >CURRENT   +C: >CONTEXT         _TOP DW,         0 DW,           0 DW,         0 DW,        \ +C: >VLINK     +C: >>IN       +C: >OUT       +C: >BLK                0 DW,         0 DW,           0 DW,         0 DW,        \ +C: >SCR       +C: >CSP       +C: >DBL      \ +C: >SPAN        29   [[  0 DW, ]]    1 DW, 2 DW, 3 DW, 4 DW, 5 DW,               9   [[  0 DW, ]]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  FL! 1                      SI POP,                             -2 /SI CX MOV,        2 /SI DI MOV,           DI BX MOV,     DI _USER /// MOV,        REP, AL MOVS,           AX AX XOR,       $ 80 #, SI MOV,     >TIB /BX DI MOV,             AL LODS,            AX BX MOV,        AH 0 X/S MOV,        1 /BX CX LEA,        REP,  AL MOVS,    $ 1000 #, BX MOV,                            $ 4A #, AH MOV,       33 INT,                                                                                                 L: END_INIT                                                                                                                      256 T-ALIGNED                                                                                                                   L: OP_TABLE     128 [[  0 DW, ]]                                OP_TABLE END_INIT - CR . ( BYTES BEFORE OP_TABLE !)             \ KERNEL SOURCE IN ASSEMBLER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \ Arithmetic                                               L: +*# 1 #, DL TEST, 0=, NOT, IF, AX POP,    AX BX ADD,           AX PUSH, THEN, 1 #, BX RCR, 1 #, DX RCR, -?, IF,              L: +?#  CRY@ AX POP, AX BX ADC,   -?, IF, ( 14  + )             L: ;#    0 /BP SI MOV,                                          L: <RDROP   BP INC,   BP INC,        -?, FB, 0   ( 0 ; )        L: POP#     DUP, 0 /BP BX MOV,  <RDROP JMP,    ( 19  pop)       L: JUMP# LODSW,         -?, FB, 2   ( 2 JUMP v)                 L: OF#        AX POP,  AX BX XCHG,                                    BX AX  XOR, JUMP# JNZ,  DROP,  LODSW, -?, FB, 62          L: DUP#  DUP,        -?, FB,  18    ( 18  dup)                  L: 2*# 1 #, BX SHL,       -?, FB,  11    ( 11  2*)              L: 2/# 1 #, BX SAR,       -?, FB,  12    ( 12  2/)              L: INV#     BX COM,       -?, FB,  13    ( 13  - )              L: IF# LODSW, BX BX OR, 0=, NOT, FB, 6  -?, FB, 36  ( 6 IF)                                                                     L: -IF#   LODSW,  BX BX OR,   0<, FB, 7  -?, FB, 37 ( 7 -IF)    L: NEXT#  LODSW,   -1 #, CX MOV, CX W/ 0 /BP ADD,                      <RDROP JNB,   -?, FB, 5  ( 5 NEXT )                      L: AND# AX POP,  AX BX AND, -?, FB, 15   ( 15  AND)             L: XOR#  AX POP,  AX BX XOR, -?, FB, 16   ( 16  XOR )           L: OR#  AX POP,  AX BX OR, -?, FB, 17   ( 17  OR )              L: NIP#  AX POP,  -?, FB, 19   ( 19  OR )                       L: -#   BX NEG,                                                 L: +#   AX POP,   AX BX ADD,                                      THEN, THEN,  CRY!   -?, FB,  14    ( 14  + )                  L: RPUSH#   AX POP,   AX BX XCHG,   SKIP1,  ( 1d puSH)          L: CALL#    LODSW,  L: <RPUSH   AX SI XCHG,  ( 3 CALL )         L: <PCPUSH  BP  DEC,  BP DEC, SI 0 /BP MOV,                          FB! 2  FB! 6  FB! 7  FB! 5  ( JUMP#  IF  -IF )             L: <JUMP    AX SI XCHG, -?,  IF,                                                                                                L: <STOR-3 SCASW,  L: <STOR-2 SCASW,  L: <STOR-1  SCASW,        L: <STOR    BX 0 /DI MOV,                                       L: <DROP    DROP,   SKIP2,                                      L: <PUSH    DUP,                                                L: <SWAP    AX BX XCHG,        THEN,                           FB! 17 FB! 11 FB! 12  FB! 13  FB! 15 FB! 16  FB! 37                 FB! 14 FB! 0   FB! 62  FB! 18   FB! 36  FB! 19               L: <MAIN  AX LODS,                                              L: <EX        AX DI XCHG, 0 /DI JMP,   <DBG  JMP,               L: RCOD>F#   AX POP,    <PCPUSH JMP,                            L: CODE>F#   AX POP,     <JUMP JMP,                             L: SP@#   DUP,  SP BX MOV,   >NEXT,    (  SP@   )               L: SWAP#  AX POP,            >PUSH,                             L: RP@#   BP AX MOV,         >PUSH,    (  RP@   )               L: A@#    DX AX MOV,         >PUSH,    (   A@   )                                                                               L: @IP#       LODSW,       >PUSH,    (   @P+ LIT  )             L: @P#   AX IN,       >PUSH,                                    L: <0=    BX BX OR, 0=, NOT, IF, BX BX XOR, SKIP2,              L: <2-    BX DEC,  THEN,  L: <1-    BX DEC,  >NEXT,             L: OVER#  AX POP,   AX PUSH, >PUSH,    ( 1a oveR)               L: C@IP#     AL LODS,                  ( BLIT )                 L: <BPUSH 0 #, AH MOV, >PUSH,                                   L: C@P#   AL IN,       <BPUSH JMP,                              L: !#      BX DX MOV,  DROP,         ( 1e b!)                   L: !A#      DX DI MOV,       -?, IF,   ( 0f ! )                 L: !A+#     DX DI MOV,  DX INC, DX INC,   ( 0D !+)                   THEN,   <STOR  JMP,                                        L: C@A+#  DX DI MOV,  DX INC,  0 /DI AL MOV, <BPUSH JMP,                                                                                                                                                                                                        L: <DOES-3 SCASW, L: <DOES-2 SCASW,  L: <DOES-1  SCASW,         L: <DOES AX POP,   DUP, DI BX MOV,  <PCPUSH JMP,                L: <VAR-3 SCASW,  L: <VAR-2  SCASW,   L: <VAR-1  SCASW,         L: <VAR AX DI XCHG, >PUSH,                                      L: <JSR-5  SCASW,  L: <JSR-4 SCASW,   L: <JSR-3  SCASW,         L: <JSR-2  SCASW,  L: <JSR-1 2 /DI AX LEA, <PCPUSH JMP,         L: @R#   0 /BP DI MOV,     -?, IF,     ( 08 @R)                 L: @A+#  DX DI MOV,  DX INC, DX INC,   -?, IF,   ( 09 @+)       L: @#   BX DX MOV,  DROP,                        ( 1e b!)       L: @A#   DX DI MOV,     -?, IF,                  ( 0b @ )       L: <CNST-3 SCASW, L: <CNST-2 SCASW,  L: <CNST-1 SCASW,                    THEN, THEN, THEN,                                     L: <CNST   DUP, 0 /DI BX MOV,  >NEXT,                           L: SP!#   BX SP MOV,       >DROP,                               L: RP!#   BX BP MOV,       >DROP,    ( 1F   A!)                                                                                 L:  A!#    BX DX MOV,             >DROP,    ( 1F   A!)          L: C!P#    BX AX MOV,    AL OUT,  >DROP,                        L:  !P#    BX AX MOV,    AX OUT,  >DROP,                        L: <USER!   _USER DI MOV, <STOR JMP,                            L: C!A+#   DX DI MOV,  BL 0 /DI MOV,     DX INC, >DROP,         L: C@T+#   0 /BX AL MOV,  BX INC,           <BPUSH JMP,         L:  @T+#   BX SI XCHG,     LODSW,    BX SI XCHG, >PUSH,                                                                        \ DEBUGGER INTERFACE                                             L: <TROFF LODSW, -?, FB, 63                                     L: <TRONX LODSW,                                                L: <DBG $ 2E #, <EX /// XOR,  FB! 63                                _AX #,  DI  MOV,  AX 2 /DI XCHG,                                 SI 4  /DI XCHG,     AX DI XCHG, 0 /DI JMP,                                                                                                                                                L: <REUSE CX POP,   0 /BP SI XCHG,   CX CALL,                   L: ;:#    0 /BP SI XCHG,    >NEXT,                 (  1 ;:)     L: @R+#     <REUSE #, CALL,                                                CX POP, LODSW, DUP, AX BX XCHG, CX JMP,              L: !R+#     <REUSE #, CALL,                        ( 0C !R)     L: <!PC+   BL BH XCHG,  BH 0 /SI MOV,   SI INC,                 L: <C!PC+  CX POP,  BL 0 /SI MOV, DROP, SI INC, CX JMP,         L: C!R+#   <REUSE #, CALL,  <C!PC+  JMP,                        L: (B"#    <REUSE  #, CALL,                                     L: <BPC+   SI DI MOV, AL LODS, AH AH XOR,                       L: <BPC+Z  CX POP, DUP, DI BX MOV, AX SI ADD, CX JMP,           L: ("#     <REUSE  #, CALL,                                     L: <WPC+   SI DI MOV, LODSW, <BPC+Z JMP,                                                                                                                                                                                                                         L: <LBL-3 SCASW,     L: <LBL-2 SCASW,                           L: <LBL-1 SCASW, AX DI XCHG, <JUMP JMP,                         L: <USER   <VAR   #, CX MOV,                                    L: XUSER    2 /DI DI MOV,  _USER /// DI ADD,     CX JMP,              L: <@USER-2 SCASW,      L: <@USER-1 SCASW,                L: <@USER  <CNST  #, CX MOV,  XUSER JMP,                              L: <!USER-1 SCASW,                                        L: <!USER  <STOR  #, CX MOV,  XUSER JMP,                        L: <@REG  <CNST  #, CX MOV,   SCASW, -?, IF,                    L: <!REG  <STOR  #, CX MOV,  THEN, 2 /DI AX MOV,                  _USER /// DI MOV,  >RPTR /DI DI MOV, AX DI ADD,   CX JMP,     L: <@VAR  <CNST  #, CX MOV,    -?, IF,                          L: <!VAR  <STOR  #, CX MOV, -?, IF,  L: <LVAR <VAR #, CX MOV,       THEN, THEN,  AX POP,  AX BX XCHG, AX COM, 1 #, AX SHL,        _USER /// DI MOV,  >FRAME /DI DI MOV, AX DI ADD, CX JMP,                                                                      \ DOS INTERFACE   ( A!)  PRESERVE AREG                          L: <DOS  DX DI MOV, AX BX XCHG,  DROP,  CX POP,  DX POP,          DI PUSH,  $ 21 INT, AX PUSH,  LAHF,  1 #, AX  RCR,              _USER /// DI MOV,  >RPTR /DI DI MOV,  STOSW, AX POP, STOSW,      AX BX XCHG, STOSW,    AX CX XCHG, STOSW,                        AX DX XCHG, STOSW,   HERE TO ADR   DX POP,  >DROP,                                                                          L: <BIO_K   0  #, AH  MOV,   22  INT,  >PUSH,                   L: ?BIO_K   1  #, AH  MOV,   22  INT,  0=, NOT, IF,                     0 #, AX MOV, T-RECOVER   THEN,  AX AX XOR, >PUSH,       L: <BIO_E  14 #, AH MOV, BL AL MOV, 16 INT, >DROP,              L: ?DOS_K   11 #, AH MOV,  33 INT, CBW,  >PUSH,                 L: <DOS_E   2 #, AH MOV, DX PUSH, BL DL MOV,  33 INT, ADR JMP,  L: <DOS_K   8 #, AH MOV, 33 INT, AL AL OR,  0=, IF,                           33 INT, AL AH MOV, AL AL XOR, THEN,  >PUSH,                                                                       L: <-/# AX POP,  1 #, BX SHL, 1 #, DX RCL,  AX BX CMP,                U<, NOT, IF,  AX BX SUB,   DX INC, THEN, AX PUSH, >NEXT,                                                                  L: EXEC#     AX BX XCHG,  DROP,   HERE TO ADR  <EX JMP,         L: ?ALIAS?    AX  POP,   DI POP,   DI  PUSH,  SCASW,                        0=, IF,  AX POP,  0 /DI PUSH,  -?, IF,              L: ?ALIAS  BX BX  OR,  0=, NOT, IF,   ?ALIAS?  #, CALL,         L: <ALI  SKIP2,  L: <@EXEC-3  SCASW, L: <@EXEC-2  SCASW,        L: <@EXEC-1  SCASW,                                             L: <@EXEC  0 /DI AX MOV,  AX AX OR, ADR JNZ,                                       THEN, THEN, THEN, >NEXT,                     L: <PERFORM   BX DI MOV,  DROP,       <@EXEC JMP,               L: <BLKASE   BX INC,  0=, NOT,   IF,   SCASW,                            BX DEC,  <@EXEC-2 JNZ,  THEN,  DROP,  <@EXEC-1 JMP,                                                                                                                                     \  ARRAYS                                                       L: _IND   DUP, 0 /BP BX MOV, >NEXT,     ( R@ )                  L: _TARY  1 #, BX SHL,                                          L: _5ARY    BX DI ADD,                                          L: _QARY  1 #, BX SHL,                                          L: <WARY  1 #, BX SHL,                                          L: _BARY    DI BX ADD,                                          L: _2+      BX    INC,                                          L: _1+      BX    INC,   >NEXT,                                                                                                  (  1 8 +THRU HERE START/ - . )   END-CODE                          TCOMP   TO KERNEL                                                                                                                                                                                                                                                                                                                +*#  CODE, +*          +?#  CODE, +?                           AND#  CODE, AND          +#  CODE, +                             XOR#  CODE, XOR          -#  CODE, -                            OR#  CODE, OR        NIP#  CODE, NIP                            2*#  CODE, 2*          2/#  CODE, 2/                           INV#  CODE, INV       OVER#  CODE, OVER                        CALL#  CODE, CALL(     ;:#   CODE, ;:                                                                                          <RDROP  CODE, RDROP      POP#  CODE, POP                         C@IP#  CODE, BLIT                                               SWAP#  CODE, SWAP       DUP#  CODE, DUP                                                                                      0 T-QUAN FHAND  32 T-ALLOT                                      0 T-VECTOR ERROR                                                                                                                                                                                   (B"#   CODE, (B"        ("#   CODE, (W"                          <-/#  CODE, -/                                                  @A+#  CODE, @A+     @A#  CODE, @A                              C@A+#  CODE, C@A+                                                  @#  CODE, @        !#  CODE, !                               C@T+#  CODE, C@+    @T+#  CODE, @+                               <DOS  CODE, (DOS                                                                                                               <0=    CODE, 0=      <1-  CODE, 1-     <2-  CODE, 2-                                                                               _IND RP!# RP@#  TRIO, RP                                  ?BIO_K <BIO_K <BIO_E  TRIO, BIO-K                               ?DOS_K <DOS_K <DOS_E  TRIO, DOS-K                                                                                                                                                                                                                                                                                                        SP!#  SP@#  DUO, SP                                         <TROFF  <TRONX  DUO, TRON                                           C!P#  C@P#  DUO, BPORT                                            !P#  @P#  DUO, PORT                                                                                                       A!#  CODE, A!          A@#  CODE, A                             !A#  CODE, !A        C!R+#  CODE, C!R+                          @R#  CODE, @R         !R+#  CODE, !R+                          !A+#  CODE, !A+       C!A+#  CODE, C!A+                     <PERFORM  CODE, PERFORM    @R+#  CODE, @R+                                                                                     : C@ C@+ NIP ;    : ;DROP ;: DROP ;                             : C! A! C!A+ ;    : 0; IF ;THEN DROP POP DROP ;                                                                                                                                                 ASM T-HEADER  EXIT     L: _EXIT     ;# DW,                          T-HEADER  IF(     L: _IF      IF# DW,                           T-HEADER  OF(     L: _OF      OF# DW,                           T-HEADER  JMP(    L: _JUMP  JUMP# DW,                           T-HEADER  -IF(    L: _-IF    -IF# DW,                           T-HEADER  LIT(     L: _LIT    @IP# DW,                          T-HEADER  NEXT(   L: _NEXT  NEXT# DW,                           T-HEADER  EXEC(   L: _EXEC  EXEC# DW,                           T-HEADER  PUSH     L: _PUSH RPUSH# DW,                          T-HEADER  DROP     L: _DROP  <DROP DW,                      END-CODE                                                                    ' EXIT  <MAIN  DUO, NOP                             \ <% T-: NEWTC LIT LIT LIT [ ' [LIT] 2+ T-, ] T-! T-; %>                  _LIT ' [LIT] 2+ T-!    \ VERI SPECIAL                                                                                                                                                  ->TASK  T-VUSER >TASK    -<TASK T-VUSER <TASK                      >S0  T-VUSER S0         ->SP T-VUSER >SP                        >R0  T-VUSER R0       >FRAME T-VUSER FRAME                    >SELF  T-QUSER SELF       >HDR T-VUSER HDR                      >RPTR  T-VUSER RPTR       >TIB T-VUSER TIB                                                                                       >BASE T-VUSER BASE         >H T-QUSER HERE                       >OUT T-QUSER OUT>       >>IN T-VUSER >IN                        >BLK T-VUSER BLK       >SPAN T-VUSER SPAN                     >STATE T-VUSER STATE     >HOLD T-QUSER HOLD                       >SCR T-VUSER SCR        >CSP T-VUSER CSP                                                                                          >DBL T-VUSER DPL          >VLINK T-VUSER VLINK             >CONTEXT  T-VUSER CONTEXT    >CURRENT T-VUSER CURRENT                                      >SCRH T-VUSER SCRH                                                                                    0 T-VALUE MPTR    0 T-VALUE MTOP   0 T-QUAN SPTR                0 T-VALUE CFA                                                                       0 T-CONSTANT 0     1  T-CONSTANT 1         -1 T-CONSTANT -1    2  T-CONSTANT 2                                                                                              0  T-RVALUE ER_R   2  T-RVALUE AX_R   4  T-RVALUE BX_R          6  T-RVALUE CX_R   8  T-RVALUE DX_R                                _2+  CODE,  2+              _1+  CODE,  1+                 : 1+!@ @ 1+ DUP !A ;  : +!  @ + !A ;   : 1+! @ 1+ !A ;          : @1-! @ DUP 1- !A ;  : [! 2* A + ! ; : >! 1+!@ [! ;            : >BYTE 255 AND ;     : [@ 2* A + @ ; : C[! A + A! C!A+ ;       : '+C 1+!@ >BYTE C[! ;  : "+C 1+! @A+ C[! ;                     : ^@  @ [@ ;  : @< @1-! [@ ;  : C[@ A + A! @A >BYTE ;           : -1=  INV 0= ;  : = XOR 0= ;                                   : 0< -IF DUP XOR INV ;THEN DUP XOR ;  : < - 0< ;                                                                                  15 T-CONSTANT HMASK   16 T-CONSTANT 1H                         : RESULT PUSH DROP  A POP ;                                     : *M  A! 0 HMASK FOR +* NEXT RESULT ;                           : U?  DUP XOR DUP +? 1- ;   : U< - U? ;                         : WITHIN OVER - PUSH - POP U< ;                                 : /MOD# PUSH SWAP A! POP HMASK FOR -/ NEXT RESULT ;             : /MOD 0 /MOD# ;  : MOD /MOD NIP ;  : / /MOD DROP ;             : D0 0 0 ;  \ IO KERNEL FUNCTIONS                               : D_ERR  ER_R -IF 4  ERROR  THEN DROP ;                         : DO_HANDLE PUSH  AT FHAND ^@ POP (DOS D_ERR ;                  : HFSIZE D0 $ 4202 DO_HANDLE ; : HCLOSE D0 $ 3E00 DO_HANDLE ;   : HREAD $ 3F00 DO_HANDLE ;     : HWRITE $ 4000 DO_HANDLE ;      : FOPEN  D0 $ 3D02 (DOS D_ERR ;                                : (HANDLE   EXECUTE AT FHAND @< DROP ;                          : >HANDLE   AT FHAND >! @R+ (HANDLE ;                                                                                             1024  T-CONSTANT 1K      <DOES T-CONSTANT #DOES                 ' BIO-K       T-VECTOR  EMIT                                    ' BIO-K 2+    T-VECTOR  KEY                                   : RESET-KEY [ ' BIO-K 2+ ] T-LITERAL TO KEY ;                     ' BIO-K 2+ 2+ T-VECTOR  ?KEY                                  : ?TYPE INV -IF INV IF 1- ;THEN THEN DROP DROP RDROP ;          : TYPE ?TYPE FOR C@+ EMIT NEXT DROP ;  : ID. C@+ 31 AND TYPE ;  : BLKPOS 1K *M $ 4200 DO_HANDLE ;                               : RBLK BLKPOS 1K HREAD ;  : WBLK BLKPOS 1K HWRITE ;             : ;S ;DROP AT FHAND @ IF [ ' HCLOSE ] T-LITERAL (HANDLE             1- IF ;THEN RESET-KEY THEN ;                                : F_KEY ;DROP 0 SP 1 HREAD AX_R IF DROP DUP 32 U<                    IF 32 SWAP ;THEN ;THEN  ;S 13 SWAP ;      \ CHK EOF !!!    : F_EMIT SP 1 HWRITE DROP ;                                                                                                                                                                     : CHARS ?TYPE FOR DUP EMIT NEXT DROP ; : SPACES 32 SWAP CHARS ; : BACK 8 EMIT ; : SPACE 1 SPACES ;                              : DO-K 32 - -IF 19 + ( -CR) IF 5 + ( -BS) IF ( 0<>)   ;THEN       ( BS) INV PUSH PUSH IF 1- BACK SPACE  BACK THEN POP POP ;THEN   ( CR)  ;THEN  32 + A! PUSH OVER OVER + PUSH 1+ A DUP EMIT          POP  A!  C!A+  POP OVER OVER U< ;                          : EXPECT ?TYPE 1+ PUSH 0 POP BEGIN KEY 255 AND DO-K                    IF DROP AGAIN THEN   DROP DROP ;                         : DIG?  C" A  -  -IF  7 +  INV -IF  ;THEN INV THEN  10 + ;      : -ROT SWAP PUSH SWAP POP ;                                     : /STR DUP A! + PUSH A - POP ;                                  : CONVERT IF BEGIN 1- PUSH C@+  SWAP PUSH  DIG? DUP BASE U<       -IF DROP -ROT BASE *M DROP PUSH BASE *M  A!                               + A POP +? POP POP IF AGAIN THEN  ;THEN                      DROP DROP POP POP 1 /STR THEN ;                                                                                        \              LIT"          (".             ".                 T-HEADER (" ] L: _"1 <JSR-3  L: _"2  <JSR-4  L: _"3 <JSR-4                    (B" EXIT       (B"             C@+ TYPE  EXIT [   : BSRCH DUP PUSH PUSH A! BEGIN C@A+ OVER XOR IF DROP  NEXT               RDROP DUP XOR INV  ;THEN DROP DROP POP POP SWAP - ;    : HEX 16 TO BASE ; : DECIMAL 10 TO BASE ; : BINARY 2 TO BASE ;  : D+  PUSH A! PUSH A + POP POP +? ;                             : ROT PUSH SWAP POP SWAP ;  : ;ROT ;: ROT ;  : D0 0 0 ;         : DNEGATE A! INV 1 + A INV 0 +? ;  : 2SWAP PUSH -ROT POP -ROT ; : ?NEG OVER C@ C" - = IF /STR IF ;: DNEGATE THEN ;THEN DROP ;   : ?HEX OVER C@ C" $ " !" = IF /STR IF POP  A! BASE PUSH A PUSH        16 TO BASE ;:      POP TO BASE THEN ;THEN DROP ;          : ?NUMBER ;ROT ?NEG ?HEX 0 TO DPL  D0 2SWAP CONVERT                BEGIN IF OVER C@ DUP C" : = SWAP  C" ,  C" 0  WITHIN OR         WHILE DUP TO DPL /STR CONVERT REPEAT DROP THEN NIP -ROT ;                                                                    : MOVE SWAP A! ?TYPE FOR C@+ C!A+ NEXT DROP ;                   : FILL SWAP A! ?TYPE FOR DUP C!A+  NEXT DROP ;                  : #V INV 2* FRAME + ;   \ LOCAL VARIABLE ADDRESS                T-' #V  <@EXEC-1   0 NM: EXEC( ! ;M  1 NM: EXEC( @ ;M           T-HEADER LV T-, T-, T-, T-,                                     ' LV T-HEADER ORIG @+ T-, @+ T-, @+ T-, _ORIG T-, DROP          : LOCALS OVER OVER + 1+ A! POP FRAME PUSH RP TO FRAME A #V        DUP TO RP  A!  SWAP FOR !A+ 0 NEXT  SWAP  FOR !A+ NEXT ;:     L: 'RETURN       FRAME TO RP  POP  TO FRAME ;                   : SRCH DUP PUSH PUSH A! BEGIN @A+ OVER XOR   IF DROP  NEXT               RDROP DUP XOR INV  ;THEN DROP DROP POP POP SWAP - ;                                                                    MAC: SH 0 AT NBUFS 20 DUMP;                                                                                                                                                                                                                                     ' LV T-HEADER NBUFS @+ T-, @+ T-, DROP <WARY T-, 32 T-ALLOT     3 T-VALUE #BUFS   #BUFS 1+ T-VALUE FBUFS    0 T-VALUE BUFP       #BUFS    T-VALUE USE  #BUFS T-VALUE PREV \ INDEX OF BUFFERS    : SRCH-B 0 AT NBUFS #BUFS SRCH ; : -BUFS 0 AT NBUFS 32 -1 FILL ;  : +BUF #BUFS USE 1+ AND DUP TO USE ;                          : GETBUF +BUF PREV XOR IF USE EXIT THEN +BUF ; \ NOT LAST USED  : FBUF PREV FBUFS + AT NBUFS ; : DISCARD -1 FBUF ! ;            : ^BUF PREV 1K *M DROP BUFP + ;    : UPDATE 0 FBUF ! ;          : ?SAVE TO PREV FBUF @ IF DROP ;THEN DROP                                      ^BUF PREV NBUFS SCRH >HANDLE WBLK DISCARD ;      : BUFFER -1 SRCH-B  -IF DROP GETBUF ?SAVE DROP PREV THEN             DUP TO PREV TO NBUFS ^BUF ;   \ REGISTER BLKNUM            : BLOCK DUP SRCH-B   -IF DROP BUFFER DUP PREV NBUFS SCRH             >HANDLE RBLK  ;THEN TO PREV DROP ^BUF ;                    : !BUFS #BUFS FOR AT RP ?SAVE NEXT ;  : FLUSH !BUFS -BUFS ;                                                                     T-HEADER ?TIB <BLKASE T-, ] TIB TIB BLOCK [                     : WORD 1 HERE ! 255 AND A! HERE  SPAN >IN -                        IF 1- PUSH A BLK ?TIB >IN + A!                                    BEGIN  C@A+ OVER XOR 0=                                           IF   DROP                                                       NEXT   SPAN TO >IN DROP                                       ;THEN  DROP A 1- PUSH 0 HERE ! POP A!  \ INIT STRING            BEGIN  C@A+ OVER XOR                       \ INCRMENT             IF  OVER XOR  HERE A PUSH '+C  POP A!                           NEXT  SPAN TO >IN  DROP                                       ;THEN DROP SPAN POP INV + TO >IN                              THEN DROP ;                                                  : BLWORD 32 WORD C@+ TYPE ;                                                                                                                                                                                                                                     : 0-DROP SKIP BEGIN DROP THEN UNTIL ;                           : #-1DROP SKIP BEGIN DROP THEN 1+ 0= UNTIL DROP ;               : =DROP SKIP BEGIN DROP THEN OVER XOR UNTIL OVER XOR ;          : FIND( PUSH   \ WHAT TO SEARCH  -  ADDRESS OF WORD                 BEGIN 0-DROP  =DROP INV  WHILE  INV       \ -1  çÖ Ö ãà           BEGIN @ 128 AND -1 + DROP @A 32 AND     \ CARRY                   C@A+ 31 AND SWAP 0=                                             IF DROP AT RP SWAP PUSH C@+ AT RP BEGIN                            XOR 1- -IF DROP C@+ C@A+ NEXT  C@A+ POP     \ FOUND             #-1DROP A 0 DUP +? 2* 1-  ;THEN DROP POP SWAP                THEN DROP A + @                                               WHILE REPEAT DROP                                             REPEAT DROP POP 0 ;  \ NOT FOUND                            : FIND PUSH -1  CONTEXT @ POP FIND( ;                                                                                                                                                                                                                           KERNEL                                                                                                                          -BUFS                                                                   PAD  60 - TO HERE                                               PAD  1K + TO BUFP                                               AT KERNEL TO CONTEXT                                            1K        TO SPAN                                               0         TO >IN                                        =" TEMP.SCR"                                                    PAD  C!                                                         PAD  C@+ MOVE                                                   0 PAD  '+C                                                      PAD 1+ FOPEN  AX_R TO SCRH                                          0 BLOCK TO TIB                                                                                                              : FIND( PUSH   \ WHAT TO SEARCH  -  ADDRESS OF WORD                 BEGIN 0-DROP  =DROP INV        \ -1  çÖ Ö ãà                    WHILE  INV                                                        BEGIN @ 128 AND -1 + DROP @A 32 AND      \ CARRY                  IF DROP C@A+ 31 AND ELSE DROP                                      AT RP C@+ C@A 31 AND DUP                 \ FOUND                FOR XOR 1- -IF DROP C@+ C@A+ NEXT                                        @A+ POP 1-DROP AR 0 DUP +? 2* 1-                             ;THEN DROP POP                                         THEN AR + @                                                   WHILE REPEAT DROP                                             REPEAT DROP POP 0 ;  \ NOT FOUND                                                                                            : FIND PUSH -1 ORDER# @+ IF 1- FOR @+ @ SWAP NEXT THEN                  DROP CONTEXT @ POP  FIND( TO ?, ;                                                                                       \ : PROBA  0 LOCALS  5 FOR AT RP #V @ . NEXT ;                  \ : PROBA2 0 LOCALS 0 LV . 1 LV . 2 LV . 3 LV . 4 LV . 5 LV . ; \ T-VARIABLE PROBA  : #. AR PUSH 1 PROBA +!                     \        S. R. PROBA @ . KEY DROP POP TO AR ;                   \ <% T-: S. S. BLK . KEY DROP T-; %>                            : NPSH #. DUP TO AR  POP #. RP AR 2* -  #.                                    DUP TO RP  TO AR    #.  PUSH                          1- #.  FOR !A+ #. NEXT #. ;                                 : NPOP  2+ DUP PUSH FOR RP AT RP 2* + @ NEXT  DROP ( 0)                    RP 2* + TO RP PUSH ;                                 : ZPSH TO AR  POP RP AR 2* - DUP TO RP AR 1- PUSH TO AR               BEGIN 0 !A+ NEXT PUSH ;                                   : WCOMP  PUSH TO AR   BEGIN  @+ @A+ XOR                                   IF DROP DUP XOR RDROP ;THEN DROP NEXT DUP XOR INV ;   : COMP  PUSH TO AR   BEGIN  C@+ C@A+ XOR                                  IF DROP DUP XOR RDROP ;THEN DROP NEXT DUP XOR INV ;    : USING FLUSH -USE FOPEN TO SCRH ;                              : LIST DUP TO SCR  BLOCK .BLOCK ;                               | : ?LD BLK 0= A" LOADING?" ;                                   : --> ?LD 0 TO >IN BLK 1+ TO BLK ; IMMEDIATE                    : COPY  SWAP BLOCK SWAP BLOCK 1K CMOVE UPDATE FLUSH ;           : THRU  1+ SWAP  DO I LOAD LOOP ;                               : +THRU BLK DUP D+ THRU ;                                       : -USE SCRH 1+ IF SCRH CLOSE DROP -1 TO SCRH THEN ;                                                                            \ : D1+ TO AR 1+ IF AR ;THEN AR 1+ ;                            \ : NUMBER ?NUMBER ROT ABORT" ?" ;                              T-VARIABLE PROBA                                                : #. CR 1 PROBA +!  DUP . PROBA @ . ;                                   : FIND          : ABORT : ERROR                         : COMP PUSH TO AR BEGIN  OVER AT RP + C@ OVER AT RP + C@ =         IF DROP NEXT DROP DROP 0 ;THEN DROP DROP DROP POP INV ;      \ 10 [[ 9 R@ - 10 * DUP 4 .R                                    \      9 [[ 9 R@ - OVER + 4 .R ]] CR ]]                         \ MAC: TEN # 10 ;                                               CR TEN [[ TEN R@ - TEN  [[ DUP TEN R@ - * 4 .R ]] DROP CR ]]    MAC: POP R> ;  MAC: PUSH >R ;                                   TO MAC: ! ;THEN EXIT THEN !                                     MAC: RDROP  AT DROP ;                                           : [[ POP >IN PUSH SWAP DUP IF 1- THEN PUSH PUSH ;               : ]] POP POP ?DUP IF 1- R@ TO >IN PUSH PUSH ;THEN RDROP PUSH ;  : ?CR -IF CR THEN ;                                             \ 256 [[ 255 R@ - 15 AND ?CR 255 R@ -  4 .R ]]                   10 [[ 9 R@ - 10 * DUP 4 .R                                           9 [[ 8 R@ - OVER + 4 .R ]] CR ]]                                                                                                                                                                                                                          : M+ S>D D+ ;                                                   : B_ADR 2DUP 1K UM/MOD DROP BLOCK + PUSH 1 M+ POP ;             : BPEEK B_ADR C@ ;  : BPOKE PUSH B_ADR POP SWAP C! UPDATE ;     FUNC: BLKREAD ( NBYTEL NBYTEH ADDRS BYTES / NBLOCK REMAIN )        1K NBYTEL 1K 1- AND - BYTES MIN TO REMAIN                       NBYTEL NBYTEH 1K UM/MOD DROP NIP TO NBLOCK                     BEGIN BYTES WHILE                                                NBLOCK BLOCK NBYTEL 1K 1- AND + ADDRS REMAIN CMOVE              REMAIN  AT ADDRS +!      NBLOCK 1+ TO NBLOCK                    NBYTEL NBYTEH REMAIN M+ TO NBYTEH TO NBYTEL                     BYTES REMAIN - DUP TO BYTES 1K MIN TO REMAIN                   REPEAT  ;                                                     : HV ( BYTE POSITION IN SCR FILE ) M+ 2DUP  PAD 256                BLKREAD   PAD   256    DUMP ;  : SV 0 HV ;                   : PV -256 HV ;   : NV 256 HV ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  