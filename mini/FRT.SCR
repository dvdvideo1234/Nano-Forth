PROBA.F                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( EDITOR MAKE  )                                                $8000 TO FENCE          FORGET |  SAVE2                                                                                                 HERE                                                      7 13  THRU   TO  SIZEMARK                                     SIZE. .( FIRST EXTENT)                                                                                                          \ 151 153 THRU     14  15 THRU   164 LOAD                        20 27 THRU                                                                                                                     SIZE. .( EDITOR)  CR                                                                                                                                                                                                                                                                                                                                                                            CREATE -IT  VOCABULARY ASSEMBLER   21898 5500 - TO THERE        : DEFINITIONS CONTEXT TO CURRENT ;                              : PREVIOUS ORDER TO CONTEXT ;                                   : DB, 1, ; : DW, 2, ; : SHORT?  -$80 $80 WITHIN ;               : VOC. 6 - ?ID. ;    MARKER -ASM    LIKE -ASM   BE -IT    -ASM  : ORDER. ;DROP AT ORDER DUP 2+ 2+ SWAP ITEMS? LOOPS STR VOC. ;  3 -HEADS !    : ;2DROP EX 2DROP ;   0 VECTOR VC                 : ?-CREATE ;2DROP >IN TOKEN 1+ @ $2D2D XOR 0; TO >IN 2DUP VC ;  : NFAMILY  ' TO VC 1H ;BASE  LOOPS TOKEN (DNUM ?-CREATE ;       : FAMILY ' TO VC  ;2DROP LOOPS DUP ?-CREATE OVER + ;              69 84 THRU  SIZE. .( ASSEMBLER)       PRUNE                                                                                                                                                                                                                                                                                                                                                   PAGE .( HELLO FRIENDS!  ON SUNDAY  13.12.08 )  CR CR                                                                            $8000 TO FENCE          FORGET |  SAVE2                                                                                         260 LOAD  \ HOUSEKEEPING  & EDITOR                              276 LOAD  \ ASSEMBLER                                           CR                                                              294 LOAD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        MARKER -MINI  ( DEFINING WORDS) \ MOVE WORD --------------------  MINI ALSO  TO MINI \ 45 LOAD                                   47   48   THRU   \ PREPARATIONS & MACROSES                                       SIZE. .( PREPARATIONS) CR                      31   38   THRU   \ CREATE TARGET COMPILER                            39   LOAD   \ CREATE TARGET COMPILER                            49   LOAD   \ INVOLVE TARGET COMPILER FROM  ZONE 49         52  64   THRU   \ KERNEL                                                        SIZE. .( KERNEL)           CR                       65   LOAD   \ MEMORY LOCATIONS  - VARIABLE OF ANY KIND          66   LOAD   \ DOS  PRIMITIVES                                   111  LOAD   \ ONLY FIXES  TO COMPILER                      112 150   THRU   PREVIOUS                                                        SIZE. .( FORTH BODY)       CR                                                                                                                                                 F83 : | 1 -HEADS ! ;    : LIKE ' @ ;  | : C@'+ C@ ' + ;         0 VECT> C@'+ EXEC ;    CODE, TO 2 1,                            : TRACE ' TR EXEC TR ;                                          : WW CR DUP .H STR DUP .H ?ID. ;                                : L WW WW WW WW WW WW WW ;                                      : SEE NOP ' L ;                                                 0 CODE, BYE                                                                                                                     : TEST CR SOURCE IN? 1L MIN TYPE ." <-" .BG ;                   : TEST-ON lit TEST TO 'TEST ;                                   : TEST-OFF 0 TO 'TEST ;                                         : TRACE ' TR EXEC TR ; IMMEDIATE                                                                                                                                                                                                                                                                                                PAGE                                                            CR CR  .( HELLO FRIENDS!)  CR CR                                                                                                      1 LOAD   \ EDITOR                                         ;S                                                                    2 LOAD   \ ASSEMBLER                                                                                                            4 LOAD   \ MAKE FILE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      F83 : | 1 -HEADS ! ;    : LIKE ' @ ;  | : C@'+ C@ ' + ;         0 VECT> C@'+ EXEC ;                                                  DUP CODE, TO 2 1, DUP CODE, AT 4 1,  CODE, FROM 6 1,       0 VECT> C@'+ ! ;                                                     DUP CODE, BE 0 1,     CODE, IS 2 1, : META ' IS ;                                                                          TO MACRO  0 VECT> C@'+ 2, ; : ['] COMPILE lit ', ', ;                DUP CODE, TO 2 1,  DUP CODE, AT 4 1,  CODE, FROM 6 1,      TO FORTH        : ;IN >IN EX TO >IN ;   : L/ 1L NEGATE AND ;                                                                    TO COMMON  : \ BLK #BLK IF ;IN 1L + L/  ;THEN 0 TO FNAME DROP ;            ( : \ ;IN BLK #BLK IF NL ;THEN 0 AND ; )             TO FORTH   0 TO CICLES  \ cr + lf                                                                                                                                                                                                                               ' XY  2@  (2: VALUE 2,             <N> : 3@ @+ 2@ ROT ;  <N>    ' 'SAME 2@  (2: VECTOR 2,                                       ' FGET 2+ @  3@  (3: QUAN 2,                                    ' HERE  2@  (2: GLOBAL 1,                                       ' BASE  2@  (2: USER 1,                                         : LINK+ HERE @SWAP 2, ; : WORDLIST Z, AT FORTH 2+ LINK+ ;       | ' FORTH 3@ (3: VOC: WORDLIST                                  : VOCABULARY AT FORTH ;NS VOC: ;                                \ : VARIABLE CREATE Z, ;                                        : VARIABLE 0 VARIABLE: ;                                        : CREATE VARIABLE SAVE2 ;                                       : BCONST AT COMMON ;NS  CONSTANT SAVE1                                DOES> C@ `` SWAP NPAD C!- C!- 2 TO EVAL ;                 LIKE STATES DUP  (1: WARY ZARY,      2+ (1: BARY ZARY,                                                                                                                                                                                                                                                                          | 0 VALUE WADR  |  : ;WADR WADR EX TO WADR ;                    : L ;WADR bs LOOPS CR DUP .H STR DUP .H ?ID. ;                  : SEE NOP ' TO WADR L ;                                                                   LIKE TYPE DUP  BE SEE IS SEE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          HERE VALUE FENCE       AT FORTH  2+  VALUE VOCLINK              <N>                                                               ' >LFA  ALIAS N>LINK                                            ' 2-    ALIAS V>LINK                                          <N>                                                             : ?DUP #IF DUP THEN ;                                           : forget C>N 1- A" ?FRG" DUP FENCE U< A" fnc"  PUSH               BEGIN VOCLINK @ ?DUP I U< 0=    IF @ VOCLINK ! AGAIN THEN      VOCLINK BEGIN DUP 2-                                             BEGIN @ DUP I U< 0=  IF  N>LINK  AGAIN THEN                    OVER 2- ! @ ?DUP 0= UNTIL FORTH TO FORTH POP TO HERE DROP ;    : FORGET '  forget ;                                            : MARKER ?EXIST IF >IN FORGET TO >IN  THEN                              CREATE DOES> 2- forget ;                                                                                                                                                                | VARIABLE %!%  | : #% @ IF %!% -HEADS 2 EXCHANGE THEN <N> ;    : <N 0 %!% ! -HEADS #% ;  : N> %!% #% ;                                                                                         : PRUNE VOCLINK                                                 BEGIN DUP PUSH V>LINK                                             BEGIN @ DUP HERE U< 0= IF    N>LINK  AGAIN THEN                 DUP I V>LINK ! ?DUP                                             IF DUP PUSH                                                       BEGIN  N>LINK @ ?DUP  IF                                          DUP HERE U< IF DUP POP N>LINK ! DUP PUSH THEN                 AGAIN  THEN 0 POP N>LINK !                                    THEN POP @ ?DUP 0=                                            UNTIL $F000 TO NPTR ;                                                                                                                                                                                                                                           : <^> POP  AT COMMON ;NS <N ;GO TO N> PUSH CREATE ;             \ N>                                                            \ : DEC -1 SWAP +! ;  : S-C! DUP DEC ;   \ DEL LAST CHAR        \ : INC  1 SWAP +! ;  : HOLD SWAP +1 ;                          \ : S+C! DUP XEP C@+ + C! J INC ;       \ APPEND CHAR                                                                           : D>STR 1H ;BASE NPAD DUP B! XEP 0 S# -19  SWAP 1+                         DUP C!B+   LOOPS ALPHA C!B+ ;                        : CONST  <^>  2,  DOES> @ 0 D>STR  EVAL ;                       \ N>                                                            | LBL: MAC::  <^>  TO FNAME S, DOES> EVAL ;                     TO COMMON                                                       : MAC: `;  MAC:: ; SAVE2        \  AT COMMON MOVEW              : MAC TOKEN 1+ C@ MAC:: ; SAVE2 \  AT COMMON MOVEW              TO FORTH                                                                                                                        : LOOPS CSP XCHG TO CSP  FOR CSP EXECUTE NEXT POP TO CSP ;      $ 2BBD  ALIAS BUFFER    | : ;UPLOAD  BUFFER 1K EX UPDATE ;      : ++ DUP 1+ XCHG PUSH EX POP SCR 1+ TO SCR ; : ;DROP EX DROP ;  : COPY BLOCK SCR ;UPLOAD CMOVE ; : COPIES ;DROP LOOPS ++ COPY ; : BMOV DUP COPY ;UPLOAD BLANK ; : BMOVES ;DROP LOOPS ++ BMOV ;                                                                  EXIT                                                            0 VALUE SIZEMARK                                                : SIZE. CR CICLES .  ." CICLES  " 0 TO CICLES                              HERE DUP SIZEMARK - . ." BYTES IS " TO SIZEMARK ;                                                                                                                                                                                                                                                                                                                                                                                                    : T. EXEC . EX . EX . EX . ;                                    : *. DUP * . ;                                                  : T^. EXEC *. EX *. EX *. EX *. ;                               : TASK1 1 EX 2 EX 3 EX 4 ;                                      : TASK2 4 EX 3 EX 2 EX 1 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0 VALUE PET    200 BARY CHARS   0 CHARS VALUE BPTR              : ;PET PET EX TO PET ;     : ;PTR BPTR EX TO BPTR ;             : C!+ DUP 1+ PUSH C! POP ;                                      : ADD ;PET + ;             : C++ ;PTR C!+ ;                     : SUB NEGATE ADD ;                                              : DIV ;PET SWAP / ;                                             : MUL ;PET * ;                                                  : FETCH ;PET @ ;                                                : STORE ;PET ! ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                : ++ DUP 1+ XCHG PUSH EX POP SCR 1+ TO SCR ;                    \ : ;DROP EX DROP ;                                             | : ;UPLOAD  BUFFER 1K EX UPDATE ;                              : COPY BLOCK SCR ;UPLOAD CMOVE ;                                : COPIES ;DROP LOOPS ++ COPY ;                                  : BMOV DUP COPY ;UPLOAD BLANK ;                                 : BMOVES ;DROP LOOPS ++ BMOV ;                                  0 VALUE ALTSCR                                                  : SA  ALTSCR SCR TO ALTSCR TO SCR E ;                                                                                                                                                           \ : PUSHES LOOPS J 1+ TO TEST ;                                 \ : POPS LOOPS TEST . ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \ TARGET COMPILER \ STACKS , C,  CELL+ CELL- CELL* INC DEC      FORGET STK  : STK ;    ' 2- ALIAS CELL-  ' 2, ALIAS ,           ' 1, ALIAS C,   ' 2+ ALIAS CELL+  ' 2* ALIAS CELL*                                      : STACK, DUP , Z, CELL* CLARY ;         | : SWAP;, SWAP EX , ; : 3, SWAP;, C, ;   : 4, SWAP;, , ;       : Z, 0 , ;     : ZC, 0 C, ;    : W, STR , ;   : B, CSTR C, ;    : INC 1 OVER +! ;  : DEC -1 OVER +! ;  : TOPEL STR 1- CELL* + ; 0 VECT> CELL+ ; \ : (DLIT (DNUM DPL 1+ IF SWAP 'LIT THEN 'LIT ; 1 VECT> @+ PUSH I @ = A" full" POP INC TOPEL ! ;                2 VECT> CELL+ PUSH I @ 0= A" empty" I TOPEL @ POP DEC DROP ;    (3: STACK STACK,  : FIX DUP @ A" ?FIX?" HERE SWAP! ;            : ON -1 SWAP! ; : OFF 0 SWAP! ;   : @SWAP OVER @ XEP SWAP! ;                                                                                                                                                                                                                                                                    \ COMPILER STUFF   -  NAME GENERATION                           | : H1 'SAME BLK 2, CURRENT HERE TOKEN S, @SWAP 2, ;            | : H2  -1 -HEADS +! HERE <N> ;GO TO <N> ALIAS ;                | : H3 -HEADS @ IF H2 ;THEN H1 ;                                : HEADER H3   HERE TO CFA ;                                     | : ;PERF HEADER W, EX PERFORM ;                                | : ;CODE, CREATE A, EX ,' ;                                    : (1: ;CODE, DOES> ;PERF ;                                      : (2: ;CODE, 2, DOES> ;PERF W, ;                                : (3: ;CODE, 2, 2, DOES> ;PERF W, W, ;                                                                                                                                                                                                                                                                                                                                                                                                                          \ COMPILER STUFF   - NO NAME GENERATION : ;, EX 2, ;            : ;HERE HERE EX TO HERE ;                                       : ALLOT ;HERE + ; \ : ?DUP DUP 0; DUP                           : <%> THERE ;HERE TO THERE ;                                    : <N> NPTR ;HERE TO NPTR ;                                      AT CSTK INITSTK                                                 | : ;CSP CSP EX TO CSP ;                                        : ?CSP SP@ ;CSP - A" ?IF?" ;                                    : CSP! ;CSP SP@ ;                                               : ?STKC CMARK  AT CSTK @ XOR  A" ?LP?" CSTK TO CMARK  CSTK ;    : STKC!  TO CSTK  CMARK TO CSTK  AT CSTK @  TO CMARK ;                                                                                                                                                                                                                                                                                                                                          \ COMPILER STUFF   - NO NAME GENERATION                          0 WARY STATES ]] (DLIT 2, (DNUM EXEC [[ \ INTERPRET            : A, 1 STATES PERFORM ;   \ COMPILE ADDRESS                     : S, ;DROP CSTR DUP 1, LOOPS B, ;                               : ," =" S, ;                                                    : ,T TOKEN S, ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | : LOCATE ;SWAP 3 TOKEN SRCHPNT  PUSH  CICLES 1+ TO CICLES ;   : ' LOCATE DUP 2 AND = ?? ; \ COMPILER                          : ALIAS [[ #DO-DEFER @ 5 - , ]] H1 2, 2, ; \ ;, ;, H1 ;         : CODE, HEADER A, ; : ,' ' A, ; : CREATE lit NOP CODE, ; \ !!!  LIKE (?DBG BE HEADER                                            #DO-CONST @ 'T (1: 6 + 'CODE, CONSTANT  , 'T 2, ,               #DO-VAR  @  'T (1: 6 + 'CODE, VARIABLE: , 'T 2, ,                #DO-VAR  @  'T CREATE 2+ 2+ !    \ PATCH CREATE  !!!                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \ LOCATE ' INTERPRETTER COMPILER [ ]  ',  (: (;                 | : .! POP TO SRCHPNT ;                                         : ] .! AT MACRO VFIND if; AT COMMON VFIND if; U1- U1-            CONTEXT VFIND if; AT HIDDEN VFIND if; AT ORDER  FIND if; U1- ; : [  .!  CONTEXT VFIND if;  AT ORDER  FIND if; \ INTERPRETER         AT COMMON VFIND if; U1- ;  'T [   TO SCRH   COMPILING      | : CUTW     CURRENT @ DUP >LFA 0 @SWAP CURRENT ! ;             | : PASTEW OVER @SWAP SWAP >LFA ! ; \ : MOVEW CUTW SWAP PASTEW ;| : (:  STKC!  0  TO CSP  CSP! ] ;  | : ((: CUTW (: ;           | : (;  ?CSP ?STKC  CSP   A" ?:;?" [[ SCRH , ]]                        #IF CURRENT PASTEW DUP THEN DROP; ;                      : VECT>  (+DOES 0 (: ;                                          : 4TH> 0 (4TH:  0 (: ;                                          \ : VARIABLE: CREATE 2, ;                                                                                                                                                                       \ MAIN LOOP     \ COMPILE NUMBER LIKE LITERAL                   \ 0 VECTOR 'TEST   6 LOAD                                                                                                       LBL: (INT  \ CR SOURCE IN? 1L MIN TYPE ." <-" .BG                           'TEST                                                          LOCATE STATES PERFORM INTERPRET ; SAVE2 \ MAIN LOOP  : F83 DECIMAL  FORTH  ONLY  TO FORTH ;                                                                                          | : (INIT lit (INT  TO INTERPRET   lit (LIT TO  'LIT  0 TO BLK  lit (DNUM 2 STATES !  lit (DLIT 0 STATES ! lit 2, 1 STATES !      AT CSTK INITSTK    F83  [[ SCRH , ]] ;     \ INTERPRETTER ON  : (AB  CLOSE-ALL (INIT   ON-START 0 @SWAP                         IF  EMPTY-BUFS  NPAD 1+ EVAL  " FRT01.SCR"  FOPEN                 TO SCRH  3 LOAD   THEN   BEGIN KBD AGAIN ; SAVE2                                                                                                                                            : SAVE2 ;HERE 2- ;                                              : SAVE1 ;HERE 1- ;                                                                                                              'T (1: 6 +  'CODE,  :      LIKE SAVE2 , 'T ((: ,  \ : !!!       LIKE :  'CODE, LBL: LIKE (INT  , 'T ((: ,                       (": ; EXIT (;                                                   (": DOES>  ;code  0DOES>                                                                                                        'T ,' DEFER ',    COMPILING                                                                                                     \ UPV TO THRESHOLD  \ VOXAN    : CREATE VARIABLE SAVE2 ;                                                                        \ : HFORTH ABORT ;                                              \ 0 VALUE LastCompAdr    0 VALUE LastSP    0 VALUE LastVocAdr   \ : TFIND                                                                                                                                                                                        MARKER -TARGET                                                    PREVIOUS                                                      VOCABULARY TCOMP                                                ASSEMBLER ALSO                                                                                                                  TCOMP ALSO   DEFINITIONS                                                                                                        |   32768 CONSTANT MSB                                          |  MSB 1-  CONSTANT -MSB                                                                                                          VARIABLE LX                                                                                                                                                                                                                                                                                                                   : CODE, HEADER , ;                                              | : @LITERAL @ [',] LITERAL ;                                   | : @, @ , ;   : OLDTC LIT LIT LIT [ ' [LIT] 2+ , ] ! ;         : (( HEADER COMPILE [ ' DO: @, ] , , IMMEDIATE ;                | : CONST CREATE LX LINK+ , , DOES> 2+ DUP 1+! 2+ @LITERAL ;    | : <F> <% CONST IMMEDIATE %> ;   | : <00F> 0 0 <F> ;           : ALIGNED HERE SWAP ALIGN TO HERE ;                                                                                              <%                                                               ' IOV @                                                         1 NM: HERE 2+ SWAP! ;M                                          2 NM: @LITERAL ;M                                                HEADER JUSTIFY , , , 0 ,  IMMEDIATE                           %>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             : RDROPS CO RDROP ;                                             | : DUPE? RDROPS RESCAN 0>=                                         IF 2DROP ;THEN STR ROT - IF DROP ;THEN  RDROP                  2+ STR 0< A" DUP! " MSB OVER 2- XOR!  HERE   ;               | : ?REL HERE SWAP  IF OVER 2+ - THEN ;                         | : A?REL DUP 1- C@ 1 OR $ E9 XOR 0= ?REL ;                     : FW <00F> TO JUSTIFY                                                  DOES> 2+ DUP 1+! STR 0<                                        IF @, ;THEN LINK+ ;                                                                                                       : ?FW JUSTIFY DUPE?  N>C SWAP                                                                                                                                                                                                                                                                                                                                                                          DOES> 2+ DUP !+! STR 0<                                        IF @LITERAL ;THEN  ?E ' CASE                                     ['] JMP,  OF BCOMPILE [ $ E9 C, ]                                LINK+ ENDOF                                                    ['] CALL, OF BCOMPILE [ $ E8 C, ]                                LINK+ ENDOF                                                    [']   DW, OF LINK+ ENDOF                                        A" NO LBL OP!" ENDCASE ;                                 | : ?FL JUSTIFY DUPE? BEGIN TO >< ?DUP                                WHILE A?REL REPEAT                                          ( !!! BLWORD DROP ) BLWORD DROP RDROP ;                                                                                                                                                                                                                                                                                                                                                        | : VIEWER: : DOES> PUSH  CR LX @ SKIP BEGIN                      STR SWAP DUP @ R@ EXECUTE THEN ?DUP -UNTIL RDROP ;            | : ?NODE. 0= IF  DUP STR .H @ .H 4 - ?ID. ?TAB ;THEN DROP ;    VIEWER:  TLIST.  DUP XOR ?NODE. ;                               VIEWER:  UNDEF.  0< ?NODE. ;                                    VIEWER: UNUSED.  -MSB AND ?NODE. ;                              \ PREVIOUS                                                       VOCABULARY KERNEL   KERNEL ALSO F83 PRUNE                                                                                                                                                                                                                                                                                         BEGIN OVER TO >< ?DUP -UNTIL DROP ;                                                                                         : FL <00F> TO JUSTIFY                                                                                                                                                                                                                                                                                                             : C: MSB <F> ;   : L: ?FL HERE C: ;                            | : ?TAB 52 OUTC < IF CR ;THEN 26 OUTC OVER MOD - SPACES  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   : S-INS ST PUSH TO SPTR >S POP SPTR +! ;  \ INSERT STR IN TOP   : #>S ;DROP S-! ST LOOPS C!+ ;            \ FORMATED PUSHSTR    : S!+ PUSH C@+ OVER I C@+ + SWAP CMOVE POP +! ; \ APPEND STR    : SWAP+S S> CSTR S-INS ;                  \ CONCAT TOP & NEXT   : C>S  1  #>S ;    $C000 TO SPTR          \ CHAR > STR          : C-INS C>S SWAP+S ;  : S>! S> SWAP S! ;  \ INSERT CHAR IN TOP                                                                  : S" =" CSTR S-! ST CMOVE ;               \ INPUT > SS          \ : SPOP! S> CSTR PUSH SWAP POP CMOVE ;     \ POP TO HERE       : N>S  0 S# #>S ; 0 0 >S  0 0 >S        \ NUM > STR == ITOA     : S+C! DUP PUSH C@+ + C! 1 POP +! ;       \ ADD CHAR                                                                                                                                                                                                                                                                                                                                            \ HERE TO FENCE  CREATE -MARKER                                    0 VALUE XK  : WHAT? 7 EMIT ;                                 : -:  ' 2, 1,  XK 2+ DUP TO XK       ( BYTES FOR MOVE UP 1 )             HERE OVER - DUP PUSH       ( START ADDRESS   )                  DUP 1+ ROT                 ( PREPARE FOR MOVE)                  CMOVE>  HERE C@ POP C!   ;   ( FIX CODE  )             : SWITCH: CREATE HERE 73 1 TO XK 0 -:                               DOES> SWAP TO XK CSTR 2DUP XK =B? 1+ 2* + + PERFORM ;       : ;SWITCH  73 - A" BAD KEYS" XK 2/ 1- SWAP C! ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 : ST  SPTR CSTR ;                         \ STACK TOP / NEXT    : S-! SPTR OVER 1+ - DUP TO SPTR C! ;     \ STRING ALLOC        : >S PUSH SPTR I - I CMOVE> POP S-! ;     \ PUSH STRING         : SDROP  ST + TO SPTR ;                   \ DROP STRING         : S> SPTR SDROP ; \ : S! OVER C@ 1+ MOVE ; \ POP / MOVE STRING  : S>! S> SWAP S! ;                        \ INSERT CHAR IN TOP  $C000 TO SPTR                                                   0 0 >S  0 0 >S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (  EDITOR POSXY WIPE RELOAD SAVEBLK LB N B ARROW)               F83      -HEADS ON                                              0 VALUE  PDATA    VARIABLE INS  0 VECTOR 'ADVANCE               : ?XY 1L U/MOD 5 2 D+ ; \ 2DUP 15 0 ATXY SWAP . .               : POSXY XY ?XY ATXY   ;         : ?INS INS @ ODD ;              : .INS  75 2 ATXY ?INS IF ." INS" ;THEN ." OVT" ;               : _INS  1 INS XOR! .INS ;    : RELOAD SCR BLOCK TO PDATA ;      : REDRAW .INS 0 0 ATXY SCR 8 #. CR  PDATA .BLOCK ;              : /L  1L 1- OR ;           ( LINE END)                          \ : L/ 1L NEGATE AND ;       ( LINE BEGIN)                      : ;LRUD  XY EX >XY ;                                            : ;LPOS  XY EX PDATA + ;                                                                                                                                                                                                                                                                                                        ( COPY POS^ LINE/ /LINE LDRAW EL INSC DELC OVTC INSL DELL LL  ) : L_UP  ;LRUD  1L - ;     ( LINE UP)                            : L_DN  ;LRUD  1L + ;     ( LINE DOWN)                          : L_END ;LRUD  /L ;       ( LINE END)                           : L_BEG ;LRUD  L/ ;       ( LINE BEGIN)                         : ->    ;LRUD  1+ ;       ( MOVE 1 CHAR RIGHT)                  : <-    ;LRUD  1- ;       ( MOVE 1 CHAR LEFT)                   : TAB>  ;LRUD  7 OR 1+ ;  ( NEXT TABULATION )                   : <TAB  ;LRUD  1- -8 AND ;  ( PREVIOUS TABULATION)              : <_|   L_DN L_BEG    ;   ( CARRIGE RETURN L_DN L_BEG )         : APOS  ;LRUD  0 AND ;    ( HOME POSITION OF CURSOR)            : LINE/ ;LPOS L/ ;  : /LINE ;LPOS /L ;                          : LDRAW POSXY LINE/ cr EMIT XY 1L / 1+ .LINE DROP ;    \ OK POS : EJECTBLOCK DISCARD -1 PREV BUFS ! ;                           : RESET EJECTBLOCK RELOAD REDRAW ;   ( !!!!!!!)                                                                                 \ TEST-ON                                                       : LB SCR + 0 MAX TO SCR RELOAD REDRAW ;   ( +blk - )            : LEOS 1K  XY - 1L - 0 MAX ;  ( - chars_to_end_of_screen )      : POS^ PDATA XY + ;          ( - char^ )                        : P2 POS^ DUP DUP 1L + ;     ( - char^ char^ char^+1l )         : LL XY /L XY - ;            ( - chars_to_end_of_line )         : GETCHAR XY 0= 'ADVANCE POS^ C@ 33 U< ;                        : -BL BEGIN  GETCHAR 0= OR UNTIL ;        : N  1 LB ;           : -NONBL BEGIN GETCHAR OR UNTIL ;         : B -1 LB ;           : >NEXT TO 'ADVANCE -NONBL -BL ;  : ADV ['] -> >NEXT ;          : >EL 1K LEOS - 1L MIN ;      : BACK ['] <- >NEXT -> ;          : EL >EL BLANK ;  ( ERASE LINE OR LESS)                         : RDRC REDRAW UPDATE ;                                          : DELL P2 SWAP LEOS CMOVE LEOS +  EL RDRC ;                     : >INSL P2 LEOS CMOVE> EL ;                                     \ TEST-OFF                                                      : C POS^ >EL L_DN >S ;             : G C L_UP DELL ;            : P ST NIP 0;  >INSL  SPTR CSTR SDROP                                   >EL MIN POS^ SWAP CMOVE RDRC ;                          : OVTC POS^ C! UPDATE ;                                         : INSL >INSL RDRC ;                                             : POSC POS^ DUP 1+ ;                                            : INSC ?INS IF POSC LL CMOVE> THEN OVTC ;                       : DELC POSC SWAP LL CMOVE bl /LINE C! LDRAW UPDATE ;            : BS <- DELC ;                                                  : X-POS 0 18 ATXY CSP RP! ;                                     : Q/ED  FLUSH  X-POS ;                                          : ESQ/E EMPTY-BUFS X-POS ;                                                                                                                                                                                                                                                                                                       72 CONST kUP       80 CONST kDOWN     77 CONST kRIGHT           75 CONST kLEFT    116 CONST kcRIGHT  115 CONST kcLEFT           82 CONST kINS      83 CONST kDEL      73 CONST kPGUP            81 CONST kPGDN     71 CONST kHOME     79 CONST kEND            119 CONST kcHOME   117 CONST kcEND     59 CONST kF1              60 CONST kF2       61 CONST kF3       62 CONST kF4              63 CONST kF5       64 CONST kF6       65 CONST kF7              66 CONST kF8       67 CONST kF9       27 CONST kESQ             68 CONST kF10      84 CONST ksF1      93 CONST ksF10            94 CONST kCF1     103 CONST kcF10     15 CONST ksTAB           104 CONST kaF1     113 CONST kaF10      9 CONST kTAB                                                                                                                                                                                                                                                                                                                                            : @KEY POSXY BKEY B/MOD #IF SWAP ;THEN DROP ;                   : ONEC XK bl U<  IF WHAT? ;THEN XK INSC LDRAW -> ;              | SWITCH: EF WHAT?               kLEFT -: <-     kUP -: L_UP     kHOME -: L_BEG   kEND -: L_END  kPGUP -:  B   kPGDN -: N        kDOWN -: L_DN  kRIGHT -: ->     kINS  -: _INS  kDEL -: DELC     ksTAB -: <TAB  kcHOME -: APOS  ;SWITCH                         | SWITCH:  EK  ONEC   ^J -: <-  ^K -: ->     ^X -:  G             127 -: DELL    bs -: BS        ^D -: DELC  cr -: <_|           ^N -: N     ^B -: B    ^L -: RESET   ^I -: TAB>                 ^C -: C     ^V -: P    ^Q -: ESQ/E   ^Z -: BACK                 ^A -: ADV   kESQ -: Q/ED  ^S -: INSL   0 -: EF   ;SWITCH       : E  RELOAD REDRAW  RP@ TO CSP  BEGIN @KEY EK AGAIN ;           : EDIT PAGE TO SCR  E ;     : ERR SCR EDIT ;                    : HELP SCR PUSH TO SCR E POP TO SCR E ;                         : VIEW ' C>N IF @- SWAP HELP THEN DROP ;                                                                                        VOCABULARY TEMP                                                 : VMOVE PUSH 0 @SWAP POP ! ;                                    : DO-PRUNE PUSH I AT TEMP VMOVE PRUNE AT TEMP POP VMOVE ;       : DO-RELINK 2+ PUSH VOCLINK I @SWAP POP ! ;                                                                                     AT MACRO  DO-PRUNE                                              AT COMMON DO-PRUNE                                              AT HIDDEN DO-PRUNE                                                                                                              AT MACRO  DO-RELINK                                             AT COMMON DO-RELINK                                             AT HIDDEN DO-RELINK                                                                                                             FORGET TEMP                                                                                                                                                                                     | LBL: MAC:: AT COMMON ;NS <N ;GO TO N>  CREATE                          TO FNAME        S, DOES> EVAL ;                        : MAC: `;  MAC:: ; SAVE2          AT COMMON MOVEW               : MAC TOKEN 1+ C@ MAC:: ; SAVE2   AT COMMON MOVEW               <N> : +VOC AT FORTH 2+ ' 8 +  DUP PUSH @SWAP POP ! ; <N>        AT FORTH 2+ OFF                                                 +VOC MACRO                                                      +VOC COMMON                                                     +VOC HIDDEN                                                     \ +VOC ASSEMBLER                                                                                                                PRUNE                                                           \ 18 LOAD                                                       \ : VOC. 6 - ?ID. ;                                             \ : NV CR DUP 2DUP .H 2- VOC. @ .H @ ;                                                                                          0 VALUE ALTSCR                                                  : SA  ALTSCR SCR TO ALTSCR TO SCR E ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ' ' ALIAS 'T                                                    : CODE, HEADER , ;   : @CODE, @ CODE, ;  ' CODE, ALIAS 'CODE,    VARIABLE  #DO-VAR   : CREATE  #DO-VAR @CODE, ;                 : VAR: CREATE , ;   ' #DO-VAR @+ !  0 0 44 FAMILY VAR:          #DO-SETG  #DO-FCOL  #DO-RPUSH #DO-EX    #DO-ARY   #DO-LBL       #DO-DOES  #DO-FLBL  #DO-LIT   #DO-SEMI  #DO-COL   #DO-CONST     #DO-GETG  #DO-DEFER #DO-BR    #DO-?BR   #DO-WPUSH #DO-#BR       #DO-USER  #DO-SETU  #DO-USRV  #DO-MNEXT #DO-.STR  #DO-.ABRT     #DO-MBR   #DO-FOR   #DO-NEXT  #DO-BOOT  #DO-SETV  #DO-OF        #DO-SWAP  #DO-DROP  #DO-CALL  #DO-STR   #DO-;4TH  #DO-4TH:      #DO-MOVE  #DO-SIZE  #DO-COMP  #DO-MACR  #DO-4TH   #DO-GLBV      #DO-;CODE #DO-COMM                                              LIKE (INT  #DO-LBL !    ' lit #DO-LIT !                         #does #DO-DOES !        ' ;code #DO-;CODE !                     ' EXIT #DO-SEMI !       LIKE CODE, #DO-COL !                                                                                    : TSIZE HERE #DO-MOVE @ - ;   : D, , , ;  : @, @ , ;                                             : CODE,, SWAP CODE, , ;                                                                        \ : .. B. " 'T .H .H" EVAL ;                                    \ : N. " (DNUM" AT MINI VFIND  .H .H  CR ;                      \ : ," bl PARSE ;DROP DUP 1, LOOPS B, ;                                                                                         \ : S, CSTR ;DROP DUP 1, LOOPS B, ;                                                                                             : ," =" S, ; : ,T TOKEN S, ;                                                                                                                                                                                                                                                                                                                                                                                                                                    : HL! HERE ' EXEC ! ; | : GETBACK ;HERE @- ;  : >LNK N>C 2- ;   \ AT MACRO  VALUE DEST   CONTEXT VALUE SOURC    FROM CONTEXT    : IMMEDIATE  CONTEXT  ;NS  AT MACRO  MOVEW ;  \   TO MACRO      : (': ' CREATE SWAP D, IMMEDIATE DOES> STR @ NEW, PERFORM ;     : (":, HEADER #DO-COMP @, ' NEW, ' NEW, ;                       : COMPILING  #DO-MACR @ MOVEW ;  : (": (":, COMPILING ;         : ;CONST #DO-CONST @ HEADER EX D, ;     : CONSTANT ;CONST ;     : ;1 #DO-SETV @ SWAP EX 1- , ;  : ;2 #DO-VAR @ -ROT  EX 2- , ;  : ;DEFER #DO-DEFER @ HEADER EX D, ;     : DEFER   ;DEFER ;      : VALUE    ;CONST ;1 ;          : VECTOR  ;DEFER ;1 ;           : QUAN     ;CONST ;1 ;2 ;       : VQUAN   ;DEFER ;1 ;2 ;                                                                        ' FORTH ALIAS 'FORTH   ' BLK ALIAS 'BLK  ' >IN ALIAS '>IN       ' HERE ALIAS 'HERE                  ' ALLOT ALIAS 'ALLOT                                                                                                                                        #DO-COL  (': ((: <:>    -IMMEDIATE                                                                   : : HEADER <:> ;           #DO-SEMI (': (;  ;    \  (": ; EXIT (;                                                                                          | : LBL, #DO-LBL @, ;                                           | : -: : SAVE2 ;                                                | : :,1 #DO-COL @ 1- , ;        : LBL: -: LBL, ;                : >: -: :,1 LBL, ;              : :: -: :,1 :,1 ;                                                                               ( COMPILING WORDS)  ( USING CASE WHILE REPEAT BEGIN THEN )      | #DO-LIT (': 2,  ((LIT   -IMMEDIATE                            M' ((LIT ALIAS LITERAL IMMEDIATE                                : ', ' ADR, ; IMMEDIATE                                         | : +DOES 2 OVER U< A" 3<?" NEGATE #DO-DOES @ + #CALL, ;        | : 0+DOES> 0 +DOES ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \ : REPEAT ', AGAIN ', THEN ; IMMEDIATE                         #DO-BR    (': <RELEASE AGAIN    #DO-?BR  (': <RELEASE UNTIL     #DO-BR    (': >MARK  AHEAD      #DO-?BR  (': >MARK    IF        #DO-#BR   (': >MARK  #IF        #DO-OF   (': >MARK    OF        #DO-CALL  (': >MARK  ?CALL      #DO-MNEXT (': >MARK  ?-FOR      #DO-RPUSH (': MARK>  FOR-       #DO-NEXT (': <RELEASE NEXT-     #DO-MBR   (': >MARK  -IF        #DO-SEMI (': RELEASE< ;THEN     #DO-FOR   (': >MARK>  FOR       #DO-NEXT  (': <RELEASE< NEXT    #DO-;CODE (': 0+DOES> DOES>     #DO-.ABRT  (': ,"    A"         #DO-STR   (':   ,"  "          #DO-.STR   (': ,"    ."                                                                          ' RELEASE< ALIAS THEN IMMEDIATE                                 M' IF  ALIAS WHILE IMMEDIATE                                                                                                                                                                                                                                    \ ELSE CASE IF USER VAR: -------------------                                                                                    : ELSE ?CSP PUSH ', AHEAD  POP CSP! ', THEN ;  IMMEDIATE        M' ELSE ALIAS ENDOF IMMEDIATE                                   : CASE CSP! CSP  0 TO CSP  ;  IMMEDIATE                                                                                         M' IF ALIAS WHILE IMMEDIATE                                     M' [ ALIAS [[ IMMEDIATE                                         ' MARK> ALIAS BEGIN IMMEDIATE                                   ' ] ALIAS ]]                                                    : USER  #DO-USER @ CODE,   #DO-SETU @, C, ;                     : GLOBAL  #DO-GETG @ CODE,   #DO-SETG @, C, ;                                                                                                                                                                                                                                                                                   \ BARY WARY CONSTANT VALUE ---------------------                : WARY #DO-ARY @ CODE, 2* CLARY ;                               : BARY #DO-ARY @ 2+ CODE, CLARY ;                               : VARIABLE CREATE 0 , ;                                         : IMMEDIATE  #DO-COMM @ MOVEW ;                                 : VECT> HERE SWAP +DOES 0 (: ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ASSEMBLER DEFINITIONS    \ MACROSES                                                                                             : ;C EX END-CODE ;      : @J @ JMP, ;           : @@J @ @J ;    : /PUSH ;C #DO-WPUSH @J ;       : /SWAP ;C #DO-SWAP @J ;        : >USR1  CBW, #DO-USRV @ /// AX ADD, AX DI XCHG, ;              : >GLB1  CBW, #DO-GLBV @ /// AX ADD, AX DI XCHG, ;              : /DROP  ;C #DO-DROP @@J ;      : /JUMP AGAIN, ;C ;             : 0>AX, AX AX XOR, ;   : 2*, BX BX ADD, ;                       \ : DUP, BX PUSH, ;    : DROP, BX POP, ;                                                                                        : XOR-DBG, [ AX DI XCHG, DI SKIPW, HERE @- TO HERE                  UNPACK    XOR    ] LITERAL #, #DO-EX @ 1+ ///  XOR, ;                                                                                                                                                                                                                                                                       VOCABULARY MINI   MINI ALSO  DEFINITIONS  ASM  \ RELOCATOR                                                                      HL! #DO-MOVE CALL,? 1                                           #DO-MOVE @ #, DI MOV, $ 1000 #, BX MOV,    $ 4A #, AH MOV, DOS,  $ F #, AH MOV, VIDEO,  DROP, SI POP, SI BX SUB, 3 #, SI SUB,   HL! #DO-SIZE 1234 #, CX MOV,                                             CLD, REP: MOVSB, $ 103 X/D BX LEA, SI BX SUB,  BX JMP, FL: 1  #DO-MOVE @ 3 + CALL,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     : PROBA1 1 EX 2 EX 3 EX 4 EX 5 ;                                                                                                : PREX PROBA1 . EX . EX . EX . EX . ;                                                                                           : Q. DUP * . ;                                                                                                                  : QEX PROBA1 Q. EX Q. EX Q. EX Q. EX Q. ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       CODE (;4TH  SI JMP,  SI POP,  /CODE                                                                                             CODE (?DBG  ?NEXT @ #, AX MOV,  ?NEXT /// AX XCHG,                  0 #, AH CMP,  SAVE1  AX DI XCHG,                                LIKE SKIPB,         \ NEST - INCASE NO DEBUG / ELSE DOWN -v     0=, NOT UNTIL,  SCASW,   X, SI PUSH, AX PUSH, DI PUSH, X,       ' (;4TH 2+ 2+ #CALL,    /ASM ] EX                                                                 (;4TH [                                                                 ASM                   X, AX POP,   AX ?NEXT /// MOV, SI POP, X, /CODE                                                                             \ LIKE (?DBG BE LOCATE    LIKE (?DBG BE -TEXT                   \ LIKE (?DBG BE HEADER    LIKE (?DBG BE PARSE                                                                                                                                                                                                                   : TEST" 1H ;BASE BLK . 34 TO FNAME EVAL CR ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    : ;CONTEXT CONTEXT XCHG PUSH EX POP TO CONTEXT ;                : M' ;CONTEXT  MACRO ' ;        : @H. HERE 1L 2/ - 1L DUMP ;    : N>C CSTR 31 AND + 2+ ;                                        \ TO COMMON : $ 1H ;BASE TOKEN EVAL ; TO FORTH                  M' DOES> 2+ @ ALIAS ;code                                       \ : PRESERVE POP OVER PUSH OVER @ PUSH PUSH ! EX POP POP ! ;    \ : PRESERVE A! POP A PUSH A@ PUSH PUSH !A EX POP POP ! ;       \ : PRESERVE XCHG I @ PUSH PUSH EX POP POP ! ;                  | : ;IMMED  ;NS CONTEXT  MOVEW ;                                : -IMMEDIATE  AT MACRO ;IMMED ;                                 : IMMEDIATE  CONTEXT ;NS  AT MACRO MOVEW ;                                                                                                                                                                                                                      : B. CR BLK 5 #. 1K >IN NEGATE - 1L /MOD SPACE  1+ . .               S. ."  H/T " HERE H.  THERE H.    KBD ; \ BKEY DROP ;                                                                      -1 VALUE THRESHOLD       : REMAINS SPTR HERE - 6 #. ;           : ADR, 1 STATES PERFORM ;                                       : ADR?OK DUP THRESHOLD U< IF ;THEN  1   A"  <ADR?> " ;          : NEW, ADR?OK  ;HERE ADR?OK !+ ;                                \ : ERR ['] 2,  1 STATES ! ERR ;                                \ : (': CREATE ', ', 2, IMMEDIATE  DOES> STR @ ADR, PERFORM ;                                                                   MAC: , 2, ;                                                     MAC: C, 1, ;                                                    MAC: UNPACK B/MOD ;                                                                                                                                                                                                                                             $100 TO THERE                           \ NEW COMFILE START     ' NEW, 1 STATES !                       \ TARGET CHECK ON         MINI ALSO  DEFINITIONS  ASM                                    -19 +ORIGIN    TO THRESHOLD       \ THRESHOLD ADDRESS                                                                           THERE THRESHOLD OVER - ERASE                                                                                                                     SIZE. .( TARGET COMPILER)                     <%>    \ COMPILE TO TARGET  ON                                                    SIZE. .( CHANGE TARGET)                       ;S                                                                                                                              CHANGING  COMPILE PART OF THE INTERPRETER                       WE CAN COMPILE TO TARGET ADDRESSES  AND                         WE SHALL BE CHACKED FOR CORRECTNESS OF THE ADDRESS                                                                                                                                                                                                              TRACE \ DGFASDFASD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \  ----- CATCH COMPILATION ADDRESSES                            0 VALUE THRESHOLD                                               0  TO THRESHOLD       : ;HERE HERE EX TO HERE ;                 .( VERY BAD !!!) ABORT                                          : SKIP POP 2+ PUSH ;                                                                                                            : NEW, DUP THRESHOLD U< A"  THRESHOLD ?" ;HERE !+ ;             ' NEW, $ 108  !  \ CONSTANT WHERE,  IS THE ADR,                                                                                 \ EXIT                                                          \ : PROBA 1 2 3 4 .DBG . . . . ;                                : VIEW ' C>N IF 2- @ EDIT THEN ;                                                                                                : NEW2  BLK , CURRENT ;                                         ' NEW2  $ 17C8 !                                                                                                                HL! #DO-BOOT   CLD, JMP,? 1   508 CLARY                         FL: 1   $1000 #, BX MOV,   $4A #, AH MOV, DOS,                             $F #, AH MOV,   VIDEO, ?, J,? 1                      #DO-BOOT @ 128 +  VALUE UPV   HERE 2- DUP #DO-USRV !            FB: 1 /// SI MOV, 6 #, SI ADD,                                   CLD, LODSW, AX SP XCHG, LODSW, AX BP XCHG,  CALL,? 1  4 C,     #DO-USRV @ 2+ CODE, ABORT                                       0 CODE, DROP     0 CODE, NOP    0 CODE, EXEC   0 CODE, PERFORM  0 CODE, +ORIGIN  0 CODE, EMIT   0 CODE, KEY    0 CODE, ?EMIT    HL! #DO-4TH: X, SI PUSH, X,  HL! #DO-4TH  SI POP,                           ?, IF, 2SCAS,    HL! #DO-SETV SCASW, BX 0 /DI MOV,  HERE BE DROP DROP,                                              HL! #DO-EX  THEN, HERE BE NOP  LODSW, AX DI XCHG, 0 /DI JMP,                                                                                                                                                                                                    (  NXT, #DOES #DEFER #VAR #LIT #CONST #SETV #WPUSH #EXEC       )         XOR-DBG,                                                        DUP,  AX BX XCHG,  CALL,? 2  6 C,  \ DEBUGGER VECTOR                                                                     LIKE NOP TO ?NEXT     2SCAS,                                                                                                  HL! #DO-CONST  SCASW, DUP, 0 /DI BX MOV, NEXT,                  HL! #DO-USER 4 /DI AL MOV,  >USR1  #DO-CONST @ 1+ JMP,          HL! #DO-SETU 2 /DI AL MOV,  >USR1  #DO-SETV @ 1+ JMP,           #DO-BOOT @ VALUE GPV HERE 2- DUP #DO-GLBV !  2- @  IS UPV       LIKE GPV BE UPV                                                                                                                 2SCAS,  HL! #DO-VAR  2 /DI AX LEA,                                      HL! #DO-WPUSH  DUP,                                             HL! #DO-SWAP AX BX XCHG, NEXT,                                                                                          #DO-VAR @, AX SKIPW,    \ ALIAS POINT                           2SCAS,  HL! #DO-DEFER          SCASW, DUP, DI BX MOV,                   HERE BE PERFORM        0 /BX BX MOV,                            HERE BE EXEC           AX POP, BX AX XCHG, AX AX OR,            ?NEXT 0=, J,  #DO-EX @ 1+ JMP,                          2SCAS,  HL! #DO-DOES  X, SI PUSH, X, SI POP, #DO-VAR @J         HERE BE KEY   CALL,? 3 10 C,                                    HERE BE ?EMIT  32 #, BL CMP, U<, IF,  `. #, BX MOV, THEN,       HERE BE EMIT 14 #, AL MOV, >GLB1 W/ 0 /DI INC, CALL,? 4 12 C,   FL: 1 FL: 2  FL: 3  FL: 4                                       DI POP, 0 /DI AL MOV, >GLB1  #DO-DEFER @ 1+ JMP,                                                                                                                                                                                                                                                                                                                                                HL! #DO-;4TH  SI PUSH, X, SI POP, X, RET,                       HERE BE +ORIGIN  2*, #DO-BOOT @ /BX BX LEA, /CODE               ' ABORT 2 +ORIGIN !                                             ' DROP #DO-DROP !                                               ASM 2SCAS,  HL! #DO-FCOL   X, SI PUSH, X,                                   HL! #DO-FLBL    2 /DI SI MOV, /CODE                 ASM 2SCAS,  HL! #DO-COL   X, SI PUSH, X,                                    HL! #DO-LBL    2 /DI SI LEA, /CODE                  ASM                                                             HL! #DO-GETG 4 /DI AL MOV,  >GLB1  #DO-CONST @ 1+ JMP,          HL! #DO-SETG 2 /DI AL MOV,  >GLB1  #DO-SETV @ 1+ JMP,           /ASM                                                                                                                                                                                                                                                                                                                            CODE #BLK  BX INC, 0=, NOT IF,  BX DEC, THEN, /CODE             CODE BB>W AX POP, AH BL XCHG, /SWAP                             CODE B/MOD  0>AX, BH AL XCHG, /PUSH                0 CODE, EX                                                                   CODE HB/MOD  0>AX, BX AX XCHG, AAH, AH BL XCHG, AX PUSH, /CODE    ASM 2*, BX DI ADD, 2*, HL! #DO-ARY 2*, 2 X/D BX LEA, /CODE    CODE (CSTR SI BX MOV, LODSB, AX SI ADD, RET, HERE TOBE             0>AX, DUP, 2 /DI BX LEA, SI 0 /BP XCHG, BX CALL,             HERE BE EX    SI 0 /BP XCHG, /CODE  CODE lit LODSW, /PUSH       CODE @R+ LODSW, AX BX XCHG, RET, LIKE (CSTR 2+ TOBE  END-CODE   CODE C@R+ LODSB, AX BX XCHG, RET, LIKE (CSTR TOBE  END-CODE     CODE C!R+  STOSB, RET,  HERE TOBE  2 /DI AX LEA, AX BX XCHG,       DI 0 /BP XCHG,  BX CALL, DI 0 /BP XCHG, /DROP                CODE !R+ STOSW, RET, LIKE C!R+ TOBE END-CODE                                                                                                                                                    \ MEMORY & ADDRESSES / INCREMENTS & DECREMENTS                          CODE  @-   -2 /BX PUSH,  PNT!  BX DEC, BX DEC,  /CODE           CODE  C@-  0>AX, -1 /BX AL MOV,  AX PUSH, PNT@ 1+ /JUMP         CODE  C!-  AX POP, AL -1 /BX MOV, PNT@ 1+ /JUMP                 CODE  !-   -2 /BX POP,  PNT@ /JUMP                      PNT@ 1+ CODE, 1-                                                   PNT@ CODE, 2-                                                        CODE  @+   0 /BX PUSH, PNT! BX INC, BX INC, /CODE               CODE  !+   0 /BX POP,   PNT@ /JUMP                              CODE  C@+  0>AX, 0 /BX AL MOV,  AX PUSH, PNT@ 1+ /JUMP          CODE  C!+  AX POP,  AL 0 /BX MOV,  PNT@ 1+ /JUMP        PNT@ 1+ CODE, 1+                                                   PNT@ CODE, 2+     \      0 CODE, INC                         \       CODE  DEC   AX POP, AX NEG, AX PUSH,                    \ HERE BE       INC   DI BX MOV,  DROP, DI 0 /BX ADD, /CODE                                                                     \ REGISTERS & BASIC MATH                                        CODE B    CX AX MOV, /PUSH                                      CODE A    DX AX MOV, /PUSH                                      CODE B!   BX CX MOV, /DROP                                      CODE A!   BX DX MOV, /DROP                                      CODE SP@  SP AX MOV, /PUSH                                      CODE RP@  BP AX MOV, /PUSH                                      CODE RP!  BX BP MOV, /DROP                                                                                                      CODE +2/  AX POP, AX BX ADD,  BX PUSH, 1 #, BX RCR, /CODE       CODE AND  AX POP,  AX BX AND, /CODE                             CODE XOR  AX POP,  AX BX XOR, /CODE                                                                                             0 CODE, else    0 CODE, skip  0 CODE, R<>S   0 CODE, ?call      0 CODE, DROP;   0 CODE, EXIT  0 CODE, RDROP  0 CODE, NIP;                                                                          CODE  SWAP;     AX POP, DUP, AX BX XCHG,  ?, IF,             HERE BE  NIP;      AX POP,  CL SKIPB,                           HERE BE  DROP;     DROP,                                        HERE BE  EXIT      THEN, 0 /BP SI MOV,                          HERE BE  RDROP     2 /BP BP LEA, /CODE                          CODE  0; BX BX OR,  LIKE DROP; 0=,     J, LIKE DROP /JUMP       CODE if; BX BX OR,  LIKE DROP; 0=, NOT J, LIKE DROP /JUMP          CODE  PUSH      X,                                           HERE BE  R<>S      DUP, X, /DROP     CODE .skip DROP,           HERE BE  skip      LODSW, /CODE         CODE .else DROP,        HERE BE  else      0 /SI SI MOV, /CODE                          CODE -if BX BX OR,  LIKE else  0<, NOT J, LIKE skip /JUMP       CODE #if BX BX OR,  LIKE else  0=, J,     LIKE skip /JUMP       CODE  if BX BX OR,  LIKE .else 0=, J,     LIKE .skip /JUMP      CODE for   BX DEC,  LIKE .else 0<, J, LODSW, LIKE PUSH /JUMP                                                                    CODE of AX BX XCHG, DROP, BX AX XOR,                                LIKE else  0=, NOT J,  LIKE .skip /JUMP                                                                                     CODE next  W/ 1 #, 0 /BP SUB,  LIKE else  U<, NOT J, PNT!                              LODSW,  LIKE RDROP /JUMP                 CODE 0>next  W/ 0 /BP DEC, PNT@ 0<, J, LIKE else /JUMP          CODE  CONT   DUP, -2 /SI BX LEA, LIKE PUSH /JUMP                CODE  TIMES  BX DEC,  LIKE CONT 0<, NOT J, LIKE DROP; /JUMP                                                                     CODE  ;GO    LODSW, DI SKIPW,                                   HERE BE  ?call  LODSW, AX SI XCHG, X, AX PUSH, X,  /CODE                                                                        \ CODE BSWAP CX POP,  AX AX XOR,  CX BX XCHG, CXZ, NOT IF,      \    BEGIN, 1 #, BX SHR, 1 #, AX RCL,  CXZ, UNTIL, THEN,        \    AX BX XCHG, NEXT, END-CODE                                                                                                 CODE NIP    AX POP, /CODE                                       CODE POP    DUP, X, DROP, X, /CODE                              CODE SWAP   AX POP, /PUSH                                       CODE DUP    DUP, /CODE                                          CODE SWAP!  DI POP, #DO-SETV @ 1+ /JUMP                         CODE XCHG   0 /BP BX XCHG, /CODE                                CODE _      LODSW, /SWAP                                        CODE ROT    DI POP, AX POP, DI PUSH, /PUSH                      CODE -ROT   AX POP, DI POP, BX PUSH, DI PUSH, /SWAP             CODE NUP    AX POP, AX PUSH, AX PUSH, /CODE                         HERE ASM 2 /DI DI MOV, 0 P/D AX MOV, /PUSH                  DUP CODE, I 0 ,  CODE, J 2 ,                                                                                                                                                                                                                                                                                                    CODE BKEY?  ( - c)                                                 1 #, AH MOV,  KBD,  0=, NOT IF,  BX DEC, THEN, RET,          HERE TOBE   BX PUSH, BX BX XOR, 2 /DI CX LEA,  CX CALL, /CODE                                                                   CODE (BKEY  ( - c) BX AX MOV, KBD, AL AL OR, 0=, NOT              IF, AH AH XOR, THEN,   AX BX XCHG, RET,                       LIKE BKEY? TOBE  END-CODE                                                                                                                                                                        HERE ASM XOR-DBG, /ASM       \ TRACE MODE ON FROM DEBUDDER      HERE ASM X, DI POP, SI POP, X,  0 /DI JMP, /ASM  \ TROFF FROM   HERE ASM XOR-DBG, /CODE      \ TRACE MODE ON/OF FROM USER      CODE, TR , ,                                                                                                                                                                                                                                                    CODE (;4TH  SI JMP,  SI POP,  /CODE                                                                                             CODE (?DBG  ?NEXT @ #, AX MOV,  ?NEXT /// AX XCHG,                  0 #, AH CMP,  SAVE1  AX DI XCHG,                                LIKE SKIPB,         \ NEST - INCASE NO DEBUG / ELSE DOWN -v     0=, NOT UNTIL,  SCASW,   X, SI PUSH, AX PUSH, DI PUSH, X,       ' (;4TH 2+ 2+ #CALL,    /ASM ] EX                                                                 (;4TH [                                                                 ASM                   X, AX POP,   AX ?NEXT /// MOV, SI POP, X, /CODE                                                                                                                                                                                                                                                                                                                                                                                                             \ CONSTANTS VALUES VECTORS                                      15 NFAMILY CONSTANT  0 0  1 1  2 2  0D cr  0A lf  20 bl  08 bs     8000 #SGN  10 1H  400 1K  40 1L  1A eof  -1 -1                     5C TPAD  7F NPAD                                           2 4 28 FAMILY GLOBAL '(AB '(DE '(ER '(IN '(OUT                                        OUTC HERE >IN BLK  TIB  /TIB  CFA SPTR         CONTEXT  CURRENT  SCR  THERE  SCRH  CSP  CMARK  NPTR            PREV  FIRST  NBUFS  SRCHPNT  CICLES  USE  RELOC                                                                           0 0 8 FAMILY VECTOR 'SAME .BG 'LIT INTERPRET 'OK PAUSE #. 'TEST                                                                  0 0 4  FAMILY VAR:  ATTR -HEADS  ON-START BLK>IN 0 ,           2 6 18 FAMILY USER  SP0 RP0 USP DPL BASE FRAME SELF ERHND                        _AX _BX _CX _DX _SI _DI _BP _ES _DS _FL                                                                                                                                        \                          VARS & INITIALIZE                                                                                    AT MINI TO CONTEXT                                                                      2 ATTR !             10 TO BASE                                                                         \ ' .DBG  TO .BG                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ 4DOS                                                                                                                          CODE 4DOS DOS, RET, PNT! \ DX CX BX AX                          PNT@ TOBE  X, SI PUSH, CX PUSH, DX PUSH, X,  2 /DI DI LEA,      AX BX XCHG, DROP,  CX POP, DX POP,  BP PUSH, DI CALL,             PUSHF, DS PUSH, ES PUSH, BP PUSH, DI PUSH, SI PUSH,             DX PUSH, CX PUSH, DUP,  AX PUSH, CS AX MOV, AX DS MOV,          AX ES MOV, CLD,  'T _AX 4 + C@ #, AL MOV, >USR1                 10 #, CX MOV, BEGIN, AX POP, STOSW, CXZ, UNTIL,                 BP POP, X, DX POP, CX POP, SI POP, X, /DROP                                                                                   CODE (K  8 #, AH MOV, DOS, AH AH XOR, /PUSH                     CODE (E  BX DX MOV, 2 #, AH MOV, DOS, /DROP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \ : VOCABULARY AT FORTH ;NS VOCABULARY ;                         VOCABULARY MINI                                                : 2^ 1 SWAP LOOPS 2* ;     TO MACRO                             : ELSE ?CSP PUSH ', AHEAD  POP CSP! ', THEN ;  TO FORTH                                                                         MAC: COM INVERT ;       ' 1, ALIAS C,   ' 2, ALIAS ,                                                                            ' SAVE1  ALIAS RECOVERB         ' SAVE2 ALIAS RECOVER           ' I ALIAS R@                                                    HEX                                                             : VOXES ;DROP AT FORTH 2+ BEGIN #IF 2+ @- 2- VOC. AGAIN THEN ;  MAC: HP HERE 2+ ;                                               | : M13 CREATE C, DOES> C@ C, HP - , ;                          E8  M13  #CALL,    E9 M13 #JMP,                                 \ HERE 70 84 THRU  HERE SWAP -                                                                                                  MARKER -ASM  F83 ONLY ASSEMBLER  ALSO DEFINITIONS HEX           0 VALUE ?NEXT | 0 VALUE DISP | 0 VALUE FLAGS   : NOT 1 XOR ;    | : opc ( opcode -) ( - opcode) CREATE DB, DOES> C@ ;           : BEGIN, HERE ;   | : ?A DUP SHORT? 0= A" SHORT?" ;                        02 70 8 FAMILY opc  O?, U<, 0=, U<=, 0<, P?, <, <=,  EA opc ?,  03 E0 2 FAMILY opc C#Z, CXZ, | : -?A - ?A EX 1- C! ; : IF,  NOT DW, HERE ;           | : AGN,   DUP HP - SHORT? ;    : WHILE, ( A OPC -) IF, SWAP ;  | : UNTL,  IF, -?A HERE ;       : THEN,  HERE OVER -?A SWAP ;   : ELSE, ?, WHILE, THEN, ;       : J, NOT UNTL, ;                : SJMP, ?, UNTL, ;              : UNTIL, PUSH AGN, IF POP  UNTL, ;THEN                              POP  NOT WHILE, #JMP, THEN, ;                               : AGAIN, AGN, IF SJMP, ;THEN #JMP, ;                                                                                                                                                                                                                            ( ASM FORWARD)   | 80 CONSTANT 2L                               2L | WARY BRANCHES  | : ASM-RESET 2 TO FLAGS  0 TO DISP ;       | : FBI 0 2L                                                        FOR I BRANCHES 0 @SWAP IF I 4 #. WHAT? 1+ THEN NEXT                ?DUP IF DUP CR 4 #. A" UNRESOLVED !" THEN ;              | : ^BRANCH TOKEN (DNUM DUP 2L U< 0= A"  BR#? " BRANCHES ;      | : FB, ^BRANCH DUP 0 @SWAP A" REDEFINED! " HP SWAP! DW, ;      | : ^< ^BRANCH 0 @SWAP ;        : L,? HP FB, ;                  : JMP,? E9 DB, L,? ;     : CALL,? E8 DB, L,? ;                  : FB: ^< THEN, ;  ( RESOLVE FORWARD BRANCH NUMBER)              | : FL?      ( A - A) 2- @ OVER - A" LBL? " ;                   | : WREL-FIX?  ( A -) BEGIN,  OVER  3 - C@ FE AND E8 =                      IF  OVER - THEN SWAP 2- ! ;                         : FL: ^< DUP  FL?  WREL-FIX? ;  : J,? NOT FB, ;                                                                                                                                                 HEX  ( bit-flags and reg seg & r/m defining words )             ( 0 VALUE DISP 0 QUAN FLAGS 0 VALUE ?NEXT ( xxxxxxccOMIAGSDW )  ( M=r/m; cc=reg count; I=immediate; A=accumulator; G=seg;)      ( S=imm.byte; D=direction;  W=word or byte; O=disp only  )      ( D=0 when r/m field is destination ) : ;FL FLAGS EX TO FLAGS ; | : F-SET ( mask -) ;FL OR ;   | : $ACC 10 F-SET ;              | : F-GET ( mask -) FLAGS AND ;   | : 1REG? 100 F-GET ;         | : F-CLR ( mask -) COM ;FL AND ; | : REG+ 100 ;FL + ;          | : F-FLIP ( mask - ) ;FL XOR ; : F/ 2 F-FLIP ;                 | : <reg> ( a -n) DUP 1+ C@ DUP ODD NOT 2* 2* OR F-SET C@ ;     | : reg CREATE , DOES> <reg> REG+ F/ DUP 0= 0; $ACC ;           | : seg ( n -) ( -n) CREATE ,  DOES> <reg> 2 F-SET ;            | : r/m ( disp-n) CREATE , DOES> <reg>  2 F-CLR  SWAP TO DISP ;                                                                                                                                                                                                 ( default D is on, r/m clears it, reg flips it, seg sets it)    ( bits 3-5=reg, bit 8=W, bit 9=D flg, bit 12=ACC flg )          HEX ( R/M & REG are 16bit constants, but reg keeps count )      1 4000 8 FAMILY r/m  X/S X/D P/S P/D /SI /DI /BP /BX              C006 r/m ///                 8 900 4 FAMILY seg  ES CS SS DS    8 0 8 FAMILY reg  AL CL DL BL AH CH DH BH                     8 100 8 FAMILY reg  AX CX DX BX SP BP SI DI                                                                                     : B#,  24 F-SET ;    : W#, 20 F-SET ;                           : #AL B#, AL $ACC ;  : #AX W#, AX $ACC ;                        : (AL /// AL $ACC ;  : (AX /// AX $ACC ;                                                                                        \ : RECOVERB 0 C, RECOVER ;  \ : SKIPCB, 0 #AL ' EXEC RECOVERB ;\ : SKIPCW, 0 #AX ' EXEC RECOVER ;                                                                                                                                                              HEX ( REG>R/M  #,  orW  11mod  01mod  10mod  ,DISP BYTE )       | 0 BARY F$  4457 , 4753 , 4941 , 4F4D ,                        : .F ( -) 8 FOR 20 R@ 2^ F-GET IF DROP R@ F$ C@ THEN               EMIT NEXT FLAGS 100 / 3 #. ."  regs " EXIT ;                 | : R>M ( reg -r/m) U2/ U2/ U2/ ;                               | : 16/ R>M U2/ ;                                                 : #, ( n1 - n1) 20 OVER SHORT? 04 AND OR F-SET  ;             | : orW ( --opc---   -  --opc--w)  1 F-GET  OR ;                | : orDW ( --opc---  -  --opc-dw)  3 F-GET  OR ;                | : modDISP, ( 2nd - ) 40 F-GET ( ie M)                           IF 80 F-GET ( ie Only) IF C, DISP ,                               ELSE 8 F-GET ( ie G) DISP OR  OVER 7 AND 6 = OR ( ie[BP])       IF DISP SWAP OVER SHORT?                                          IF 40 OR C, C, ELSE 80 OR C,  , THEN                          ELSE ( zero & not seg) C, THEN  THEN ELSE C0 OR C,  THEN ;                                                                  HEX     ( one byte opcodes with no variables )                  | : IMM? ( -f) 20 F-GET  ;  | : ACC? ( -f) 10 F-GET ;           | : ,IMM  ( n -) 5 F-GET 4 = IF ( S,-W)  C, ELSE  , THEN ;        : W/ ( -)  1 F-SET  ; ( WORD PTR - the default is byte )      | : 2REGS? ( -f) 308 F-GET DUP 200 = SWAP 108 = OR ;            | : M1 ( n -) ( -)  CREATE C, DOES> C@ C, ASM-RESET ;                                                                                                                                           HEX     ( TWO byte opcodes with no variables )                  | : M10 CREATE , DOES>  @ , ;                                   8 NFAMILY M10                                                    21CD DOS,  16CD KBD,    10CD  VIDEO,  0AD4  AAM,                0AD5 AAD,  13CD DISK,   E587  X,      10D4  AAH,                                                                                                                                                                                                               4 NFAMILY M1  D7 XLAT,  CF IRET,  C3 RET,  CB RETF,             4 NFAMILY M1  53 DUP,  5B DROP,  CC INT3,  90 NOP,              1 A4 4 FAMILY M1  MOVSB, MOVSW, CMPSB, CMPSW,                   1 AA 6 FAMILY M1  STOSB, STOSW, LODSB, LODSW, SCASB, SCASW,     1 98 8 FAMILY M1  CBW, CWD, -- WAIT, PUSHF, POPF, SAHF, LAHF,   1 F8 6 FAMILY M1  CLC, STC, CLI, STI, CLD, STD,                 1 F0 6 FAMILY M1  LOCK: -- REP: REPZ: HALT: CMC,                8 26 4 FAMILY M1  ES: CS: SS: DS:                                                                                               HEX  | : M3 ( n -) ( reg -) CREATE C, DOES>  C@                        orW C, DROP ASM-RESET   ;                                2 A4 6 FAMILY M3  MOVS, CMPS, -- STOS, LODS, SCAS,              2 6C 2 FAMILY M3  INS, OUTS,                                                                                                                                                                                                                                    ( 2 operand instructions such as ADD,  )                        HEX     | : M2 ( n -) ( various - ) CREATE C,                     DOES> C@ PUSH  IMM?                                              IF ACC? IF     DROP  POP orW 4 OR C,                                    ELSE   1REG? IF R>M THEN  80 orW C,                                    POP 38 AND OR  modDISP,                                  THEN  ,IMM                                              ELSE  2REGS?  IF SWAP R>M THEN                                        POP orDW C, OR modDISP,    THEN  ASM-RESET  ;                                                                           8 0 8 FAMILY M2  ADD, OR, ADC, SBB, AND, SUB, XOR, CMP,                                                                                                                                                                                                                                                                                                                                        HEX ( MOV,) ( one byte instr w/ W  - the string instructions )  : MOV, IMM?                                                       IF  1REG?  IF   R>M B0 OR 1 F-GET  2* 2* 2* OR C,                          ELSE C6 orW C, modDISP,    THEN  ,IMM                ELSE 90 F-GET 90 =                                              IF   DROP DROP $A0 F/ orDW C, DISP ,                            ELSE  2REGS? IF   2 F-GET ( ie D) IF SWAP THEN  R>M  THEN        8 F-GET ( ie G) IF 1 F-CLR 8C ELSE 88 THEN  orDW C,             OR  modDISP,  THEN THEN  ASM-RESET ;                         ( M6 for the rotate & shift instructions )                      HEX  | : M6 ( n -) ( n# r/m | r/m    - ) CREATE C,               DOES> C@ IMM? 16/  2 XOR  1 F-GET ( ie W) OR $D0 OR C,             1REG? IF SWAP R>M THEN OR modDISP,  IMM? IF DROP THEN                 ASM-RESET  ;                                          8 0 8  FAMILY M6  ROL, ROR, RCL, RCR, SHL, SHR, -- SAR,                                                                         ( or    AL IN,  or  AX IN,   for port in the DX register  )     | : M9 ( n# r1 | r1) CREATE C,  DOES> C@  orW NIP                    IMM? IF ( n# opc)  C, ( n#) ELSE ( opc) 8 OR THEN C,            ASM-RESET ;                                                                 E4 M9 IN,   E6 M9 OUT,                                                                                         HEX                                                             : SKIPB, 0 SWAP B#, MOV, RECOVERB ;                             : SKIPW, 0 SWAP W#, MOV, RECOVER ;                                                                                              | : M5 CREATE C, DOES> C@ C, OR modDISP, ASM-RESET  ;           3 NFAMILY M5    C5 LDS,  8D LEA,  C4 LES,                       | : M11 CREATE C, DOES> C@ C, C, ;                              | : M12 CREATE C, DOES> C@ C, , ;                               $CD M11 INT,                                                                                                                    ( mul, div, xxxxxxxW  mdNNNr/m ) ( M5 for LDS, LEA, & LES, )    HEX  | : M4 ( n -) ( -) CREATE C,                                DOES> C@ F6 orW C, SWAP 1REG? IF R>M THEN OR  modDISP,               ASM-RESET  ;                                              -8 38 6 FAMILY M4  IDIV, DIV, IMUL, MUL, NEG, INVERT,                                                                           ( use   port #, AL IN,  or  port #, AX IN,  for 8 bit ports )                                                                    LIKE NOP  TO ?NEXT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             HEX ( INC, & DEC, instructions )   ( IN, OUT, instr )           | : M7 ( n -) ( r1 | r/m  -) CREATE C,                             DOES> C@ SWAP  1REG? IF  ( opc r1) R>M THEN                     1REG? 100 =  1 F-GET AND  ( ie it's a 2-byte register)          IF  ( opc rX)  OR 40 OR C,  ( opc mem | opc rH | opc rL )       ELSE FE orW C,  OR modDISP, THEN  ASM-RESET  ;               08 M7 DEC,   00 M7 INC,                                         ( PUSH, & POP, instructions ) HEX                               | : M8 ( n -) ( reg | seg | r/m  -)  CREATE ,                      DOES>  @  8 F-GET                                                 IF  ( seg opc ) 16/ 1 AND 1 XOR 6 OR OR C,  ELSE 1REG?          IF  ( reg opc ) 2/ 8 AND 8 XOR 50 OR SWAP R>M OR C,             ELSE ( r/m opc) DUP 100 U/ FF AND C,  OR modDISP,               THEN  THEN  ASM-RESET ;                                    FF30 M8 PUSH,  8F00 M8 POP,                                                                                                     : XCHG,  ( reg mem | mem reg | reg1 reg2   -)                     211 F-GET 211 = ( 2 regs & one is AX)                           IF  ?DUP IF NIP THEN ( r1 ) R>M  90 OR C,                       ELSE  2REGS? IF  R>M  THEN  OR  86 orW C, modDISP,              THEN  ASM-RESET ;                                                                                                             : TEST,  ( various - ) IMM?                                        IF ACC? IF     DROP  A8 orW ( 4 OR) C,                                  ELSE   1REG? IF R>M THEN  F6 orW C, ( OR)  modDISP,             THEN  ,IMM                                              ELSE  2REGS?  IF SWAP R>M THEN                                        84 orW C, OR modDISP,                                     THEN  ASM-RESET  ;                                                                                                                                                                                                                                           HEX ( XCHG )  ( TEST, instruction  - almost like ADD, etc. )    : CALL, ( various -) IMM? 140 F-GET 0= OR ( intra-seg direct )    IF  ( n#)  #CALL, ( eg 2389 #, CALL, calls addr $2389)          ELSE ( mem | reg  -)  1REG?  IF R>M  THEN                           FF C,  10 OR modDISP, ( eg 0 [BX] CALL, or DX CALL, )       THEN  ASM-RESET ;         ( this is intra-seg indirect )      HEX ( CALL, instr  ) ( INT,  & segment override instructions )  : JMP,        140 F-GET ( ie R or M  intra-seg indirect )          IF ( mem | reg  -)  1REG?  IF R>M  THEN                            FF C,  20 OR modDISP, ( eg 0 [BX] JMP, DX JMP, )             ELSE  ( a) ( relative) AGAIN,                                    ( disp is added to IP, so this is a relative jump )          THEN  ASM-RESET ;                                                                                                                                                                                                                                              | 0 VALUE JPOINT                : 2SCAS, SCASW, SCASW, ;        : PNT! HERE TO JPOINT ;         : >PNT JPOINT JMP, ;            : TOBE CFA ! ;                  : NEXT, ( -) ?NEXT JMP, ;        TO FORTH  : ASM ALSO ASSEMBLER CSP! ASM-RESET ;                          ' JPOINT ALIAS PNT@                                             : CODE HEADER HP , ASM ;                               TO ASSEMBLER                                                   : /ASM PREVIOUS ?CSP ; : END-CODE FBI /ASM ;                    : /CODE NEXT, END-CODE ;                                                                                                         PREVIOUS   F83                                                                                                                                                                                                                                                                                                                                                                                 : COPY BLOCK SCR DUP 1+ TO SCR BUFFER 1K CMOVE UPDATE ;         : COPIES ;DROP LOOPS DUP 1+ XEP COPY ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          MARKER -ASM  LIKE -ASM   BE -MARKER : ;2DROP EX 2DROP ;         F83 ONLY ASSEMBLER  ALSO DEFINITIONS HEX \ VOCABULARY  ASSEMBLER0 VALUE ?NEXT ( xxxxccOMIAGSDW ) | 0 VALUE DISP | 0 VALUE FLAGS  | : ?-CREATE ;2DROP >IN BLWORD 1+ @ $ 2D2D XOR 0; TO >IN  DUP    DUP DISP EXEC ;  TO FORTH  : NFAMILY ;2DROP ' TO DISP          DUP DUP FOR [',] $ ?-CREATE NEXT ;          : FAMILY ' TO DISP          ;2DROP FOR DUP ?-CREATE OVER + NEXT ;  : NOT 1 XOR ;   : DB, C, ; : DW, , ; : SHORT?  -80 80 WITHIN ; TO ASSEMBLER     | : opc ( opcode -) ( - opcode) CREATE C, DOES> C@ ;            03 E0 2 FAMILY opc C#Z, CXZ, | : ?A DUP SHORT? 0= A" SHORT?" ;  02 70 8 FAMILY opc  O?, U<, 0=, U<=, 0<, P?, <, <=,  EA opc ?,  : BEGIN, HERE ; : IF,  NOT , BEGIN, ;   | : HP BEGIN, 2+ ;      : WHILE, ( A OPC -) IF, SWAP ; | : -?A - ?A EX 1- C! ;          : THEN,  BEGIN, OVER -?A SWAP ;   : UNTIL, IF, -?A BEGIN, ;     : ELSE, ?, WHILE, THEN, ; : J, NOT UNTIL, ; : SJMP, ?, UNTIL, ;                                                                 ( ASM FORWARD)   | 80 CONSTANT 2L                               2L | WARY BRANCHES  | : ASM-RESET 2 TO FLAGS  0 TO DISP ;       | : FBI 0 2L                                                        FOR R@ BRANCHES 0 @SWAP IF R@ .. 7 EMIT 1+ THEN NEXT               ?DUP IF DUP CR .. A" UNRESOLVED !" THEN ;                | : ^BRANCH [',] # DUP 2L U< 0= A"  BR#? "  BRANCHES ;          | : FB, ^BRANCH DUP 0 @SWAP A" REDEFINED! " HP SWAP! , ;        | : ^< ^BRANCH 0 @SWAP ;        : L,? HP FB, ;                  : JMP,? E9 C, L,? ;     : CALL,? E8 C, L,? ;                    : FB: ^< THEN, ;  ( RESOLVE FORWARD BRANCH NUMBER)              | : FL?      ( A - A) 2- @ OVER - A" LBL? " ;                   | : WREL-FIX?  ( A -) BEGIN,  OVER  3 - C@ FE AND E8 =                      IF  OVER - THEN SWAP 2- ! ;                         : FL: ^< DUP  FL?  WREL-FIX? ;  : J,? NOT FB, ;                                                                                                                                                 HEX  ( bit-flags and reg seg & r/m defining words )             ( 0 VALUE DISP 0 QUAN FLAGS 0 VALUE ?NEXT ( xxxxxxccOMIAGSDW )  ( M=r/m; cc=reg count; I=immediate; A=accumulator; G=seg;)      ( S=imm.byte; D=direction;  W=word or byte; O=disp only  )      ( D=0 when r/m field is destination ) : ;FL FLAGS EX TO FLAGS ; | : F-SET ( mask -) ;FL OR ;   | : $ACC 10 F-SET ;              | : F-GET ( mask -) FLAGS AND ;   | : 1REG? 100 F-GET ;         | : F-CLR ( mask -) COM ;FL AND ; | : REG+ 100 ;FL + ;          | : F-FLIP ( mask - ) ;FL XOR ; : F/ 2 F-FLIP ;                 | : <reg> ( a -n) DUP 1+ C@ DUP 1 AND 1 XOR 2* 2* OR F-SET C@ ; | : reg CREATE , DOES> <reg> REG+ F/ DUP 0= 0; $ACC ;           | : seg ( n -) ( -n) CREATE ,  DOES> <reg> 2 F-SET ;            | : r/m ( disp-n) CREATE , DOES> <reg>  2 F-CLR  SWAP TO DISP ;                                                                                                                                                                                                 ( default D is on, r/m clears it, reg flips it, seg sets it)    ( bits 3-5=reg, bit 8=W, bit 9=D flg, bit 12=ACC flg )          HEX ( R/M & REG are 16bit constants, but reg keeps count )      1 4000 8 FAMILY r/m  X/S X/D P/S P/D /SI /DI /BP /BX              C006 r/m ///                 8 900 4 FAMILY seg  ES CS SS DS    8 0 8 FAMILY reg  AL CL DL BL AH CH DH BH                     8 100 8 FAMILY reg  AX CX DX BX SP BP SI DI                                                                                     : B#,  24 F-SET ; : W#, 20 F-SET ;                              : #AL B#, AL $ACC ;  : #AX W#, AX $ACC ;                        : (AL /// AL $ACC ;  : (AX /// AX $ACC ;                                                                                        : RECOVERB 0 C, RECOVER ;  : SKIPCB, 0 #AL ' EXEC RECOVERB ;    : SKIPCW, 0 #AX ' EXEC RECOVER ;                                                                                                                                                                HEX ( REG>R/M  #,  orW  11mod  01mod  10mod  ,DISP BYTE )       | 0 BARY F$  4457 , 4753 , 4941 , 4F4D ,                        : .F ( -) 8 FOR 20 R@ 2^ F-GET IF DROP R@ F$ C@ THEN               EMIT NEXT FLAGS 100 / 3 U.R ."  regs " ;                     | : R>M ( reg -r/m) 2/ 2/ 2/ ;                                  | : 16/ R>M 2/ ;                                                  : #, ( n1 - n1) 20 OVER SHORT? 04 AND OR F-SET  ;             | : orW ( --opc---   -  --opc--w)  1 F-GET  OR ;                | : orDW ( --opc---  -  --opc-dw)  3 F-GET  OR ;                | : modDISP, ( 2nd - ) 40 F-GET ( ie M)                           IF 80 F-GET ( ie Only) IF C, DISP ,                               ELSE 8 F-GET ( ie G) DISP OR  OVER 7 AND 6 = OR ( ie[BP])       IF DISP SWAP OVER SHORT?                                          IF 40 OR C, C, ELSE 80 OR C,  , THEN                          ELSE ( zero & not seg) C, THEN  THEN ELSE C0 OR C,  THEN ;                                                                  HEX     ( one byte opcodes with no variables )                  | : IMM? ( -f) 20 F-GET  ;  | : ACC? ( -f) 10 F-GET ;           | : ,IMM  ( n -) 5 F-GET 4 = IF ( S,-W)  C, ELSE  , THEN ;        : W/ ( -)  1 F-SET  ; ( WORD PTR - the default is byte )      | : 2REGS? ( -f) 308 F-GET DUP 200 = SWAP 108 = OR ;            | : M1 ( n -) ( -)  CREATE C, DOES> C@ C, ASM-RESET ;                                                                                                                                                                                                           HEX     ( TWO byte opcodes with no variables )                  | : M10 CREATE , DOES>  @ , ;                                   8 NFAMILY M10                                                    21CD DOS,  16CD KBD,    10CD  VIDEO,  0AD4  AAM,                0AD5 AAD,  13CD DISK,   E587  X,      10D4  AAH,                                                                                                                                               4 NFAMILY M1  D7 XLAT,  CF IRET,  C3 RET,  CB RETF,             4 NFAMILY M1  53 DUP,  5B DROP,  CC INT3,  90 NOP,              1 A4 4 FAMILY M1  MOVSB, MOVSW, CMPSB, CMPSW,                   1 AA 6 FAMILY M1  STOSB, STOSW, LODSB, LODSW, SCASB, SCASW,     1 98 8 FAMILY M1  CBW, CWD, -- WAIT, PUSHF, POPF, SAHF, LAHF,   1 F8 6 FAMILY M1  CLC, STC, CLI, STI, CLD, STD,                 1 F0 6 FAMILY M1  LOCK: -- REP: REPZ: HALT: CMC,                8 26 4 FAMILY M1  ES: CS: SS: DS:                                                                                               HEX  | : M3 ( n -) ( reg -) CREATE C, DOES>  C@                        orW C, DROP ASM-RESET   ;                                2 A4 6 FAMILY M3  MOVS, CMPS, -- STOS, LODS, SCAS,              2 6C 2 FAMILY M3  INS, OUTS,                                                                                                                                                                                                                                    ( 2 operand instructions such as ADD,  )                        HEX     | : M2 ( n -) ( various - ) CREATE C,                     DOES> C@ PUSH  IMM?                                              IF ACC? IF     DROP  POP orW 4 OR C,                                    ELSE   1REG? IF R>M THEN  80 orW C,                                    POP 38 AND OR  modDISP,                                  THEN  ,IMM                                              ELSE  2REGS?  IF SWAP R>M THEN                                        POP orDW C, OR modDISP,    THEN  ASM-RESET  ;                                                                           8 0 8 FAMILY M2  ADD, OR, ADC, SBB, AND, SUB, XOR, CMP,                                                                                                                                                                                                                                                                                                                                        HEX ( MOV,) ( one byte instr w/ W  - the string instructions )  : MOV, IMM?                                                       IF  1REG?  IF   R>M B0 OR 1 F-GET  2* 2* 2* OR C,                          ELSE C6 orW C, modDISP,    THEN  ,IMM                ELSE 90 F-GET 90 =                                              IF   DROP DROP A0 F/ orDW C, DISP ,                             ELSE  2REGS? IF   2 F-GET ( ie D) IF SWAP THEN  R>M  THEN        8 F-GET ( ie G) IF 1 F-CLR 8C ELSE 88 THEN  orDW C,             OR  modDISP,  THEN THEN  ASM-RESET ;                         ( M6 for the rotate & shift instructions )                      HEX  | : M6 ( n -) ( n# r/m | r/m    - ) CREATE C,               DOES> C@ IMM? 16/  2 XOR  1 F-GET ( ie W) OR D0 OR C,              1REG? IF SWAP R>M THEN OR modDISP,  IMM? IF DROP THEN                 ASM-RESET  ;                                          8 0 8  FAMILY M6  ROL, ROR, RCL, RCR, SHL, SHR, -- SAR,                                                                         HEX                                                             : SKIPB, 0 SWAP B#, MOV, RECOVERB ;                             : SKIPW, 0 SWAP W#, MOV, RECOVER ;                                                                                              | : M5 CREATE C, DOES> C@ C, OR modDISP, ASM-RESET  ;           3 NFAMILY M5    C5 LDS,  8D LEA,  C4 LES,                       | : M11 CREATE C, DOES> C@ C, C, ;                              | : M12 CREATE C, DOES> C@ C, , ;                               $ CD M11 INT,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( mul, div, xxxxxxxW  mdNNNr/m ) ( M5 for LDS, LEA, & LES, )    HEX  | : M4 ( n -) ( -) CREATE C,                                DOES> C@ F6 orW C, SWAP 1REG? IF R>M THEN OR  modDISP,               ASM-RESET  ;                                              -8 38 6 FAMILY M4  IDIV, DIV, IMUL, MUL, NEG, INVERT,                                                                           | : M13 CREATE C, DOES> C@ C, HP - , ;                          E8  M13  #CALL,    E9 M13 #JMP,   ( lay down 3byte jump, CALL)  : AGAIN, DUP HP - SHORT? IF SJMP, ;THEN #JMP, ;                 ( use   port #, AL IN,  or  port #, AX IN,  for 8 bit ports )   ( or    AL IN,  or  AX IN,   for port in the DX register  )     | : M9 ( n# r1 | r1) CREATE C,  DOES> C@  orW NIP                    IMM? IF ( n# opc)  C, ( n#) ELSE ( opc) 8 OR THEN C,            ASM-RESET ;                                                                 E4 M9 IN,   E6 M9 OUT,                                                                                         HEX ( INC, & DEC, instructions )   ( IN, OUT, instr )           | : M7 ( n -) ( r1 | r/m  -) CREATE C,                             DOES> C@ SWAP  1REG? IF  ( opc r1) R>M THEN                     1REG? 100 =  1 F-GET AND  ( ie it's a 2-byte register)          IF  ( opc rX)  OR 40 OR C,  ( opc mem | opc rH | opc rL )       ELSE FE orW C,  OR modDISP, THEN  ASM-RESET  ;               08 M7 DEC,   00 M7 INC,                                         ( PUSH, & POP, instructions ) HEX                               | : M8 ( n -) ( reg | seg | r/m  -)  CREATE ,                      DOES>  @  8 F-GET                                                 IF  ( seg opc ) 16/ 1 AND 1 XOR 6 OR OR C,  ELSE 1REG?          IF  ( reg opc ) 2/ 8 AND 8 XOR 50 OR SWAP R>M OR C,             ELSE ( r/m opc) DUP 100 U/ FF AND C,  OR modDISP,               THEN  THEN  ASM-RESET ;                                    FF30 M8 PUSH,  8F00 M8 POP,                                                                                                     : XCHG,  ( reg mem | mem reg | reg1 reg2   -)                     211 F-GET 211 = ( 2 regs & one is AX)                           IF  ?DUP IF NIP THEN ( r1 ) R>M  90 OR C,                       ELSE  2REGS? IF  R>M  THEN  OR  86 orW C, modDISP,              THEN  ASM-RESET ;                                                                                                             : TEST,  ( various - ) IMM?                                        IF ACC? IF     DROP  A8 orW ( 4 OR) C,                                  ELSE   1REG? IF R>M THEN  F6 orW C, ( OR)  modDISP,             THEN  ,IMM                                              ELSE  2REGS?  IF SWAP R>M THEN                                        84 orW C, OR modDISP,                                     THEN  ASM-RESET  ;                                                                                                                                                                                                                                           HEX ( XCHG )  ( TEST, instruction  - almost like ADD, etc. )    : CALL, ( various -) IMM? 140 F-GET 0= OR ( intra-seg direct )    IF  ( n#)  #CALL, ( eg 2389 #, CALL, calls addr $2389)          ELSE ( mem | reg  -)  1REG?  IF R>M  THEN                           FF C,  10 OR modDISP, ( eg 0 [BX] CALL, or DX CALL, )       THEN  ASM-RESET ;         ( this is intra-seg indirect )      HEX ( CALL, instr  ) ( INT,  & segment override instructions )  : JMP,        140 F-GET ( ie R or M  intra-seg indirect )          IF ( mem | reg  -)  1REG?  IF R>M  THEN                            FF C,  20 OR modDISP, ( eg 0 [BX] JMP, DX JMP, )             ELSE  ( a) ( relative) AGAIN,                                    ( disp is added to IP, so this is a relative jump )          THEN  ASM-RESET ;                                                                                                                                                                                                                                              | 0 VALUE JPOINT                 LIKE NOP  TO ?NEXT                                             : 2SCAS, SCASW, SCASW, ;        : PNT! HERE TO JPOINT ;         : >PNT JPOINT JMP, ;                                                                            : TOBE CFA ! ;                  : NEXT, ( -) ?NEXT JMP, ;                                                                       TO FORTH  : ASM ALSO ASSEMBLER CSP! ASM-RESET ;                           ' JPOINT ALIAS PNT@                                             : CODE HEADER HP , ASM ;  TO ASSEMBLER                : /ASM PREVIOUS ?CSP ; : END-CODE FBI /ASM ;                    : /CODE NEXT, END-CODE ;                                                                                                         PREVIOUS   F83  PRUNE                                                                                                                                                                                                                                          MARKER -MINI  ( DEFINING WORDS) \ MOVE WORD -------------------- 51 LOAD     \ ZONE 51                                                                                                          : B. CR ." | " BLK .. >IN 1L /MOD 1+ SWAP .. ..                     SPACE HERE H. THERE H.                                                      BIOS-KEY DROP ; IMMEDIATE                          1   9  +THRU   \ COMPILER                                     'HERE TO THRESHOLD                                               46       LOAD                                                   52  64   THRU   \ KERNEL                                            65   LOAD   \ MEMORY LOCATIONS  - VARIABLE OF ANY KIND          66   LOAD   \ DOS  PRIMITIVES                                   10  +LOAD   \ ONLY FIXES  TO COMPILER                       11  49  +THRU   PREVIOUS                                                                                                      \ EXIT                                                          \ 2345678 \ 2345678 \ 2345678 \ 2345678 \ 2345678 \ 2345678     : CODE, HEADER , ;   : @CODE, @ CODE, ;  ' CODE, ALIAS 'CODE,    VARIABLE  #DO-VAR   : CREATE  #DO-VAR @CODE, ;                 : VAR: CREATE , ;   ' #DO-VAR @+ !  0 0 44 FAMILY VAR:          #DO-SETG  #DO-FCOL  #DO-RPUSH #DO-EX    #DO-ARY   #DO-LBL       #DO-DOES  #DO-FLBL  #DO-LIT   #DO-SEMI  #DO-COL   #DO-CONST     #DO-GETG  #DO-DEFER #DO-BR    #DO-?BR   #DO-WPUSH #DO-#BR       #DO-USER  #DO-SETU  #DO-USRV  #DO-MNEXT #DO-.STR  #DO-.ABRT     #DO-MBR   #DO-FOR   #DO-NEXT  #DO-BOOT  #DO-SETV  #DO-OF        #DO-SWAP  #DO-DROP  #DO-CALL  #DO-STR   #DO-;4TH  #DO-4TH:      #DO-MOVE  #DO-SIZE  #DO-COMP  #DO-MACR  #DO-4TH   #DO-GLBV      #DO-;CODE #DO-COMM                                              LIKE (INT  #DO-LBL !    ' lit #DO-LIT !                         #does #DO-DOES !        ' ;code #DO-;CODE !                     ' EXIT #DO-SEMI !       LIKE : #DO-COL !                                                                                        : TSIZE HERE #DO-MOVE @ - ;   : D, , , ;  : @, @ , ;            0 VALUE VOCADR   0 VALUE LASTW   : CODE,, SWAP CODE, , ;        HERE 100 CLARY  HERE  DUP     0 VALUE STKC                      QUAN CSTACK | CONSTANT #EMPTY   | CONSTANT #FULL                | : ;STK? CSTACK TUCK = A" CS EMPTY/FULL" EX TO CSTACK ;        : C> #EMPTY ;STK? @+ ; | : !- 2- !+ 2- ; : >C #FULL ;STK? !- ;  : ?STKC STKC CSTACK - A" ?BG?" C>   TO STKC  ;                  : STKC! STKC >C CSTACK TO STKC ;       | : LBL, #DO-LBL @, ;    : STKINIT #EMPTY TO CSTACK 0 >C STKC! ; : MARK> HERE >C STKC! ; : ?FIX DUP @ A" ?FX?" HERE SWAP! ;   : <RELEASE ?STKC  C> , ;   : >MARK HERE 0 , CSP! ;   : RELEASE< ?CSP ?FIX ;                : >MARK> >MARK MARK> ;  : <RELEASE< <RELEASE RELEASE< ;                                                                                                                                                                                                                                                                         : HL! HERE ' EXEC ! ; | : GETBACK ;HERE @- ;  : >LNK N>C 2- ;   : (': ' CREATE SWAP D, IMMEDIATE DOES> STR @ NEW, PERFORM ;     : CUTW     CURRENT @ DUP >LNK 0 @SWAP CURRENT ! ;               : PASTEW   OVER @SWAP SWAP >LNK ! ; : MOVEW CUTW SWAP PASTEW ;  : COMPILING  #DO-MACR @ MOVEW ;                                 : (": HEADER #DO-COMP @, ' NEW, ' NEW, COMPILING ;              | : <:> CSP! STKINIT ] 0 TO LASTW ;                             | : <;> ?STKC C> A" ?<>?" ?CSP [',] [ LASTW 0;                        LASTW  CURRENT  PASTEW ;   \ THIS WAY PASSING PARAMMETTERS: ;CONST #DO-CONST @ HEADER EX D, ;     : CONSTANT ;CONST ;     : ;1 #DO-SETV @ SWAP EX 1- , ;  : ;2 #DO-VAR @ -ROT  EX 2- , ;  : ;DEFER #DO-DEFER @ HEADER EX D, ;     : DEFER   ;DEFER ;      : VALUE    ;CONST ;1 ;          : VECTOR  ;DEFER ;1 ;           : QUAN     ;CONST ;1 ;2 ;       : VQUAN   ;DEFER ;1 ;2 ;                                                                                                                                        : SAVE2 -2 ALLOT ;                                              \ FOREWARD BRANCH MARKING   MARK> <RELEASE >MARK RELEASE<       \ : >CODE, ' EXEC DUP PUSH @ CODE, HERE 2- POP ! ;              \ : ;CODE ?STKC #DO-;CODE @, ?CSP ASM ;  IMMEDIATE                                                                              ' FORTH ALIAS 'FORTH   ' BLK ALIAS 'BLK  ' >IN ALIAS '>IN       ' HERE ALIAS 'HERE   ' ' ALIAS 'T   ' ALLOT ALIAS 'ALLOT        : : #DO-COL @CODE, <:> CUTW TO  LASTW ; #DO-SEMI (': <;>  ;     | : -: : RECOVER ;                                              | : :,1 #DO-COL @ 1- , ;                                        : LBL: -: LBL, ;                                                : >: -: :,1 LBL, ;                                              : :: -: :,1 :,1 ;                                                                                                                                                                                                                                               ( COMPILING WORDS)  ( USING CASE WHILE REPEAT BEGIN THEN )      | #DO-LIT (': ,  ((LIT   IMMEDIATE  \ INVERT IMM BIT TO 0                                                                       | : (LI STATE 0; ((LIT ;                                        ' (LI ALIAS LITERAL IMMEDIATE                                   : [',] ' (LI ; IMMEDIATE                                        : ', ' , ; IMMEDIATE                                            : (#?LIT DBL 1+ IF STATE 0; SWAP (LI SKIP THEN DROP (LI ;                 ' (#?LIT TO ?LITERAL                                                                                                  | : +DOES 2 OVER U< A" 3<?" NEGATE #DO-DOES @ + RCALL, ;        | : 0+DOES> 0 +DOES ;                                           ' RELEASE< ALIAS THEN IMMEDIATE                                                                                                                                                                                                                                 #DO-BR    (': <RELEASE AGAIN    #DO-?BR  (': <RELEASE UNTIL     #DO-BR    (': >MARK  AHEAD      #DO-?BR  (': >MARK    IF        #DO-#BR   (': >MARK  #IF        #DO-OF   (': >MARK    OF        #DO-CALL  (': >MARK  ?CALL      #DO-MNEXT (': >MARK  ?-FOR      #DO-RPUSH (': MARK>  FOR-       #DO-NEXT (': <RELEASE NEXT-     #DO-MBR   (': >MARK  -IF        #DO-SEMI (': RELEASE< ;THEN     #DO-FOR   (': >MARK>  FOR       #DO-NEXT  (': <RELEASE< NEXT    #DO-;CODE (': 0+DOES> DOES>     #DO-.ABRT  (': ,S"    A"        #DO-STR   (':   ,S"  "          #DO-.STR   (': ,S"    ."                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ ELSE CASE IF USER VAR: -------------------                    : ELSE ?CSP PUSH ', AHEAD  POP CSP! ', THEN ; IMMEDIATE         ' ELSE ALIAS ENDOF IMMEDIATE                                    : CASE CSP! CSP  0 TO CSP  ;  IMMEDIATE                         : ENDCASE #DO-DROP @, BEGIN CSP   WHILE ', THEN                                 REPEAT TO CSP ?CSP ; IMMEDIATE                  ' IF ALIAS WHILE IMMEDIATE                                      ' [ ALIAS [[ IMMEDIATE                                          ' MARK> ALIAS BEGIN IMMEDIATE  ' ] ALIAS ]]                     : REPEAT ', AGAIN ', THEN ; IMMEDIATE                           : USER  #DO-USER @ CODE,   #DO-SETU @, C, ;                     : GLOBAL  #DO-GETG @ CODE,   #DO-SETG @, C, ;                                                                                                                                                                                                                                                                                   \ BARY WARY CONSTANT VALUE ---------------------                : WARY #DO-ARY @ CODE, 2* CLARY ;                               : BARY #DO-ARY @ 2+ CODE, CLARY ;   : VARIABLE CREATE 0 , ;     : IMMEDIATE  #DO-COMM @ MOVEW ;                                                                                                                                                                 : VECT> HERE SWAP +DOES <:> ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ASSEMBLER DEFINITIONS    \ MACROSES                                                                                             : ;C EX END-CODE ;      : @J @ JMP, ;           : @@J @ @J ;    : /PUSH ;C #DO-WPUSH @J ;       : /SWAP ;C #DO-SWAP @J ;        : >USR1  CBW, #DO-USRV @ /// AX ADD, AX DI XCHG, ;              : >GLB1  CBW, #DO-GLBV @ /// AX ADD, AX DI XCHG, ;                                                                              : /DROP  ;C #DO-DROP @@J ;      : /JUMP AGAIN, ;C ;             : 0>AX, AX AX XOR, ;   : 2*, BX BX ADD, ;                       \ : DUP, BX PUSH, ;    : DROP, BX POP, ;                        : XOR-DBG, [ AX DI XCHG, DI SKIPW, HERE @- DROP                     SAVE2 UNPACK XOR ] LITERAL #, #DO-EX @ 1+ ///  XOR, ;                                                                                                                                                                                                                                                                       \ ONLY FIXES  TO COMPILER                                                                                                                ' (E TO '(OUT   ' (K TO '(IN                           ' PUSH #DO-RPUSH !    ' DROP  #DO-DROP !      ' EXIT #DO-SEMI ! ' lit   #DO-LIT !      ' else #DO-BR   !      ' if    #DO-?BR ! ' #if  #DO-#BR !       ' -if   #DO-MBR !       ' for  #DO-FOR ! ' next  #DO-NEXT !     ' of    #DO-OF  !   ' 0>next #DO-MNEXT ! ( ' R<>S  TO RP/SP )     ' ?call #DO-CALL !                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     >: ;DROP EX DROP; ; SAVE2                                       : EXECUTE PUSH ;                                                : XEP XCHG PUSH EX POP ;                                        | : TRUE _ [ -1 , ] ;   | : FALSE _ [ 0 , ] ;                   >: 0< -if TO FALSE else TO TRUE  ;  SAVE2                       | : ;AB A XCHG B PUSH PUSH EX POP B! POP A! ;                   : INVERT -1 XOR ;                                               : OVER NUP SWAP; ; SAVE2                                        >: U<  SWAP INVERT +2/ NIP  TO 0< ; SAVE2                       | : 9>? 9 OVER U< ;                                             : TWICE I PUSH ;                                                : LOOPS  FOR J EXECUTE NEXT  RDROP ;                            \ : LOOPS 1- -IF DROP RDROP ;THEN                               \ : REPEAT I 2- XCHG : EXECUTE PUSH ;                           \ : TIMES ;DROP LOOPS OVER PUSH PUSH EXECUTE POP POP ;                                                                          : C!     C!+ DROP; ; SAVE2                                      : C@     C@+ DROP; ; SAVE2                                      : CSTR   C@+ SWAP; ;  SAVE2                                     : +      +2/ DROP; ; SAVE2                                      : @      @+ DROP; ;   SAVE2                                     : !      !+ DROP; ; SAVE2                                       : NEGATE INVERT 1+ ;                                            : -      NEGATE + ;                                             : <      - TO 0< ;  SAVE2                                       >: 0=    #if TO TRUE  else TO FALSE ;  SAVE2                    : =      XOR TO 0= ; SAVE2                                      : WITHIN OVER - PUSH - POP  TO U< ; SAVE2                       | : ;A A EX A! ;  : C@A+ ;A C@+ ;  : @A+ ;A @+ ;                : 2DROP DROP DROP; ; SAVE2                                      : 2SWAP ROT XEP ROT ;                                                                                                           : CR  cr EMIT  lf EMIT   0 TO OUTC ;                            : SPACE bl EMIT ;        : ;SPACE EX SPACE ;                    : ALPHA  9>? 7 AND + 48 + ;     :: DIGS. LOOPS  ALPHA EMIT ;    :: .H ;SPACE B/MOD TWICE  HB/MOD TWICE TO DIGS. ;               :: TYPE ;DROP LOOPS CSTR ?EMIT ;        : ".  CSTR TYPE ;       : ID. ;SPACE  ". ;      : .DH TO .H .H ;                        : SPACES LOOPS SPACE ;                                          : LENZ DUP CONT CSTR if; RDROP 1- SWAP - ;                      : TYPEZ DUP LENZ TYPE ;                                         : BKEY  BEGIN PAUSE BKEY? UNTIL (BKEY ;                                                                                         \ SPACE  5 .H SPACE B.                                                                                                                                                                                                                                                                                                          | : (A" (CSTR SWAP IF '(ER EXEC ABORT THEN DROP ;               ' (A" #DO-.ABRT !        | : ?? A"  ?" ;                        | : ("  (CSTR ;          ' ("   #DO-STR !                       | : (." (CSTR ". ;       ' (."  #DO-.STR !                      | : ;code POP CFA ! ;    ' ;code  #DO-;CODE !                   : ACCEPT ( A L -- A NEWL ) OVER PUSH I + PUSH BEGIN  KEY         cr OF RDROP PUSH I  ENDOF                                       bs OF DUP J XOR IF bs EMIT SPACE bs EMIT 1- THEN ENDOF           DUP bl 256 WITHIN IF DUP EMIT SWAP C!+ DUP  THEN                DROP THEN THEN  DUP I = UNTIL DROP J POP POP - ;              : ?SRCH B! PUSH A! ?-FOR POP TRUE ;THEN POP XCHG PUSH  J         FOR- J EXECUTE IF NEXT- J 1+ skip THEN POP RDROP POP SWAP - ;  : =B? ?SRCH B C@A+ XOR ; : <>B? ?SRCH  B C@A+ XOR TO 0= ; SAVE2 : =W? ?SRCH B @A+ XOR ;  : <>W? ?SRCH  B @A+ XOR TO 0= ;  SAVE2                                                                                                                                  0 BARY TOAT ,T TO  ,T AT                                                                                                       | : C>N? 2- ?CALL   OVER ?SRCH                                     A C@ bl 1+ U< #IF POP RDROP 0 PUSH PUSH ;THEN  \ BAD CHAR       DROP A C@- A! #IF  A + B XOR ;THEN 1+                        ;THEN  DUP 1- bl 1- EX  1+ IF A SWAP ;THEN 0 ;                                                                                  : C>N  C>N? IF 1 ;THEN C>N? IF 2 ;THEN  C>N? IF 3 ;THEN 6 + 0 ;                                                                 : ?ID. C>N 1- DUP #BLK IF 1- #IF 2+ THEN  TOAT ID.                        BEGIN ID. ;THEN  UNTIL 58 EMIT .H ;                                                                                                                                                                                                                                                                                                                                                   | >: DDH. TWICE SWAP DUP .H ; | : TOP. DUP @ DDH. ?ID. BKEY ;   | >: (S. ;SPACE SP@ .H TWICE 2SWAP TO DDH. ; SAVE2              : S. CR TO (S. ; SAVE2                                          | >: (R.  R<>S (S. R<>S  ;  : R. CR TO (R. ; SAVE2                                                                              : (DBG PUSH S. POP POP (R. PUSH PUSH J 2- TOP.   NIP                       83 XOR IF AT TR THEN TO TR ;                                                                                         : .BGR S. POP (R. PUSH I TOP. 2DROP ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | : ;@! @+ XCHG PUSH EX POP !- DROP; ; SAVE2                    | : ;B B EX B! ;                                                | : U1- XEP 1- ;                                                : STR @+ SWAP; ;  SAVE2                                         : A- ;A 1- ;                                                    : A+ ;A 1+ ;                                                    : C!A- ;A C!- ;                                                 : !B+ ;B !+ ;                                                   : C!B+ ;B C!+ ;                                                 : C@B- ;B C@- ;                                                 : 2! !+ ! ;                                                     : 2@ @+ @ SWAP; ; SAVE2                                                                                                                                                                                                                                                                                                         : +! ;@! + ;                                                    : XOR! ;@! XOR ;                                                >: ;SWAP EX SWAP; ; SAVE2                                       >: ;NIP EX NIP;   ; SAVE2                                                                                                       : 0<> #IF TRUE THEN ;                                           : ;RDROP EX RDROP ;                                             : ODD 1 AND ;                                                   : UM+ +2/ 0< ODD ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              >: 0<= #if TO TRUE  TO 0< ;  SAVE2                              : <= - TO 0<= ;  SAVE2                                          : >= < TO 0= ;  SAVE2                                           : <>  = TO 0= ; SAVE2                                           : S>D DUP 0< ;                                                  : > <= TO 0= ;  SAVE2                                           : 2* DUP + ;                                                    : U2/ 0 +2/ NIP ;                                               | : ?S2/  IF ?CALL #SGN XOR ;THEN THEN U2/ ;                    : 2/ S>D ?S2/ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                 \ + - ZSWAP ODD 2* 2/ OVER 2DUP S>D ABS OR  TUCK MAX  MIN       : ABS -IF NEGATE THEN ;                                         : OR OVER INVERT AND XOR ;                                      : 2DUP OVER OVER ;                                              : TUCK DUP -ROT ; | : US>D XEP S>D ;                            | : >BE 2DUP < IF SWAP THEN ;                                   : MAX >BE DROP ;                                                : MIN >BE NIP ;                                                 \ : 2DROP DROP DROP; ; SAVE2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ : REGS! TO _FL   TO _AX   TO _BX   TO _CX   TO _DX  ;         \ : @+= ( W A - W| A+ ) @+ XEP @A+ XOR OR ;                     \ : 2@+=  0 SWAP @+= @+= DROP ;                                 \ : D2/ 0 +* DROP ;                                             \ : STRTEST CR ." STRTEST" ;  STRTEST                           \ : (STR J POP POP C@+ + PUSH PUSH ;                            \ : >BYTE 255 AND ;                                             \ : >< B/MOD SWAP BB>W ;                                                                                                        \ 0 VECT> PERFORM @ PUSH CR  .SDB POP R<>S .SDB R<>S            \ ?ID. BKEY DROP ;  DUP  ' I CODE,, .BGR   ' J CODE,, .DBG      \ : EMIT ;AB '(OUT EXEC OUTC 1+ TO OUTC ;                       \ : KEY  ;AB '(IN EXEC ;                                        \ | >: (S. ;SPACE SP@ .H ?CALL DDH. ;THEN XEP XEP DDH. ;                                                                                                                                        \ -/ +* UM* M+  UM/MOD  UM+ D+  DNEGATE D-  D0  D0-ROT          : D+ ROT + ?CALL SWAP 0;  1+ ;THEN XEP +2/ 0< ;                 : DNEGATE OVER IF INVERT SWAP ;SWAP THEN NEGATE ;               : D- DNEGATE D+ ;   | >: ;SGN EX DNEGATE ;                      : UM*  0 SWAP ;DROP 1H LOOPS   \ ?FOR +* NEXT THEN  DROP ;      ( : +*)  XEP OVER ODD #IF DROP J THEN +2/ XEP ODD ?S2/ ;        | : D2* ?CALL XOR ;THEN 2* XEP DUP UM+ ;                        : UM/MOD ;SWAP ;DROP 1H LOOPS   \ ?FOR -/ NEXT THEN DROP SWAP ; ( -/)   XEP D2*  J NEGATE +2/ 0< IF XEP 1+ ;THEN  J + ;         : M+ S>D D+ ;  : D0 0 0 ;                                                                                                                                                                                                                                                                                                                                                                                                                                       \ MOVE FILL BLANK ERASE -TEXT ?B ?W FOUND NONE  >ZSTR           : FILL A! SWAP B! TIMES A C!B+ ;                                : ERASE 0 FILL ;        : BLANK bl FILL ;                       : REVERCE B! A! B A - U2/ TIMES C@A+ C@B-  A 1- C!  B C! ;      : EXCHANGE -ROT B! A! TIMES C@A+ B C@+ B!  A 1- C!  B 1- C! ;   : CMOVE -ROT B! A! TIMES C@A+ C!B+ ;                            : CMOVE> TUCK + A! TUCK + B! TIMES C@B- C!A- ;                  : -COMPARE -ROT B! A! 0 SWAP TIMES C@A+ B C@+ B! XOR 0;           RDROP 2DROP A 1- C@ C@B- - ;                                  : -TEXT DUP C@ 1+ -COMPARE ;                                    : >ZSTR ( A L - ZA ) NPAD XEP J SWAP J MIN CMOVE 0 C!B+ ;       \ : MOVE RANGE! DUP A B WITHIN A BA- ROT IF CMOVE> ;THEN CMOVE ;\ : RANGE! OVER + B! A! ;                : BA- B A - ;          \ : =D? ?SRCH  B 2@+= ;    : <>D? ?SRCH  B 2@+= TO 0= ;  SAVE2                                                                                                                                  \ M* M/ * / */ /MOD MOD U/MOD U/ UMOD ENDZ LENZ ACCEPT          :: U/MOD 0 SWAP UM/MOD ; : U/ U/MOD NIP ;  : UMOD U/MOD DROP ;  : MU/MOD TUCK U/MOD XEP TO U/MOD ;                              | : *?- 2DUP XOR 0< 0; ABS SWAP ABS TO ;SGN ;                   | : /?- -IF ABS PUSH DNEGATE POP TO ;SGN THEN ;                 : M* *?- UM* ;  : * M* DROP; ; SAVE2 : M/MOD /?- MU/MOD ;       : M/ M/MOD ROT DROP; ; SAVE2   : /MOD US>D M/MOD DROP; ; SAVE2  : / /MOD NIP ; : MOD /MOD DROP; ; SAVE2                         : M*/ PUSH M* POP M/ ; : */ M*/ DROP; ; SAVE2                   : ;BASE BASE XCHG PUSH TO BASE  EX POP TO BASE ;                                                                                | 0 VALUE X  | : END;  X A XOR IF ;THEN RDROP ;                 | : ?DIG  48 - 9>?  IF 7 - DUP lf <  OR THEN  DUP BASE U< ;                                                                                                                                                                                                     | : UD*+ SWAP ;GO TO D+ ?CALL DROP  XEP XEP THEN BASE UM* ;     : CONVERT BEGIN END; C@A+ ?DIG WHILE UD*+ AGAIN THEN DROP A- ;  | CREATE NUMOPS ,T ^`&~#%$-. | : ?OP ;AB NUMOPS CSTR C@A+ =B? ; | CREATE #OP  0 C, 0 C, 64 C, 128 C, 10 C, 2 C, 16 C,                                                                           : >NUMBER OVER + TO X A!  -1 TO DPL  D0  END;    \ EMPTY ?         ?OP 7 = IF A+ ;SGN THEN  ?OP 7 U< \ OPTIONS ? MINUS             IF X A - 1 > 0; ?OP A+ DUP 4 <    \ ^`~& \ ONECHAR NUMS            IF C@A+ OVER 0= IF 31 AND THEN  SWAP #OP + C@ + NIP SWAP;       ELSE  #OP + C@ ;BASE      THEN        \ NEW BASE           THEN CONVERT END; 0 TO DPL BEGIN END; ?OP 8 = 0; A+              A PUSH CONVERT  DPL  A POP - + TO DPL  AGAIN ;                                                                                : (DNUM CSTR >NUMBER DPL -IF DROP THEN DROP X A - ?? ;                                                                                                                                          \ NUMOUT   DECIMAL BINARY HEX                                   : 1# ;SWAP 1+ XEP BASE MU/MOD  2DUP OR 0= ;                     >: S# BEGIN 1# UNTIL NIP NIP ;                                  | : D# XEP -IF DNEGATE ?CALL -10 SWAP 1+ ;THEN THEN 0 S# ;      >: D.R ;GO AT DIGS. D# OVER - SPACES ;                          : D.  0 D.R  SPACE ;                                            : .R US>D TO D.R ;  SAVE2                                       : . S>D D. ;                                                    : (U.R ;SPACE lf ;BASE 0 SWAP TO D.R ; SAVE2                    : H. 0 1H ;BASE 0 1# DROP S# DIGS. SPACE ;  ' (U.R TO  #.                                                                                                                                                                                                                                                                                                                                                                                                       \ STECK OF VOCABULARIES                                         | : ;VSTK XCHG PUSH J @ J EX POP ! ;                            : ITEMS? @+ 2+ - U2/ ;  : INITSTK DUP 2+ 2+ SWAP! ;             #DO-VAR @                                                       1 VECT>  ;VSTK 2@ = A" +ITM" !+ ;                               2 VECT>  ;VSTK ITEMS? 0= A" -ITM" @- ;                          HEADER ORDER , , , 0 , >MARK 32 CLARY  RELEASE<                  AT ORDER INITSTK                   : TOP@ @ @- DROP ;                                                                          ' ORDER HEADER HANDLE W, W, W, Z, DROP >MARK 32 CLARY RELEASE<  AT HANDLE INITSTK       |  0 VALUE EOS?                                                                                                                                                                                                                                                                                                                                                         \ TESTS                                                                                                                         \   B.  ;S                                                      \ PARSE NUMBER                                                  \ EXIT                                                          \ ' PAD  DEFER PAD                                              \ : ?NUM PAD 10 ACCEPT >NUMBER ;                                \ : CNV DECIMAL PAD 10 ACCEPT OVER + TO X A!                    \                             SPACE 0 0 CONVERT D. ;            \ : FORI '?FOR BEGIN I . NEXT THEN ;                            \ : ACP PAD 10 2DUP . . ACCEPT SPACE . . ;                      \ : RANG? 1 1 B! A! B  A .BG  .H .H ;                           \ : PRESERVE XCHG I @ PUSH PUSH EX POP POP ! ;                  \ : MFIND AT FORTH (FIND ;                                                                                                                                                                      | : IO? _FL ODD A" IO?" ;    0 VECT> PUSH D0 ROT POP @ 4DOS ;   HEX | DUP CODE, CFpos 4201 ,   DUP CODE, FClose 3E00 C,             |  CODE, CFsize  4202 ,    0 VECT> @  4DOS ;                | DUP CODE, FOpen 3D02 ,       | DUP CODE, FCreate  3C00 ,      DUP CODE, FRead 3F00 ,         DUP CODE, FWrite  4000 ,             CODE, FSeek 4200 ,                                          | : FRW 1K UM* SCRH FSeek  IO?  1K SCRH  EX IO? ;               | : FWBLK FRW FWrite ;        | : FRBLK FRW FRead ;             : Fsize ( HND -- DX:AX ) CFpos IO? _DX _AX                         _BX CFsize TO _CX _AX _DX  ( DX:CX) ROT _CX _BX FSeek ;      : FSIZE SCRH Fsize 1K UM/MOD NIP ;                              : Fcut ( SCR -) FRW NIP D0 ROT FWrite DROP ;   DECIMAL          | :: ;File CSTR >ZSTR D0 EX IO? _AX ;                           : FOPEN ;File  FOpen ;        : FCREATE ;File FCreate ;                                                                                                                                         \ BLOCK WORDS                                                   15 DUP TO   NBUFS 1+ BARY FBUFS     NBUFS 1+ WARY  BUFS         0 VECT> C@ PREV FBUFS C! ;  DUP   | : @BUF PREV 1K * FIRST + ;   CODE, DISCARD  0 C,     CODE, UPDATE  -1 C,                    : !BUF PREV BUFS ! ;   | : +BUF USE 1+ NBUFS AND DUP TO USE ;   | : /BUF @BUF 1K ERASE ; | : EMPTY-BUF -1 !BUF  DISCARD /BUF ;  : EMPTY-BUFS  NBUFS  FOR- +BUF TO PREV EMPTY-BUF  NEXT- ;       | : ?BUF PUSH 0 BUFS NBUFS 1+ POP =W? ;                         | : ?SAVE PREV FBUFS C@ IF @BUF PREV BUFS @ FWBLK DISCARD THEN ; | : ;ABLK XCHG PUSH EX RDROP @BUF IO? ;                        : BUFFER ;ABLK J ?BUF -IF ?BUF -IF DROP +BUF THEN THEN              TO PREV ?SAVE /BUF J !BUF ;                                 : SAVE-BUFS  NBUFS  FOR- +BUF TO PREV ?SAVE NEXT- ;             : BLOCK ;ABLK J ?BUF -IF DROP J BUFFER J FRBLK ;THEN TO PREV ;                                                                                                                                  \ ID. >LFA WORD.                                                                                                                0 VECT> C@ TO BASE ;   DUP CODE, DECIMAL 10 C,                  DUP CODE, BINARY  2 C,     CODE, HEX 16 C,                      : >LFA C@+ + ; | : NEWLN CMARK 1+ TO CMARK ;                                                                                    | 0 VALUE XX                                                    | : TAB16 OUTC NEGATE 15 AND SPACES ;                           | : ?8 CSP 1+ TO CSP DUP C@ OUTC + 6 + 79 U< IF                     EX OUTC 1L U< IF TAB16 ;THEN NEWLN  CMARK  bs 1- AND 0=           IF BKEY 27 = TO XX THEN CR ;THEN CR NEWLN EX TAB16 ;      : WORD. ?8  DUP .H ID. ;                                        \ : TEST.W CR 0 TO CSP  LOOPS " A-WORD" WORD. ;                 \ : ?79 CR 7 LOOPS ?CALL 9                                      \         LOOPS 9 J - TO DIGS. ;THEN EX 124 EMIT ;                                                                              \ VFIND  FIND  FOR-WORDS  WORDS : alias DUP @ 1+ 0= 0; 2+ @ ;                                                                   : ;NS CURRENT XCHG PUSH TO CURRENT EX POP TO CURRENT ;          : FOR-WORDS   BEGIN DUP WHILE EX >LFA @ AGAIN THEN RDROP ;      : WORDS  CR  0 DUP TO XX DUP TO CSP TO CMARK ;DROP CONTEXT @       FOR-WORDS  BEGIN DUP WORD.  XX IF RDROP ;THEN  EX AGAIN ;                                                                    | CODE alias #DO-DEFER @ 3 - #, AX MOV,   0 /BX AX CMP, 0=,                  IF, 2 /BX BX MOV, THEN, /CODE                      : VFIND @ FOR-WORDS BEGIN 2DUP -TEXT IF  EX AGAIN THEN               NIP A! B 2+ alias DUP RDROP ;                              : FIND           @+ 2- ITEMS?  FOR @- PUSH VFIND                    IF RDROP RDROP DUP ;THEN  POP NEXT  DROP 0 ;                                                                                                                                                                                                                : IN?  /TIB >IN + >IN NEGATE ;   \ PARSING WORDS                | : BLK; BLK #BLK if; RDROP ; | >: ;TIB TO BLK BLK; 0 TO /TIB ; : SOURCE BLK; /TIB if; BLK BLOCK 1K + TO /TIB ;                 | : ;IN+ PUSH IN?  NUP POP EX A OVER - DUP >IN + TO >IN ;       | : (PARSE ;IN+ =B? 1+ 0; EX 1- ;                               | : (SKIP ;GO TO 2DROP ;IN+ <>B? 1+ 0; A- ;                     : PARSE PUSH SOURCE I bl = IF I (SKIP THEN POP (PARSE ;         : S! NUP  C!+ SWAP CMOVE ;      : CS! 1 SWAP C!+ C! ;           | : ;S! XCHG PUSH PARSE EX POP XEP #IF J S! ;THEN  NIP J CS! ;  :: FNAME bl NPAD ;S! NPAD MIN ; : =" 34 TO FNAME ;              : TOKEN bl TPAD ;S! 31 MIN ;      \ : WORD HERE ;S! ;           : ?EXIST >IN TOKEN CURRENT VFIND ROT TO >IN NIP ;               : RESCAN ?EXIST  0; ." \+"                                         OUTC 1L AND IF CR THEN  TPAD ID. BLK;  lf ;BASE BLK . ;      'T RESCAN  TO 'SAME                                                                                                             \ HANDLES FCLOSE EOF IO! HEX DECIMAL BINARY IO!                 | >: EOS -1 TO EOS? ; | 0 QUAN FBUF                                                                                             : FGET FBUF ?CALL EOS  _ [ cr , ] ;THEN  \ IF EOF THEN EOS        AT FBUF 1 AT HANDLE TOP@  FRead  _AX 0;  \ SOMETHING            DROP FBUF  DUP eof XOR 0; RDROP  ; \ CONTROLS - LIKE BL                                                                       \ STDIO                                                         CREATE FIO 0 , 0 ,     CREATE SIO ' (K , ' (E ,                 SIO 2@ FIO 2!   ' FGET FIO !            \ FIX VECTORS                                                                                                                                                                                                                                                                                                                                                                                                           \ EOS? ;TI ;SIO  ;BUF FOPEN ;S                                  \ : TOP. AT HANDLE TOP@ SPACE . ;                               : ;SIO  2@ '(IN XCHG '(OUT PUSH PUSH ?CALL EX                    POP POP THEN  TO '(IN  TO '(OUT ; | : (EVAL NEGATE TUCK - ;    : ;BUF POP RP@ ROT - RP@ OVER RP! PUSH SWAP PUSH EX POP RP! ;   : ;TI /TIB XCHG >IN PUSH TIB PUSH BLK PUSH PUSH ?CALL EX POP POP  POP POP THEN 0 TO EOS? TO /TIB TO >IN TO TIB TO ;TIB ; SAVE2  | :: FCLOSE1 TIMES HANDLE FClose ;                              | : CLOSE-ALL AT HANDLE ITEMS? FCLOSE1 ;                        | : ;FILE TO HANDLE  0 TO FBUF EX  TO FCLOSE1  0 TO EOS? ;      :: FTYPE FNAME FOPEN ;FILE BEGIN FGET EMIT EOS? UNTIL ;         : SAVE 1 ON-START !  FNAME FCREATE ;FILE  lit [ #DO-BOOT @ , ]   HERE OVER -  AT HANDLE TOP@ FWrite ;                                                                                                                                                                                                                           \ STREEM EVALUATION  - SEVAL  EVAL LOAD OK? FLOAD KBD ;S IO!    | : OK. ."  OK" ; | : PROMPT. ." >" ; \ ' OK' TO 'OK            | : OK? BLK IF EX CR ;THEN PROMPT. EX SPACE EX OK. CR ;         | : SEVAL ;SIO 100 ;BUF D0 ;TI BEGIN ?CALL EOS? UNTIL ;THEN OK?  TIB 100 ACCEPT (EVAL TO /TIB TO >IN EX INTERPRET ; SAVE2       : KBD 0 SIO SEVAL ; :: INCLUDE FNAME FOPEN ;FILE -1 FIO SEVAL ; :: EVAL CSTR 0 RP@ 2SWAP (EVAL  ;TI INTERPRET ; SAVE2           >: THRU 1+ 1K NEGATE DUP ;TI BEGIN ?CALL EOS? UNTIL ;THEN       INTERPRET ; SAVE2 | 0 CODE, BYE  : LOAD DUP TO THRU ;                             \     LBL: ;S TO EOS ; SAVE2     ??           : FLUSH SAVE-BUFS EMPTY-BUFS ;                                  | : -USE SCRH 1+ 0; SCRH FClose -1 TO SCRH ;                    : USING FLUSH -USE FNAME FOPEN TO SCRH ;                        \               : BYE CLOSE-ALL FLUSH -USE (BYE ;                                                                                                                                               \ : PROBA " #10 #12 #13 +" EVAL ;                               \ : PROBA2 " 1 2 + . ;S + Y Z W V" EVAL ;                       \ : PROBA3   99 " (:"  AT ORDER FIND .H .H .H ;                 \ : LOAD ( BLK) 1K NEGATE ( >IN) 0 ( /TIB) ROT ;TI INTERPRET ;  \ : FNAMER FNAME FOPEN DUP .BG Fsize .BG  D. FClose ;           \ : THRU U1- ;DROP OVER - LOOPS 1+ XEP J LOAD ;                 \ : PROBA5 1 2 3 4 ;TI ;                                        \ | : ? @ . ;                                                   \ : BLK. CR   ." BLK= " BLK . ." >IN= " >IN .                   \           ." /TIB= " /TIB . ." TIB= " TIB . ;                                                                                                                                                                                                                                                                                                                                                                                                                 \ DUMP LIST ?                                                   : .LINE  4 #. 1L TO TYPE ;                                      : .BLOCK ;DROP 1H LOOPS CR 1H J - .LINE ;                       : LIST  CR DUP TO SCR  DUP  6 #.  BLOCK .BLOCK ;                | : ;[] EMIT 91 EMIT EX 93 EMIT ;                               | : UNITS? U/MOD SWAP 0; 1+ ;                                   | : DU CR DUP .H 2 LOOPS SPACE bs LOOPS CSTR H. ;               : DUMP ;DROP 1H UNITS? LOOPS DUP DU bl ;[] SWAP 1H TYPE ;       0 VALUE XY                                                                                                                      : >XY 1K 1- AND TO XY ;                                         : ERR> CR TPAD ". ". BLK; BLK TO SCR  >IN  >XY ;                ' ERR>   TO '(ER                                                                                                                                                                                                                                                \ KBD & VIDEO                                                   \ 200 SET CURPOS    300 READ CURPOS  100 SHAPE CURS             \ 900 FILL SCREEN                                               CODE VIDEO VIDEO, RET, LIKE 4DOS TOBE  END-CODE                 : .ATTR  0 SWAP ATTR @ $920 VIDEO ;                             : XY?   D0 0 $300 VIDEO _DX B/MOD ;                             : ATXY  BB>W  D0 $200 VIDEO ;                                   : CURS! BB>W  D0 -ROT $100 VIDEO ;                              : PAGE 0 0 ATXY 2000 .ATTR ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ VOCABULARIES                                                  ' ORDER HEADER CSTK W, W, W, Z, DROP >MARK 100 CLARY RELEASE<   #DO-VAR @  1 VECT> TO CURRENT ;  2 VECT> TO CONTEXT ;           CODE, FORTH , , 0 , 0 ,   \ ROOT VOCABULARY  ONLY               HEADER  MACRO  ' FORTH W, W, W, W, W, DROP AT MACRO #DO-MACR !  HEADER COMMON  ' FORTH W, W, W, W, W, DROP AT COMMON #DO-COMM ! HEADER HIDDEN  ' FORTH W, W, W, W, W, DROP                                                                                      : .( 41 PARSE TYPE  ;    IMMEDIATE                              : (  41 PARSE 2DROP ;    IMMEDIATE                              : ALSO CONTEXT TO ORDER ;  : ONLY AT ORDER INITSTK ALSO ;                                                                       LBL: X BLK; BLK 1+ TIB XOR if AT EOS                              1K NEGATE TO >IN  BLK 1+ TO ;TIB ; SAVE2  \ EMPTY WORD        0 ' X 1- 2- C!   IMMEDIATE                                                                                                      \ COMPILER STUFF   - NO NAME GENERATION : ;, EX 2, ;            : ;HERE HERE EX TO HERE ; : ALLOT ;HERE + ; \ : ?DUP DUP 0; DUP : 1, ;HERE C!+ ;      : 2, ;HERE !+ ; \ : ALIGN ;HERE ODD + ;   | : SWAP;, SWAP EX 2, ; : 3, SWAP;, 1, ;  : 4, SWAP;, 2, ;      : <%> THERE ;HERE TO THERE ; : <N> NPTR ;HERE TO NPTR ;                                : COMPILE @R+ 2, ; : BCOMPILE C@R+ 1, ;  : ON -1 SWAP! ; : OFF 0 SWAP! ;   : @SWAP OVER @ XEP SWAP! ;    AT CSTK INITSTK   | : ;CSP CSP EX TO CSP ;                      : ?CSP SP@ ;CSP - A" ?IF?" ;    : CSP! ;CSP SP@ ;               : ?STKC CMARK  AT CSTK @ XOR  A" ?LP?" CSTK TO CMARK  CSTK ;    : FIX DUP @ A" ?FIX?" HERE SWAP! ;                              : STKC!  TO CSTK  CMARK TO CSTK  AT CSTK @  TO CMARK ;          : Z, 0 2, ;     : ZC, 0 1, ;    : W, STR 2, ;   : B, CSTR 1, ;                                                                                                                                                                                                  \ COMPILER STUFF   - NO NAME GENERATION                         : (DLIT (DNUM DPL 1+ IF SWAP 'LIT THEN 'LIT ;                    0 WARY STATES ]] (DLIT 2, (DNUM EXEC [[ \ INTERPRET            : A, 1 STATES PERFORM ;   \ COMPILE ADDRESS                     : S, ;DROP CSTR DUP 1, LOOPS B, ; : ," =" S, ; : ,T TOKEN S, ;  : CLARY HERE OVER ERASE ALLOT ;       \  : H2+ HERE 2+ ;        : ZARY,  HERE DUP PUSH 2- EXEC POP - CLARY ;   \ : HP, H2+ 2, ; : >MARK HERE Z, CSP! ;          : RELEASE< ?CSP FIX ;           : <RELEASE ?STKC 2, ;           : MARK> HERE STKC! ;            : >MARK> >MARK MARK> ;   : <RELEASE< <RELEASE RELEASE< ;        0 VECT> C@ 1, A, HERE NEGATE HERE 2- +! ; | 'CODE, #CAL, 232 C, 0 VECT> HERE XEP @ PUSH 3 OVER U< A" 4<?" NEGATE POP + #CAL, ;  DUP | 'CODE, (+DOES  #DO-DOES   @ ,  | : 0DOES> 0 (+DOES DROP ;     | 'CODE, (4TH:    #DO-4TH:  @ ,                                                                                                                                                             \ COMPILER STUFF   -  CONTROL STRUCTURES                        0 VECT> W, PERFORM ; #DO-COMP ! \ PREPARE FOR COMPILING IF ; ...(": FOR-   PUSH   MARK>         (": FOR    for    >MARK>        (": NEXT-  next   <RELEASE      (": NEXT   next   <RELEASE<     (": OF     of     >MARK         (": ;THEN  EXIT   RELEASE<      (": AHEAD  else   >MARK         (": ?-FOR  0>next >MARK         (": IF     if     >MARK         (": ?CALL  ?call  >MARK         (": -IF    -if    >MARK         (": #IF    #if    >MARK         (": UNTIL  if     <RELEASE      (": AGAIN  else   <RELEASE      ' MARK>    DEFER BEGIN      COMPILING                           ' RELEASE< DEFER THEN       COMPILING                           (": A" (A" ,"         (": "  ("  ,"       (": ."  (." ,"        #DO-LIT @ #DO-COMP @ 'CODE, (LIT , 'T 2, , \ LITERAL                                                                                                                                                                                                            \ COMPILER STUFF   -  NAME GENERATION                           | : LOCATE ;SWAP 3 TOKEN SRCHPNT  PUSH  CICLES 1+ TO CICLES ;   : ' LOCATE DUP 2 AND = ?? ; \ COMPILER                          | : H1 'SAME BLK 2, CURRENT HERE TOKEN S, @SWAP 2, ;            : ALIAS [[ #DO-DEFER @ 5 - , ]] H1 2, 2, ; \ ;, ;, H1 ;         | : H2  -1 -HEADS +! HERE <N> ;GO TO <N> ALIAS ;                | : H3 -HEADS @ IF H2 ;THEN H1 ; : HEADER H3   HERE TO CFA ;    : CODE, HEADER A, ; : ,' ' A, ; : CREATE lit NOP CODE, ; \ !!!  | : ;PERF HEADER W, EX PERFORM ; | : ;CODE, CREATE A, EX ,' ;   : (1: ;CODE, DOES> ;PERF ;   : (2: ;CODE, 2, DOES> ;PERF W, ;   : (3: ;CODE, 2, 2, DOES> ;PERF W, W, ;                          LIKE (?DBG BE HEADER                                            #DO-CONST @ 'T (1: 6 + 'CODE, CONSTANT  , 'T 2, ,               #DO-VAR  @  'T (1: 6 + 'CODE, VARIABLE: , 'T 2, ,                #DO-VAR  @  'T CREATE 2+ 2+ !    \ PATCH CREATE  !!!                                                                           \ LOCATE ' INTERPRETTER COMPILER [ ]  ',  (: (;                 | : .! POP TO SRCHPNT ;                                         : ] .! AT MACRO VFIND if; AT COMMON VFIND if; U1- U1-            CONTEXT VFIND if; AT HIDDEN VFIND if; AT ORDER  FIND if; U1- ; : [  .!  CONTEXT VFIND if;  AT ORDER  FIND if; \ INTERPRETER         AT COMMON VFIND if; U1- ;  'T [   TO SCRH   COMPILING      | : CUTW     CURRENT @ DUP >LFA 0 @SWAP CURRENT ! ;             | : PASTEW OVER @SWAP SWAP >LFA ! ; \ : MOVEW CUTW SWAP PASTEW ;| : (:  STKC!  0  TO CSP  CSP! ] ;  | : ((: CUTW (: ;           | : (;  ?CSP ?STKC  CSP   A" ?:;?" [[ SCRH , ]]                        #IF CURRENT PASTEW DUP THEN DROP; ;                      : VECT>  (+DOES 0 (: ;                                          : 4TH> 0 (4TH:  0 (: ;                                          \ : VARIABLE: CREATE 2, ;                                                                                                                                                                       \ MAIN LOOP     \ COMPILE NUMBER LIKE LITERAL                   \ 0 VECTOR 'TEST   6 LOAD                                                                                                       LBL: (INT  \ CR SOURCE IN? 1L MIN TYPE ." <-" .BG                           'TEST                                                          LOCATE STATES PERFORM INTERPRET ; SAVE2 \ MAIN LOOP  : F83 DECIMAL  FORTH  ONLY  TO FORTH ;                                                                                          | : (INIT lit (INT  TO INTERPRET   lit (LIT TO  'LIT  0 TO BLK  lit (DNUM 2 STATES !  lit (DLIT 0 STATES ! lit 2, 1 STATES !      AT CSTK INITSTK    F83  [[ SCRH , ]] ;     \ INTERPRETTER ON  : (AB  CLOSE-ALL (INIT   ON-START 0 @SWAP                         IF  EMPTY-BUFS  NPAD 1+ EVAL  " FRT01.SCR"  FOPEN                 TO SCRH  3 LOAD   THEN   BEGIN KBD AGAIN ; SAVE2                                                                                                                                            : SAVE2 ;HERE 2- ;                                              : SAVE1 ;HERE 1- ;                                                                                                              'T (1: 6 +  'CODE,  :      LIKE SAVE2 , 'T ((: ,  \ : !!!       LIKE :  'CODE, LBL: LIKE (INT  , 'T ((: ,                       (": ; EXIT (;                                                   (": DOES>  ;code  0DOES>                                                                                                        'T ,' DEFER ',    COMPILING                                                                                                     \ UPV TO THRESHOLD  \ VOXAN    : CREATE VARIABLE SAVE2 ;                                                                                                                                                                                                                                                                                                                                        \ INITIALIZATION                                                                                                                'HERE TO HERE    AT MINI @   AT FORTH !  \ 300 'ALLOT              $EF00 TO FIRST     3 TO NBUFS  \ EMPTY-BUFS                  $D000  TO NPTR        'T .BGR TO .BG      6 TO SCRH             NPTR   TO SPTR                                                  $EF00  TO RP0          $E500  TO SP0                            \  (INIT                                                        #DO-MOVE @ TO RELOC                                             'T (DBG TO '(DE         'T (AB  TO  '(AB                                                                                        \ TSIZE  #DO-SIZE @ !                                                                                                           \ PRUNE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         : INC  1 SWAP +! ;                                              : DEC -1 SWAP +! ;                                              : W>H TPAD XEP J B! 5 C!B+  `$  C!B+ B/MOD TWICE HB/MOD                 TWICE ALPHA C!B+ ;                                      | : D>H1 1H ;BASE 0 S# ;                                        : D>H D>H1  TPAD DUP PUSH B! DUP 1+ C!B+ `$ C!B+                        FOR ALPHA C!B+ NEXT I C@ 5 > IF `. I INC THEN POP ;     : S+C! DUP XEP C@+ + C! J INC ;       \ APPEND CHAR             : S-C! DUP DEC ;                      \ DEL LAST CHAR                                                                           : W2C. D>H ". ;                                                                                                                                                                                                                                                                                                                                                                                 \ : ;NS  CURRENT XCHG PUSH TO CURRENT EX POP TO CURRENT ;       : W, STR , ;                    : B, CSTR C, ;                  : COMPILE POP W, PUSH ;         : BCOMPILE POP B, PUSH ;        : EXECUTE PUSH ;        : XEP POP SWAP PUSH EXECUTE POP ;       : U+ XEP + ;            : +THRU BLK TUCK + U+ THRU ;            : -ROT SWAP XEP SWAP ;                                          : W0 HEADER W, EX PERFORM ;     : ROT ?call AT -ROT SWAP ;      0 VECT> W0 ;  CODE, CONSTANT #DO-CONST @, ' , ,                 0 VECT> W0 W, ; CODE, VALUE #DO-CONST @ 1- ,                        #DO-SETV @, ' , ,                                           0 VECT> W0 W, W, ; CODE, QUAN #DO-CONST @ 2- ,                      #DO-SETV 1- @ ,    #DO-VAR @, ' , ,                                                                                                                                                                                                                                                                                         : TFD 0 256 FOR/ DUP 128 FDIG? . 1+ /NEXT DROP ;                : TEST?B NUMOPS CSTR TUCK HOLD! FOR/ ?OP                                    CR HLD TMP OVER - TYPE                                         .H HLD> DROP /NEXT ;                                                                                                 : I' POP' DUP' PUSH' ;                                          : SWAP PUSH XCHG POP ;  : EX POP XCHG PUSH ;                    : EXECUTE PUSH ;        : XEP XCHG PUSH EX POP ;                : NIP XEP DROP ;        : NUP XEP DUP ;                         : TUCK DUP XEP SWAP ;   : TAKE DROP SWAP ;                      : DIP  DROP DUP ;       : DRIP SWAP DIP ;                       : USWAP XEP SWAP ;      : OVER NUP SWAP ;                       : ROT USWAP SWAP ;      : -ROT SWAP USWAP ;                     : I POP I' PUSH XCHG ;   : J POP I PUSH XCHG ;                                                                                                                                                  \ : .SDB SP@ H. ROT DUP H. ROT DUP H. ROT DUP H. 2 SPACES ;     \ : .BG CR .SDB  RP/SP .SDB RP/SP  R@ @ ?ID. KEY DROP ;         \ : PROBA 10 .BG TIMES .BG DUP .BG . .BG ;                      \ : PROBA TIMES DUP . ;                                         \ : PROBA TIMES DUP 1+ TIMES DUP 1+ . ;                         EXIT                                                            : HEADER HEADERS @ 1+ #IF HEADERS !  HERE <%> ALIAS <%>                   ;THEN DROP THEAD ;                                    : .BG CR .SDB  R<>S .SDB R<>S  I @ ?ID. BKEY DROP ;             XTIMES: DEC   BX                                                        JNL   XCONT                                                     POP   BX                                                        SJMP  XEXIT                                             XCONT:  PUSH  BX                                                        LEA   BX,[SI-2]                                                 SJMP  XTOR                                              ( : RETURN FRAME RP! POP TO FRAME ;                             : ;FRAME DUP RP@ OVER B/MOD + 2* - B! POP FRAME PUSH  RP@         TO FRAME 0 A! B RP! PUSH B/MOD SWAP FOR/ A !B+ /NEXT              FOR/ !B+ /NEXT EX RETURN ;                                  ?NONAM1:POP  AX                                                         POP  DI                                                         PUSH DI                                                         SCASW                                                           JNE  _PSH2                                                      POP  AX
                                                       PUSH [DI]                                                       JMP  SHORT _PSH2                                                CALL ?NONAM1                                            XNONAME:SCASW,   BX  PUSH,   0 /DI BX MOV,                                                                                                                                                      \ : TFIND2 ( WHAT WHERE -- THAT THAT | WHAT 0 )                 \    " LOOP/"  FIND  IF DUP .H ID. ;THEN DROP ;                 \ : TFD  FOR/ I . /NEXT ;                                                                                                       \ : TFIND ( WHAT WHERE -- THAT THAT | WHAT 0 )                  \     " LOOP/"  AT MINI  (FND  IF DUP .H ID. ;THEN DROP ;       \ : LOAD ( BLK) 1K NEGATE ( >IN) 0 ( /TIB) ROT ;TI INTERPRET ;  \ : THRU PUSH I SWAP - FOR J I - LOAD  NEXT RDROP ;             \ : PREVIOUS ORDER TO CONTEXT ;                                 \ : NAME? PAD 40  ACCEPT  0 TO BLK  CR 2DUP TYPE  CR            \ TUCK + TO /TIB NEGATE TO >IN 'HERE TO HERE ;                  \ : WORD? NAME? TOKEN ". ;                                                                                                                                                                                                                                                                                                      ( F: ;F  CLASS: ;CLASS : ?SIZE 0 SWAP FOR R@ 1+ PICK + NEXT ; ) : ;METHOD PREVIOUS      \ END DEFINING METHODS OF CLASS                   DEFINITIONS ; \ CONTINUE COMPILING WITH LAST CONTEXT  ' IOV @ 1-     2 NM: TO SELF ;M                                 2 NM: STR TO CONTEXT TO SELF ;M      3 MAKER INSTANCE ,         : '? 0 BEGIN ' DUP @            \ FIND WORD & IT'S BEHAVIOUR       [ ' AT @ ] LITERAL =         \ ? LIKE 'AT' OR 'TO'             WHILE 2+ C@ + REPEAT + ;      \ GET CORRESPONDING METHOD ADDR                                                                 : ;F [',] ;M '? TO ON;  \ ENDCOMPILE A FIELD                    ; IMMEDIATE             \ & REGISTRATE INITIALIZER              -HEADERS                                                          0 VALUE MHP            \ STATE OF MH BEFOR OPERATION          | 0 VALUE ADRI           \ INITIALIZER ADDR                     -->                                                                                                                             \ METHOD: INHERIT F:  VALUES MHP ADRI                           \ CLASS STRUCTURE 0. INSTANCER  1. INITIALIZER 2. CONTEXTER     \ 3. INVALID NAME 4. CONTEXT  5. VOCABULARY LINK                                                                                : METHOD: ALSO ' 2+ 2+  \ SAVE OLD CONTEXT                                DUP  @  LIT   \ ADDRESS & BEHAVIOUR OF A CLASS CONTEXT [ ' FORTH @ 1+ , ] =?  \ CHECK OK ?                                      EXEC          \ GET CONTEXT OF A CLASS                          DEFINITIONS ; \ USE IT                                : INHERIT METHOD: CONTEXT 2- DUP >R    \ SAVE OLD & GET CONTEXT     2- 2- 254 !                        \ SAVE INHERITED ADR INIT    ;METHOD  R> CONTEXT !              \ LINK WITH PARENT'S     ;                                                               : F: HEADER COMPILE [ 9 FRM @ , ]      \ FIELD NAME & OFFSET         USE: TO ON;  ;     -->            \ START, & REGISTER ADDR                                                                 : SEND NOOP SELF >R  SWAP TO SELF EXEC  R> TO SELF ;            ' SEND DUP @ 1- SWAP!  M: RP @2+! @ SEND ;M  ' SEND 2+ !        : [SEND] METHOD: ' COMPILE TO SEND , ;METHOD ;  IMMEDIATE       : ACTOR CREATE METHOD: ' , ;METHOD , DOES> 2@ SEND ;                                                                            0 NM: DUP PUSH 6 + INSTANCE POP EXEC ;M   TO MHP                                                                                : CLASS: HEADER  0 TO ON;               \ INHERITANCE FLAG          COMPILE [ MHP , ]                   \ INSTANCE CREATOR          >MARK  TO ADRI                      \ INITIALIZER ADDRESS SE    ALSO  HERE                          \ SAVE CURRENT CONTEXT      COMPILE [ ' FORTH @ 1+ , ]          \ VOCABULARY HEADER COM     COMPILE [ 1 C, bl C, ]      2Z,     \ CLASS_CONTEXT,            WORDLIST                            \ & WORDLIST LINK           EXEC DEFINITIONS                    \ CHANGE CONTEXT TO  CUR    MH TO ON;      ;   -->              \ MACROS DP STATE SAVE  : ;CLASS  M: ADRI ! 254         \ START COMPILE INITIALIZER OF A     @ ?DUP IF 254  TO ON;      \ SET ON CLASS BODY & TEST FOR O              TO ON;  THEN      \ IF INHERITANCE - GET INIT \ LI     BEGIN AT ON; @ 252 - WHILE \ MORE FIELDS ? TEST, COMPILE, F       ON; DUP ,                \ COMPILE FIELD INITIALIZER TO C       MH TO MHP                \ SET POINTER TO MHP  - TO CHECK       >MAC                     \ DO IT ON A MACROS DICTIONARY -       MH MHP = IF RECOVER THEN \ DISCARD INITIALIZER OF FIELD I       MHP 252 @ - ON; !        \ CALCULATE OFFSET & SET TO FIEL     REPEAT [',] ;M             \ END COMPILE INITIALIZER OF A C     ON; TO MH                  \ OLD STATE  TO  MACROS DICTIONA     ;METHOD                    \ PREVIOUS CONTEXT -> current        ON; DROP  ;                \ DROP FLAG                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     : "! OVER C@ 1+ MOVE ;    : '+ '>" "+ ;                         : "+C OVER COUNT + C! DUP C@ 1+ SWAP C! ;                                                                                       : <REG>  " 0 F: " '>" BLWORD  '+  "  ;F " '+ ;                  : WREG   <REG> " ,"  '+ "T "DROP "EVAL ;                        : BREG   <REG> " C," '+ "T "DROP "EVAL ;                        CLASS: 2DPOS   WREG XPOS  WREG YPOS    ;CLASS                   METHOD: 2DPOS  : .POS XPOS ? YPOS ? ;                             : AREA XPOS @ YPOS @ * ;                                      ;METHOD                                                                                                                         CLASS: 3DPOS  INHERIT 2DPOS  WREG ZPOS    ;CLASS                METHOD: 3DPOS  : .POS .POS ZPOS ? ;                               : VOLUME XPOS @ YPOS @ * ZPOS @ * ;                           ;METHOD                                                                                                                         MARKER -CLASS  0 NM: DUP PUSH 6 + INSTANCE POP EXEC ;M TO SELF   ' FORTH @ 1+                                                                 0 NM: @ , ;M CODE, #FLIT, , IMMEDIATE             : CLASS: HEADER COMPILE [ SELF , ] 2Z, ALSO HERE                 COMPILE [ ' FORTH @ 1+ , ]      COMPILE [ 1 C, bl C, ]                                 2Z, WORDLIST   EXEC DEFINITIONS ;        0 NM: @ SELF + ;M  : ;METHOD PREVIOUS DEFINITIONS ;            : FINIT CONTEXT 2- @+! , ; 1 MAKER FIELD FINIT                  : METHOD: ALSO ' 2+ 2+ DUP  @    EXEC  DEFINITIONS ;            : ;CLASS ;METHOD ;                                                                                                                                                                                                                                                                                                                                                                                                                                              : INHERIT METHOD: CONTEXT 2- DUP >R    \ SAVE OLD & GET CONTEXT     2- 2- 254 !                        \ SAVE INHERITED ADR INIT    ;METHOD  R> CONTEXT !              \ LINK WITH PARENT'S     ;                                                                                                                               : SEND NOOP  SELF PUSH TO SELF EXEC POP TO SELF ;               ' SEND 1-!   M: POP DUP 2+ PUSH @ SEND ;M ' SEND 2+ !           : [SEND] METHOD: ' COMPILE TO SEND , ;METHOD ;  IMMEDIATE       : ACTOR CREATE METHOD: ' ;METHOD SWAP , , DOES> 2@ SEND ;       CLASS: COMPLEX   CELL FIELD X   CELL FIELD Y  ;CLASS            \ COMPLEX A                                                                                                                                                                                                                                                                                                                                                                                     \ : META ' IS ;  \ METACOMPILER IN OBE WORD                     : CONST  AT COMMON ;NS  CONSTANT DOES> ;GO AT EVAL @ TPAD         XEP J B! 5 C!B+ `$ C!B+ B/MOD TWICE HB/MOD TWICE ALPHA C!B+ ; : C: <N CONST N> ;  : L: HERE C: ;      : ALIGN ;HERE ODD + ;   : INC 1 SWAP +! ; : DEC -1 SWAP +! ;                            : --@ -2 OVER +! @ ;       : @++ 2 OVER +! @ 2- ;                                                                               256 128 + VARIABLE: PPR  \ POINTER TO PRIMITIVES                256 256 + VARIABLE: PSF  \ POINTER TO SHORT FORTH TOKENS        512 128 + VARIABLE: PGL  \ POINTER TO GLOBALS                                                                                   -21 +ORIGIN  CONSTANT HI-TARGET         HI-TARGET VALUE TPTR                                                                                                                                                                                                                                                                    @+      !+      DUP     DROP                                    +2/     AND     XOR     LIT                                     EXIT    XCHG    POP     PUSH                                    (IF     (-IF    (NEXT   (CALL     ?FOR                          : JUMP POP @+ +2/ DROP : EXECUTE PUSH : NOP ; : INVERT -1 XOR ; : SIP DUP : XEP XCHG EXECUTE POP ;                              : ABS -IF : NEGATE INVERT : 1- PUSH ?FOR : -1 -1 ;THEN  POP       THEN ;  : SWAP PUSH XCHG POP ;  : EX POP XCHG PUSH ;          : - NEGATE : + +2/ DROP ; : OVER PUSH DUP XCHG POP ;            L: >4TH AX POP, L: PC!PUSH AX SI XCHG,  L: RPUSH X, AX PUSH, X, PP: NOP  L: _NOP  FB: 1    THEN, THEN, THEN,   _NOP TO ?NEXT  \   LODSW,  1 #, AL TEST, 0=, NOT, IF, SI DEC,  1 #, AH MOV,         AL DEC, 0<, IF,  AX DI XCHG,  0 /DI AX MOV,  PC!PUSH JMP,      THEN, THEN, AX DI XCHG,  0 /DI JMP,                           L: >NEST  2 /DI AX LEA, PC!PUSH JMP,                                                                                            0 QUAN #WORDS  0 VALUE EPOINT  | 0 VALUE TARGET                 | : ;T TPTR  EX  TO TPTR ;  : $ALLOT NEGATE ;T + ;              : S! OVER C@ 1+ CMOVE ; : C"PUSH  ;T C!- ; : W"PUSH  ;T !- ;    : EMPTY-NAMES HI-TARGET  TO TPTR  0 TO #WORDS ;                 : "PUSH  DUP C@ 1+ $ALLOT TPTR S! ; : S+C! OVER CSTR + C! INC ; : ADD`C  TPAD `` S+C! ;                                         : ENTRY  TOKEN "PUSH C"PUSH W"PUSH  AT #WORDS INC ;             | : EPOINT! 2+ 1+ TO EPOINT ; | : POINT+ EPOINT C@+ + EPOINT! ; : EFIND ?CALL 1+ ;THEN DUP TO TARGET  TPTR  EPOINT!  EPOINT         #WORDS ?SRCH TARGET EPOINT -TEXT  #IF POINT+ THEN ;         : DOER CREATE 1, 2, DOES> CSTR PUSH --@ PUSH I @ A" OVER!" I        HERE I !   POP POP  ENTRY ;                                   PGL 1 DOER PG:  PPR 1 DOER PP:  PSF 2 DOER PS:                                                                                                                                                                                                                VOCABULARY MINI   MINI ALSO  DEFINITIONS    ASM                 L: DO-BOOT   ?, B,? 1   L: <USER-ADR>  L,? 2  30 CLARY \ BOOT   FB: 1 $1000 #, BX MOV, $4A #, AH MOV, DOS, $F #, AH MOV, VIDEO, FL: 2   CLD,   <USER-ADR> 4 + #, SI MOV,           \ RESET        LODSW, AX SP XCHG,  LODSW, AX BP XCHG,  B,? 1   2SCAS,        L: DO-SETV  SCASW, BX 0 /DI MOV, PP: DROP L: _DROP DROP, ?, IF, L: DO-VAR  DUP, DI BX MOV, PP: 2+ L: _2+ BX INC, BX INC, ?, IF, L: DO-CONST  SCASW,  0 /DI AX MOV,                              L: #PUSH  DUP,      L: #SWAP AX BX XCHG,  ?, IF,                L: PC!PUSH AX SI XCHG,  L: RPUSH X, AX PUSH, X,                 PP: NOP  L: _NOP  FB: 1    THEN, THEN, THEN,   _NOP TO ?NEXT  \   LODSW,  1 #, AL SHL, PC!PUSH U<, J,  2 #, AH MOV, AX DI XCHG,  0<, NOT, IF,  SI DEC,  0 /DI JMP, THEN,                         SI DEC, 0 /DI AX MOV,  PC!PUSH JMP,                                                                                                                                                            L: DO-GO    LODSW, RPUSH JMP, L: _?call   LODSW, PC!PUSH JMP,   L: DO-:  2 /DI AX LEA, PC!PUSH JMP,  PP: LIT  LODSW, #PUSH JMP, PP: !+   0 /BX POP,  _2+ JMP,   PP: @+   0 /BX PUSH, _2+ JMP,   PP: XCHG   0 /BP BX XCHG, NEXT, PP: DUP    DUP, NEXT,           PP: PUSH    AX POP, AX BX XCHG, RPUSH JMP,      \               PP: POP    DUP, X, DROP, X, NEXT,               \               PP: -2/  BX NEG,                                                PP: +2/  AX POP, AX BX ADD,  BX PUSH, 1 #, BX RCR, NEXT, \      PP: AND  AX POP,  AX BX AND, NEXT,              \               PP: XOR  AX POP,  AX BX XOR, NEXT,  PP: DROP; L: #DROP;  DROP,  PP: ;; 0 /BP SI MOV, PP: RDROP L: _RDROP BP INC, BP INC, NEXT,  PP: (0br BX BX OR, 0=, NOT, IF,                                 PP: (skip L: #skip  LODSB, NEXT,                                PP: (-br  BX BX OR,  #SKIP 0<, J,                               PP: (br  L: #J THEN, LODSB, CBW,  AX SI ADD, NEXT,                                                                              PP: (bra 0 /SI SI MOV, NEXT,                                    PP: DO-STR  0>AX, DUP, 2 /DI BX LEA, SI 0 /BP XCHG, BX CALL,    PP: EX     SI 0 /BP XCHG, NEXT,                                 PP: J  2 #, DI MOV, CX SKIPW,                                   PP: I   DI DI XOR, 0 P/D AX MOV, #PUSH JMP,                     PG: (K  8 #, AH MOV, DOS, L: #CPUSH AH AH XOR, #PUSH JMP,       PG: (E  BX DX MOV, 2 #, AH MOV, DOS, _DROP JMP,                 PP: _COUNT 0 /BX AL MOV, BX INC, #CPUSH JMP,                    2SCAS,  L: DO-DOES  AX POP, DUP, 2 /DI BX LEA,  PC!PUSH JMP,    PP: NEXT  W/ 1 #, 0 /BP SUB,  #J U<, NOT J, LODSW, _RDROP JMP,  L: DO-DEFER          SCASW, DUP, DI BX MOV,                     PP: PERFORM        0 /BX BX MOV,                                PP: EXEC           BX DI MOV, DROP, 0 /DI JMP,                                                                                                                                                                                                                  PP: 2DOS AX BX XCHG, DROP,  DOS, DUP,  AX PUSH, PUSHF, DROP,    PP: ODD 1 #, BX SHR,  L: _CARRY  BX BX SBB, NEXT,               PP: 0=  1 #, BX SUB,     _CARRY JMP,                            PP: 0<  1 #, BX SHL,     _CARRY JMP,                            PP: U<  AX POP,  BX AX SUB, _CARRY JMP,                         PP: A  DX AX MOV,  #PUSH JMP,  \ ADDRESS                        PP: B  CX AX MOV,  #PUSH JMP,  \ BYTES                          PP: A! BX DX MOV,  _DROP JMP,                                   PP: B! BX CX MOV,  _DROP JMP,                                   PP: BB>W AX POP, AH BL XCHG, #SWAP JMP,                         PP: B/MOD  0>AX, BH AL XCHG, #PUSH JMP,                         PP: HB/MOD  0>AX, BX AX XCHG, AAH, AH BL XCHG, AX PUSH, NEXT,                                                                                                                                                                                                                                                                   0 CODE, DROP     0 CODE, NOP                                    #DO-BOOT @ 4 +  VALUE UPV   HERE 2- DUP #DO-USRV !              0 CODE, EXEC   0 CODE, PERFORM                                                                                                                                                                  HEX | DUP CODE, CFpos 4201 ,   DUP CODE, FClose 3E00 C,             |  CODE, CFsize  4202 ,    0 VECT> @  4DOS ;                | DUP CODE, FOpen 3D02 ,       | DUP CODE, FCreate  3C00 ,      DUP CODE, FRead 3F00 ,         DUP CODE, FWrite  4000 ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                         CODE +2/  AX POP, AX BX ADD,  BX PUSH, 1 #, BX RCR, /CODE       CODE AND  AX POP,  AX BX AND, /CODE                             CODE XOR  AX POP,  AX BX XOR, /CODE                             CODE lit LODSW, /PUSH                                                                                                           \ CODE NIP    AX POP, /CODE                                     CODE PUSH   X, DUP, X, /DROP                                    CODE POP    DUP, X, DROP, X, /CODE                              \ CODE SWAP   AX POP, /PUSH                                     CODE DUP    DUP, /CODE                                          CODE XCHG   0 /BP BX XCHG, /CODE                                \ CODE ROT    DI POP, AX POP, DI PUSH, /PUSH                    \ CODE -ROT   AX POP, DI POP, BX PUSH, DI PUSH, /SWAP           0 CODE, else    0 CODE, skip  0 CODE, R<>S   0 CODE, ?call      0 CODE, DROP;   0 CODE, EXIT  0 CODE, RDROP  0 CODE, NIP;                                                                          CODE  DROP;     DROP,                                        HERE BE  EXIT      THEN, 0 /BP SI MOV,                          HERE BE  RDROP     BP INC, BP INC, /CODE                        | CODE .skip DROP,    HERE BE  skip   LODSW, /CODE              | CODE .else DROP,    HERE BE  else   0 /SI SI MOV, /CODE       CODE #if BX BX OR,  LIKE else  0=, J,     LIKE skip /JUMP       CODE -if BX BX OR,  LIKE else  0<, NOT J, LIKE skip /JUMP       CODE  if BX BX OR,  LIKE .else 0=, J,     LIKE .skip /JUMP      CODE for   BX DEC,  LIKE .else 0<, J, LODSW, LIKE PUSH /JUMP    | CODE of AX BX XCHG, DROP, BX AX XOR,                              LIKE else  0=, NOT J,  LIKE .skip /JUMP                     CODE next  W/ 1 #, 0 /BP SUB,  LIKE else  U<, NOT J, PNT!                              LODSW,  LIKE RDROP /JUMP                 CODE  CONT   DUP, -2 /SI BX LEA, LIKE PUSH /JUMP                CODE  TIMES  BX DEC,  LIKE CONT 0<, NOT J, LIKE DROP; /JUMP                                                                     : LIT1 POP @+ PUSH ;                                            : PROBA1 LIT1 [ 56 , ] ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        PRUNE FORTH MARKER -NEW  VOCABULARY COMP  VOCABULARY ROOT  \ RESVOCABULARY TCOM  VOCABULARY TINT   TINT DEFINITIONS \ TRANSIENT : CLARY HERE OVER ERASE ALLOT ; | : [IS] @R+ 2+ ! ; : ? @ . ;   : ZARY,  HERE DUP PUSH 2- EXEC POP - CLARY ;  (  : IS ' 2+ ! ;) : ALIGN DUP 1- SWAP IF DUP DUP 1+ AND THEN A" 2^?" SWAP >ALIGN ; : ALIGNED HERE SWAP ALIGN HERE - CLARY ; | : ;-NAME <N EX N> ; | : ;HERE HERE EX TO HERE ; ( : META ' IS ;)VARIABLE -HEADERS   16 ALIGNED  HERE      12000 CLARY    HERE  PAD TO HERE \ SPACE  CONSTANT TEND   DUP VALUE THERE     CONSTANT TSTART             : <% THERE ;HERE TO THERE ; | : ;-HEAD -HEADERS @ EX -HEADERS ! ; : <N> NPTR ;HERE TO NPTR ; | : ;<N> EX <N> ;  ' <% ALIAS %>   | : ;NS  CURRENT XCHG PUSH TO CURRENT EX POP TO CURRENT ;       : C: AT HIDDEN ;NS ['] CONSTANT ;-NAME EXEC ; : L: HERE C: ;    | : ;CSP CSP EX TO CSP ;    : ?CSP SP@ ;CSP - A" SP CHG!" ;     : TSIZE THERE TSTART - ;  : CSP! ;CSP SP@ ;   1 11 +THRU                                                                        \ COMPILER STUFF   - NO NAME GERATION                           | : H2+ HERE 2+ ;                                               | : ;CFA! EX HERE TO CFA ;      : C, ;HERE C!+ ;                : , ;HERE !+ ;                  : ALLOT ;HERE + ;               : S,    C@ 1+ ALLOT ;           : HP, H2+ , ;                   : SAVE2 ;HERE 2- ;              : SAVE1 ;HERE 1- ;              : Z, 0 , ;                      : ZC, 0 C, ;                    : MARK/ HERE Z, ;               : /MARK HERE SWAP! ;            : LOOP/ MARK/ HERE ;            : /LOOP , /MARK ;               : FIX    DUP PUSH @ A" REDEFINE?" POP /MARK ;                   : W, @+ SWAP , ;                \ : ALIGN 2 ALIGNED ;           : COMPILE POP @+ PUSH , ;       : BCOMPILE POP C@+ PUSH C, ;    | : ;, EX , ;                   ' ' ALIAS H'  ' | ALIAS H|      : ?? 0= A" ?" ;                   0 VALUE VOCTYPE                                                                                                                                               \ FORWARD DEFINITIONS OF SPECIAL LOCATIONS                      ' -HEADERS @  CONSTANT  #VARIABLE       ' ALIAS 6 + @  CONSTANT  #ALIAS         | : [:] H' 4 + FIX ;  IMMEDIATE                  HERE ASM   SCASW, X, SI PUSH, X,  /ASM         \ >FSUB          HERE ASM   2 /DI SI MOV,          /CODE        \ >FJMP           SWAP  2  |  MAKER FWD:  Z,    |  FWD: ?ANY1                   | : ?ANY SWAP -ROT SEARCH [:] ?ANY1 ROT PUSH IF                   ( R@ 2 = IF DUP ?TARGET EX THEN) \ DON'T INTERPRET TARGET        POP THEN RDROP ; | : ?ANY2 SWAP ORDER# STR FIND TO ?ANY1 ;   | : \? 1 AT COMP ?ANY 0 ;                                       | : ?TARGET TSTART TEND WITHIN EX A" NOT TARGET!" ;              156 LOAD  ' SNUMBER TO NUM   ' LITERAL TO ?LITERAL             | : LOCT BLWORD 3 AT TCOM ?ANY 2 AT COMP ?ANY 1 AT ROOT ?ANY 0  ; | : (? CREATE C, DOES> C@ LOCT DUP TO VOCTYPE ?? +  ;         0 (? ?0          2 (? ?1         4 (? ?2   \ ' HELPERS                                                                          \ CODE NAP  DX POP, /CODE         CODE DAP  DX PUSH, /CODE      \ : S. DAP POP R@ SWAP PUSH CR S. KEY 283 = A" ESC ?" DROP NAP ; \      TO TCOM ' S. ALIAS S. TO TINT                           FWD: HEADER | FWD: HEAD  FWD: ,S     FWD: CREATE  FWD: ALIAS    FWD: VAR     FWD: 2VAR  FWD: 3VAR   FWD: CODE,     \                                                                            : 4VAR ;, [:] 3VAR   ;, [:] 2VAR   ;, [:] VAR  ;,  \            [:] CREATE #VARIABLE    [:] CODE,  ;,  \                        [:] HEADER ;CFA! ;-HEAD ?DUP   IF      \ ?-HEAD  ;CFA!                   1- EX EX  HERE  <N>  ;<N>     \                        [:] ALIAS  ;,  #ALIAS   ;,     ELSE    \                                       RDROP           THEN    \ ;-HEAD  IS DISCARDED   [:] HEAD BLK , 'SAME CURRENT HERE @SWAP ;,   \                  [:] ,S BLWORD C@+ PUSH 31 MIN DUP POP 1- C! 1+ ALLOT ;          : VARIABLE  0 TO VAR ;     : CVAR CREATE C, ;                                                                                   : CODE HEADER HP, ASM ;  \ CREATOS & MAKERS  \  DOES>       | : ;( HEADER  EX  W, PERFORM ;       \         : (XW   2VAR DOES> W, PERFORM ;     \ 1      : (X1   2VAR DOES> ;( ;             \ 2 .. 1MAKER  + EXEC   : (X2   3VAR DOES> ;( W, ;          \ ..       2MAKER  + EXEC   : (X3   4VAR DOES> ;( W, W, ;       \ ..       3MAKER  + EXEC   : (W     VAR DOES> @ , ;            \ WORD COMPILER             : (X@   2VAR DOES> @+ PERFORM ;    : W3,  , , , ;               : (XX   2VAR DOES> @+ PUSH EXEC POP PERFORM ;                   : (BR,  CVAR DOES> C@ C, H2+ - , ; \ .. + R,                      232 (BR, CALLI,   ' SWAP! -1 (X@ ON   ' SWAP! 0 (X@ OFF       TO TCOM  ' , 0 (XW LITERAL  ' CALLI, 0 (X@ DOES,  0 (W ;code,    0 (W  DROP,  ' ,S"  0 (XW A"   ' ,S"  0 (XW ." ' ,S"  0 (XW "   : [:] ?2 FIX ;  : \\ BLWORD \? ?? , ;                           : ['] [ ?1 LITERAL ] LITERAL @ , ;  TO TINT                                                                                    |  0 VALUE POINT      0 VALUE CICLES | : POINT! POP TO POINT ;  | : FINDING BLWORD POINT  PUSH  CICLES 1+ TO CICLES ;           | : TARGET, DUP ?TARGET 0= EX , ;                               | : NOT_FND SNUMBER [ TCOM ] LITERAL ; TINT                     | 0 WARY AWORD ] NOT_FND TARGET, EXEC SNUMBER [ \ INTERPRET     : T[ [',] [ POINT! 2 AT TINT ?ANY  2 ?ANY2 3 ;  \ : S. S. BIOS-K: T] ] POINT! 2 AT TCOM ?ANY  1 AT ROOT ?ANY 0 ;  \ COMPILE                                                                                                                                     | : INTER FINDING AWORD PERFORM INTERPRET ; ' (INT @ ' INTER !  : STOP! [',] [ ['] (INT [IS] INTERPRET ;                        : GO! ['] INTER [IS] INTERPRET T[ ;  : | ;-HEAD 1 OR ;  PRUNE   : ': STOP! : ;   : ';  [',] ; GO! ; IMMEDIATE  : ' ?0 ;         : VIEW ' DUP TSTART TEND WITHIN 0= A" MEM" C>N DROP 2- @ EDIT ; : LIKE ' @ ; : BE ' ! ; : IS ' 2+ ! '; ': META ' IS '; TINT ALSO                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                MARKER -VOXAN                                                    VARIABLE PROBA  LIKE PROBA  FORGET PROBA   0 VALUE THRESHOLD    VALUE #VAR?                                                    : WORD. ?DUP 0;  CSP DUP 0= IF CR 5 + THEN 1- TO CSP                 DUP H. ID. CSP 0; OUTC NEGATE 15 AND SPACES ;                            : NEXTW N>C 2- @ ; : VWORD. 8 - C>N DROP WORD. ;  : WLOOP POP EXECUTE 0 TO CSP                                                BEGIN ?DUP WHILE      DUP EX REPEAT RDROP ;         : WORDS" CONTEXT @ WLOOP BEGIN EX WORD. NEXTW AGAIN ;           : VOXAN CONTEXT @ WLOOP BEGIN EX N>C DUP @ #VAR? = IF DUP 2+ @     THRESHOLD U<                                                    IF OVER WORD. THEN THEN DROP   NEXTW AGAIN ;                 : VOXES AT FORTH 2+ WLOOP BEGIN EX VWORD. @ AGAIN ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( \ 21898 4412 - 2300 - TO THERE   )                            $8000 TO FENCE                                                  FORGET |                                                        SAVE2                                                                   HERE                                                    6 LOAD                                                          : SIZE. CR CICLES .  ." CICLES  " 0 TO CICLES                              HERE DUP SIZEMARK - . ." BYTES IS " TO SIZEMARK ;     TO  SIZEMARK                                                   SIZE. .( EDITOR)  CR                                                                                                                                                                                                                                                                                                                                                                            16 WARY REGS ( AX BX CX DX FL BP SI DS DI ES SP SS IP CS IC WR) : REGISTER CREATE C, DOES> C@ REGS @ ; 0 REGISTER RAX           1 REGISTER RBX  2 REGISTER RCX   3 REGISTER RDX  4 REGISTER RFL HERE 0 REGS !  ASM  SP 10 REGS /// MOV, SS 11 REGS /// MOV,              21 #, INT,  HERE 1- 1 REGS !                           CS: 11 REGS /// SS MOV, CS: 10 REGS /// SP MOV, RET, END-CODE   CODE >CALL BX 12 REGS /// MOV, AX POP, BX POP, CX POP, DX POP,  SI PUSH, BP PUSH, DS PUSH, CS: 12 REGS /// CALL, ES PUSH,        DI PUSH, DS PUSH, SI PUSH, BP PUSH, PUSHF, DX PUSH, CX PUSH,    BX PUSH, CS PUSH, ES POP, 0 REGS #, DI MOV, CLD,  STOSW,        9 #, CX MOV, BEGIN, AX POP, STOSW, CXNZ, NOT, UNTIL,            DS POP, BP POP, SI POP, BX POP, NEXT, END-CODE                 CODE >INT   BL  1 REGS @ /// MOV,  0 REGS @ #, BX MOV,                  ' >CALL CELL+ JMP, END-CODE                             CODE >DOS BX PUSH, $ 21 #, BX MOV, ' >INT CELL+ JMP, END-CODE                                                                   PAGE                                                            CR CR  .( HELLO FRIENDS!)  CR CR                                                                                                ( \ 21898 4412 - 2300 - TO THERE   )                                  1 LOAD                                                    ;S                                                                    4 LOAD                                                         50 LOAD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    CREATE -IT  VOCABULARY ASSEMBLER   21898 5500 - TO THERE        : DEFINITIONS CONTEXT TO CURRENT ;                              : PREVIOUS ORDER TO CONTEXT ;                                   : DB, 1, ; : DW, 2, ; : SHORT?  -$80 $80 WITHIN ;               LIKE STATES  (1: WARY ZARY,     LIKE STATES 2+ (1: BARY ZARY,   : MARKER ?EXIST IF >IN FORGET TO >IN  THEN                              CREATE DOES> 2- forget ;                                : VOC. 6 - ?ID. ;    MARKER -ASM    LIKE -ASM   BE -IT    -ASM  : ORDER. ;DROP AT ORDER DUP 2+ 2+ SWAP ITEMS? LOOPS STR VOC. ;  3 -HEADS !    : ;2DROP EX 2DROP ;   0 VECTOR VC                 : ?-CREATE ;2DROP >IN TOKEN 1+ @ $2D2D XOR 0; TO >IN 2DUP VC ;  : NFAMILY  ' TO VC 1H ;BASE  LOOPS TOKEN (DNUM ?-CREATE ;       : FAMILY ' TO VC  ;2DROP LOOPS DUP ?-CREATE OVER + ;              69 84 THRU  SIZE. .( ASSEMBLER)       PRUNE                                                                                                                                                    72 CONST kUP       80 CONST kDOWN     77 CONST kRIGHT           75 CONST kLEFT    116 CONST kcRIGHT  115 CONST kcLEFT           82 CONST kINS      83 CONST kDEL      73 CONST kPGUP            81 CONST kPGDN     71 CONST kHOME     79 CONST kEND            119 CONST kcHOME   117 CONST kcEND     59 CONST kF1              60 CONST kF2       61 CONST kF3       62 CONST kF4              63 CONST kF5       64 CONST kF6       65 CONST kF7              66 CONST kF8       67 CONST kF9       27 CONST kESQ             68 CONST kF10      84 CONST ksF1      93 CONST ksF10            94 CONST kCF1     103 CONST kcF10     15 CONST ksTAB           104 CONST kaF1     113 CONST kaF10      9 CONST kTAB                                                                                                                                                                                                                                                                                                                                            151 153 THRU     14  15 THRU   164 LOAD                         \ HERE TO FENCE  CREATE -MARKER                                    0 VALUE XK  : WHAT? 7 EMIT ;                                 : -:  ' 2, 1,  XK 2+ DUP TO XK       ( BYTES FOR MOVE UP 1 )             HERE OVER - DUP PUSH       ( START ADDRESS   )                  DUP 1+ ROT                 ( PREPARE FOR MOVE)                  CMOVE>  HERE C@ POP C!   ;   ( FIX CODE  )             : SWITCH: CREATE HERE 73 1 TO XK 0 -:                               DOES> SWAP TO XK CSTR 2DUP XK =B? 1+ 2* + + PERFORM ;       : ;SWITCH  73 - A" BAD KEYS" XK 2/ 1- SWAP C! ;                                                                                   12 LOAD           \ STRING                                    7 11 THRU           \ EDITOR                                                                                                                                                                                                                                    (  EDITOR POSXY WIPE RELOAD SAVEBLK LB N B ARROW)               F83      -HEADS ON                                              0 VALUE  PDATA    VARIABLE INS  0 VECTOR 'ADVANCE               : ?XY 1L U/MOD 5 2 D+ ; \ 2DUP 15 0 ATXY SWAP . .               : POSXY XY ?XY ATXY   ;         : ?INS INS @ ODD ;              : .INS  75 2 ATXY ?INS IF ." INS" ;THEN ." OVT" ;               : _INS  1 INS XOR! .INS ;    : RELOAD SCR BLOCK TO PDATA ;      : REDRAW .INS 0 0 ATXY SCR 8 #. CR  PDATA .BLOCK ;              : /L  1L 1- OR ;           ( LINE END)                          : L/ 1L NEGATE AND ;       ( LINE BEGIN)                        : ;LRUD  XY EX >XY ;                                            : ;LPOS  XY EX PDATA + ;                                                                                                                                                                                                                                                                                                        ( COPY POS^ LINE/ /LINE LDRAW EL INSC DELC OVTC INSL DELL LL  ) : L_UP  ;LRUD  1L - ;     ( LINE UP)                            : L_DN  ;LRUD  1L + ;     ( LINE DOWN)                          : L_END ;LRUD  /L ;       ( LINE END)                           : L_BEG ;LRUD  L/ ;       ( LINE BEGIN)                         : ->    ;LRUD  1+ ;       ( MOVE 1 CHAR RIGHT)                  : <-    ;LRUD  1- ;       ( MOVE 1 CHAR LEFT)                   : TAB>  ;LRUD  7 OR 1+ ;  ( NEXT TABULATION )                   : <TAB  ;LRUD  1- -8 AND ;  ( PREVIOUS TABULATION)              : <_|   L_DN L_BEG    ;   ( CARRIGE RETURN L_DN L_BEG )         : APOS  ;LRUD  0 AND ;    ( HOME POSITION OF CURSOR)            : LINE/ ;LPOS L/ ;  : /LINE ;LPOS /L ;                          : LDRAW POSXY LINE/ cr EMIT XY 1L / 1+ .LINE DROP ;    \ OK POS : EJECTBLOCK DISCARD -1 PREV BUFS ! ;                           : RESET EJECTBLOCK RELOAD REDRAW ;   ( !!!!!!!)                                                                                 : LB SCR + 0 MAX TO SCR RELOAD REDRAW ;   ( +blk - )            : LEOS 1K  XY - 1L - 0 MAX ;  ( - chars_to_end_of_screen )      : POS^ PDATA XY + ;          ( - char^ )                        : P2 POS^ DUP DUP 1L + ;     ( - char^ char^ char^+1l )         : LL XY /L XY - ;            ( - chars_to_end_of_line )         : GETCHAR XY 0= 'ADVANCE POS^ C@ 33 U< ;                        : -BL BEGIN  GETCHAR 0= OR UNTIL ;        : N  1 LB ;           : -NONBL BEGIN GETCHAR OR UNTIL ;         : B -1 LB ;           : >NEXT TO 'ADVANCE -NONBL -BL ;  : ADV ['] -> >NEXT ;          : >EL 1K LEOS - 1L MIN ;      : BACK ['] <- >NEXT -> ;          : EL >EL BLANK ;  ( ERASE LINE OR LESS)                         : RDRC REDRAW UPDATE ;                                          : DELL P2 SWAP LEOS CMOVE LEOS +  EL RDRC ;                     : >INSL P2 LEOS CMOVE> EL ;                                                                                                                                                                     : C POS^ >EL L_DN >S ;             : G C L_UP DELL ;            : P ST NIP 0;  >INSL  SPTR CSTR SDROP                                   >EL MIN POS^ SWAP CMOVE RDRC ;                          : OVTC POS^ C! UPDATE ;                                         : INSL >INSL RDRC ;                                             : POSC POS^ DUP 1+ ;                                            : INSC ?INS IF POSC LL CMOVE> THEN OVTC ;                       : DELC POSC SWAP LL CMOVE bl /LINE C! LDRAW UPDATE ;            : BS <- DELC ;                                                  : X-POS 0 18 ATXY CSP RP! ;                                     : Q/ED  FLUSH  X-POS ;                                          : ESQ/E EMPTY-BUFS X-POS ;                                                                                                        5 LOAD                                                                                                                                                                                        : @KEY POSXY BKEY B/MOD #IF SWAP ;THEN DROP ;                   : ONEC XK bl U<  IF WHAT? ;THEN XK INSC LDRAW -> ;              | SWITCH: EF WHAT?               kLEFT -: <-     kUP -: L_UP     kHOME -: L_BEG   kEND -: L_END  kPGUP -:  B   kPGDN -: N        kDOWN -: L_DN  kRIGHT -: ->     kINS  -: _INS  kDEL -: DELC     ksTAB -: <TAB  kcHOME -: APOS  ;SWITCH                         | SWITCH:  EK  ONEC   ^J -: <-  ^K -: ->     ^X -:  G             127 -: DELL    bs -: BS        ^D -: DELC  cr -: <_|           ^N -: N     ^B -: B    ^L -: RESET   ^I -: TAB>                 ^C -: C     ^V -: P    ^Q -: ESQ/E   ^Z -: BACK                 ^A -: ADV   kESQ -: Q/ED  ^S -: INSL   0 -: EF   ;SWITCH       : E  RELOAD REDRAW  RP@ TO CSP  BEGIN @KEY EK AGAIN ;           : EDIT PAGE TO SCR  E ;     : ERR SCR EDIT ;                    : HELP SCR PUSH TO SCR E POP TO SCR E ;                         : VIEW ' C>N IF @- SWAP HELP THEN DROP ;                                                                                        : ST  SPTR CSTR ;                         \ STACK TOP / NEXT    : S-! SPTR OVER 1+ - DUP TO SPTR C! ;     \ STRING ALLOC        : >S PUSH SPTR I - I CMOVE> POP S-! ;     \ PUSH STRING         : SDROP  ST + TO SPTR ;                   \ DROP STRING         : S> SPTR SDROP ; \ : S! OVER C@ 1+ MOVE ; \ POP / MOVE STRING  : S>! S> SWAP S! ;                        \ INSERT CHAR IN TOP  $C000 TO SPTR                                                   0 0 >S  0 0 >S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  : S-INS ST PUSH TO SPTR >S POP SPTR +! ;  \ INSERT STR IN TOP   : #>S ;DROP S-! ST LOOPS C!+ ;            \ FORMATED PUSHSTR    : S!+ PUSH C@+ OVER I C@+ + SWAP CMOVE POP +! ; \ APPEND STR    : SWAP+S S> CSTR S-INS ;                  \ CONCAT TOP & NEXT   : C>S  1  #>S ;    $C000 TO SPTR          \ CHAR > STR          : C-INS C>S SWAP+S ;  : S>! S> SWAP S! ;  \ INSERT CHAR IN TOP                                                                  : S" =" CSTR S-! ST CMOVE ;               \ INPUT > SS          \ : SPOP! S> CSTR PUSH SWAP POP CMOVE ;     \ POP TO HERE       : N>S  0 S# #>S ; 0 0 >S  0 0 >S        \ NUM > STR == ITOA     : S+C! DUP PUSH C@+ + C! 1 POP +! ;       \ ADD CHAR                                                                                                                                                                                                                                                                                                                                            HERE VALUE FENCE       AT FORTH  2+  VALUE VOCLINK              <N>                                                               ' >LFA  ALIAS N>LINK                                            ' 2-    ALIAS V>LINK                                          <N>                                                             : ?DUP #IF DUP THEN ;                                                                                                           : forget C>N 1- A" ?FRG" DUP FENCE U< A" fnc"  PUSH               BEGIN VOCLINK @ ?DUP I U< 0=    IF @ VOCLINK ! AGAIN THEN      VOCLINK BEGIN DUP 2-                                             BEGIN @ DUP I U< 0=  IF  N>LINK  AGAIN THEN                    OVER 2- ! @ ?DUP 0= UNTIL FORTH TO FORTH POP TO HERE DROP ;    : FORGET '  forget ;                                                                                                                                                                                                                                            | VARIABLE %!%  | : #% @ IF %!% -HEADS 2 EXCHANGE THEN <N> ;    : <N 0 %!% ! -HEADS #% ;  : N> %!% #% ;                                                                                         : PRUNE VOCLINK                                                 BEGIN DUP PUSH V>LINK                                             BEGIN @ DUP HERE U< 0= IF    N>LINK  AGAIN THEN                 DUP I V>LINK ! ?DUP                                             IF DUP PUSH                                                       BEGIN  N>LINK @ ?DUP  IF                                          DUP HERE U< IF DUP POP N>LINK ! DUP PUSH THEN                 AGAIN  THEN 0 POP N>LINK !                                    THEN POP @ ?DUP 0=                                            UNTIL $F000 TO NPTR ;                                                                                                                                                                                                                                           VOCABULARY TEMP                                                 : VMOVE PUSH 0 @SWAP POP ! ;                                    : DO-PRUNE PUSH I AT TEMP VMOVE PRUNE AT TEMP POP VMOVE ;       : DO-RELINK 2+ PUSH VOCLINK I @SWAP POP ! ;                                                                                     AT MACRO  DO-PRUNE                                              AT COMMON DO-PRUNE                                              AT HIDDEN DO-PRUNE                                                                                                              AT MACRO  DO-RELINK                                             AT COMMON DO-RELINK                                             AT HIDDEN DO-RELINK                                                                                                             FORGET TEMP                                                                                                                                                                                     4 LOAD                                                          : DEFINITIONS CONTEXT  TO CURRENT ;                             : 2^ 1 SWAP LOOPS 2* ;                                          | : $$ 1H ;BASE TOKEN (DNUM ;                                   | : ## lf ;GO AT $$ ;                                           TO MACRO                                                        : ELSE ?CSP PUSH ', AHEAD  POP CSP! ', THEN ;                   TO FORTH                                                        <N>   ' I ALIAS R@                                              ' INVERT ALIAS COM     ' SAVE2 ALIAS RECOVER                    ' 2, ALIAS ,           ' 1, ALIAS C,                            <N>                                                               86 100 THRU   DECIMAL                                                                                                                                                                                                                                         | LBL: MAC:: AT COMMON ;NS <N ;GO TO N>  CREATE                          TO FNAME        S, DOES> EVAL ;                        : MAC: `;  MAC:: ; SAVE2          AT COMMON MOVEW               : MAC TOKEN 1+ C@ MAC:: ; SAVE2   AT COMMON MOVEW               <N> : +VOC AT FORTH 2+ ' 8 +  DUP PUSH @SWAP POP ! ; <N>        AT FORTH 2+ OFF                                                 +VOC MACRO                                                      +VOC COMMON                                                     +VOC HIDDEN                                                     \ +VOC ASSEMBLER                                                                                                                PRUNE                                                           \ 18 LOAD                                                       \ : VOC. 6 - ?ID. ;                                             \ : NV CR DUP 2DUP .H 2- VOC. @ .H @ ;                                                                                          \ : ENDCASE #DO-DROP .BGR  @, BEGIN CSP .BGR  WHILE ', THEN     \    .BGR    REPEAT   TO CSP ?CSP ; IMMEDIATE                   \ : REPEAT ', AGAIN ', THEN ; IMMEDIATE                         \ 0 VALUE VOCADR   0 VALUE LASTW                                \ HERE 100 CLARY  HERE  DUP     0 VALUE STKC                    \ QUAN CSTACK | CONSTANT #EMPTY   | CONSTANT #FULL              \ | : ;STK? CSTACK TUCK = A" CS EMPTY/FULL" EX TO CSTACK ;      \ : C> #EMPTY ;STK? @+ ; | : !- 2- !+ 2- ; : >C #FULL ;STK? !- ;\ : ?STKC STKC CSTACK - A" ?BG?" C>   TO STKC  ;                \ : STKC! STKC >C CSTACK TO STKC ;                              \ : STKINIT #EMPTY TO CSTACK 0 >C STKC! ;                       \ : MARK> HERE >C STKC! ;                                       \ : ?FIX DUP @ A" ?FX?" HERE SWAP! ;   : <RELEASE ?STKC  C> , ; \ : >MARK HERE 0 , CSP! ;   : RELEASE< ?CSP ?FIX ;              \ : >MARK> >MARK MARK> ;  : <RELEASE< <RELEASE RELEASE< ;                                                                       0 BARY B-CODE                                                   4 1,    0 1,    0 1,    6 1,    3 1,    8 1,    1 1,    3 1,    3 1,    3 1,    9 1,    3 1,                                                                                                    0 BARY EAN-R                                                    %1110010 1,  %1100110 1,  %1101100 1,  %1000010 1,  %1011100 1, %1001110 1,  %1010000 1,  %1000100 1,  %1001000 1,  %1110100 1,                                                                 : BSWAP 0 SWAP ;NIP LOOPS 2* OVER ODD + XEP U2/ ;               : R>G 7 BSWAP ;         : R>L 127 XOR ;                         \ : EAN-SUM 1 TO WEIGHT     \    1 QUAN WEIGHT                  \          0 12 LOOPS 2 AT WEIGHT XOR!  J B-CODE C@ WEIGHT * + ;: EAN-SUM 3 0 ;NIP ROT LOOPS OVER J B-CODE C@ * +  XEP 2 XOR ;                                                                                                                                                                                                  \ : EAN-CHK 10 MOD #IF 10 SWAP - THEN ;                         CODE BSWAP CX POP,  AX AX XOR,  CX BX XCHG,                        BEGIN, 1 #, BX SHR,   1 #, AX RCL,                              CXZ,  UNTIL,  AX  BX  XCHG,  NEXT, END-CODE                  ;S                                                              EXIT                                                            9F6C  6E 9F 59 33 C0 87 CB 00  C5 00 C3 E2 00 00 00 01          9F7C  A3 04 04 30 0B 00 57 99  00 00 02 A3 04 04 30 14                                                                          48DE  E0 48 59 33 C0 87 CB D1  EB D1 D0 E2 FA 93 E9 96          48EE  B9 04 44 55 4D 50 00 00  44 45 00 FF 86 47 18 A2                                                                                                                                                                                                                                                                                                                                          L: CONT -1 /SI AX LEA, CL SKIPW,      L: (DOES AX POP,          L: (JSR  AX SI XCHG,                  L: (RPUSH X, AX PUSH, X,  L: NOP LODSW, 1 #, AL TEST, 0=, J,? 1   SI DEC, #PAGE AH MOV,    35 #, AL ADD, U<, NOT, IF, FB: 1  AX DI XCHG, 0 /DI JMP, THEN,   AX DI XCHG,  0 /DI AX MOV, (JSR JMP,                          L: >-2/< AX POP, BX PUSH, AX BX XCHG,           L: -2/ BX NEG,  L: +2/ AX POP, AX BX ADD,  DUP,  1 #, BX RCR, NEXT,             L: (@R  BX PUSH,  2 /DI BX LEA,  SI 0 /BP XCHG, BX CALL,        L: EX SI 0 /BP XCHG, NEXT,   L: TIMES  BX DEC, CONT 0<, NOT, J, L: DROP;  DROP,              L: EXIT   0 /BP SI MOV,            L: RDROP  2 /BP BP LEA,  NEXT,                                  L: 0;     BX BX OR,  0=, DROP; J, NEXT,                                                                                                                                                                                                                                                                                         L: (SKIP   CLC,                                                 L: (EXEPT  LAHF, LODSB,  $FE #, AL CMP,  U<, NOT, J,? 1                    SAHF, U<, NOT, IF,                                   L: (JUMP   CBW, AX SI ADD, THEN, NEXT,                          L: if      1 #, BX CMP, (EXEPT JMP,                             L: -if     $8000 BX CMP, CMC, (EXEPT JMP,                       L: (NEXT-  W/ 0 /BP DEC, 0<, IF,  L: /NEXT   LODSW, RDROP JMP,  L: (NEXT+  W/ 0 /BP INC, 0<, NOT, /NEXT J,  THEN,               L: jump    STC, (EXEPT JMP,                                                                                                                                                                     CODE BSWAP CX POP,  AX AX XOR,  CX BX XCHG, CXZ, NOT IF,           BEGIN, 1 #, BX SHR, 1 #, AX RCL,  CXZ, UNTIL, THEN,             AX BX XCHG, NEXT, END-CODE                                                                                                                                                                   \ : EX CX POP, DI POP, CX PUSH, DI JMP,                         \ : SWAP CX POP, BX PUSH, BX CX XCHG, ;                         \ L: CODE>F SI POP,                                             \ 3 5 8                                                         \ FEDCBA9876543210                                              \ 55555...55555...                                              \ 55555  next xchg if  -if oif  jmp  call EX                    \ ...    nop  exit drop dup lit swap push pop                   \ 011    +    AND  XOR  OR  \  TWO PARAMS  / ELSE IMMEDIATE OP  \ ...    @+  !+   C@+  C!+  /  IMMEDIATE OFFSET                 \        +*  -/   @R+  !R+                                      : NAND AND -1 XOR ;                                             : NOR  OR  -1 XOR ;                                                                                                                                                                                                                                             ( $Id: )  MARKER -HORST                                         ( Copyright{2005}: Albert van der Horst,                                           HCC FIG Holland by GNU Public License)       ( Minimal POSTIT/FIXUP 8086 ASSEMBLER AvdH HCC HOLLAND)         ( This replace the FIG-Forth version. )                         ( 5 screens follow here, this is an excerpt of the Pentium )    ( assembler in the blocks of ciforth after 4.0.6 and    )       ( compatible with the great assembler   )                       VOCABULARY DESA   DESA  TO DESA         : CELLS 2* ;            | 0 VALUE TADR                                                  : TOGGLE OVER C@ XOR SWAP C! ; : SPLIT UNPACK SWAP ;            \ : SPLIT 0 100 UM/MOD SWAP ; \ Split X : ls BYTE and REMAINDER : FAMILY, ' TO TADR FOR DUP TADR EXEC OVER + NEXT DROP DROP ;   HEX  1 5 +THRU  DECIMAL                                                                                                                                                                         ( --assembler_generic SPLIT 1PI FIR 1FAMILY, )  \ A4sep27 AvdH  \ Post INSTRUCTION of LENGTH.  Big endian specific!             : POST  SWAP , 1 CELLS - ALLOT ;                                \ Fixup with ms byte of FIX below ADDR, leave next FIX ADDR     : FIX| 1- PUSH   SPLIT R@ SWAP TOGGLE   POP ;                   : 1PI CREATE , DOES>  @ 1 POST  ;   \ 1 byte post-it opcode     : 2PI CREATE , DOES>  @ 2 POST  ;   \ 2 byte post-it opcode     \ : 3PI CREATE , DOES>  @ 3 POST  ;   \ 3 byte post-it opcode   \ Fixup from behind starting with ls byte.                      : FIR CREATE , DOES> @ HERE BEGIN FIX| OVER 0= UNTIL 2DROP ;    \ Create a family adding INC to OPCODE with COUNT members       \ : 1FAMILY, 0 DO DUP 1PI OVER + LOOP DROP DROP ;               \ : 2FAMILY, 0 DO DUP 2PI OVER + LOOP DROP DROP ;               \ : 3FAMILY, 0 DO DUP 3PI OVER + LOOP DROP DROP ;               \ : FAMILY|R 0 DO DUP FIR OVER + LOOP DROP DROP ;                                                                               ( --assembler_commaers ) \ A4sep27 AvdH                         : lsbyte, SPLIT C, ;                                            : (W,) lsbyte, lsbyte, DROP ;                                   \ : (L,) lsbyte, lsbyte, lsbyte, lsbyte, DROP ;                                                                                 ( O=obligatory R=Relative I=Immediate )                         ' (W,) ALIAS OW,          ' (W,) ALIAS IW,                      \ ' (L,) ALIAS (RL,)    ' (L,) ALIAS IL,     ' (L,) ALIAS L,    ' (W,) ALIAS (RW,)      ' C,   ALIAS IB,                        ' C,   ALIAS (RB,)                                              ' (W,) ALIAS SG,        ' (W,) ALIAS W,                         ' C,   ALIAS P,         ' C,   ALIAS B,                         ' C,   ALIAS IS,                                                                                                                                                                                                                                                ( --assembler_i86_opcodes_1 )                  \ A4sep27 AvdH   08 06 4 FAMILY, 1PI PUSH|ES, PUSH|CS, PUSH|SS, PUSH|DS,         08 07 4 FAMILY, 1PI POP|ES, -- POP|SS, POP|DS,                  08 26 4 FAMILY, 1PI ES:, CS:, SS:, DS:,                         08 27 4 FAMILY, 1PI DAA, DAS, AAA, AAS,                         01 00 2 FAMILY, FIR  B'| X'|                                    08 04 8 FAMILY, 1PI ADDI|A, ORI|A, ADCI|A, SBBI|A,                     ANDI|A, SUBI|A,  XORI|A, CMPI|A,                         02 A0 2 FAMILY, 1PI MOV|TA, MOV|FA,                             70 1PI J,  ( As in J, L| Y| <CALC> S, )                             01 00 2 FAMILY, FIR  Y| N|                                      02 00 8 FAMILY, FIR  O| C| Z| CZ| S| P| L| LE|              08 40 4 FAMILY, 1PI INC|X, DEC|X, PUSH|X, POP|X,                90 1PI XCHG|AX,                                                                                                                                                                                 ( --assembler_i86_opcodes_2 )                  \ A4sep27 AvdH   08 00 8 FAMILY, 2PI ADD, OR, ADC, SBB, AND, SUB, XOR, CMP,      02 84 2 FAMILY, 2PI TEST, XCHG,                                 01 98 8 FAMILY, 1PI CBW, CWD, IR2, WAIT,                                                     PUSHF, POPF, SAHF, LAHF,           02 A4 6 FAMILY, 1PI MOVS, CMPS, -- STOS, LODS, SCAS,            08 B0 2 FAMILY, 1PI MOVI|BR, MOVI|XR,                           08 C3 2 FAMILY, 1PI RET, RETF, 08 C2 2 FAMILY, 1PI RET+, RETF+, 01 C4 2 FAMILY, 1PI LES, LDS,  00C6 2PI MOVI,   0CD 1PI INT,    01 CC 4 FAMILY, 1PI INT3, -- INTO, IRET,                        01 D4 4 FAMILY, 1PI AAM, AAD, -- XLAT,                          01 E0 4 FAMILY, 1PI LOOPNZ, LOOPZ, LOOP, JCXZ,                  02 E4 2 FAMILY, 1PI IN|P, OUT|P, 2 EC 2 FAMILY, 1PI IN|D, OUT|D, 01 E8 2 FAMILY, 1PI CALL, JMP,                                 0088 2PI MOV,           008C 2PI MOV|SG,        008D 2PI LEA,   EA 1PI JMPF,  EB 1PI JMPS,    9A 1PI CALLF, A8 1PI TESTI|A,     ( --assembler_i86_opcodes_3 ) \ A2oct21 AvdH                    01 F0 6 FAMILY, 1PI LOCK, -- REPNZ, REPZ, HLT, CMC,             01 F8 6 FAMILY, 1PI CLC, STC, CLI, STI, CLD, STD, ( 38FE)       800 80 8 FAMILY, 2PI  ADDI, ORI, ADCI, SBBI,                                            ANDI, SUBI, XORI, CMPI,      800 83 8      FAMILY, 2PI ADDSI, -- ADCSI, SBBSI, -- SUBSI, -- CMPSI,      800 10F6 6 FAMILY, 2PI NOT, NEG, MUL|AD,                                                      IMUL|AD, DIV|AD, IDIV|AD,         0800 00FE 2 FAMILY, 2PI  INC, DEC,                              0800 10FF 4 FAMILY, 2PI CALLO, CALLFARO, JMPO, JMPFARO,         0200 0000 2 FAMILY, FIR  1| V|          0800 00D0 8                     FAMILY, 2PI ROL, ROR, RCL, RCR, SHL, SHR, -- SAR,       800 C0 8 FAMILY, 2PI ROLI, RORI, RCLI, RCRI, SHLI, SHRI,        -- SARI,    00F6 2PI TESTI,   008F 2PI POP,   30FF 2PI PUSH,                                                                                                                                    ( $Id: )  MARKER -HORST  ( MODIFIED INSTRUCTIONS)               ( Copyright{2005}: Albert van der Horst,                                           HCC FIG Holland by GNU Public License)       ( Minimal POSTIT/FIXUP 8086 ASSEMBLER AvdH HCC HOLLAND)         ( This replace the FIG-Forth version. )                         ( 5 screens follow here, this is an excerpt of the Pentium )    ( assembler in the blocks of ciforth after 4.0.6 and    )       ( compatible with the great assembler   )                       VOCABULARY DESA   DESA  TO DESA         : CELLS 2* ;            | 0 VALUE TADR   : UNPACK B/MOD SWAP ;                          : TOGGLE OVER C@ XOR SWAP C! ; : SPLIT UNPACK SWAP ;            \ : SPLIT 0 100 UM/MOD SWAP ; \ Split X : ls BYTE and REMAINDER \ : FAMILY, ' TO TADR FOR DUP TADR EXEC OVER + NEXT DROP DROP ; : +THRU BLK TUCK + PUSH + POP THRU ;                            HEX  1 5 +THRU  DECIMAL                                                                                                         ( --assembler_generic SPLIT 1PI FIR 1FAMILY, )  \ A4sep27 AvdH  \ Post INSTRUCTION of LENGTH.  Big endian specific!             : POST  SWAP , 1 CELLS - ALLOT ;                                \ Fixup with ms byte of FIX below ADDR, leave next FIX ADDR     : FIX| 1- PUSH   SPLIT R@ SWAP TOGGLE   POP ;                   : 1PI CREATE C, DOES> C@ 1 POST  ;   \ 1 byte post-it opcode    : 2PI CREATE , DOES>  @ 2 POST  ;   \ 2 byte post-it opcode     \ : 3PI CREATE , DOES>  @ 3 POST  ;   \ 3 byte post-it opcode   \ Fixup from behind starting with ls byte.                      : FIR CREATE , DOES> @ HERE BEGIN FIX| OVER 0= UNTIL 2DROP ;                                                                                                                                                                                                                                                                                                                                                                                                    ( --assembler_commaers ) \ A4sep27 AvdH                         : lsbyte, SPLIT C, ;                                            : (W,) lsbyte, lsbyte, DROP ;                                   \ : (L,) lsbyte, lsbyte, lsbyte, lsbyte, DROP ;                                                                                 ( O=obligatory R=Relative #=Immediate )                         ' (W,) ALIAS OW,          ' (W,) ALIAS #W,                      \ ' (L,) ALIAS (RL,)    ' (L,) ALIAS #L,     ' (L,) ALIAS L,    ' (W,) ALIAS (RW,)      ' C,   ALIAS #B,                        ' C,   ALIAS (RB,)                                              ' (W,) ALIAS SG,        ' (W,) ALIAS W,                         ' C,   ALIAS P,         ' C,   ALIAS B,                         ' C,   ALIAS IS,                                                                                                                                                                                                                                                ( --assembler_i86_opcodes_1 )                  \ A4sep27 AvdH   08 06 4 FAMILY  1PI ES>, CS>, SS>, DS>,                         08 07 4 FAMILY  1PI >ES, --   >SS, >DS,                         08 26 4 FAMILY  1PI ES:  CS:  SS:  DS:                          08 27 4 FAMILY  1PI DAA, DAS, AAA, AAS,                         01 00 2 FAMILY  FIR  B'| X'|                                    \ 8 4 8 FAMILY  1PI +#A, OR#A, +C#A, -B#A, &#A, -#A, XOR#A, =#A,02 A0 2 FAMILY  1PI MOV>A, MOV<A,                               70 1PI J,  ( As in J, L| Y| <CALC> S, )                             01 00 2 FAMILY  FIR  Y| N|                                      02 00 8 FAMILY  FIR  O| C| Z| CZ| S| P| L| LE|              08 40 4 FAMILY  1PI X+, X-, X>, >X,                             90 1PI >AX<,                                                                                                                                                                                                                                                    ( --assembler_i86_opcodes_2 )                  \ A4sep27 AvdH   08 00 8 FAMILY  2PI +, OR, +C, -B, &, -, XOR, =,                02 84 2 FAMILY  2PI TEST, XCHG,                                 01 98 8 FAMILY  1PI CBW, CWD, IR2, WAIT, F>, >F, AH:=F, F:=AH,  02 A4 6 FAMILY  1PI MOVS, CMPS, -- STOS, LODS, SCAS,            08 B0 2 FAMILY  1PI BR:=#, XR:=#,                               08 C3 2 FAMILY  1PI RET, RETF,                                  08 C2 2 FAMILY  1PI RET+, RETF+,                                01 C4 2 FAMILY  1PI LES, LDS,                                              00C6 2PI MOV#,   0CD 1PI INT,                        01 CC 4 FAMILY  1PI INT3, -- INTO, IRET,                        01 D4 4 FAMILY  1PI AAM, AAD, -- XLAT,                          01 E0 4 FAMILY  1PI LOOPNZ, LOOPZ, LOOP, JCXZ,                  02 E4 2 FAMILY  1PI IN|P, OUT|P,                                 2 EC 2 FAMILY  1PI IN|D, OUT|D,                                                                                                ( --assembler_i86_opcodes_3 ) \ A2oct21 AvdH                     01 E8 2 FAMILY  1PI CALL, JMP,                                 0088 2PI MOV,           008C 2PI >SG>,        008D 2PI LEA,     EA 1PI FJMP,  EB 1PI SJMP,    9A 1PI FCALL, A8 1PI TEST#A,      01 F0 6 FAMILY  1PI LOCK, -- REPNZ, REPZ, HLT, CMC,             01 F8 6 FAMILY  1PI CLC, STC, CLI, STI, CLD, STD, ( 38FE)       800    80 8 FAMILY  2PI  +#, OR#, +C#, -B#, &#, -#, XOR#, =#,   800    83 8 FAMILY  2PI +S#, --  +CS#, -BS#, -- -S#, --  =S#,   800  10F6 6 FAMILY  2PI NOT, NEG, U*AD, I*AD, U/AD, I/AD,       0800 00FE 2 FAMILY  2PI  INC, DEC,                              0800 10FF 4 FAMILY  2PI CALLO, FCALLO, JMPO, FJMPO,             0200 0000 2 FAMILY  FIR  1| V|                                  0800   D0 8 FAMILY  2PI ROL, ROR, RCL, RCR, <<, >>, -- SAR,     800 C0 8 FAMILY  2PI ROL#, ROR#, RCL#, RCR#, <<#, >>#, -- SAR#, 00F6 2PI TEST#,   008F 2PI POP,   30FF 2PI PUSH,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( EDITOR MAKE  )                                                                                                                        HERE                                                      261  267  THRU   TO  SIZEMARK \ 7 13                                                                                          SIZE. .( FIRST EXTENT)                                                                                                          268 275 THRU    \ 20 27 THRU                                                                                                    SIZE. .( EDITOR)  CR                                                                                                                                                                                                                                                                                                                                                                                                                                            F83 : | 1 -HEADS ! ;    : LIKE ' @ ;  | : C@'+ C@ ' + ;         0 VECT> C@'+ EXEC ;                                                  DUP CODE, TO 2 1, DUP CODE, AT 4 1,  CODE, FROM 6 1,       0 VECT> C@'+ ! ;                                                     DUP CODE, BE 0 1,     CODE, IS 2 1, : META ' IS ;                                                                          TO MACRO  0 VECT> C@'+ 2, ; : ['] COMPILE lit ', ', ;                DUP CODE, TO 2 1,  DUP CODE, AT 4 1,  CODE, FROM 6 1,      TO FORTH        : ;IN >IN EX TO >IN ;   : L/ 1L NEGATE AND ;                                                                    TO COMMON  : \ BLK #BLK IF ;IN 1L + L/  ;THEN 0 TO FNAME DROP ;            ( : \ ;IN BLK #BLK IF NL ;THEN 0 AND ; )             TO FORTH   0 TO CICLES  \ cr + lf                                                                                                                                                                                                                               ' XY  2@  (2: VALUE 2,             <N> : 3@ @+ 2@ ROT ;  <N>    ' 'SAME 2@  (2: VECTOR 2,                                       ' FGET 2+ @  3@  (3: QUAN 2,                                    ' HERE  2@  (2: GLOBAL 1,                                       ' BASE  2@  (2: USER 1,                                         : LINK+ HERE @SWAP 2, ; : WORDLIST Z, AT FORTH 2+ LINK+ ;       | ' FORTH 3@ (3: VOC: WORDLIST                                  : VOCABULARY AT FORTH ;NS VOC: ;                                \ : VARIABLE CREATE Z, ;                                        : VARIABLE 0 VARIABLE: ;                                        : CREATE VARIABLE SAVE2 ;                                       : BCONST AT COMMON ;NS  CONSTANT SAVE1                                DOES> C@ `` SWAP NPAD C!- C!- 2 TO EVAL ;                 LIKE STATES DUP  (1: WARY ZARY,      2+ (1: BARY ZARY,                                                                                                                                                                                                                                                                          | 0 VALUE WADR  |  : ;WADR WADR EX TO WADR ;                    : L ;WADR bs LOOPS CR DUP .H STR DUP .H ?ID. ;                  : SEE NOP ' TO WADR L ;                                                                   LIKE TYPE DUP  BE SEE IS SEE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          HERE VALUE FENCE       AT FORTH  2+  VALUE VOCLINK              <N>                                                               ' >LFA  ALIAS N>LINK                                            ' 2-    ALIAS V>LINK                                          <N>                                                             : ?DUP #IF DUP THEN ;                                           : forget C>N 1- A" ?FRG" DUP FENCE U< A" fnc"  PUSH               BEGIN VOCLINK @ ?DUP I U< 0=    IF @ VOCLINK ! AGAIN THEN      VOCLINK BEGIN DUP 2-                                             BEGIN @ DUP I U< 0=  IF  N>LINK  AGAIN THEN                    OVER 2- ! @ ?DUP 0= UNTIL FORTH TO FORTH POP TO HERE DROP ;    : FORGET '  forget ;                                            : MARKER ?EXIST IF >IN FORGET TO >IN  THEN                              CREATE DOES> 2- forget ;                                                                                                                                                                | VARIABLE %!%  | : #% @ IF %!% -HEADS 2 EXCHANGE THEN <N> ;    : <N 0 %!% ! -HEADS #% ;  : N> %!% #% ;                                                                                         : PRUNE VOCLINK                                                 BEGIN DUP PUSH V>LINK                                             BEGIN @ DUP HERE U< 0= IF    N>LINK  AGAIN THEN                 DUP I V>LINK ! ?DUP                                             IF DUP PUSH                                                       BEGIN  N>LINK @ ?DUP  IF                                          DUP HERE U< IF DUP POP N>LINK ! DUP PUSH THEN                 AGAIN  THEN 0 POP N>LINK !                                    THEN POP @ ?DUP 0=                                            UNTIL $F000 TO NPTR ;                                                                                                                                                                                                                                           : <^> POP  AT COMMON ;NS <N ;GO TO N> PUSH CREATE ;             \ N>                                                            \ : DEC -1 SWAP +! ;  : S-C! DUP DEC ;   \ DEL LAST CHAR        \ : INC  1 SWAP +! ;  : HOLD SWAP +1 ;                          \ : S+C! DUP XEP C@+ + C! J INC ;       \ APPEND CHAR                                                                           : D>STR 1H ;BASE NPAD DUP B! XEP 0 S# -19  SWAP 1+                         DUP C!B+   LOOPS ALPHA C!B+ ;                        : CONST  <^>  2,  DOES> @ 0 D>STR  EVAL ;                       \ N>                                                            | LBL: MAC::  <^>  TO FNAME S, DOES> EVAL ;                     TO COMMON                                                       : MAC: `;  MAC:: ; SAVE2        \  AT COMMON MOVEW              : MAC TOKEN 1+ C@ MAC:: ; SAVE2 \  AT COMMON MOVEW              TO FORTH                                                                                                                        : COPY BLOCK SCR DUP 1+ TO SCR BUFFER 1K CMOVE UPDATE ;         : COPIES ;DROP LOOPS DUP 1+ XEP COPY ;                          : WHIPE  BUFFER 1K BLANK UPDATE ;                               : BMOVE  DUP COPY  WHIPE ;                                      : BMOVES ;DROP LOOPS DUP 1+ XEP BMOVE ;                                                                                         0 VALUE SIZEMARK                                                : SIZE. CR CICLES .  ." CICLES  " 0 TO CICLES                              HERE DUP SIZEMARK - . ." BYTES IS " TO SIZEMARK ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ HERE TO FENCE  CREATE -MARKER                                    0 VALUE XK  : WHAT? 7 EMIT ;                                 : -:  ' 2, 1,  XK 2+ DUP TO XK       ( BYTES FOR MOVE UP 1 )             HERE OVER - DUP PUSH       ( START ADDRESS   )                  DUP 1+ ROT                 ( PREPARE FOR MOVE)                  CMOVE>  HERE C@ POP C!   ;   ( FIX CODE  )             : SWITCH: CREATE HERE 73 1 TO XK 0 -:                               DOES> SWAP TO XK CSTR 2DUP XK =B? 1+ 2* + + PERFORM ;       : ;SWITCH  73 - A" BAD KEYS" XK 2/ 1- SWAP C! ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 : ST  SPTR CSTR ;                         \ STACK TOP / NEXT    : S-! SPTR OVER 1+ - DUP TO SPTR C! ;     \ STRING ALLOC        : >S PUSH SPTR I - I CMOVE> POP S-! ;     \ PUSH STRING         : SDROP  ST + TO SPTR ;                   \ DROP STRING         : S> SPTR SDROP ; \ : S! OVER C@ 1+ MOVE ; \ POP / MOVE STRING  : S>! S> SWAP S! ;                        \ INSERT CHAR IN TOP  $C000 TO SPTR                                                   0 0 >S  0 0 >S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (  EDITOR POSXY WIPE RELOAD SAVEBLK LB N B ARROW)               F83      -HEADS ON                                              0 VALUE  PDATA    VARIABLE INS  0 VECTOR 'ADVANCE               : ?XY 1L U/MOD 5 2 D+ ; \ 2DUP 15 0 ATXY SWAP . .               : POSXY XY ?XY ATXY   ;         : ?INS INS @ ODD ;              : .INS  75 2 ATXY ?INS IF ." INS" ;THEN ." OVT" ;               : _INS  1 INS XOR! .INS ;    : RELOAD SCR BLOCK TO PDATA ;      : REDRAW .INS 0 0 ATXY SCR 8 #. CR  PDATA .BLOCK ;              : /L  1L 1- OR ;           ( LINE END)                          \ : L/ 1L NEGATE AND ;       ( LINE BEGIN)                      : ;LRUD  XY EX >XY ;                                            : ;LPOS  XY EX PDATA + ;                                                                                                                                                                                                                                                                                                        ( COPY POS^ LINE/ /LINE LDRAW EL INSC DELC OVTC INSL DELL LL  ) : L_UP  ;LRUD  1L - ;     ( LINE UP)                            : L_DN  ;LRUD  1L + ;     ( LINE DOWN)                          : L_END ;LRUD  /L ;       ( LINE END)                           : L_BEG ;LRUD  L/ ;       ( LINE BEGIN)                         : ->    ;LRUD  1+ ;       ( MOVE 1 CHAR RIGHT)                  : <-    ;LRUD  1- ;       ( MOVE 1 CHAR LEFT)                   : TAB>  ;LRUD  7 OR 1+ ;  ( NEXT TABULATION )                   : <TAB  ;LRUD  1- -8 AND ;  ( PREVIOUS TABULATION)              : <_|   L_DN L_BEG    ;   ( CARRIGE RETURN L_DN L_BEG )         : APOS  ;LRUD  0 AND ;    ( HOME POSITION OF CURSOR)            : LINE/ ;LPOS L/ ;  : /LINE ;LPOS /L ;                          : LDRAW POSXY LINE/ cr EMIT XY 1L / 1+ .LINE DROP ;    \ OK POS : EJECTBLOCK DISCARD -1 PREV BUFS ! ;                           : RESET EJECTBLOCK RELOAD REDRAW ;   ( !!!!!!!)                                                                                 \ TEST-ON                                                       : LB SCR + 0 MAX TO SCR RELOAD REDRAW ;   ( +blk - )            : LEOS 1K  XY - 1L - 0 MAX ;  ( - chars_to_end_of_screen )      : POS^ PDATA XY + ;          ( - char^ )                        : P2 POS^ DUP DUP 1L + ;     ( - char^ char^ char^+1l )         : LL XY /L XY - ;            ( - chars_to_end_of_line )         : GETCHAR XY 0= 'ADVANCE POS^ C@ 33 U< ;                        : -BL BEGIN  GETCHAR 0= OR UNTIL ;        : N  1 LB ;           : -NONBL BEGIN GETCHAR OR UNTIL ;         : B -1 LB ;           : >NEXT TO 'ADVANCE -NONBL -BL ;  : ADV ['] -> >NEXT ;          : >EL 1K LEOS - 1L MIN ;      : BACK ['] <- >NEXT -> ;          : EL >EL BLANK ;  ( ERASE LINE OR LESS)                         : RDRC REDRAW UPDATE ;                                          : DELL P2 SWAP LEOS CMOVE LEOS +  EL RDRC ;                     : >INSL P2 LEOS CMOVE> EL ;                                     \ TEST-OFF                                                      : C POS^ >EL L_DN >S ;             : G C L_UP DELL ;            : P ST NIP 0;  >INSL  SPTR CSTR SDROP                                   >EL MIN POS^ SWAP CMOVE RDRC ;                          : OVTC POS^ C! UPDATE ;                                         : INSL >INSL RDRC ;                                             : POSC POS^ DUP 1+ ;                                            : INSC ?INS IF POSC LL CMOVE> THEN OVTC ;                       : DELC POSC SWAP LL CMOVE bl /LINE C! LDRAW UPDATE ;            : BS <- DELC ;                                                  : X-POS 0 18 ATXY CSP RP! ;                                     : Q/ED  FLUSH  X-POS ;                                          : ESQ/E EMPTY-BUFS X-POS ;                                                                                                                                                                                                                                                                                                       72 CONST kUP       80 CONST kDOWN     77 CONST kRIGHT           75 CONST kLEFT    116 CONST kcRIGHT  115 CONST kcLEFT           82 CONST kINS      83 CONST kDEL      73 CONST kPGUP            81 CONST kPGDN     71 CONST kHOME     79 CONST kEND            119 CONST kcHOME   117 CONST kcEND     59 CONST kF1              60 CONST kF2       61 CONST kF3       62 CONST kF4              63 CONST kF5       64 CONST kF6       65 CONST kF7              66 CONST kF8       67 CONST kF9       27 CONST kESQ             68 CONST kF10      84 CONST ksF1      93 CONST ksF10            94 CONST kCF1     103 CONST kcF10     15 CONST ksTAB           104 CONST kaF1     113 CONST kaF10      9 CONST kTAB                                                                                                                                                                                                                                                                                                                                            : @KEY POSXY BKEY B/MOD #IF SWAP ;THEN DROP ;                   : ONEC XK bl U<  IF WHAT? ;THEN XK INSC LDRAW -> ;              | SWITCH: EF WHAT?               kLEFT -: <-     kUP -: L_UP     kHOME -: L_BEG   kEND -: L_END  kPGUP -:  B   kPGDN -: N        kDOWN -: L_DN  kRIGHT -: ->     kINS  -: _INS  kDEL -: DELC     ksTAB -: <TAB  kcHOME -: APOS  ;SWITCH                         | SWITCH:  EK  ONEC   ^J -: <-  ^K -: ->     ^X -:  G             127 -: DELL    bs -: BS        ^D -: DELC  cr -: <_|           ^N -: N     ^B -: B    ^L -: RESET   ^I -: TAB>                 ^C -: C     ^V -: P    ^Q -: ESQ/E   ^Z -: BACK                 ^A -: ADV   kESQ -: Q/ED  ^S -: INSL   0 -: EF   ;SWITCH       : E  RELOAD REDRAW  RP@ TO CSP  BEGIN @KEY EK AGAIN ;           : EDIT PAGE TO SCR  E ;     : ERR SCR EDIT ;                    : HELP SCR PUSH TO SCR E POP TO SCR E ;                         : VIEW ' C>N IF @- SWAP HELP THEN DROP ;                                                                                        CREATE -IT  VOCABULARY ASSEMBLER   21898 5500 - TO THERE        : DEFINITIONS CONTEXT TO CURRENT ;                              : PREVIOUS ORDER TO CONTEXT ;                                   : DB, 1, ; : DW, 2, ; : SHORT?  -$80 $80 WITHIN ;               : VOC. 6 - ?ID. ;    MARKER -ASM    LIKE -ASM   BE -IT    -ASM  : ORDER. ;DROP AT ORDER DUP 2+ 2+ SWAP ITEMS? LOOPS STR VOC. ;  3 -HEADS !    : ;2DROP EX 2DROP ;   0 VECTOR VC                 : ?-CREATE ;2DROP >IN TOKEN 1+ @ $2D2D XOR 0; TO >IN 2DUP VC ;  : NFAMILY  ' TO VC 1H ;BASE  LOOPS TOKEN (DNUM ?-CREATE ;       : FAMILY ' TO VC  ;2DROP LOOPS DUP ?-CREATE OVER + ;            \ 69 84 THRU  SIZE. .( ASSEMBLER)       PRUNE                   277 292 THRU  SIZE. .( ASSEMBLER)       PRUNE                                                                                                                                                                                                                                                                                   \ : VOCABULARY AT FORTH ;NS VOCABULARY ;                         VOCABULARY MINI                                                : 2^ 1 SWAP LOOPS 2* ;     TO MACRO                             : ELSE ?CSP PUSH ', AHEAD  POP CSP! ', THEN ;  TO FORTH                                                                         MAC: COM INVERT ;       ' 1, ALIAS C,   ' 2, ALIAS ,                                                                            ' SAVE1  ALIAS RECOVERB         ' SAVE2 ALIAS RECOVER           ' I ALIAS R@                                                    HEX                                                             : VOXES ;DROP AT FORTH 2+ BEGIN #IF 2+ @- 2- VOC. AGAIN THEN ;  MAC: HP HERE 2+ ;                                               | : M13 CREATE C, DOES> C@ C, HP - , ;                          E8  M13  #CALL,    E9 M13 #JMP,                                 \ HERE 70 84 THRU  HERE SWAP -                                                                                                  MARKER -ASM  F83 ONLY ASSEMBLER  ALSO DEFINITIONS HEX           0 VALUE ?NEXT | 0 VALUE DISP | 0 VALUE FLAGS   : NOT 1 XOR ;    | : opc ( opcode -) ( - opcode) CREATE DB, DOES> C@ ;           : BEGIN, HERE ;   | : ?A DUP SHORT? 0= A" SHORT?" ;                        02 70 8 FAMILY opc  O?, U<, 0=, U<=, 0<, P?, <, <=,  EA opc ?,  03 E0 2 FAMILY opc C#Z, CXZ, | : -?A - ?A EX 1- C! ; : IF,  NOT DW, HERE ;           | : AGN,   DUP HP - SHORT? ;    : WHILE, ( A OPC -) IF, SWAP ;  | : UNTL,  IF, -?A HERE ;       : THEN,  HERE OVER -?A SWAP ;   : ELSE, ?, WHILE, THEN, ;       : J, NOT UNTL, ;                : SJMP, ?, UNTL, ;              : UNTIL, PUSH AGN, IF POP  UNTL, ;THEN                              POP  NOT WHILE, #JMP, THEN, ;                               : AGAIN, AGN, IF SJMP, ;THEN #JMP, ;                                                                                                                                                                                                                            ( ASM FORWARD)   | 80 CONSTANT 2L                               2L | WARY BRANCHES  | : ASM-RESET 2 TO FLAGS  0 TO DISP ;       | : FBI 0 2L                                                        FOR I BRANCHES 0 @SWAP IF I 4 #. WHAT? 1+ THEN NEXT                ?DUP IF DUP CR 4 #. A" UNRESOLVED !" THEN ;              | : ^BRANCH TOKEN (DNUM DUP 2L U< 0= A"  BR#? " BRANCHES ;      | : FB, ^BRANCH DUP 0 @SWAP A" REDEFINED! " HP SWAP! DW, ;      | : ^< ^BRANCH 0 @SWAP ;        : L,? HP FB, ;                  : JMP,? E9 DB, L,? ;     : CALL,? E8 DB, L,? ;                  : FB: ^< THEN, ;  ( RESOLVE FORWARD BRANCH NUMBER)              | : FL?      ( A - A) 2- @ OVER - A" LBL? " ;                   | : WREL-FIX?  ( A -) BEGIN,  OVER  3 - C@ FE AND E8 =                      IF  OVER - THEN SWAP 2- ! ;                         : FL: ^< DUP  FL?  WREL-FIX? ;  : J,? NOT FB, ;                                                                                                                                                 HEX  ( bit-flags and reg seg & r/m defining words )             ( 0 VALUE DISP 0 QUAN FLAGS 0 VALUE ?NEXT ( xxxxxxccOMIAGSDW )  ( M=r/m; cc=reg count; I=immediate; A=accumulator; G=seg;)      ( S=imm.byte; D=direction;  W=word or byte; O=disp only  )      ( D=0 when r/m field is destination ) : ;FL FLAGS EX TO FLAGS ; | : F-SET ( mask -) ;FL OR ;   | : $ACC 10 F-SET ;              | : F-GET ( mask -) FLAGS AND ;   | : 1REG? 100 F-GET ;         | : F-CLR ( mask -) COM ;FL AND ; | : REG+ 100 ;FL + ;          | : F-FLIP ( mask - ) ;FL XOR ; : F/ 2 F-FLIP ;                 | : <reg> ( a -n) DUP 1+ C@ DUP ODD NOT 2* 2* OR F-SET C@ ;     | : reg CREATE , DOES> <reg> REG+ F/ DUP 0= 0; $ACC ;           | : seg ( n -) ( -n) CREATE ,  DOES> <reg> 2 F-SET ;            | : r/m ( disp-n) CREATE , DOES> <reg>  2 F-CLR  SWAP TO DISP ;                                                                                                                                                                                                 ( default D is on, r/m clears it, reg flips it, seg sets it)    ( bits 3-5=reg, bit 8=W, bit 9=D flg, bit 12=ACC flg )          HEX ( R/M & REG are 16bit constants, but reg keeps count )      1 4000 8 FAMILY r/m  X/S X/D P/S P/D /SI /DI /BP /BX              C006 r/m ///                 8 900 4 FAMILY seg  ES CS SS DS    8 0 8 FAMILY reg  AL CL DL BL AH CH DH BH                     8 100 8 FAMILY reg  AX CX DX BX SP BP SI DI                                                                                     : B#,  24 F-SET ;    : W#, 20 F-SET ;                           : #AL B#, AL $ACC ;  : #AX W#, AX $ACC ;                        : (AL /// AL $ACC ;  : (AX /// AX $ACC ;                                                                                        \ : RECOVERB 0 C, RECOVER ;  \ : SKIPCB, 0 #AL ' EXEC RECOVERB ;\ : SKIPCW, 0 #AX ' EXEC RECOVER ;                                                                                                                                                              HEX ( REG>R/M  #,  orW  11mod  01mod  10mod  ,DISP BYTE )       | 0 BARY F$  4457 , 4753 , 4941 , 4F4D ,                        : .F ( -) 8 FOR 20 R@ 2^ F-GET IF DROP R@ F$ C@ THEN               EMIT NEXT FLAGS 100 / 3 #. ."  regs " EXIT ;                 | : R>M ( reg -r/m) U2/ U2/ U2/ ;                               | : 16/ R>M U2/ ;                                                 : #, ( n1 - n1) 20 OVER SHORT? 04 AND OR F-SET  ;             | : orW ( --opc---   -  --opc--w)  1 F-GET  OR ;                | : orDW ( --opc---  -  --opc-dw)  3 F-GET  OR ;                | : modDISP, ( 2nd - ) 40 F-GET ( ie M)                           IF 80 F-GET ( ie Only) IF C, DISP ,                               ELSE 8 F-GET ( ie G) DISP OR  OVER 7 AND 6 = OR ( ie[BP])       IF DISP SWAP OVER SHORT?                                          IF 40 OR C, C, ELSE 80 OR C,  , THEN                          ELSE ( zero & not seg) C, THEN  THEN ELSE C0 OR C,  THEN ;                                                                  HEX     ( one byte opcodes with no variables )                  | : IMM? ( -f) 20 F-GET  ;  | : ACC? ( -f) 10 F-GET ;           | : ,IMM  ( n -) 5 F-GET 4 = IF ( S,-W)  C, ELSE  , THEN ;        : W/ ( -)  1 F-SET  ; ( WORD PTR - the default is byte )      | : 2REGS? ( -f) 308 F-GET DUP 200 = SWAP 108 = OR ;            | : M1 ( n -) ( -)  CREATE C, DOES> C@ C, ASM-RESET ;                                                                                                                                           HEX     ( TWO byte opcodes with no variables )                  | : M10 CREATE , DOES>  @ , ;                                   8 NFAMILY M10                                                    21CD DOS,  16CD KBD,    10CD  VIDEO,  0AD4  AAM,                0AD5 AAD,  13CD DISK,   E587  X,      10D4  AAH,                                                                                                                                                                                                               4 NFAMILY M1  D7 XLAT,  CF IRET,  C3 RET,  CB RETF,             4 NFAMILY M1  53 DUP,  5B DROP,  CC INT3,  90 NOP,              1 A4 4 FAMILY M1  MOVSB, MOVSW, CMPSB, CMPSW,                   1 AA 6 FAMILY M1  STOSB, STOSW, LODSB, LODSW, SCASB, SCASW,     1 98 8 FAMILY M1  CBW, CWD, -- WAIT, PUSHF, POPF, SAHF, LAHF,   1 F8 6 FAMILY M1  CLC, STC, CLI, STI, CLD, STD,                 1 F0 6 FAMILY M1  LOCK: -- REP: REPZ: HALT: CMC,                8 26 4 FAMILY M1  ES: CS: SS: DS:                                                                                               HEX  | : M3 ( n -) ( reg -) CREATE C, DOES>  C@                        orW C, DROP ASM-RESET   ;                                2 A4 6 FAMILY M3  MOVS, CMPS, -- STOS, LODS, SCAS,              2 6C 2 FAMILY M3  INS, OUTS,                                                                                                                                                                                                                                    ( 2 operand instructions such as ADD,  )                        HEX     | : M2 ( n -) ( various - ) CREATE C,                     DOES> C@ PUSH  IMM?                                              IF ACC? IF     DROP  POP orW 4 OR C,                                    ELSE   1REG? IF R>M THEN  80 orW C,                                    POP 38 AND OR  modDISP,                                  THEN  ,IMM                                              ELSE  2REGS?  IF SWAP R>M THEN                                        POP orDW C, OR modDISP,    THEN  ASM-RESET  ;                                                                           8 0 8 FAMILY M2  ADD, OR, ADC, SBB, AND, SUB, XOR, CMP,                                                                                                                                                                                                                                                                                                                                        HEX ( MOV,) ( one byte instr w/ W  - the string instructions )  : MOV, IMM?                                                       IF  1REG?  IF   R>M B0 OR 1 F-GET  2* 2* 2* OR C,                          ELSE C6 orW C, modDISP,    THEN  ,IMM                ELSE 90 F-GET 90 =                                              IF   DROP DROP $A0 F/ orDW C, DISP ,                            ELSE  2REGS? IF   2 F-GET ( ie D) IF SWAP THEN  R>M  THEN        8 F-GET ( ie G) IF 1 F-CLR 8C ELSE 88 THEN  orDW C,             OR  modDISP,  THEN THEN  ASM-RESET ;                         ( M6 for the rotate & shift instructions )                      HEX  | : M6 ( n -) ( n# r/m | r/m    - ) CREATE C,               DOES> C@ IMM? 16/  2 XOR  1 F-GET ( ie W) OR $D0 OR C,             1REG? IF SWAP R>M THEN OR modDISP,  IMM? IF DROP THEN                 ASM-RESET  ;                                          8 0 8  FAMILY M6  ROL, ROR, RCL, RCR, SHL, SHR, -- SAR,                                                                         ( or    AL IN,  or  AX IN,   for port in the DX register  )     | : M9 ( n# r1 | r1) CREATE C,  DOES> C@  orW NIP                    IMM? IF ( n# opc)  C, ( n#) ELSE ( opc) 8 OR THEN C,            ASM-RESET ;                                                                 E4 M9 IN,   E6 M9 OUT,                                                                                         HEX                                                             : SKIPB, 0 SWAP B#, MOV, RECOVERB ;                             : SKIPW, 0 SWAP W#, MOV, RECOVER ;                                                                                              | : M5 CREATE C, DOES> C@ C, OR modDISP, ASM-RESET  ;           3 NFAMILY M5    C5 LDS,  8D LEA,  C4 LES,                       | : M11 CREATE C, DOES> C@ C, C, ;                              | : M12 CREATE C, DOES> C@ C, , ;                               $CD M11 INT,                                                                                                                    ( mul, div, xxxxxxxW  mdNNNr/m ) ( M5 for LDS, LEA, & LES, )    HEX  | : M4 ( n -) ( -) CREATE C,                                DOES> C@ F6 orW C, SWAP 1REG? IF R>M THEN OR  modDISP,               ASM-RESET  ;                                              -8 38 6 FAMILY M4  IDIV, DIV, IMUL, MUL, NEG, INVERT,                                                                           ( use   port #, AL IN,  or  port #, AX IN,  for 8 bit ports )                                                                    LIKE NOP  TO ?NEXT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             HEX ( INC, & DEC, instructions )   ( IN, OUT, instr )           | : M7 ( n -) ( r1 | r/m  -) CREATE C,                             DOES> C@ SWAP  1REG? IF  ( opc r1) R>M THEN                     1REG? 100 =  1 F-GET AND  ( ie it's a 2-byte register)          IF  ( opc rX)  OR 40 OR C,  ( opc mem | opc rH | opc rL )       ELSE FE orW C,  OR modDISP, THEN  ASM-RESET  ;               08 M7 DEC,   00 M7 INC,                                         ( PUSH, & POP, instructions ) HEX                               | : M8 ( n -) ( reg | seg | r/m  -)  CREATE ,                      DOES>  @  8 F-GET                                                 IF  ( seg opc ) 16/ 1 AND 1 XOR 6 OR OR C,  ELSE 1REG?          IF  ( reg opc ) 2/ 8 AND 8 XOR 50 OR SWAP R>M OR C,             ELSE ( r/m opc) DUP 100 U/ FF AND C,  OR modDISP,               THEN  THEN  ASM-RESET ;                                    FF30 M8 PUSH,  8F00 M8 POP,                                                                                                     : XCHG,  ( reg mem | mem reg | reg1 reg2   -)                     211 F-GET 211 = ( 2 regs & one is AX)                           IF  ?DUP IF NIP THEN ( r1 ) R>M  90 OR C,                       ELSE  2REGS? IF  R>M  THEN  OR  86 orW C, modDISP,              THEN  ASM-RESET ;                                                                                                             : TEST,  ( various - ) IMM?                                        IF ACC? IF     DROP  A8 orW ( 4 OR) C,                                  ELSE   1REG? IF R>M THEN  F6 orW C, ( OR)  modDISP,             THEN  ,IMM                                              ELSE  2REGS?  IF SWAP R>M THEN                                        84 orW C, OR modDISP,                                     THEN  ASM-RESET  ;                                                                                                                                                                                                                                           HEX ( XCHG )  ( TEST, instruction  - almost like ADD, etc. )    : CALL, ( various -) IMM? 140 F-GET 0= OR ( intra-seg direct )    IF  ( n#)  #CALL, ( eg 2389 #, CALL, calls addr $2389)          ELSE ( mem | reg  -)  1REG?  IF R>M  THEN                           FF C,  10 OR modDISP, ( eg 0 [BX] CALL, or DX CALL, )       THEN  ASM-RESET ;         ( this is intra-seg indirect )      HEX ( CALL, instr  ) ( INT,  & segment override instructions )  : JMP,        140 F-GET ( ie R or M  intra-seg indirect )          IF ( mem | reg  -)  1REG?  IF R>M  THEN                            FF C,  20 OR modDISP, ( eg 0 [BX] JMP, DX JMP, )             ELSE  ( a) ( relative) AGAIN,                                    ( disp is added to IP, so this is a relative jump )          THEN  ASM-RESET ;                                                                                                                                                                                                                                              | 0 VALUE JPOINT                : 2SCAS, SCASW, SCASW, ;        : PNT! HERE TO JPOINT ;         : >PNT JPOINT JMP, ;            : TOBE CFA ! ;                  : NEXT, ( -) ?NEXT JMP, ;        TO FORTH  : ASM ALSO ASSEMBLER CSP! ASM-RESET ;                          ' JPOINT ALIAS PNT@                                             : CODE HEADER HP , ASM ;                               TO ASSEMBLER                                                   : /ASM PREVIOUS ?CSP ; : END-CODE FBI /ASM ;                    : /CODE NEXT, END-CODE ;                                                                                                         PREVIOUS   F83                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 MARKER -MINI  ( DEFINING WORDS) \ MOVE WORD --------------------  MINI ALSO  TO MINI \ 45 LOAD                                  296  297   THRU \ PREPARATIONS & MACROSES       47  48                            SIZE. .( PREPARATIONS) CR                     298  307   THRU \ CREATE TARGET COMPILER        31   39                                                                              308   LOAD \ INVOLVE TARGET COMPILER FROM  ZONE 49                                                                         309  323   THRU   \ KERNEL 52/64  MEM_LLOCATIONS 65 66-DOS                        SIZE. .( KERNEL)       CR                                                                                     324  362   THRU PREVIOUS                                                          SIZE. .( FORTH BODY)       CR                                                                                                                                                                                                                 MARKER -MINI  ( DEFINING WORDS) \ MOVE WORD --------------------  MINI ALSO  TO MINI \ 45 LOAD                                   47   48   THRU   \ PREPARATIONS & MACROSES                                       SIZE. .( PREPARATIONS) CR                      31   38   THRU   \ CREATE TARGET COMPILER                            39   LOAD   \ CREATE TARGET COMPILER                            49   LOAD   \ INVOLVE TARGET COMPILER FROM  ZONE 49         52  64   THRU   \ KERNEL                                                        SIZE. .( KERNEL)           CR                       65   LOAD   \ MEMORY LOCATIONS  - VARIABLE OF ANY KIND          66   LOAD   \ DOS  PRIMITIVES                                   111  LOAD   \ ONLY FIXES  TO COMPILER                      112 150   THRU   PREVIOUS                                                        SIZE. .( FORTH BODY)       CR                                                                                                                                                                                                                                                                                 : ;CONTEXT CONTEXT XCHG PUSH EX POP TO CONTEXT ;                : M' ;CONTEXT  MACRO ' ;        : @H. HERE 1L 2/ - 1L DUMP ;    : N>C CSTR 31 AND + 2+ ;                                        \ TO COMMON : $ 1H ;BASE TOKEN EVAL ; TO FORTH                  M' DOES> 2+ @ ALIAS ;code                                       \ : PRESERVE POP OVER PUSH OVER @ PUSH PUSH ! EX POP POP ! ;    \ : PRESERVE A! POP A PUSH A@ PUSH PUSH !A EX POP POP ! ;       \ : PRESERVE XCHG I @ PUSH PUSH EX POP POP ! ;                  | : ;IMMED  ;NS CONTEXT  MOVEW ;                                : -IMMEDIATE  AT MACRO ;IMMED ;                                 : IMMEDIATE  CONTEXT ;NS  AT MACRO MOVEW ;                                                                                                                                                                                                                      : B. CR BLK 5 #. 1K >IN NEGATE - 1L /MOD SPACE  1+ . .               S. ."  H/T " HERE H.  THERE H.    KBD ; \ BKEY DROP ;                                                                      -1 VALUE THRESHOLD       : REMAINS SPTR HERE - 6 #. ;           : ADR, 1 STATES PERFORM ;                                       : ADR?OK DUP THRESHOLD U< IF ;THEN  DUP .H  A"  <ADR?> " ;      : NEW, ADR?OK  ;HERE ADR?OK !+ ;                                \ : ERR ['] 2,  1 STATES ! ERR ;                                \ : (': CREATE ', ', 2, IMMEDIATE  DOES> STR @ ADR, PERFORM ;                                                                   MAC: , 2, ;                                                     MAC: C, 1, ;                                                    MAC: UNPACK B/MOD ;                                                                                                                                                                                                                                             ' ' ALIAS 'T                                                    : CODE, HEADER , ;   : @CODE, @ CODE, ;  ' CODE, ALIAS 'CODE,    VARIABLE  #DO-VAR   : CREATE  #DO-VAR @CODE, ;                 : VAR: CREATE , ;   ' #DO-VAR @+ !  0 0 44 FAMILY VAR:          #DO-SETG  #DO-FCOL  #DO-RPUSH #DO-EX    #DO-ARY   #DO-LBL       #DO-DOES  #DO-FLBL  #DO-LIT   #DO-SEMI  #DO-COL   #DO-CONST     #DO-GETG  #DO-DEFER #DO-BR    #DO-?BR   #DO-WPUSH #DO-#BR       #DO-USER  #DO-SETU  #DO-USRV  #DO-MNEXT #DO-.STR  #DO-.ABRT     #DO-MBR   #DO-FOR   #DO-NEXT  #DO-BOOT  #DO-SETV  #DO-OF        #DO-SWAP  #DO-DROP  #DO-CALL  #DO-STR   #DO-;4TH  #DO-4TH:      #DO-MOVE  #DO-SIZE  #DO-COMP  #DO-MACR  #DO-4TH   #DO-GLBV      #DO-;CODE #DO-COMM                                              LIKE (INT  #DO-LBL !    ' lit #DO-LIT !                         #does #DO-DOES !        ' ;code #DO-;CODE !                     ' EXIT #DO-SEMI !       LIKE CODE, #DO-COL !                                                                                    : TSIZE HERE #DO-MOVE @ - ;   : D, , , ;  : @, @ , ;                                             : CODE,, SWAP CODE, , ;                                                                        \ : .. B. " 'T .H .H" EVAL ;                                    \ : N. " (DNUM" AT MINI VFIND  .H .H  CR ;                      \ : ," bl PARSE ;DROP DUP 1, LOOPS B, ;                                                                                         \ : S, CSTR ;DROP DUP 1, LOOPS B, ;                                                                                             : ," =" S, ; : ,T TOKEN S, ;                                                                                                                                                                                                                                                                                                                                                                                                                                    : HL! HERE ' EXEC ! ; | : GETBACK ;HERE @- ;  : >LNK N>C 2- ;   \ AT MACRO  VALUE DEST   CONTEXT VALUE SOURC    FROM CONTEXT    : IMMEDIATE  CONTEXT  ;NS  AT MACRO  MOVEW ;  \   TO MACRO      : (': ' CREATE SWAP D, DOES> STR @ NEW, PERFORM ;               : (":, HEADER #DO-COMP @, ' NEW, ' NEW, ;                       : COMPILING  #DO-MACR @ MOVEW ;  : (": (":, COMPILING ;         : ;CONST #DO-CONST @ HEADER EX D, ;     : CONSTANT ;CONST ;     : ;1 #DO-SETV @ SWAP EX 1- , ;  : ;2 #DO-VAR @ -ROT  EX 2- , ;  : ;DEFER #DO-DEFER @ HEADER EX D, ;     : DEFER   ;DEFER ;      : VALUE    ;CONST ;1 ;          : VECTOR  ;DEFER ;1 ;           : QUAN     ;CONST ;1 ;2 ;       : VQUAN   ;DEFER ;1 ;2 ;                                                                        ' FORTH ALIAS 'FORTH   ' BLK ALIAS 'BLK  ' >IN ALIAS '>IN       ' HERE ALIAS 'HERE                  ' ALLOT ALIAS 'ALLOT                                                                                                                                        #DO-COL  (': ((: <:>   \ -IMMEDIATE                                                                  : : HEADER <:> ;           #DO-SEMI (': (;  ;     IMMEDIATE  \  (": ; EXIT (;                                                                              | : LBL, #DO-LBL @, ;                                           | : -: : SAVE2 ;                                                | : :,1 #DO-COL @ 1- , ;        : LBL: -: LBL, ;                : >: -: :,1 LBL, ;              : :: -: :,1 :,1 ;                                                                               ( COMPILING WORDS)  ( USING CASE WHILE REPEAT BEGIN THEN )      #DO-LIT (': 2,  (LIT    ' (LIT  TO 'LIT                         M' (LIT ALIAS LITERAL   IMMEDIATE                               : ', ' ADR, ; IMMEDIATE                                         | : +DOES 2 OVER U< A" 3<?" NEGATE #DO-DOES @ + #CALL, ;        | : 0+DOES> 0 +DOES ;                                                                                                           \ : REPEAT ', AGAIN ', THEN ; IMMEDIATE                                                                                         #DO-BR    (': <RELEASE AGAIN    IMMEDIATE                       #DO-?BR  (': <RELEASE UNTIL     IMMEDIATE                       #DO-BR    (': >MARK  AHEAD      IMMEDIATE                       #DO-?BR  (': >MARK    IF        IMMEDIATE                       #DO-#BR   (': >MARK  #IF        IMMEDIATE                       #DO-OF   (': >MARK    OF        IMMEDIATE                       #DO-CALL  (': >MARK  ?CALL      IMMEDIATE                       #DO-MNEXT (': >MARK  ?-FOR      IMMEDIATE                       #DO-RPUSH (': MARK>  FOR-       IMMEDIATE                       #DO-NEXT (': <RELEASE NEXT-     IMMEDIATE                                                                                                                                                                                                                                                                                       #DO-MBR   (': >MARK  -IF        IMMEDIATE                       #DO-SEMI (': RELEASE< ;THEN     IMMEDIATE                       #DO-FOR   (': >MARK>  FOR       IMMEDIATE                       #DO-NEXT  (': <RELEASE< NEXT    IMMEDIATE                       #DO-;CODE (': 0+DOES> DOES>     IMMEDIATE                       #DO-.ABRT  (': ,"    A"         IMMEDIATE                       #DO-STR   (':   ,"  "           IMMEDIATE                       #DO-.STR   (': ,"    ."         IMMEDIATE                                                                                       ' RELEASE< ALIAS THEN IMMEDIATE                                 M' IF  ALIAS WHILE IMMEDIATE    \ M' IF ALIAS WHILE IMMEDIATE                                                                                                                                                                                                                                                                                                                                   \ ELSE CASE IF USER VAR: -------------------                                                                                    : ELSE ?CSP PUSH ', AHEAD  POP CSP! ', THEN ;  IMMEDIATE        : CASE CSP! CSP  0 TO CSP  ;  IMMEDIATE                                                                                         M' ELSE ALIAS ENDOF IMMEDIATE                                   M' [ ALIAS [[       IMMEDIATE                                   ' MARK> ALIAS BEGIN IMMEDIATE                                   ' ] ALIAS ]]                                                    : USER  #DO-USER @ CODE,   #DO-SETU @, C, ;                     : GLOBAL  #DO-GETG @ CODE,   #DO-SETG @, C, ;                                                                                                                                                                                                                                                                                                                                                   \ BARY WARY CONSTANT VALUE ---------------------                : WARY #DO-ARY @ CODE, 2* CLARY ;                               : BARY #DO-ARY @ 2+ CODE, CLARY ;                               : VARIABLE CREATE 0 , ;                                         : IMMEDIATE  #DO-COMM @ MOVEW ;                                 : VECT> HERE SWAP +DOES 0 (: ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ASSEMBLER DEFINITIONS    \ MACROSES                                                                                             : ;C EX END-CODE ;      : @J @ JMP, ;           : @@J @ @J ;    : /PUSH ;C #DO-WPUSH @J ;       : /SWAP ;C #DO-SWAP @J ;        : >USR1  CBW, #DO-USRV @ /// AX ADD, AX DI XCHG, ;              : >GLB1  CBW, #DO-GLBV @ /// AX ADD, AX DI XCHG, ;              : /DROP  ;C #DO-DROP @@J ;      : /JUMP AGAIN, ;C ;             : 0>AX, AX AX XOR, ;   : 2*, BX BX ADD, ;                       \ : DUP, BX PUSH, ;    : DROP, BX POP, ;                                                                                        : XOR-DBG, [ AX DI XCHG, DI SKIPW, HERE @- TO HERE                  UNPACK    XOR    ] LITERAL #, #DO-EX @ 1+ ///  XOR, ;                                                                                                                                                                                                                                                                       $100 TO THERE                           \ NEW COMFILE START     ' NEW, 1 STATES !                       \ TARGET CHECK ON         MINI ALSO  DEFINITIONS  ASM                                    -19 +ORIGIN    TO THRESHOLD       \ THRESHOLD ADDRESS                                                                           THERE THRESHOLD OVER - ERASE                                                                                                                     SIZE. .( TARGET COMPILER)                     <%>    \ COMPILE TO TARGET  ON                                                    SIZE. .( CHANGE TARGET)                       \ ;S                                                                                                                            \ CHANGING  COMPILE PART OF THE INTERPRETER                     \ WE CAN COMPILE TO TARGET ADDRESSES  AND                       \ WE SHALL BE CHACKED FOR CORRECTNESS OF THE ADDRESS                                                                            HL! #DO-BOOT   CLD, JMP,? 1   508 CLARY                         FL: 1   $1000 #, BX MOV,   $4A #, AH MOV, DOS,                             $F #, AH MOV,   VIDEO, ?, J,? 1                      #DO-BOOT @ 128 +  VALUE UPV   HERE 2- DUP #DO-USRV !            FB: 1 /// SI MOV, 6 #, SI ADD,                                   CLD, LODSW, AX SP XCHG, LODSW, AX BP XCHG,  CALL,? 1  4 C,     #DO-USRV @ 2+ CODE, ABORT                                       0 CODE, DROP     0 CODE, NOP    0 CODE, EXEC   0 CODE, PERFORM  0 CODE, +ORIGIN  0 CODE, EMIT   0 CODE, KEY    0 CODE, ?EMIT    HL! #DO-4TH: X, SI PUSH, X,  HL! #DO-4TH  SI POP,                           ?, IF, 2SCAS,    HL! #DO-SETV SCASW, BX 0 /DI MOV,  HERE BE DROP DROP,                                              HL! #DO-EX  THEN, HERE BE NOP  LODSW, AX DI XCHG, 0 /DI JMP,                                                                                                                                                                                                    (  NXT, #DOES #DEFER #VAR #LIT #CONST #SETV #WPUSH #EXEC       )                                                                XOR-DBG,  DUP,  AX BX XCHG,  CALL,? 2  6 C,  \ DEBUGGER VECTOR                                                                    LIKE NOP TO ?NEXT     2SCAS,                                                                                                  HL! #DO-CONST  SCASW, DUP, 0 /DI BX MOV, NEXT,                  HL! #DO-USER 4 /DI AL MOV,  >USR1  #DO-CONST @ 1+ JMP,          HL! #DO-SETU 2 /DI AL MOV,  >USR1  #DO-SETV @ 1+ JMP,           #DO-BOOT @ VALUE GPV HERE 2- DUP #DO-GLBV !  2- @  IS UPV       LIKE GPV BE UPV                                                                                                                 2SCAS,  HL! #DO-VAR  2 /DI AX LEA,                                      HL! #DO-WPUSH  DUP,                                             HL! #DO-SWAP AX BX XCHG, NEXT,                                                                                          #DO-VAR @, AX SKIPW,    \ ALIAS POINT                           2SCAS,  HL! #DO-DEFER          SCASW, DUP, DI BX MOV,                   HERE BE PERFORM        0 /BX BX MOV,                            HERE BE EXEC           AX POP, BX AX XCHG, AX AX OR,            ?NEXT 0=, J,  #DO-EX @ 1+ JMP,                          2SCAS,  HL! #DO-DOES  X, SI PUSH, X, SI POP, #DO-VAR @J         HERE BE KEY   CALL,? 3 10 C,                                    HERE BE ?EMIT  32 #, BL CMP, U<, IF,  `. #, BX MOV, THEN,       HERE BE EMIT 14 #, AL MOV, >GLB1 W/ 0 /DI INC, CALL,? 4 12 C,   FL: 1 FL: 2  FL: 3  FL: 4                                       DI POP, 0 /DI AL MOV, >GLB1  #DO-DEFER @ 1+ JMP,                                                                                                                                                                                                                                                                                                                                                HL! #DO-;4TH  SI PUSH, X, SI POP, X, RET,                       HERE BE +ORIGIN  2*, #DO-BOOT @ /BX BX LEA, /CODE               ' ABORT 2 +ORIGIN !                                             ' DROP #DO-DROP !                                               \ ASM 2SCAS,  HL! #DO-FCOL   X, SI PUSH, X,                     \             HL! #DO-FLBL    2 /DI SI MOV, /CODE                 ASM 2SCAS,  HL! #DO-COL   X, SI PUSH, X,                                    HL! #DO-LBL    2 /DI SI LEA, /CODE                ASM                                                             HL! #DO-GETG 4 /DI AL MOV,  >GLB1  #DO-CONST @ 1+ JMP,          HL! #DO-SETG 2 /DI AL MOV,  >GLB1  #DO-SETV @ 1+ JMP,           /ASM                                                                                                                                                                                                                                                                                                                            CODE #BLK  BX INC, 0=, NOT IF,  BX DEC, THEN, /CODE             CODE BB>W AX POP, AH BL XCHG, /SWAP                             CODE B/MOD  0>AX, BH AL XCHG, /PUSH                0 CODE, EX                                                                   CODE HB/MOD  0>AX, BX AX XCHG, AAH, AH BL XCHG, AX PUSH, /CODE    ASM 2*, BX DI ADD, 2*, HL! #DO-ARY 2*, 2 X/D BX LEA, /CODE    CODE (CSTR SI BX MOV, LODSB, AX SI ADD, RET, HERE TOBE             0>AX, DUP, 2 /DI BX LEA, SI 0 /BP XCHG, BX CALL,             HERE BE EX    SI 0 /BP XCHG, /CODE  CODE lit LODSW, /PUSH       CODE @R+ LODSW, AX BX XCHG, RET, LIKE (CSTR 2+ TOBE  END-CODE   CODE C@R+ LODSB, AX BX XCHG, RET, LIKE (CSTR TOBE  END-CODE     CODE C!R+  STOSB, RET,  HERE TOBE  2 /DI AX LEA, AX BX XCHG,       DI 0 /BP XCHG,  BX CALL, DI 0 /BP XCHG, /DROP                CODE !R+ STOSW, RET, LIKE C!R+ TOBE END-CODE                                                                                                                                                    \ MEMORY & ADDRESSES / INCREMENTS & DECREMENTS                          CODE  @-   -2 /BX PUSH,  PNT!  BX DEC, BX DEC,  /CODE           CODE  C@-  0>AX, -1 /BX AL MOV,  AX PUSH, PNT@ 1+ /JUMP         CODE  C!-  AX POP, AL -1 /BX MOV, PNT@ 1+ /JUMP                 CODE  !-   -2 /BX POP,  PNT@ /JUMP                      PNT@ 1+ CODE, 1-                                                   PNT@ CODE, 2-                                                        CODE  @+   0 /BX PUSH, PNT! BX INC, BX INC, /CODE               CODE  !+   0 /BX POP,   PNT@ /JUMP                              CODE  C@+  0>AX, 0 /BX AL MOV,  AX PUSH, PNT@ 1+ /JUMP          CODE  C!+  AX POP,  AL 0 /BX MOV,  PNT@ 1+ /JUMP        PNT@ 1+ CODE, 1+                                                   PNT@ CODE, 2+     \      0 CODE, INC                         \       CODE  DEC   AX POP, AX NEG, AX PUSH,                    \ HERE BE       INC   DI BX MOV,  DROP, DI 0 /BX ADD, /CODE                                                                     \ REGISTERS & BASIC MATH                                        CODE B    CX AX MOV, /PUSH                                      CODE A    DX AX MOV, /PUSH                                      CODE B!   BX CX MOV, /DROP                                      CODE A!   BX DX MOV, /DROP                                      CODE SP@  SP AX MOV, /PUSH                                      CODE RP@  BP AX MOV, /PUSH                                      CODE RP!  BX BP MOV, /DROP                                                                                                      CODE +2/  AX POP, AX BX ADD,  BX PUSH, 1 #, BX RCR, /CODE       CODE AND  AX POP,  AX BX AND, /CODE                             CODE XOR  AX POP,  AX BX XOR, /CODE                                                                                             0 CODE, else    0 CODE, skip  0 CODE, R<>S   0 CODE, ?call      0 CODE, DROP;   0 CODE, EXIT  0 CODE, RDROP  0 CODE, NIP;                                                                          CODE  SWAP;     AX POP, DUP, AX BX XCHG,  ?, IF,             HERE BE  NIP;      AX POP,  CL SKIPB,                           HERE BE  DROP;     DROP,                                        HERE BE  EXIT      THEN, 0 /BP SI MOV,                          HERE BE  RDROP     2 /BP BP LEA, /CODE                          CODE  0; BX BX OR,  LIKE DROP; 0=,     J, LIKE DROP /JUMP       CODE if; BX BX OR,  LIKE DROP; 0=, NOT J, LIKE DROP /JUMP          CODE  PUSH      X,                                           HERE BE  R<>S      DUP, X, /DROP     CODE .skip DROP,           HERE BE  skip      LODSW, /CODE         CODE .else DROP,        HERE BE  else      0 /SI SI MOV, /CODE                          CODE -if BX BX OR,  LIKE else  0<, NOT J, LIKE skip /JUMP       CODE #if BX BX OR,  LIKE else  0=, J,     LIKE skip /JUMP       CODE  if BX BX OR,  LIKE .else 0=, J,     LIKE .skip /JUMP      CODE for   BX DEC,  LIKE .else 0<, J, LODSW, LIKE PUSH /JUMP                                                                    CODE of AX BX XCHG, DROP, BX AX XOR,                                LIKE else  0=, NOT J,  LIKE .skip /JUMP                                                                                     CODE next  W/ 1 #, 0 /BP SUB,  LIKE else  U<, NOT J, PNT!                              LODSW,  LIKE RDROP /JUMP                 CODE 0>next  W/ 0 /BP DEC, PNT@ 0<, J, LIKE else /JUMP          CODE  CONT   DUP, -2 /SI BX LEA, LIKE PUSH /JUMP                CODE  TIMES  BX DEC,  LIKE CONT 0<, NOT J, LIKE DROP; /JUMP                                                                     CODE  ;GO    LODSW, DI SKIPW,                                   HERE BE  ?call  LODSW, AX SI XCHG, X, AX PUSH, X,  /CODE                                                                        \ CODE BSWAP CX POP,  AX AX XOR,  CX BX XCHG, CXZ, NOT IF,      \    BEGIN, 1 #, BX SHR, 1 #, AX RCL,  CXZ, UNTIL, THEN,        \    AX BX XCHG, NEXT, END-CODE                                                                                                 CODE NIP    AX POP, /CODE                                       CODE POP    DUP, X, DROP, X, /CODE                              CODE SWAP   AX POP, /PUSH                                       CODE DUP    DUP, /CODE                                          CODE SWAP!  DI POP, #DO-SETV @ 1+ /JUMP                         CODE XCHG   0 /BP BX XCHG, /CODE                                CODE _      LODSW, /SWAP                                        CODE ROT    DI POP, AX POP, DI PUSH, /PUSH                      CODE -ROT   AX POP, DI POP, BX PUSH, DI PUSH, /SWAP             CODE NUP    AX POP, AX PUSH, AX PUSH, /CODE                         HERE ASM 2 /DI DI MOV, 0 P/D AX MOV, /PUSH                  DUP CODE, I 0 ,  CODE, J 2 ,                                                                                                                                                                                                                                                                                                    CODE BKEY?  ( - c)                                                 1 #, AH MOV,  KBD,  0=, NOT IF,  BX DEC, THEN, RET,          HERE TOBE   BX PUSH, BX BX XOR, 2 /DI CX LEA,  CX CALL, /CODE                                                                   CODE (BKEY  ( - c) BX AX MOV, KBD, AL AL OR, 0=, NOT              IF, AH AH XOR, THEN,   AX BX XCHG, RET,                       LIKE BKEY? TOBE  END-CODE                                                                                                                                                                        HERE ASM XOR-DBG, /ASM       \ TRACE MODE ON FROM DEBUDDER      HERE ASM X, DI POP, SI POP, X,  0 /DI JMP, /ASM  \ TROFF FROM   HERE ASM XOR-DBG, /CODE      \ TRACE MODE ON/OF FROM USER      CODE, TR , ,                                                                                                                                                                                                                                                    CODE (;4TH  SI JMP,  SI POP,  /CODE                                                                                             CODE (?DBG  ?NEXT @ #, AX MOV,  ?NEXT /// AX XCHG,                  0 #, AH CMP,  SAVE1  AX DI XCHG,                                LIKE SKIPB,         \ NEST - INCASE NO DEBUG / ELSE DOWN -v     0=, NOT UNTIL,  SCASW,   X, SI PUSH, AX PUSH, DI PUSH, X,       ' (;4TH 2+ 2+ #CALL,    /ASM ] EX                                                                 (;4TH [                                                                 ASM                   X, AX POP,   AX ?NEXT /// MOV, SI POP, X, /CODE                                                                                                                                                                                                                                                                                                                                                                                                             \ CONSTANTS VALUES VECTORS                                      15 NFAMILY CONSTANT  0 0  1 1  2 2  0D cr  0A lf  20 bl  08 bs     8000 #SGN  10 1H  400 1K  40 1L  1A eof  -1 -1                     5C TPAD  7F NPAD                                           2 4 28 FAMILY GLOBAL '(AB '(DE '(ER '(IN '(OUT                                        OUTC HERE >IN BLK  TIB  /TIB  CFA SPTR         CONTEXT  CURRENT  SCR  THERE  SCRH  CSP  CMARK  NPTR            PREV  FIRST  NBUFS  SRCHPNT  CICLES  USE  RELOC                                                                           0 0 8 FAMILY VECTOR 'SAME .BG 'LIT INTERPRET 'OK PAUSE #. 'TEST                                                                  0 0 3  FAMILY VAR:  ATTR -HEADS  ON-START                      \ 0 0 4  FAMILY VAR:  ATTR -HEADS  ON-START BLK>IN 0 ,          2 6 18 FAMILY USER  SP0 RP0 USP DPL BASE FRAME SELF ERHND                        _AX _BX _CX _DX _SI _DI _BP _ES _DS _FL                                                                        \                          VARS & INITIALIZE                                                                                    AT MINI TO CONTEXT                                                                      2 ATTR !             10 TO BASE                                                                         \ ' .DBG  TO .BG                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ 4DOS                                                                                                                          CODE 4DOS DOS, RET, PNT! \ DX CX BX AX                          PNT@ TOBE  X, SI PUSH, CX PUSH, DX PUSH, X,  2 /DI DI LEA,      AX BX XCHG, DROP,  CX POP, DX POP,  BP PUSH, DI CALL,             PUSHF, DS PUSH, ES PUSH, BP PUSH, DI PUSH, SI PUSH,             DX PUSH, CX PUSH, DUP,  AX PUSH, CS AX MOV, AX DS MOV,          AX ES MOV, CLD,  'T _AX 4 + C@ #, AL MOV, >USR1                 10 #, CX MOV, BEGIN, AX POP, STOSW, CXZ, UNTIL,                 BP POP, X, DX POP, CX POP, SI POP, X, /DROP                                                                                   CODE (K  8 #, AH MOV, DOS, AH AH XOR, /PUSH                     CODE (E  BX DX MOV, 2 #, AH MOV, DOS, /DROP                                                                                                                                                                                                                     \ ONLY FIXES  TO COMPILER                                                                                                                ' (E TO '(OUT   ' (K TO '(IN                           ' PUSH #DO-RPUSH !    ' DROP  #DO-DROP !      ' EXIT #DO-SEMI ! ' lit   #DO-LIT !                                                                      ' else #DO-BR   !      ' if    #DO-?BR ! ' #if  #DO-#BR !       ' -if   #DO-MBR !       ' for  #DO-FOR ! ' next  #DO-NEXT !     ' of    #DO-OF  !   ' 0>next #DO-MNEXT ! ( ' R<>S  TO RP/SP )     ' ?call #DO-CALL !                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     >: ;DROP EX DROP; ; SAVE2                                       : EXECUTE PUSH ;                                                : XEP XCHG PUSH EX POP ;                                        | : TRUE _ [ -1 , ] ;   | : FALSE _ [ 0 , ] ;                   >: 0< -if TO FALSE else TO TRUE  ;  SAVE2                       | : ;AB A XCHG B PUSH PUSH EX POP B! POP A! ;                   : INVERT -1 XOR ;                                               : OVER NUP SWAP; ; SAVE2                                        >: U<  SWAP INVERT +2/ NIP  TO 0< ; SAVE2                       | : 9>? 9 OVER U< ;                                             : TWICE I PUSH ;                                                : LOOPS  FOR J EXECUTE NEXT  RDROP ;                            \ : LOOPS 1- -IF DROP RDROP ;THEN                               \ : REPEAT I 2- XCHG : EXECUTE PUSH ;                           \ : TIMES ;DROP LOOPS OVER PUSH PUSH EXECUTE POP POP ;                                                                          : C!     C!+ DROP; ; SAVE2                                      : C@     C@+ DROP; ; SAVE2                                      : CSTR   C@+ SWAP; ;  SAVE2                                     : +      +2/ DROP; ; SAVE2                                      : @      @+ DROP; ;   SAVE2                                     : !      !+ DROP; ; SAVE2                                       : NEGATE INVERT 1+ ;                                            : -      NEGATE + ;                                             : <      - TO 0< ;  SAVE2                                       >: 0=    #if TO TRUE  else TO FALSE ;  SAVE2                    : =      XOR TO 0= ; SAVE2                                      : WITHIN OVER - PUSH - POP  TO U< ; SAVE2                       | : ;A A EX A! ;  : C@A+ ;A C@+ ;  : @A+ ;A @+ ;                : 2DROP DROP DROP; ; SAVE2                                      : 2SWAP ROT XEP ROT ;                                                                                                           : CR  cr EMIT  lf EMIT   0 TO OUTC ;                            : SPACE bl EMIT ;        : ;SPACE EX SPACE ;                    : ALPHA  9>? 7 AND + 48 + ;     :: DIGS. LOOPS  ALPHA EMIT ;    :: .H ;SPACE B/MOD TWICE  HB/MOD TWICE TO DIGS. ;               :: TYPE ;DROP LOOPS CSTR ?EMIT ;        : ".  CSTR TYPE ;       : ID. ;SPACE  ". ;      : .DH TO .H .H ;                        : SPACES LOOPS SPACE ;                                          : LENZ DUP CONT CSTR if; RDROP 1- SWAP - ;                      : TYPEZ DUP LENZ TYPE ;                                         : BKEY  BEGIN PAUSE BKEY? UNTIL (BKEY ;                                                                                         \ SPACE  5 .H SPACE B.                                                                                                                                                                                                                                                                                                          | : (A" (CSTR SWAP IF '(ER EXEC ABORT THEN DROP ;               ' (A" #DO-.ABRT !        | : ?? A"  ?" ;                        | : ("  (CSTR ;          ' ("   #DO-STR !                       | : (." (CSTR ". ;       ' (."  #DO-.STR !                      | : ;code POP CFA ! ;    ' ;code  #DO-;CODE !                   : ACCEPT ( A L -- A NEWL ) OVER PUSH I + PUSH BEGIN  KEY         cr OF RDROP PUSH I  ENDOF                                       bs OF DUP J XOR IF bs EMIT SPACE bs EMIT 1- THEN ENDOF           DUP bl 256 WITHIN IF DUP EMIT SWAP C!+ DUP  THEN                DROP THEN THEN  DUP I = UNTIL DROP J POP POP - ;              : ?SRCH B! PUSH A! ?-FOR POP TRUE ;THEN POP XCHG PUSH  J         FOR- J EXECUTE IF NEXT- J 1+ skip THEN POP RDROP POP SWAP - ;  : =B? ?SRCH B C@A+ XOR ; : <>B? ?SRCH  B C@A+ XOR TO 0= ; SAVE2 : =W? ?SRCH B @A+ XOR ;  : <>W? ?SRCH  B @A+ XOR TO 0= ;  SAVE2                                                                                                                                  0 BARY TOAT ,T TO  ,T AT                                                                                                       | : C>N? 2- ?CALL   OVER ?SRCH                                     A C@ bl 1+ U< #IF POP RDROP 0 PUSH PUSH ;THEN  \ BAD CHAR       DROP A C@- A! #IF  A + B XOR ;THEN 1+                        ;THEN  DUP 1- bl 1- EX  1+ IF A SWAP ;THEN 0 ;                                                                                  : C>N  C>N? IF 1 ;THEN C>N? IF 2 ;THEN  C>N? IF 3 ;THEN 6 + 0 ;                                                                 : ?ID. C>N 1- DUP #BLK IF 1- #IF 2+ THEN  TOAT ID.                        BEGIN ID. ;THEN  UNTIL 58 EMIT .H ;                                                                                                                                                                                                                                                                                                                                                   | >: DDH. TWICE SWAP DUP .H ; | : TOP. DUP @ DDH. ?ID. BKEY ;   | >: (S. ;SPACE SP@ .H TWICE 2SWAP TO DDH. ; SAVE2              : S. CR TO (S. ; SAVE2                                          | >: (R.  R<>S (S. R<>S  ;  : R. CR TO (R. ; SAVE2                                                                              : (DBG PUSH S. POP POP (R. PUSH PUSH J 2- TOP.   NIP                       83 XOR IF AT TR THEN TO TR ;                                                                                         : .BGR S. POP (R. PUSH I TOP. 2DROP ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | : ;@! @+ XCHG PUSH EX POP !- DROP; ; SAVE2                    | : ;B B EX B! ;                                                | : U1- XEP 1- ;                                                : STR @+ SWAP; ;  SAVE2                                         : A- ;A 1- ;                                                    : A+ ;A 1+ ;                                                    : C!A- ;A C!- ;                                                 : !B+ ;B !+ ;                                                   : C!B+ ;B C!+ ;                                                 : C@B- ;B C@- ;                                                 : 2! !+ ! ;                                                     : 2@ @+ @ SWAP; ; SAVE2                                                                                                                                                                                                                                                                                                         : +! ;@! + ;                                                    : XOR! ;@! XOR ;                                                >: ;SWAP EX SWAP; ; SAVE2                                       >: ;NIP EX NIP;   ; SAVE2                                                                                                       : 0<> #IF TRUE THEN ;                                           : ;RDROP EX RDROP ;                                             : ODD 1 AND ;                                                   : UM+ +2/ 0< ODD ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              >: 0<= #if TO TRUE  TO 0< ;  SAVE2                              : <= - TO 0<= ;  SAVE2                                          : >= < TO 0= ;  SAVE2                                           : <>  = TO 0= ; SAVE2                                           : S>D DUP 0< ;                                                  : > <= TO 0= ;  SAVE2                                           : 2* DUP + ;                                                    : U2/ 0 +2/ NIP ;                                               | : ?S2/  IF ?CALL #SGN XOR ;THEN THEN U2/ ;                    : 2/ S>D ?S2/ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                 \ + - ZSWAP ODD 2* 2/ OVER 2DUP S>D ABS OR  TUCK MAX  MIN       : ABS -IF NEGATE THEN ;                                         : OR OVER INVERT AND XOR ;                                      : 2DUP OVER OVER ;                                              : TUCK DUP -ROT ; | : US>D XEP S>D ;                            | : >BE 2DUP < IF SWAP THEN ;                                   : MAX >BE DROP ;                                                : MIN >BE NIP ;                                                 \ : 2DROP DROP DROP; ; SAVE2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ : REGS! TO _FL   TO _AX   TO _BX   TO _CX   TO _DX  ;         \ : @+= ( W A - W| A+ ) @+ XEP @A+ XOR OR ;                     \ : 2@+=  0 SWAP @+= @+= DROP ;                                 \ : D2/ 0 +* DROP ;                                             \ : STRTEST CR ." STRTEST" ;  STRTEST                           \ : (STR J POP POP C@+ + PUSH PUSH ;                            \ : >BYTE 255 AND ;                                             \ : >< B/MOD SWAP BB>W ;                                                                                                        \ 0 VECT> PERFORM @ PUSH CR  .SDB POP R<>S .SDB R<>S            \ ?ID. BKEY DROP ;  DUP  ' I CODE,, .BGR   ' J CODE,, .DBG      \ : EMIT ;AB '(OUT EXEC OUTC 1+ TO OUTC ;                       \ : KEY  ;AB '(IN EXEC ;                                        \ | >: (S. ;SPACE SP@ .H ?CALL DDH. ;THEN XEP XEP DDH. ;                                                                                                                                        \ -/ +* UM* M+  UM/MOD  UM+ D+  DNEGATE D-  D0  D0-ROT          : D+ ROT + ?CALL SWAP 0;  1+ ;THEN XEP +2/ 0< ;                 : DNEGATE OVER IF INVERT SWAP ;SWAP THEN NEGATE ;               : D- DNEGATE D+ ;   | >: ;SGN EX DNEGATE ;                      : UM*  0 SWAP ;DROP 1H LOOPS   \ ?FOR +* NEXT THEN  DROP ;      ( : +*)  XEP OVER ODD #IF DROP J THEN +2/ XEP ODD ?S2/ ;        | : D2* ?CALL XOR ;THEN 2* XEP DUP UM+ ;                        : UM/MOD ;SWAP ;DROP 1H LOOPS   \ ?FOR -/ NEXT THEN DROP SWAP ; ( -/)   XEP D2*  J NEGATE +2/ 0< IF XEP 1+ ;THEN  J + ;         : M+ S>D D+ ;  : D0 0 0 ;                                                                                                                                                                                                                                                                                                                                                                                                                                       \ MOVE FILL BLANK ERASE -TEXT ?B ?W FOUND NONE  >ZSTR           : FILL A! SWAP B! TIMES A C!B+ ;                                : ERASE 0 FILL ;        : BLANK bl FILL ;                       : REVERCE B! A! B A - U2/ TIMES C@A+ C@B-  A 1- C!  B C! ;      : EXCHANGE -ROT B! A! TIMES C@A+ B C@+ B!  A 1- C!  B 1- C! ;   : CMOVE -ROT B! A! TIMES C@A+ C!B+ ;                            : CMOVE> TUCK + A! TUCK + B! TIMES C@B- C!A- ;                  : -COMPARE -ROT B! A! 0 SWAP TIMES C@A+ B C@+ B! XOR 0;           RDROP 2DROP A 1- C@ C@B- - ;                                  : -TEXT DUP C@ 1+ -COMPARE ;                                    : >ZSTR ( A L - ZA ) NPAD XEP J SWAP J MIN CMOVE 0 C!B+ ;       \ : MOVE RANGE! DUP A B WITHIN A BA- ROT IF CMOVE> ;THEN CMOVE ;\ : RANGE! OVER + B! A! ;                : BA- B A - ;          \ : =D? ?SRCH  B 2@+= ;    : <>D? ?SRCH  B 2@+= TO 0= ;  SAVE2                                                                                                                                  \ M* M/ * / */ /MOD MOD U/MOD U/ UMOD ENDZ LENZ ACCEPT          :: U/MOD 0 SWAP UM/MOD ; : U/ U/MOD NIP ;  : UMOD U/MOD DROP ;  : MU/MOD TUCK U/MOD XEP TO U/MOD ;                              | : *?- 2DUP XOR 0< 0; ABS SWAP ABS TO ;SGN ;                   | : /?- -IF ABS PUSH DNEGATE POP TO ;SGN THEN ;                 : M* *?- UM* ;  : * M* DROP; ; SAVE2 : M/MOD /?- MU/MOD ;       : M/ M/MOD ROT DROP; ; SAVE2   : /MOD US>D M/MOD DROP; ; SAVE2  : / /MOD NIP ; : MOD /MOD DROP; ; SAVE2                         : M*/ PUSH M* POP M/ ; : */ M*/ DROP; ; SAVE2                   : ;BASE BASE XCHG PUSH TO BASE  EX POP TO BASE ;                                                                                | 0 VALUE X  | : END;  X A XOR IF ;THEN RDROP ;                 | : ?DIG  48 - 9>?  IF 7 - DUP lf <  OR THEN  DUP BASE U< ;                                                                                                                                                                                                     | : UD*+ SWAP ;GO TO D+ ?CALL DROP  XEP XEP THEN BASE UM* ;     : CONVERT BEGIN END; C@A+ ?DIG WHILE UD*+ AGAIN THEN DROP A- ;  | CREATE NUMOPS ,T ^`&~#%$-. | : ?OP ;AB NUMOPS CSTR C@A+ =B? ; | CREATE #OP  0 C, 0 C, 64 C, 128 C, 10 C, 2 C, 16 C,                                                                           : >NUMBER OVER + TO X A!  -1 TO DPL  D0  END;    \ EMPTY ?         ?OP 7 = IF A+ ;SGN THEN  ?OP 7 U< \ OPTIONS ? MINUS             IF X A - 1 > 0; ?OP A+ DUP 4 <    \ ^`~& \ ONECHAR NUMS            IF C@A+ OVER 0= IF 31 AND THEN  SWAP #OP + C@ + NIP SWAP;       ELSE  #OP + C@ ;BASE      THEN        \ NEW BASE           THEN CONVERT END; 0 TO DPL BEGIN END; ?OP 8 = 0; A+              A PUSH CONVERT  DPL  A POP - + TO DPL  AGAIN ;                                                                                : (DNUM CSTR >NUMBER DPL -IF DROP THEN DROP X A - ?? ;                                                                                                                                          \ NUMOUT   DECIMAL BINARY HEX                                   : 1# ;SWAP 1+ XEP BASE MU/MOD  2DUP OR 0= ;                     >: S# BEGIN 1# UNTIL NIP NIP ;                                  | : D# XEP -IF DNEGATE ?CALL -10 SWAP 1+ ;THEN THEN 0 S# ;      >: D.R ;GO AT DIGS. D# OVER - SPACES ;                          : D.  0 D.R  SPACE ;                                            : .R US>D TO D.R ;  SAVE2                                       : . S>D D. ;                                                    : (U.R ;SPACE lf ;BASE 0 SWAP TO D.R ; SAVE2                    : H. 0 1H ;BASE 0 1# DROP S# DIGS. SPACE ;  ' (U.R TO  #.                                                                                                                                                                                                                                                                                                                                                                                                       \ STECK OF VOCABULARIES                                         | : ;VSTK XCHG PUSH J @ J EX POP ! ;                            : ITEMS? @+ 2+ - U2/ ;  : INITSTK DUP 2+ 2+ SWAP! ;             #DO-VAR @                                                       1 VECT>  ;VSTK 2@ = A" +ITM" !+ ;                               2 VECT>  ;VSTK ITEMS? 0= A" -ITM" @- ;                          HEADER ORDER , , , 0 , >MARK 32 CLARY  RELEASE<                  AT ORDER INITSTK                   : TOP@ @ @- DROP ;                                                                          ' ORDER HEADER HANDLE W, W, W, Z, DROP >MARK 32 CLARY RELEASE<  AT HANDLE INITSTK       |  0 VALUE EOS?                                                                                                                                                                                                                                                                                                                                                         \ TESTS                                                                                                                         \   B.  ;S                                                      \ PARSE NUMBER                                                  \ EXIT                                                          \ ' PAD  DEFER PAD                                              \ : ?NUM PAD 10 ACCEPT >NUMBER ;                                \ : CNV DECIMAL PAD 10 ACCEPT OVER + TO X A!                    \                             SPACE 0 0 CONVERT D. ;            \ : FORI '?FOR BEGIN I . NEXT THEN ;                            \ : ACP PAD 10 2DUP . . ACCEPT SPACE . . ;                      \ : RANG? 1 1 B! A! B  A .BG  .H .H ;                           \ : PRESERVE XCHG I @ PUSH PUSH EX POP POP ! ;                  \ : MFIND AT FORTH (FIND ;                                                                                                                                                                      | : IO? _FL ODD A" IO?" ;    0 VECT> PUSH D0 ROT POP @ 4DOS ;   HEX | DUP CODE, CFpos 4201 ,   DUP CODE, FClose 3E00 C,             |  CODE, CFsize  4202 ,    0 VECT> @  4DOS ;                | DUP CODE, FOpen 3D02 ,       | DUP CODE, FCreate  3C00 ,      DUP CODE, FRead 3F00 ,         DUP CODE, FWrite  4000 ,             CODE, FSeek 4200 ,                                          | : FRW 1K UM* SCRH FSeek  IO?  1K SCRH  EX IO? ;               | : FWBLK FRW FWrite ;        | : FRBLK FRW FRead ;             : Fsize ( HND -- DX:AX ) CFpos IO? _DX _AX                         _BX CFsize TO _CX _AX _DX  ( DX:CX) ROT _CX _BX FSeek ;      : FSIZE SCRH Fsize 1K UM/MOD NIP ;                              : Fcut ( SCR -) FRW NIP D0 ROT FWrite DROP ;   DECIMAL          | :: ;File CSTR >ZSTR D0 EX IO? _AX ;                           : FOPEN ;File  FOpen ;        : FCREATE ;File FCreate ;                                                                                                                                         \ BLOCK WORDS                                                   15 DUP TO   NBUFS 1+ BARY FBUFS     NBUFS 1+ WARY  BUFS         0 VECT> C@ PREV FBUFS C! ;  DUP   | : @BUF PREV 1K * FIRST + ;   CODE, DISCARD  0 C,     CODE, UPDATE  -1 C,                    : !BUF PREV BUFS ! ;   | : +BUF USE 1+ NBUFS AND DUP TO USE ;   | : /BUF @BUF 1K ERASE ; | : EMPTY-BUF -1 !BUF  DISCARD /BUF ;  : EMPTY-BUFS  NBUFS  FOR- +BUF TO PREV EMPTY-BUF  NEXT- ;       | : ?BUF PUSH 0 BUFS NBUFS 1+ POP =W? ;                         | : ?SAVE PREV FBUFS C@ IF @BUF PREV BUFS @ FWBLK DISCARD THEN ; | : ;ABLK XCHG PUSH EX RDROP @BUF IO? ;                        : BUFFER ;ABLK J ?BUF -IF ?BUF -IF DROP +BUF THEN THEN              TO PREV ?SAVE /BUF J !BUF ;                                 : SAVE-BUFS  NBUFS  FOR- +BUF TO PREV ?SAVE NEXT- ;             : BLOCK ;ABLK J ?BUF -IF DROP J BUFFER J FRBLK ;THEN TO PREV ;                                                                                                                                  \ ID. >LFA WORD.                                                                                                                0 VECT> C@ TO BASE ;   DUP CODE, DECIMAL 10 C,                  DUP CODE, BINARY  2 C,     CODE, HEX 16 C,                      : >LFA C@+ + ; | : NEWLN CMARK 1+ TO CMARK ;                                                                                    | 0 VALUE XX                                                    | : TAB16 OUTC NEGATE 15 AND SPACES ;                           | : ?8 CSP 1+ TO CSP DUP C@ OUTC + 6 + 79 U< IF                     EX OUTC 1L U< IF TAB16 ;THEN NEWLN  CMARK  bs 1- AND 0=           IF BKEY 27 = TO XX THEN CR ;THEN CR NEWLN EX TAB16 ;      : WORD. ?8  DUP .H ID. ;                                        \ : TEST.W CR 0 TO CSP  LOOPS " A-WORD" WORD. ;                 \ : ?79 CR 7 LOOPS ?CALL 9                                      \         LOOPS 9 J - TO DIGS. ;THEN EX 124 EMIT ;                                                                              \ VFIND  FIND  FOR-WORDS  WORDS : alias DUP @ 1+ 0= 0; 2+ @ ;                                                                   : ;NS CURRENT XCHG PUSH TO CURRENT EX POP TO CURRENT ;          : FOR-WORDS   BEGIN DUP WHILE EX >LFA @ AGAIN THEN RDROP ;      : WORDS  CR  0 DUP TO XX DUP TO CSP TO CMARK ;DROP CONTEXT @       FOR-WORDS  BEGIN DUP WORD.  XX IF RDROP ;THEN  EX AGAIN ;                                                                    | CODE alias #DO-DEFER @ 3 - #, AX MOV,   0 /BX AX CMP, 0=,                  IF, 2 /BX BX MOV, THEN, /CODE                      : VFIND @ FOR-WORDS BEGIN 2DUP -TEXT IF  EX AGAIN THEN               NIP A! B 2+ alias DUP RDROP ;                              : FIND           @+ 2- ITEMS?  FOR @- PUSH VFIND                    IF RDROP RDROP DUP ;THEN  POP NEXT  DROP 0 ;                                                                                                                                                                                                                : IN?  /TIB >IN + >IN NEGATE ;   \ PARSING WORDS                | : BLK; BLK #BLK if; RDROP ; | >: ;TIB TO BLK BLK; 0 TO /TIB ; : SOURCE BLK; /TIB if; BLK BLOCK 1K + TO /TIB ;                 | : ;IN+ PUSH IN?  NUP POP EX A OVER - DUP >IN + TO >IN ;       | : (PARSE ;IN+ =B? 1+ 0; EX 1- ;                               | : (SKIP ;GO TO 2DROP ;IN+ <>B? 1+ 0; A- ;                     : PARSE PUSH SOURCE I bl = IF I (SKIP THEN POP (PARSE ;         : S! NUP  C!+ SWAP CMOVE ;      : CS! 1 SWAP C!+ C! ;           | : ;S! XCHG PUSH PARSE EX POP XEP #IF J S! ;THEN  NIP J CS! ;  :: FNAME bl NPAD ;S! NPAD MIN ; : =" 34 TO FNAME ;              : TOKEN bl TPAD ;S! 31 MIN ;      \ : WORD HERE ;S! ;           : ?EXIST >IN TOKEN CURRENT VFIND ROT TO >IN NIP ;               : RESCAN ?EXIST  0; ." \+"                                         OUTC 1L AND IF CR THEN  TPAD ID. BLK;  lf ;BASE BLK . ;      'T RESCAN  TO 'SAME                                                                                                             \ HANDLES FCLOSE EOF IO! HEX DECIMAL BINARY IO!                 | >: EOS -1 TO EOS? ; | 0 QUAN FBUF                                                                                             : FGET FBUF ?CALL EOS  _ [ cr , ] ;THEN  \ IF EOF THEN EOS        AT FBUF 1 AT HANDLE TOP@  FRead  _AX 0;  \ SOMETHING            DROP FBUF  DUP eof XOR 0; RDROP  ; \ CONTROLS - LIKE BL                                                                       \ STDIO                                                         CREATE FIO 0 , 0 ,     CREATE SIO ' (K , ' (E ,                 SIO 2@ FIO 2!   ' FGET FIO !            \ FIX VECTORS                                                                                                                                                                                                                                                                                                                                                                                                           \ EOS? ;TI ;SIO  ;BUF FOPEN ;S                                  \ : TOP. AT HANDLE TOP@ SPACE . ;                               : ;SIO  2@ '(IN XCHG '(OUT PUSH PUSH ?CALL EX                    POP POP THEN  TO '(IN  TO '(OUT ; | : (EVAL NEGATE TUCK - ;    : ;BUF POP RP@ ROT - RP@ OVER RP! PUSH SWAP PUSH EX POP RP! ;   : ;TI /TIB XCHG >IN PUSH TIB PUSH BLK PUSH PUSH ?CALL EX POP POP  POP POP THEN 0 TO EOS? TO /TIB TO >IN TO TIB TO ;TIB ; SAVE2  | :: FCLOSE1 TIMES HANDLE FClose ;                              | : CLOSE-ALL AT HANDLE ITEMS? FCLOSE1 ;                        | : ;FILE TO HANDLE  0 TO FBUF EX  TO FCLOSE1  0 TO EOS? ;      :: FTYPE FNAME FOPEN ;FILE BEGIN FGET EMIT EOS? UNTIL ;         : SAVE 1 ON-START !  FNAME FCREATE ;FILE  lit [ #DO-BOOT @ , ]   HERE OVER -  AT HANDLE TOP@ FWrite ;                                                                                                                                                                                                                           \ STREEM EVALUATION  - SEVAL  EVAL LOAD OK? FLOAD KBD ;S IO!    | : OK. ."  OK" ; | : PROMPT. ." >" ; \ ' OK' TO 'OK            | : OK? BLK IF EX CR ;THEN PROMPT. EX SPACE EX OK. CR ;         | : SEVAL ;SIO 100 ;BUF D0 ;TI BEGIN ?CALL EOS? UNTIL ;THEN OK?  TIB 100 ACCEPT (EVAL TO /TIB TO >IN EX INTERPRET ; SAVE2       : KBD 0 SIO SEVAL ; :: INCLUDE FNAME FOPEN ;FILE -1 FIO SEVAL ; :: EVAL CSTR 0 RP@ 2SWAP (EVAL  ;TI INTERPRET ; SAVE2           >: THRU 1+ 1K NEGATE DUP ;TI BEGIN ?CALL EOS? UNTIL ;THEN       INTERPRET ; SAVE2 | 0 CODE, BYE  : LOAD DUP TO THRU ;                             \     LBL: ;S TO EOS ; SAVE2     ??           : FLUSH SAVE-BUFS EMPTY-BUFS ;                                  | : -USE SCRH 1+ 0; SCRH FClose -1 TO SCRH ;                    : USING FLUSH -USE FNAME FOPEN TO SCRH ;                        \               : BYE CLOSE-ALL FLUSH -USE (BYE ;                                                                                                                                               \ : PROBA " #10 #12 #13 +" EVAL ;                               \ : PROBA2 " 1 2 + . ;S + Y Z W V" EVAL ;                       \ : PROBA3   99 " (:"  AT ORDER FIND .H .H .H ;                 \ : LOAD ( BLK) 1K NEGATE ( >IN) 0 ( /TIB) ROT ;TI INTERPRET ;  \ : FNAMER FNAME FOPEN DUP .BG Fsize .BG  D. FClose ;           \ : THRU U1- ;DROP OVER - LOOPS 1+ XEP J LOAD ;                 \ : PROBA5 1 2 3 4 ;TI ;                                        \ | : ? @ . ;                                                   \ : BLK. CR   ." BLK= " BLK . ." >IN= " >IN .                   \           ." /TIB= " /TIB . ." TIB= " TIB . ;                                                                                                                                                                                                                                                                                                                                                                                                                 \ DUMP LIST ?                                                   : .LINE  4 #. 1L TO TYPE ;                                      : .BLOCK ;DROP 1H LOOPS CR 1H J - .LINE ;                       : LIST  CR DUP TO SCR  DUP  6 #.  BLOCK .BLOCK ;                | : ;[] EMIT 91 EMIT EX 93 EMIT ;                               | : UNITS? U/MOD SWAP 0; 1+ ;                                   | : DU CR DUP .H 2 LOOPS SPACE bs LOOPS CSTR H. ;               : DUMP ;DROP 1H UNITS? LOOPS DUP DU bl ;[] SWAP 1H TYPE ;       0 VALUE XY                                                                                                                      : >XY 1K 1- AND TO XY ;                                         : ERR> CR TPAD ". ". BLK; BLK TO SCR  >IN  >XY ;                ' ERR>   TO '(ER                                                                                                                                                                                                                                                \ KBD & VIDEO                                                   \ 200 SET CURPOS    300 READ CURPOS  100 SHAPE CURS             \ 900 FILL SCREEN                                               CODE VIDEO VIDEO, RET, LIKE 4DOS TOBE  END-CODE                 : .ATTR  0 SWAP ATTR @ $920 VIDEO ;                             : XY?   D0 0 $300 VIDEO _DX B/MOD ;                             : ATXY  BB>W  D0 $200 VIDEO ;                                   : CURS! BB>W  D0 -ROT $100 VIDEO ;                              : PAGE 0 0 ATXY 2000 .ATTR ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ VOCABULARIES                                                  ' ORDER HEADER CSTK W, W, W, Z, DROP >MARK 100 CLARY RELEASE<   #DO-VAR @  1 VECT> TO CURRENT ;  2 VECT> TO CONTEXT ;           CODE, FORTH , , 0 , 0 ,   \ ROOT VOCABULARY  ONLY               HEADER  MACRO  ' FORTH W, W, W, W, W, DROP AT MACRO #DO-MACR !  HEADER COMMON  ' FORTH W, W, W, W, W, DROP AT COMMON #DO-COMM ! HEADER HIDDEN  ' FORTH W, W, W, W, W, DROP                                                                                      : .( 41 PARSE TYPE  ;    IMMEDIATE                              : (  41 PARSE 2DROP ;    IMMEDIATE                              : ALSO CONTEXT TO ORDER ;  : ONLY AT ORDER INITSTK ALSO ;                                                                       LBL: X BLK; BLK 1+ TIB XOR if AT EOS                              1K NEGATE TO >IN  BLK 1+ TO ;TIB ; SAVE2  \ EMPTY WORD        0 ' X 1- 2- C!   IMMEDIATE                                                                                                      \ COMPILER STUFF   - NO NAME GENERATION : ;, EX 2, ;            : ;HERE HERE EX TO HERE ; : ALLOT ;HERE + ; \ : ?DUP DUP 0; DUP : 1, ;HERE C!+ ;      : 2, ;HERE !+ ; \ : ALIGN ;HERE ODD + ;   | : SWAP;, SWAP EX 2, ; : 3, SWAP;, 1, ;  : 4, SWAP;, 2, ;      : <%> THERE ;HERE TO THERE ; : <N> NPTR ;HERE TO NPTR ;                                : COMPILE @R+ 2, ; : BCOMPILE C@R+ 1, ;  : ON -1 SWAP! ; : OFF 0 SWAP! ;   : @SWAP OVER @ XEP SWAP! ;    AT CSTK INITSTK   | : ;CSP CSP EX TO CSP ;                      : ?CSP SP@ ;CSP - A" ?IF?" ;    : CSP! ;CSP SP@ ;               : ?STKC CMARK  AT CSTK @ XOR  A" ?LP?" CSTK TO CMARK  CSTK ;    : FIX DUP @ A" ?FIX?" HERE SWAP! ;                              : STKC!  TO CSTK  CMARK TO CSTK  AT CSTK @  TO CMARK ;          : Z, 0 2, ;     : ZC, 0 1, ;    : W, STR 2, ;   : B, CSTR 1, ;                                                                                                                                                                                                  \ COMPILER STUFF   - NO NAME GENERATION                         : (DLIT (DNUM DPL 1+ IF SWAP 'LIT THEN 'LIT ;                    0 WARY STATES ]] (DLIT 2, (DNUM EXEC [[ \ INTERPRET            : A, 1 STATES PERFORM ;   \ COMPILE ADDRESS                     : S, ;DROP CSTR DUP 1, LOOPS B, ; : ," =" S, ; : ,T TOKEN S, ;  : CLARY HERE OVER ERASE ALLOT ;       \  : H2+ HERE 2+ ;        : ZARY,  HERE DUP PUSH 2- EXEC POP - CLARY ;   \ : HP, H2+ 2, ; : >MARK HERE Z, CSP! ;          : RELEASE< ?CSP FIX ;           : <RELEASE ?STKC 2, ;           : MARK> HERE STKC! ;            : >MARK> >MARK MARK> ;   : <RELEASE< <RELEASE RELEASE< ;        0 VECT> C@ 1, A, HERE NEGATE HERE 2- +! ; | 'CODE, #CAL, 232 C, 0 VECT> HERE XEP @ PUSH 3 OVER U< A" 4<?" NEGATE POP + #CAL, ;  DUP | 'CODE, (+DOES  #DO-DOES   @ ,  | : 0DOES> 0 (+DOES DROP ;     | 'CODE, (4TH:    #DO-4TH:  @ ,                                                                                                                                                             \ COMPILER STUFF   -  CONTROL STRUCTURES                        0 VECT> W, PERFORM ; #DO-COMP ! \ PREPARE FOR COMPILING IF ; ...(": FOR-   PUSH   MARK>         (": FOR    for    >MARK>        (": NEXT-  next   <RELEASE      (": NEXT   next   <RELEASE<     (": OF     of     >MARK         (": ;THEN  EXIT   RELEASE<      (": AHEAD  else   >MARK         (": ?-FOR  0>next >MARK         (": IF     if     >MARK         (": ?CALL  ?call  >MARK         (": -IF    -if    >MARK         (": #IF    #if    >MARK         (": UNTIL  if     <RELEASE      (": AGAIN  else   <RELEASE      ' MARK>    DEFER BEGIN      COMPILING                           ' RELEASE< DEFER THEN       COMPILING                           (": A" (A" ,"         (": "  ("  ,"       (": ."  (." ,"        \ #DO-LIT @ #DO-COMP @ 'CODE, (LIT , 'T 2, , \ LITERAL          (":, (LIT lit 2,                                                                                                                                                                                \ COMPILER STUFF   -  NAME GENERATION                           | : LOCATE ;SWAP 3 TOKEN SRCHPNT  PUSH  CICLES 1+ TO CICLES ;   : ' LOCATE DUP 2 AND = ?? ; \ COMPILER                          | : H1 'SAME BLK 2, CURRENT HERE TOKEN S, @SWAP 2, ;            : ALIAS [[ #DO-DEFER @ 5 - , ]] H1 2, 2, ; \ ;, ;, H1 ;         | : H2  -1 -HEADS +! HERE <N> ;GO TO <N> ALIAS ;                | : H3 -HEADS @ IF H2 ;THEN H1 ; : HEADER H3   HERE TO CFA ;    : CODE, HEADER A, ; : ,' ' A, ; : CREATE lit NOP CODE, ; \ !!!  | : ;PERF HEADER W, EX PERFORM ; | : ;CODE, CREATE A, EX ,' ;   : (1: ;CODE, DOES> ;PERF ;   : (2: ;CODE, 2, DOES> ;PERF W, ;   : (3: ;CODE, 2, 2, DOES> ;PERF W, W, ;                          LIKE (?DBG BE HEADER                                            #DO-CONST @ 'T (1: 6 + 'CODE, CONSTANT  , 'T 2, ,               #DO-VAR  @  'T (1: 6 + 'CODE, VARIABLE: , 'T 2, ,                #DO-VAR  @  'T CREATE 2+ 2+ !    \ PATCH CREATE  !!!                                                                           \ LOCATE ' INTERPRETTER COMPILER [ ]  ',  (: (;                 | : .! POP TO SRCHPNT ;                                         : ] .! AT MACRO VFIND if; AT COMMON VFIND if; U1- U1-            CONTEXT VFIND if; AT HIDDEN VFIND if; AT ORDER  FIND if; U1- ; : [  .!  CONTEXT VFIND if;  AT ORDER  FIND if; \ INTERPRETER         AT COMMON VFIND if; U1- ;  'T [   TO SCRH   COMPILING      | : CUTW     CURRENT @ DUP >LFA 0 @SWAP CURRENT ! ;             | : PASTEW OVER @SWAP SWAP >LFA ! ;  : MOVEW CUTW SWAP PASTEW ; | : (:  STKC!  0  TO CSP  CSP! ] ;  | : ((: CUTW (: ;           | : (;  ?CSP ?STKC  CSP   A" ?:;?" [[ SCRH , ]]                        #IF CURRENT PASTEW DUP THEN DROP; ;                      : VECT>  (+DOES 0 (: ;                                          : 4TH> 0 (4TH:  0 (: ;                                          \ : VARIABLE: CREATE 2, ;                                                                                                                                                                       \ MAIN LOOP     \ COMPILE NUMBER LIKE LITERAL                   \ 0 VECTOR 'TEST   6 LOAD                                                                                                       LBL: (INT  \ CR SOURCE IN? 1L MIN TYPE ." <-" .BG                           'TEST                                                          LOCATE STATES PERFORM INTERPRET ; SAVE2 \ MAIN LOOP  : F83 DECIMAL  FORTH  ONLY  TO FORTH ;                                                                                          | : (INIT lit (INT  TO INTERPRET   lit (LIT TO  'LIT  0 TO BLK  lit (DNUM 2 STATES !  lit (DLIT 0 STATES ! lit 2, 1 STATES !      AT CSTK INITSTK    F83  [[ SCRH , ]] ;     \ INTERPRETTER ON  : (AB  CLOSE-ALL (INIT   ON-START 0 @SWAP                         IF  EMPTY-BUFS  NPAD 1+ EVAL  " FRT01.SCR"  FOPEN                 TO SCRH  3 LOAD   THEN   BEGIN KBD AGAIN ; SAVE2                                                                                                                                            : SAVE2 ;HERE 2- ;                                              : SAVE1 ;HERE 1- ;                                                                                                              'T (1: 6 +  'CODE,  :      LIKE SAVE2 , 'T ((: ,  \ : !!!       LIKE :  'CODE, LBL: LIKE (INT  , 'T ((: ,                       (": ; EXIT (;                                                   (": DOES>  ;code  0DOES>                                                                                                        'T ,' DEFER ',    COMPILING                                                                                                     \ UPV TO THRESHOLD  \ VOXAN    : CREATE VARIABLE SAVE2 ;                                                                                                                                                                                                                                                                                                                                        \ INITIALIZATION                                                                                                                'HERE TO HERE    AT MINI @   AT FORTH !  \ 300 'ALLOT              $EF00 TO FIRST     3 TO NBUFS  \ EMPTY-BUFS                  $D000  TO NPTR        'T .BGR TO .BG      6 TO SCRH             NPTR   TO SPTR                                                  $EF00  TO RP0          $E500  TO SP0                            \  (INIT                                                        #DO-MOVE @ TO RELOC                                             'T (DBG TO '(DE         'T (AB  TO  '(AB                                                                                        \ TSIZE  #DO-SIZE @ !                                                                                                           \ PRUNE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         